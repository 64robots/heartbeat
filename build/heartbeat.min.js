/*

heartbeat
(c) 2013 - 2014 abudaan
https://github.com/abudaan/heartbeat/wiki/license


In util.js the method base64ToBinary() is based on Daniel Guerrero's code:

https://github.com/danguer/blog-examples/blob/master/js/base64-binary.js
https://github.com/danguer/blog-examples/blob/master/LICENSE


In util.js the method toBinaryString(), midi_parse.js and midi_stream.js are based on Matt Westcott & Ben Fishman's code:

https://github.com/gasman/jasmid
https://github.com/gasman/jasmid/blob/master/LICENSE


The code in midi_write.js is based on Sergi Mansilla's code:

https://github.com/sergi/jsmidi
https://github.com/sergi/jsmidi/blob/master/README.md

*/
var saveAs=saveAs||typeof navigator!="undefined"&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(e){"use strict";if(typeof navigator!="undefined"&&/MSIE [1-9]\./.test(navigator.userAgent))return;var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=e.URL||e.webkitURL||e,i=t.createElementNS("http://www.w3.org/1999/xhtml","a"),s=!e.externalHost&&"download"in i,o=function(n){var r=t.createEvent("MouseEvents");r.initMouseEvent("click",!0,!1,e,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(r)},u=e.webkitRequestFileSystem,a=e.requestFileSystem||u||e.mozRequestFileSystem,f=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},l="application/octet-stream",c=0,h=[],p=function(){var e=h.length;while(e--){var t=h[e];typeof t=="string"?r.revokeObjectURL(t):t.remove()}h.length=0},d=function(e,t,n){t=[].concat(t);var r=t.length;while(r--){var i=e["on"+t[r]];if(typeof i=="function")try{i.call(e,n||e)}catch(s){f(s)}}},v=function(r,o){var f=this,p=r.type,v=!1,m,g,y=function(){var e=n().createObjectURL(r);return h.push(e),e},b=function(){d(f,"writestart progress write writeend".split(" "))},w=function(){if(v||!m)m=y(r);g?g.location.href=m:window.open(m,"_blank"),f.readyState=f.DONE,b()},E=function(e){return function(){if(f.readyState!==f.DONE)return e.apply(this,arguments)}},S={create:!0,exclusive:!1},x;f.readyState=f.INIT,o||(o="download");if(s){m=y(r),t=e.document,i=t.createElementNS("http://www.w3.org/1999/xhtml","a"),i.href=m,i.download=o;var T=t.createEvent("MouseEvents");T.initMouseEvent("click",!0,!1,e,0,0,0,0,0,!1,!1,!1,!1,0,null),i.dispatchEvent(T),f.readyState=f.DONE,b();return}e.chrome&&p&&p!==l&&(x=r.slice||r.webkitSlice,r=x.call(r,0,r.size,l),v=!0),u&&o!=="download"&&(o+=".download");if(p===l||u)g=e;if(!a){w();return}c+=r.size,a(e.TEMPORARY,c,E(function(e){e.root.getDirectory("saved",S,E(function(e){var t=function(){e.getFile(o,S,E(function(e){e.createWriter(E(function(t){t.onwriteend=function(t){g.location.href=e.toURL(),h.push(e),f.readyState=f.DONE,d(f,"writeend",t)},t.onerror=function(){var e=t.error;e.code!==e.ABORT_ERR&&w()},"writestart progress write abort".split(" ").forEach(function(e){t["on"+e]=f["on"+e]}),t.write(r),f.abort=function(){t.abort(),f.readyState=f.DONE},f.readyState=f.WRITING}),w)}),w)};e.getFile(o,{create:!1},E(function(e){e.remove(),t()}),E(function(e){e.code===e.NOT_FOUND_ERR?t():w()}))}),w)}),w)},m=v.prototype,g=function(e,t){return new v(e,t)};return m.abort=function(){var e=this;e.readyState=e.DONE,d(e,"abort")},m.readyState=m.INIT=0,m.WRITING=1,m.DONE=2,m.error=m.onwritestart=m.onprogress=m.onwrite=m.onabort=m.onerror=m.onwriteend=null,e.addEventListener("unload",p,!1),g.unload=function(){p(),e.removeEventListener("unload",p,!1)},g}(typeof self!="undefined"&&self||typeof window!="undefined"&&window||this.content);typeof module!="undefined"&&module!==null?module.exports=saveAs:typeof define!="undefined"&&define!==null&&define.amd!=null&&define([],function(){return saveAs}),function(){"use strict";var e=window.console,t,n=[],r,i,s,o,u=0,a=["threshold","knee","ratio","reduction","attack","release"],f=navigator.userAgent,l,c,h=!1;f.match(/(iPad|iPhone|iPod)/g)?l="ios":f.indexOf("Android")!==-1?l="android":f.indexOf("Linux")!==-1?l="linux":f.indexOf("Macintosh")!==-1?l="osx":f.indexOf("Windows")!==-1&&(l="windows"),f.indexOf("Chrome")!==-1?c="chrome":f.indexOf("Safari")!==-1?c="safari":f.indexOf("Firefox")!==-1?c="firefox":f.indexOf("Opera")!==-1&&(c="opera");if(window.AudioContext)r=new window.AudioContext,r.createGainNode===undefined&&(r.createGainNode=r.createGain);else if(window.webkitAudioContext)r=new window.webkitAudioContext;else if(window.oAudioContext)r=new window.oAudioContext;else{if(!window.msAudioContext){window.sequencer={browser:c,os:l},alert("heartbeat requires the Web Audio API which is not yet implemented in "+c+"; please use another browser"),window.sequencer.ready=function(e){e()};return}r=new window.msAudioContext}o=r.createBufferSource(),o.start===undefined&&(h=!0),window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame,window.Blob=window.Blob||window.webkitBlob||window.mozBlob,s=r.createDynamicsCompressor(),s.connect(r.destination),i=r.createGainNode(),i.connect(r.destination),i.gain.value=1,t={context:r,masterGainNode:i,masterCompressor:s,useDelta:!1,timedTasks:{},scheduledTasks:{},repetitiveTasks:{},getSampleId:function(){return"S"+u++ +(new Date).getTime()},addInitMethod:function(e){n.push(e)},callInitMethods:function(){var e,t=n.length;for(e=0;e<t;e++)n[e]()}},window.sequencer={protectedScope:t,ui:{},ua:f,os:l,browser:c,legacy:h,webmidi:!1,webaudio:!0,util:{},debug:4,defaultInstrument:"sinewave",pitch:440,bufferTime:.35,autoAdjustBufferTime:!1,noteNameMode:"sharp",minimalSongLength:6e4,pauseOnBlur:!1,restartOnFocus:!0,defaultPPQ:960,overrulePPQ:!0,precision:3,midiInputs:[],midiOutputs:[],storage:{midi:{id:"midi"},audio:{id:"audio"},instruments:{id:"instruments"},samplepacks:{id:"samplepacks"},assetpacks:{id:"assetpacks"}},getTime:function(){return r.currentTime},setMasterVolume:function(e){e=e<0?0:e>1?1:e,i.gain.value=e},getMasterVolume:function(){return i.gain.value},getCompressionReduction:function(){return s.reduction.value},enableMasterCompressor:function(e){e?(i.disconnect(0),i.connect(s),s.disconnect(0),s.connect(r.destination)):(s.disconnect(0),i.disconnect(0),i.connect(r.destination))},configureMasterCompressor:function(e){var t,n;for(t=a.length;t>=0;t--)n=a[t],e[n]!==undefined&&(s[n].value=e[n])}}}(),function(){"use strict";function y(e,n){function h(t){v[r.id]=!0;for(u=g.length-1;u>=0;u--){f=g[u];if(f===!1)continue;l=f.taskIds;if(l!==undefined){c=!0;for(a=l.length-1;a>=0;a--)v[l[a]]!==!0&&(c=!1);c&&(f.method(t),g[u]=!1)}}e++,y(e,n)}var r,i,s,u,a,f,l,c;if(e===m.length){for(u=g.length-1;u>=0;u--){f=g[u];if(f===!1)continue;f.method()}v={},m=[],g=[],d=0,p=!1,n&&(t.log("onTaskQueueDone"),n());return}r=m[e],s=r.scope||null,i=r.params||[],o(i)!=="array"&&(i=[i]),i.push(h),r.method.apply(s,i)}var e=window.sequencer,t=window.console,n,r,i,s,o,u,a,f,l,c,h,p=!1,d=0,v={},m=[],g=[];e.removeMidiFile=function(e){var t,n=[],i,o;e.className==="MidiFile"?(t=e,e=t.localPath):t=r(e,l.midi),t.className==="MidiFile"?n.push(t):(o=t,f(o,function(e){e.className==="MidiFile"&&n.push(e)}));for(i=n.length-1;i>=0;i--)t=n[i],s(t.localPath,l.midi)},e.removeInstrument=function(e,t){var n,i=[],o,u,a,h;e.className==="InstrumentConfig"?(n=e,e=n.localPath):n=r(e,l.instruments);if(n.className==="InstrumentConfig")i.push(n);else{u=n;for(o in u)u.hasOwnProperty(o)&&(n=u[o],n.className==="InstrumentConfig"&&i.push(n))}for(o=i.length-1;o>=0;o--)n=i[o],a=n.mapping,h=n.sample_path,t===!0&&(f(a,function(e){s(h+"/"+e.n,l.audio)}),s(h,l.samplepacks)),s(n.localPath,l.instruments);c()},e.removeSamplePack=function(e){var t,n=[],i,o,u,a,h;e.className==="SamplePack"?(t=e,e=t.localPath):t=r(e,l.samplepacks),t.className==="SamplePack"?n.push(t):(h=t,f(h,function(e){e.className==="SamplePack"&&n.push(e)}));for(i=n.length-1;i>=0;i--){t=n[i],o=t.samples;for(a=o.length-1;a>=0;a--)u=o[a],s(u.folder+"/"+u.id,l.audio);t.reset(),s(t.localPath,l.samplepacks)}c()},e.removeAssetPack=function(e){var t,n;e.className==="AssetPack"?(t=e,e=t.localPath):t=r(e,l.assetpacks),t.className==="AssetPack"?t.unload():(n=t,f(n,function(e){e.className==="AssetPack"&&e.unload()}))},e.startTaskQueue=function(e){if(p===!0)return;p=!0,y(0,e)},e.addTask=function(t,n,r){return t.id="task"+d++,m.push(t),n!==undefined&&(r===!0?e.addCallbackAfterTask(n):e.addCallbackAfterTask(n,[t.id])),t.id},e.addCallbackAfterTask=function(e,t){g.push({method:e,taskIds:t})},e.getInstrument=function(e,t){return r(e,l.instruments,t)},e.getMidiFile=function(e,t){return r(e,l.midi,t)},e.getSamplePack=function(e,t){return r(e,l.samplepacks,t)},e.getSample=function(e,t){return r(e,l.audio,t)},e.getAssetPack=function(e,t){return r(e,l.assetpacks,t)},e.getSamplePacks=function(e,t){return h(e,l.samplepacks,t)},e.getAssetPacks=function(e,t){return h(e,l.assetpacks,t)},e.getSamples=function(e,t){return h(e,l.audio,t)},e.getInstruments=function(e,t){return h(e,l.instruments,t)},e.getMidiFiles=function(e,t){return h(e,l.midi,t)},e.protectedScope.addInitMethod(function(){l=e.storage,n=e.protectedScope.loadLoop,r=e.protectedScope.findItem,i=e.protectedScope.storeItem,s=e.protectedScope.deleteItem,o=e.protectedScope.typeString,u=e.protectedScope.getArguments,a=e.protectedScope.isEmptyObject,f=e.protectedScope.objectForEach,c=e.protectedScope.updateInstruments,h=e.protectedScope.findItemsInFolder})}(),function(){"use strict";function m(e,t){e=null,t(!1)}function g(n){var r=u(n.localPath,e.storage.assetpacks,!0),i=n.action;r&&r.className==="AssetPack"&&i!=="overwrite"?e.debug>=2&&t.warn("there is already an AssetPack at",n.localPath):a(n,n.localPath,e.storage.assetpacks)}function y(e,t){e.url!==undefined?i({url:e.url,responseType:"json",onError:function(n){m(e,t)},onSuccess:function(n,r){if(n===null){t(!1);return}e.loaded=!0,n.name!==undefined&&e.name===undefined&&(e.name=n.name),n.folder!==undefined&&e.folder===undefined&&(e.folder=n.folder),e.name===undefined&&(e.name=o(e.url).name),e.localPath=e.folder!==undefined?e.folder+"/"+e.name:e.name,e.filesize=r,n.instruments&&(e.instruments=e.instruments.concat(n.instruments)),n.samplepacks&&(e.samplepacks=e.samplepacks.concat(n.samplepacks)),n.midifiles&&(e.midifiles=e.midifiles.concat(n.midifiles)),b(e,t)}}):(e.localPath=e.folder!==undefined?e.folder+"/"+e.name:e.name,b(e,t))}function b(t,n){var r,i,s;i=t.midifiles;for(r=i.length-1;r>=0;r--)s=i[r],s.pack=t,e.addMidiFile(s);i=t.instruments;for(r=i.length-1;r>=0;r--)s=i[r],s.pack=t,e.addInstrument(s);i=t.samplepacks;for(r=i.length-1;r>=0;r--)s=i[r],s.pack=t,e.addSamplePack(s);n()}var e=window.sequencer,t=window.console,n=0,r,i,s,o,u,a,f,l,c,h,p,d,v;v=function(e){this.id="AP"+n++ +(new Date).getTime(),this.name=this.id,this.className="AssetPack",this.loaded=!1,this.midifiles=e.midifiles||[],this.samplepacks=e.samplepacks||[],this.instruments=e.instruments||[],this.url=e.url;var t=this;c(e,function(e,n){t[n]=e})},v.prototype.unload=function(){var e,t,n;t=this.midifiles;for(e=t.length-1;e>=0;e--)n=t[e],h(n.folder+"/"+n.name);t=this.instruments;for(e=t.length-1;e>=0;e--)n=t[e],p(n.folder+"/"+n.name);t=this.samplepacks;for(e=t.length-1;e>=0;e--)n=t[e],d(n.folder+"/"+n.name);f(this.localPath,r.assetpacks)},e.addAssetPack=function(n,r){var i=l(n),s,o,u,a;if(i!=="object")return e.debug>=2&&t.warn("can't create an AssetPack with this data",n),!1;if(n.json){o=n.json,u=n.name,a=n.folder;if(l(o)==="string")try{o=JSON.parse(o)}catch(f){return e.debug>=2&&t.warn("can't create an AssetPack with this data",n),!1}if(o.instruments===undefined&&o.midifiles===undefined&&o.samplepacks===undefined)return e.debug>=2&&t.warn("can't create an AssetPack with this data",n),!1;n={midifiles:o.midifiles,instruments:o.instruments,samplepacks:o.samplepacks,name:u===undefined?o.name:u,folder:a===undefined?o.folder:a}}s=new v(n),e.addTask({type:"load asset pack",method:y,params:s},function(e){if(s.loaded===!1){r(!1);return}g(s),r&&r(s)},!0),e.startTaskQueue()},e.protectedScope.addInitMethod(function(){i=e.protectedScope.ajax,s=e.protectedScope.round,o=e.protectedScope.parseUrl,u=e.protectedScope.findItem,a=e.protectedScope.storeItem,f=e.protectedScope.deleteItem,l=e.protectedScope.typeString,c=e.protectedScope.objectForEach,r=e.storage,h=e.removeMidiFile,p=e.removeInstrument,d=e.removeSamplePack})}(),function(){"use strict";var e,t,n,r=0;n=function(t){if(!t)return;if(t.length!==3||e(t[0])!=="number"||e(t[1])!=="string"||e(t[3])!=="number"){console.log("wrong number of arguments, please consult documentation");return}this.ticks=t[0],this.sample=t[1],this.duration=t[2],this.className="AudioEvent",this.id="event_"+r++},n.prototype={clone:function(){var e=new n,r;for(r in this)this.hasOwnProperty(r)&&(r==="id"?e.id=t(this.id):r!=="clone"&&(e[r]=this[r]));return e}},sequencer.createAudioEvent=function(){var e=Array.prototype.slice.call(arguments),t=e[0].className;return t==="AudioEvent"?e[0].clone():new n(e)},sequencer.protectedScope.addInitMethod(function(){e=sequencer.protectedScope.typeString,t=sequencer.protectedScope.copyName})}(),function(){"use strict";function h(e){this.id="FX"+n++ +""+(new Date).getTime(),this.type=e.type,this.buffer=e.buffer,this.config=e,this.bypass=!1,this.amount=0,this.output=r.createGainNode(),this.wetGain=r.createGainNode(),this.dryGain=r.createGainNode(),this.output.gain.value=1,this.wetGain.gain.value=this.amount,this.dryGain.gain.value=1-this.amount}var e=window.sequencer,t=window.console,n=0,r,i,s,o,u,a,f,l,c;h.prototype.setInput=function(e){e.connect(this.dryGain),this.dryGain.connect(this.output),e.connect(this.node),this.node.connect(this.wetGain),this.wetGain.connect(this.output)},h.prototype.setAmount=function(e){this.amount=e<0?0:e>1?1:e,this.wetGain.gain.value=this.amount,this.dryGain.gain.value=1-this.amount},h.prototype.copy=function(){switch(this.type){case"reverb":return new o(this.config);case"panner":return new u(this.config);case"panner2":return new a(this.config);case"delay":return new f(this.config);case"compressor":return new c(this.config)}},e.createReverb=function(e){var n=s(e);if(n===!1)return t.warn("no reverb with id",e,"loaded"),!1;var r={type:"reverb",buffer:n};return new o(r)},e.createPanner=function(e){return e=e||{},e.type="panner",new u(e)},e.createPanner2=function(e){return e=e||{},e.type="panner2",new a(e)},e.createDelay=function(e){return e=e||{},e.type="delay",new f(e)},e.createCompressor=function(e){return e=e||{},e.type="compressor",new c(e)},e.createBiQuadFilter=function(e){return e=e||{},e.type="biquadfilter",new l(e)},e.protectedScope.addInitMethod(function(){r=e.protectedScope.context,i=e.protectedScope.createClass,s=e.getSample,o=i(h,function(e){this.node=r.createConvolver(),this.node.buffer=e.buffer}),u=i(h,function(e){this.node=r.createPanner(),this.node.panningModel="equalpower",this.node.setPosition(0,0,0)}),a=i(h,function(e){this.node=r.createPanner(),this.node.panningModel="HRTF",this.node.setPosition(0,0,0)}),f=i(h,function(e){this.node=r.createDelay(),this.node.delayTime.value=.3}),c=i(h,function(e){this.node=r.createDynamicsCompressor()}),l=i(h,function(e){this.node=r.createBiquadFilter(),this.node.type=0,this.node.Q.value=4,this.node.frequency.value=1600}),u.prototype.setPosition=function(e){var t=e,n=1-Math.abs(t);this.node.setPosition(t,0,n)},a.prototype.setPosition=function(e){var t=parseInt(e),n=t+90,r,i;n>90&&(n=180-n),r=Math.sin(t*(Math.PI/180)),i=Math.sin(n*(Math.PI/180)),this.node.setPosition(r,0,i)},f.prototype.setTime=function(e){this.node.delayTime.value=e}})}(),function(){"use strict";var e=sequencer.createNote,t=sequencer.findEvent,n=sequencer.protectedScope.round,r=sequencer.protectedScope.getEvents,i=sequencer.protectedScope.typeString,s="max min avg all",o="data1 data2 velocity noteNumber noteName frequency",u;u=function(){var u=Array.prototype.slice.call(arguments),a=u.length,f,l,c,h,p,d,v,m,g,y,b,w=128,E=-1,S=0,x=0,T=!1;c=r(u[0]);if(c.length===0)return-1;h=u[1];if(i(h)!=="string")return console.error("please provide a search string like for instance get('velocity max bar >= 1 < 8')"),-1;a>2&&console.warn("ignoring invalid arguments, please consult documentation"),h=h.split(" "),p=h.length,f=h[0],l=h[1];if(o.indexOf(f)===-1)return console.error("you can't use 'min', 'max' or 'avg'","on the property",f),-1;if(s.indexOf(l)===-1)return console.error(l,"is not a valid operator"),-1;p>2&&(p===6&&console.warn("ignoring cruft found in search string, please consult documentation"),h.shift(),h.shift(),c=t(c,h.join(" "))),f==="noteName"&&(f="noteNumber",T=!0);for(d=0,v=c.length;d<v;d++)m=c[d],g=m[f],g>E&&(E=g,b=m.noteName),g<w&&(w=g,y=m.noteName),g!==undefined&&(S+=g);x=S/v,T&&(x=n(x),x=e(x).name,w=y,E=b);if(l==="max")return E;if(l==="min")return w;if(l==="avg")return x;if(l==="all")return{min:w,max:E,avg:x}},sequencer.getStats=u,sequencer.protectedScope.addInitMethod(function(){e=sequencer.createNote,t=sequencer.findEvent,n=sequencer.protectedScope.round,r=sequencer.protectedScope.getEvents,i=sequencer.protectedScope.typeString})}(),function(){"use strict";var e,t,n,r,i,s,o={barsbeats:["bar","beat","sixteenth","tick"],time:["hour","minute","second","millisecond"]},u="OR AND NOT XOR",a=new RegExp(" "+u.replace(/\s+/g," | ")+" "),f={bar:1,beat:1,sixteenth:1,tick:1,ticks:1,barsbeats:1,musical_time:1,hour:1,minute:1,second:1,millisecond:1,millis:1,time:1,linear_time:1,id:1,type:1,data1:1,data2:1,velocity:1,noteNumber:1,frequency:1,noteName:1},l,c,h,p,d,v,m,g,y,b,w,E;l=function(){var e=Array.prototype.slice.call(arguments),n,r,o,u,f,l,c,p,v,m,g,y,S,x,T;g=h(e[0]),y=[];if(g.length===0)return console.warn("findEvent: no events"),y;if(t(e[1])!=="string")return console.error("please provide a search string like for instance findEvent('beat = 2 AND velocity > 60 < 100');"),y;o=e[1],u=o.split(" "),r=u.length,s=[];for(n=0;n<r;n++)f=u[n],a.test(" "+f+" ")&&s.push(f);u=o.split(a),r=u.length,i=[];for(n=0;n<r;n++)d(u[n].split(" "));r=i.length,v=0,m=-1;for(n=0;n<r;n++)l=i[v++],f=s[m++],f==="AND"?y=E(y,l):f==="NOT"?y=E(y,l,!0):f==="XOR"?(x=E(g,l),y=b(y,x)):(S=E(g,l),y=y.concat(S)),c=l,p=f;return w(y)},b=function(e,t){var n,r=e.length,i,s=t.length,o,u,a,f=[];for(n=0;n<r;n++){a=!0,o=e[n],u=o.id;for(i=0;i<s;i++)if(t[i].id===u){a=!1;break}a&&f.push(o)}for(i=0;i<s;i++){a=!0,o=t[i],u=o.id;for(n=0;n<r;n++)if(e[n].id===u){a=!1;break}a&&f.push(o)}return f},w=function(e){var t,n=e.length,r,i,s,o=[];e.sort(function(e,t){return e.eventNumber-t.eventNumber});for(t=0;t<n;t++)r=e[t],i=r.id,i!==s&&o.push(r),s=i;return o},E=function(e,t,n){var r=[],i=t.property,s=t.operator1,o=t.operator2,u=t.value1,a=t.value2,f=e.length,l,c,h=!1;n=n||!1,n&&(s=y(s),o=y(o));for(c=0;c<f;c++)l=e[c],h=m(i,l[i],s,u,o,a),h&&r.push(l);return r},m=function(e,n,i,s,o,u){var a=!1,f=!1;if(n===undefined)return a;switch(e){case"noteName":if(i==="=")return s.length===3&&n.length===4?a=n.indexOf(s)===0:s.length===4&&n.length===5&&(a=n.indexOf(s)===0),a;break;case"type":t(s)!=="number"&&isNaN(s)&&(s=r(s));break;case"bar":case"beat":case"sixteenth":}t(n)==="string"?(t(s)!=="string"&&(s="'"+s+"'"),u&&t(u)!=="string"&&(u="'"+u+"'"),f=!0):t(n)==="number"&&(t(s)!=="number"&&(s=parseInt(s)),u&&t(u)!=="number"&&(u=parseInt(u)));switch(i){case"=":case"==":case"===":a=n===s;break;case"*=":a=n.indexOf(s)!==-1;break;case"^=":a=n.indexOf(s)===0;break;case"$=":a=n.indexOf(s)===n.length-s.length;break;case"%=":f?a=!1:a=n%s===0;break;case"!*=":a=n.indexOf(s)===-1;break;case"!^=":a=n.indexOf(s)!==0;break;case"!$=":a=n.indexOf(s)!==n.length-s.length;break;case"!%=":f?a=!0:a=n%s!==0;break;case"!=":case"!==":f?a=n.indexOf(s)===-1:a=n!==s;break;case">":o?a=g(n,i,s,o,u):a=n>s;break;case">=":o?a=g(n,i,s,o,u):a=n>=s;break;case"<":o?a=g(n,i,s,o,u):a=n<s;break;case"<=":o?a=g(n,i,s,o,u):a=n<=s;break;default:console.warn("eval is evil!")}return a},g=function(e,t,n,r,i){var s=!1;switch(t){case">":switch(r){case"<":s=e>n&&e<i;break;case"<=":s=e>n&&e<=i}break;case">=":switch(r){case"<":s=e>=n&&e<i;break;case"<=":s=e>=n&&e<=i}break;case"<":switch(r){case">":s=e<n||e>i;break;case">=":s=e<n||e>=i}break;case"<=":switch(r){case">":s=e<=n||e>i;break;case">=":s=e<=n||e>=i}}return s},h=function(e){var n,r,i,s=[];return t(e)==="array"?s=e:e.className===undefined?console.warn(e):e.className==="Track"||e.className==="Part"?s=e.events:e.className==="Song"&&(s=e.events),s},d=function(e){var t={property:e[0],operator1:e[1],value1:e[2],operator2:e[3],value2:e[4]},n=e[0],r=e[1],u=e[2],a=e[3],l=e[4],c;if(f[n]!==1)return console.error(n,"is not a supported property"),!1;t=v(t);if(n==="barsbeats"||n==="time"){u=p(u,n);for(c=0;c<4;c++)t={},t.property=o[n][c],t.operator1=r,t.value1=u[c],i.push(t),s.push("AND");s.pop();if(l){l=p(l,n);for(c=0;c<4;c++)t={},t.property=o[n][c],t.operator2=a,t.value2=l[c],i.push(t),s.push("AND");s.pop()}}else i.push(t)},p=function(e,n){e=e.replace(/(\[|\])/g,""),t(e)!=="array"&&(n==="barsbeats"?e.indexOf(",")===-1?e=[e,1,1,0]:e=e.split(","):n==="time"&&(e.indexOf(",")===-1?e=[0,e,0,0]:e=e.split(",")));switch(e.length){case 1:n==="barsbeats"?e.push(1,1,0):n==="time"&&e.push(0,0,0);break;case 2:n==="barsbeats"?e.push(1,0):n==="time"&&e.push(0,0);break;case 3:e.push(0)}return e},v=function(t){var n=t.operator1,r=t.operator2,i=function(e){return e==="<"||e===">"||e==="<="||e===">="?!0:!1},s=function(e){return e==="="||e==="=="||e==="==="?!0:!1};return t.property==="noteName"&&(i(n)||s(n))&&(t.property="noteNumber",t.value1=e(t.value1).number),t.property==="noteName"&&(i(r)||s(r))&&(t.property="noteNumber",t.value2=e(t.value2).number),i(n)&&!i(r)&&(delete t.operator2,delete t.value2),t},y=function(e){var t;switch(e){case"=":case"==":case"===":t="!==";break;case"!=":case"!==":t="===";break;case"<":t=">=";break;case">":t="<=";break;case"<=":t=">";break;case">=":t="<";break;case"*=":case"^=":case"&=":case"%=":t="!"+e;break;default:t=e}return t},c=function(){var e=l.apply(this,arguments),t=e.length,r,i,s,o={},u,a=[];for(r=0;r<t;r++)i=e[r],i.type===sequencer.NOTE_ON?(o[i.noteNumber]===undefined&&(o[i.noteNumber]=[]),o[i.noteNumber].push(i)):i.type===sequencer.NOTE_OFF&&(u=o[i.noteNumber],u&&(s=u.shift(),a.push(n(s,i))),u.length===0&&delete o[i.noteNumber]);return a.sort(function(e,t){return e.ticks-t.ticks}),a},sequencer.findEvent=l,sequencer.findNote=c,sequencer.protectedScope.getEvents=h,sequencer.protectedScope.addInitMethod(function(){e=sequencer.createNote,t=sequencer.protectedScope.typeString,n=sequencer.createMidiNote,r=sequencer.midiEventNumberByName})}(),function(){"use strict";function S(e){e=null}function x(e,t,n,r){var i;for(t=0;t<n;t++){i=e[t];if(i===undefined)continue;i.className==="MidiNote"?r.push(i.noteOn):f(i)==="array"&&x(i,0,i.length)}}function T(e){return{getValue:function(e){return Math.sin(e*2*Math.PI)}}}var e=window.sequencer,t=window.console,n=e.debug,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E;w=function(e){this.className="Instrument",this.config=e,this.scheduledEvents={},this.scheduledSamples={},this.sustainPedalDown=!1,this.sustainPedalSamples={},this.sampleDataByNoteNumber={},this.sampleData=[],this.info=e.info||e.instrument_info,this.author=e.author||e.instrument_author,this.license=e.license||e.instrument_license,this.pack=e.pack,this.parse()},w.prototype.reset=function(){var t=e.getInstrument(this.config.localPath),n=e.getSamplePack(this.config.sample_path);if(n===!1||t===!1)this.scheduledEvents={},this.scheduledSamples={},this.sustainPedalSamples={},this.sampleDataByNoteNumber={},this.sampleData=[],this.update&&delete o[this.updateTaskId],t===!1&&this.track.setInstrument()},w.prototype.parse=function(){function _(n){var r,i;if(n.n)m=C[n.n];else{g=[d,p,p.toLowerCase()];for(i=2;i>=0;i--){m=C[g[i]];if(m!==undefined){A[y]={n:g[i]};break}}}if(m===undefined){e.debug&&t.log("no buffer found for "+y+" ("+O.name+")"),x=!1;return}x={noteNumber:d,buffer:m,bufferId:n.n,autopan:O.autopan},k.sustain===!0&&(x.sustain=!0,E=!0),n.s!==undefined?(x.sustain_start=n.s[0],x.sustain_end=n.s[1],x.sustain=!0,E=!0):k.sustain===!0&&(r=N.samplesById[n.n].sustain,r!==undefined?(x.sustain_start=r[0],x.sustain_end=r[1]):x.sustain=!1),k.release_duration!==undefined&&(x.release_duration=k.release_duration,x.release_envelope=k.release_envelope||O.releaseEnvelope,x.release=!0,E=!0),n.r!==undefined&&(f(n.r)==="array"?(x.release_duration=n.r[0],x.release_envelope=n.r[1]||O.releaseEnvelope):isNaN(n.r)||(x.release_duration=n.r,x.release_envelope=O.releaseEnvelope),x.release=!0,E=!0),n.p!==undefined&&(x.panPosition=n.p,x.panning=!0)}var n,r,s,u,a,l,c,h,p,d,v,m,g,y,b,w,E,S,x,N,C,k=this.config,L=k.notename_mode===undefined?e.noteNameMode:k.notename_mode,A=k.mapping,O=this;if(k.name===undefined)return t.error("instruments must have a name",k),!1;if(A===undefined)return t.error("instruments must have a mapping to samples",k),!1;this.name=k.name,this.folder=k.folder||"",this.autopan=k.autopan||!1,this.singlePitch=k.single_pitch||!1,this.samplePath=k.sample_path||this.name,this.keyScalingRelease=k.keyscaling_release,this.keyScalingPanning=k.keyscaling_panning,this.keyRange=k.keyrange||k.key_range,v=this.samplePath.split("/"),N=i.samplepacks;for(n=0,r=v.length;n<r;n++){if(N===undefined){e.debug&&t.log("sample pack not found",v.join("/"));return}N=N[v[n]]}C=i.audio;try{for(n=0,r=v.length;n<r;n++)C=C[v[n]]}catch(M){e.debug&&t.log('sample pack "'+v[n]+'" is not loaded');return}if(C===undefined){e.debug&&t.log("sample pack not found",v.join("/"));return}if(f(A)==="array"){this.keyRange=A,A={};for(n=this.keyRange[0];n<=this.keyRange[1];n++)A[n]=""}this.keyRange===undefined?(this.lowestNote=128,this.highestNote=-1):(this.lowestNote=this.keyRange[0],this.highestNote=this.keyRange[1],this.numNotes=this.highestNote-this.lowestNote),k.release_duration!==undefined?this.releaseDuration=k.release_duration:this.releaseDuration=0,this.releaseEnvelope=k.release_envelope||"equal power",this.autopan&&(this.autoPanner=T()),this.samplepack=N;for(y in A)if(A.hasOwnProperty(y)){b=A[y],isNaN(y)?(l=y.length,c=y.substring(l-1),h=y.substring(0,l-1),p=y,d=e.getNoteNumber(h,c)):(p=e.getNoteNameFromNoteNumber(y,L),p=p.join(""),d=y),d=parseInt(d,10),this.keyRange===undefined&&(this.lowestNote=d<this.lowestNote?d:this.lowestNote,this.highestNote=d>this.highestNote?d:this.highestNote);if(f(b)==="array"){this.multiLayered=!0;for(n=0,r=b.length;n<r;n++){w=b[n],_(w),this.sampleDataByNoteNumber[d]===undefined&&(this.sampleDataByNoteNumber[d]=[]),u=w.v[0],a=w.v[1];for(s=u;s<=a;s++)this.sampleDataByNoteNumber[d][s]=x;this.sampleData.push(x)}}else _(b),this.sampleDataByNoteNumber[d]=x,this.sampleData.push(x)}this.keyRange===undefined&&(this.numNotes=this.highestNote-this.lowestNote,this.keyRange=[this.lowestNote,this.highestNote]),this.config.mapping=A;if(this.singlePitch)for(n=127;n>=0;n--)this.sampleData[n]=x,this.sampleDataByNoteNumber[n]=x;E&&(this.updateTaskId="update_"+this.name+"_"+(new Date).getTime(),o[this.updateTaskId]=function(){O.autopan?O.update(this.autoPanner.getValue()):O.update()})},w.prototype.getInfoAsHTML=function(){var t="",n="",r="",i=this.samplepack;return this.info!==undefined&&(n+="<tr><td>info</td><td>"+this.info+"</td></tr>"),this.author!==undefined&&(n+="<tr><td>author</td><td>"+this.author+"</td></tr>"),this.license!==undefined&&(n+="<tr><td>license</td><td>"+this.license+"</td></tr>"),n+="<tr><td>keyrange</td><td>"+this.lowestNote+"("+e.getFullNoteName(this.lowestNote)+")",n+=" - "+this.highestNote+"("+e.getFullNoteName(this.highestNote)+")</td></tr>",n!==""&&(n='<table><th colspan="2">instrument</th>'+n+"</table>",t+=n),i===undefined?t:(i.info!==undefined&&(r+="<tr><td>info</td><td>"+i.info+"</td></tr>"),i.author!==undefined&&(r+="<tr><td>author</td><td>"+i.author+"</td></tr>"),i.license!==undefined&&(r+="<tr><td>license</td><td>"+i.license+"</td></tr>"),i.compression!==undefined&&(r+="<tr><td>compression</td><td>"+i.compression+"</td></tr>"),i.filesize!==undefined&&(r+="<tr><td>filesize</td><td>"+g(i.filesize/1024/1024,2)+" MiB</td></tr>"),r!==""&&(r='<table><th colspan="2">samplepack</th>'+r+"</table>",t+=r),t)},w.prototype.getInfo=function(){var e={instrument:{},samplepack:{}};return this.info!==undefined&&(e.instrument.info=this.info),this.author!==undefined&&(e.instrument.author=this.author),this.license!==undefined&&(e.instrument.license=this.license),this.keyrange!==undefined&&(e.instrument.keyrange=this.keyrange),this.info!==undefined&&(e.samplepack.info=this.info),this.author!==undefined&&(e.samplepack.author=this.author),this.license!==undefined&&(e.samplepack.license=this.license),this.compression!==undefined&&(e.samplepack.compression=this.compression),this.filesize!==undefined&&(e.samplepack.filesize=g(this.samplepack.filesize/1024/1024,2)),e},w.prototype.createSample=function(e){var n=e.noteNumber,r=e.velocity,i=this.sampleDataByNoteNumber[n],s=f(i);return s==="array"&&(i=i[r]),i===undefined||i===!1?{start:function(){t.warn("no audio data loaded for",n)},stop:function(){},update:function(){},addData:function(){},unschedule:function(){}}:(i.track=e.track,p(i))},w.prototype.setKeyScalingPanning=function(e,t){var n,r,i=this.sampleData.length,s,o;if(e===!1)for(n=0;n<i;n++)r=this.sampleData[n],r.panning=!1;if(isNaN(e)===!1&&isNaN(t)===!1){s=(t-e)/this.numNotes,o=e;for(n=0;n<i;n++)r=this.sampleData[n],r.panning=!0,r.panPosition=o,o+=s}},w.prototype.setRelease=function(e,t){if(e===undefined)return;this.releaseEnvelope=t||this.releaseEnvelope,this.keyScalingRelease=undefined;var n,r,i=this.sampleData.length;for(n=0;n<i;n++)r=this.sampleData[n],r.release=!0,r.release_duration=e,r.release_envelope=this.releaseEnvelope;this.releaseDuration=e},w.prototype.setKeyScalingRelease=function(e,t,n){var r,i,s=this.sampleData.length,o,u;this.releaseEnvelope=n||this.releaseEnvelope;if(isNaN(e)===!1&&isNaN(t)===!1){this.keyScalingRelease=[e,t],this.releaseDuration=0,o=(t-e)/this.numNotes,u=e;for(r=0;r<s;r++)i=this.sampleData[r],i.release_duration=u,i.release_envelope=u,u+=o}},w.prototype.transpose=function(e,n,r){function s(o,u){var a;r&&r("transposing sample "+(o+1)+" of "+i),o<i?(a=u[o],setTimeout(function(){b(a.buffer,e,function(e){a.buffer=e,s(++o,u)})},10)):n&&(t.log("ready"),n())}if(b===undefined){t.log("transpose is still experimental");return}var i=this.sampleData.length;s(0,this.sampleData)},w.prototype.processEvent=function(e,t){var n=e.type,r,i,s,o;t=t===undefined?0:t,n===128||n===144?n===128?(this.sustainPedalDown===!0&&(e.sustainPedalDown=!0),this.stopNote(e,t)):this.playNote(e,t):e.type===176&&(r=e.data1,i=e.data2,r===64?i===127?(this.sustainPedalDown=!0,v(this.track.song,"sustain_pedal","down")):i===0&&(this.sustainPedalDown=!1,v(this.track.song,"sustain_pedal","up"),this.stopSustain(t)):r===10?(s=this.track,s.setPanning(m(i,0,127,-1,1))):r===7&&(s=this.track,o=s.output,o.gain.setValueAtTime(i/127,t)))},w.prototype.stopSustain=function(e){var t,n=this.scheduledSamples,r=this.sustainPedalSamples;h(r,function(r){r!==undefined&&(t=r.midiNote,t.noteOn.sustainPedalDown=undefined,t.noteOff.sustainPedalDown=undefined,r.stop(e,function(e){n[e.sourceId]=null,delete n[e.sourceId]}))}),this.sustainPedalSamples={}},w.prototype.playNote=function(n,r){var i,s;if(!n.midiNote){e.debug&&t.warn("playNote() no midi note");return}s=n.midiNote.id,i=this.scheduledSamples[s],i!==undefined&&i.unschedule(0),i=this.createSample(n),i.addData({midiNote:n.midiNote,noteName:n.midiNote.note.fullName,sourceId:s}),this.scheduledSamples[s]=i,i.start(r,n.velocity)},w.prototype.stopNote=function(n,r){if(n.midiNote===undefined){e.debug&&t.warn("stopNote() no midi note");return}var i=n.midiNote.id,s=this.scheduledSamples[i],o=this.scheduledSamples,u=this.sustainPedalSamples;if(n.sustainPedalDown===!0){u[i]=s;return}if(s===undefined)return;s.stop(r,function(){o[i]=null,delete o[i]})},w.prototype.hasScheduledSamples=function(){return c(this.scheduledSamples)},w.prototype.reschedule=function(t){var n=t.millis,r=n+e.bufferTime*1e3,i=n+20,s=this.scheduledSamples,o,u,a;for(o in s)if(s.hasOwnProperty(o)){a=s[o],u=a.midiNote;if(u===undefined||u.state==="removed")a.unschedule(0,S),delete s[o];else{if(u.noteOn.millis>=n&&u.noteOff.millis<r&&a.noteName===u.fullName)continue;delete s[o],a.unschedule(null,S)}}},w.prototype.unschedule=function(){var e=Array.prototype.slice.call(arguments),t=[],n,r,i,o;x(e,0,e.length,t);for(n=t.length-1;n>=0;n--)r=t[n],r.midiNote!==undefined?(i=r.midiNote.id,o=this.scheduledSamples[i],o!==undefined&&(o.unschedule(0,S),delete this.scheduledSamples[i])):r.className==="MidiEvent"&&(i=r.id,delete s["event_"+i],delete this.scheduledEvents[i])},w.prototype.allNotesOff=function(){var e,t,n=this.scheduledSamples;this.stopSustain(0),this.sustainPedalDown=!1;if(n===undefined||c(n)===!0)return;for(t in n)n.hasOwnProperty(t)&&(e=n[t],e&&e.unschedule(0,S));this.scheduledSamples={},h(this.scheduledEvents,function(e,t){delete s["event_"+t]}),this.scheduledEvents={}},w.prototype.update=function(e){var t,n;for(t in this.scheduledSamples)this.scheduledSamples.hasOwnProperty(t)&&(n=this.scheduledSamples[t],n&&n.update(e))},e.createInstrument=function(e){var r=f(e),s,o;return r==="object"?(e.className==="Instrument"?o=e:e.className==="InstrumentConfig"&&(e.name==="sinewave"?o=new E(e):o=new w(e)),o):(r==="string"&&(s=u(e,i.instruments)),s===!1||s.className!=="InstrumentConfig"?(n>=2&&t.info("can not create instrument from",e),!1):(s.name==="sinewave"?o=new E(s):o=new w(s),o))},e.protectedScope.addInitMethod(function(){var t=e.protectedScope;i=e.storage,p=e.createSample,d=e.createReverb,v=e.protectedScope.songDispatchEvent,r=t.context,s=t.timedTasks,o=t.repetitiveTasks,h=t.objectForEach,c=t.isEmptyObject,u=t.findItem,a=t.storeItem,f=t.typeString,l=t.pathToArray,b=t.transpose,E=t.createClass(w),m=e.util.remap,g=e.util.round,y=e.util.getEqualPowerCurve,E.prototype.parse=function(){var e=this,t=this.config;this.name="SineWave",this.waveForm=t.wave_form||0,this.autopan=t.autopan||!1,this.folder=t.folder||"heartbeat",this.releaseDuration=t.release_duration||1500,this.autopan&&(this.autoPanner=T()),o["update_"+this.name+"_"+(new Date).getTime()]=function(){e.autopan?e.update(Math.sin(r.currentTime*2*Math.PI)):e.update()}},E.prototype.createSample=function(e){var t={oscillator:!0,track:e.track,event:e,autopan:this.autopan,wave_form:this.waveForm,release_envelope:"equal power",release_duration:this.releaseDuration};return p(t)},e.createSimpleSynth=function(e){return e=e||{},new E(e)}})}(),function(){"use strict";function l(e,t){e=undefined,t&&t(!1)}function c(n){var r=i(n.localPath,e.storage.instruments,!0),o=n.action;r&&r.className==="InstrumentConfig"&&o!=="overwrite"?e.debug>=2&&(t.warn("there is already an Instrument at",n.localPath),l(n)):s(n,n.localPath,e.storage.instruments)}function h(e,t){if(e.url===undefined){e.localPath=e.folder!==undefined?e.folder+"/"+e.name:e.name,t();return}n({url:e.url,responseType:"json",onError:function(){l(e,t)},onSuccess:function(n){if(n===null){t(!1);return}n.name!==undefined&&e.name===undefined&&(e.name=n.name),n.folder!==undefined&&e.folder===undefined&&(e.folder=n.folder),e.name===undefined&&(e.name=r(e.url).name),e.localPath=e.folder!==undefined?e.folder+"/"+e.name:e.name,u(n,function(t,n){n!=="name"&&n!=="folder"&&(e[n]=t)}),t()}})}var e=window.sequencer,t=window.console,n,r,i,s,o,u,a=0,f;f=function(e){this.id="IC"+a++ +(new Date).getTime(),this.className="InstrumentConfig";var t=this;u(e,function(e,n){t[n]=e})},e.addInstrument=function(n,r,i){var s=o(n),u,a,l,p;if(s!=="object")return e.debug>=2&&t.warn("can't add an Instrument with this data",n),!1;if(n.json){a=n.json,l=n.name,p=n.folder;if(o(a)==="string")try{a=JSON.parse(a)}catch(d){return e.debug>=2&&t.warn("can't add an Instrument with this data",n),!1}if(a.mapping===undefined)return e.debug>=2&&t.warn("can't add an Instrument with this data",n),!1;n={mapping:a.mapping,name:l===undefined?a.name:l,folder:p===undefined?a.folder:p}}u=new f(n),e.addTask({type:"load instrument config",method:h,params:u},function(){c(u),r&&r(u)},i),e.startTaskQueue()},e.protectedScope.addInitMethod(function(){n=e.protectedScope.ajax,i=e.protectedScope.findItem,r=e.protectedScope.parseUrl,s=e.protectedScope.storeItem,o=e.protectedScope.typeString,u=e.protectedScope.objectForEach})}(),function(){"use strict";var e=window.sequencer,t=window.console,n=window.requestAnimationFrame,r,i="newEvents newNotes newParts changedEvents changedNotes changedParts removedEvents removedNotes removedParts".split(" "),s=.1,o=10,u=4,a=32,f="chromatic",l=2,c=Math.floor,h=Math.ceil,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k;r=function(e,t){this.song=e,this.song.keyEditor=this,this.playhead=v(this.song,"barsbeats ticks millis","keyeditor"),this.numBars=e.bars,this.newNumBars=this.numBars,this.eventListeners={},this.interrupt=!1,this.iteratorFactory=p(this.song,this),this.verticalLine=this.iteratorFactory.createVerticalLineIterator(this),this.horizontalLine=this.iteratorFactory.createHorizontalLineIterator(this),this.eventIterator=this.iteratorFactory.createEventIterator(this),this.noteIterator=this.iteratorFactory.createNoteIterator(this),this.partIterator=this.iteratorFactory.createPartIterator(this),this.exactFitVertical=t.exactFitVertical||!1,this.exactFitHorizontal=t.exactFitHorizontal||!1,this.activeEvents=[],this.activeNotes=[],this.activeParts=[],this.newEvents=[],this.newNotes=[],this.newParts=[],this.changedEvents=[],this.changedNotes=[],this.changedParts=[],this.removedEvents=[],this.removedNotes=[],this.removedParts=[],this.recordedNotesObj={},this.recordedEventsObj={},this.snapshot={activeEvents:this.activeEvents,activeNotes:this.activeNotes,activeParts:this.activeParts,newEvents:this.newEvents,newNotes:this.newNotes,newParts:this.newParts,changedEvents:this.changedEvents,changedNotes:this.changedNotes,changedParts:this.changedParts,removedEvents:this.removedEvents,removedNotes:this.removedNotes,removedParts:this.removedParts},t.paginate?(this.paginate=!0,this.pageNo=0,this.barsPerPage=t.barsPerPage,this.pageWidth=t.pageWidth,this.pageHeight=t.pageHeight,this.width=this.pageWidth,this.lowestNote=t.lowestNote||e.lowestNote,this.highestNote=t.highestNote||e.highestNote,this.pitchRange=this.highestNote-this.lowestNote,this.exactFitVertical?(this.pitchHeight=this.height/this.pitchRange,this.height=this.pageHeight):(this.pitchHeight=t.pitchHeight||o,this.height=this.pitchHeight*this.pitchRange),x(this,0),T(this)):(this.setStartPosition(t.startPosition||1),this.setEndPosition(t.endPosition||e.bars+1),this.numTicks=this.endTicks-this.startTicks,t.width?(this.width=t.width,this.tickWidth=this.width/this.numTicks):t.tickWidth?(this.tickWidth=t.tickWidth,this.width=this.numTicks*this.tickWidth,this.exactFitHorizontal=!1):t.barsPerPage&&t.viewportWidth?(this.barsPerPage=t.barsPerPage,this.viewportWidth=t.viewportWidth,this.tickWidth=this.viewportWidth/(this.startPosition.ticksPerBar*this.barsPerPage),this.width=this.numTicks*this.tickWidth,this.scrollX=0,this.scrollPosition=0,this.viewportTicks=this.viewportWidth/this.tickWidth,this.maxScrollPosition=Math.ceil(this.width/this.viewportWidth),this.scrollLimit=this.viewportWidth/this.tickWidth,N(this),this.exactFitHorizontal=!1):t.viewportWidth?(this.viewportWidth=this.width=t.viewportWidth,this.tickWidth=this.viewportWidth/this.numTicks,this.exactFitHorizontal=!0):(this.tickWidth=s,this.width=this.numTicks*this.tickWidth,this.exactFitHorizontal=!1),this.lowestNote=t.lowestNote||e.lowestNote,this.highestNote=t.highestNote||e.highestNote,this.pitchRange=t.pitchRange||this.highestNote-this.lowestNote+1,t.height?(this.height=t.height,this.pitchHeight=this.height/this.pitchRange):t.pitchHeight?(this.pitchHeight=t.pitchHeight,this.height=this.pitchRange*this.pitchHeight,this.exactFitVertical=!1):t.viewportHeight?(this.viewportHeight=this.height=t.viewportHeight,this.pitchHeight=this.viewportHeight/this.pitchRange,this.exactFitVertical=!0):(this.pitchHeight=o,this.height=this.pitchRange*this.pitchHeight,this.exactFitVertical=!1)),this.scrollX=0,this.scrollY=0,this.currentPage=1,this.numPages=h(this.width/this.viewportWidth),this.snapValueX=t.snapX||a,this.snapValueY=t.snapY||f,this.setSnapX(this.snapValueX),this.setSnapY(this.snapValueY)},r.prototype.setBarsPerPage=function(e){this.interrupt=!0;var t=w(this.scrollX/(this.viewportWidth/this.barsPerPage));this.barsPerPage=e,this.tickWidth=this.viewportWidth/(this.startPosition.ticksPerBar*this.barsPerPage),this.viewportTicks=this.viewportWidth/this.tickWidth,this.width=this.numTicks*this.tickWidth,this.verticalLine.reset(),this.horizontalLine.reset(),this.eventIterator.reset(),this.partIterator.reset(),this.scrollLimit=this.viewportWidth/this.tickWidth,this.maxScrollPosition=Math.ceil(this.width/this.viewportWidth),this.snapWidth=this.tickWidth*this.snapTicks,this.numPages=h(this.numBars/this.barsPerPage),this.currentPage=c(this.song.ticks/(this.barsPerPage*this.song.ticksPerBar))+1,C(this,"scale",{}),this.song.playing?this.scrollPosition=c(this.song.ticks/this.viewportTicks):(this.scrollPosition=this.viewportWidth/this.barsPerPage*t/this.viewportWidth,C(this,"scroll",{x:this.scrollPosition*this.viewportWidth})),this.interrupt=!1},r.prototype.setViewport=function(e,t){var n=!1;this.barsPerPage&&e!==this.viewportWidth?(this.viewportWidth=e,this.tickWidth=this.viewportWidth/(this.startPosition.ticksPerBar*this.barsPerPage),this.viewportTicks=this.viewportWidth/this.tickWidth,this.width=this.numTicks*this.tickWidth,n=!0):this.exactFitHorizontal===!0&&e!==this.width&&(this.viewportWidth=this.width=e,this.tickWidth=this.width/this.numTicks,n=!0),this.exactFitVertical===!0&&t!==this.height&&(this.viewportHeight=this.height=t,this.pitchHeight=this.height/this.pitchRange,n=!0),n&&(this.verticalLine.reset(),this.horizontalLine.reset(),this.eventIterator.reset(),this.noteIterator.reset(),this.partIterator.reset(),C(this,"draw",{}))},r.prototype.updateSong=function(e){this.iteratorFactory.updateSong();var t,n=0,r,s,o,u;for(n=i.length-1;n>=0;n--){t=i[n];switch(t){case"newNotes":case"changedNotes":o=e[t];for(r=o.length-1;r>=0;r--)u=o[r],u.bbox=this.getNoteRect(u);break;case"newParts":case"changedParts":o=e[t];for(r=o.length-1;r>=0;r--)u=o[r],u.bbox=this.getPartRect(u)}}this.newNumBars=e.numBars,this.newEvents=this.newEvents.concat(e.newEvents),this.changedEvents=this.changedEvents.concat(e.changedEvents),this.removedEvents=this.removedEvents.concat(e.removedEvents),this.removedEventsObj=b(this.removedEvents,"id"),this.newNotes=this.newNotes.concat(e.newNotes),this.changedNotes=this.changedNotes.concat(e.changedNotes),this.removedNotes=this.removedNotes.concat(e.removedNotes),this.removedNotesObj=b(this.removedNotes,"id"),this.newParts=this.newParts.concat(e.newParts),this.changedParts=this.changedParts.concat(e.changedParts),this.removedParts=this.removedParts.concat(e.removedParts),this.removedPartsObj=b(this.removedParts,"id")},r.prototype.setStartPosition=function(e){g(e)!=="array"&&(e=["barsandbeats",e,1,1,0]),this.startPosition=d(this.song,e),this.startTicks=this.startPosition.ticks,this.startMillis=this.startPosition.millis},r.prototype.setEndPosition=function(e){g(e)!=="array"&&(e=["barsandbeats",e,1,1,0]),this.endPosition=d(this.song,e),this.endTicks=this.endPosition.ticks,this.endMillis=this.endPosition.millis},r.prototype.addEventListener=function(e,t){var n=e.split(" "),r,i=this,s;n.forEach(function(e){r=i.eventListeners[e],r===undefined&&(i.eventListeners[e]=[],r=i.eventListeners[e]),s=e+"-"+r.length,r.push(t)})},r.prototype.nextPage=function(){x(this,this.startBar+this.barsPerPage),C(this,"pagechange",{pageNo:this.pageNo,lastPage:this.lastPage})},r.prototype.prevPage=function(){x(this,this.startBar-this.barsPerPage),C(this,"pagechange",{pageNo:this.pageNo,lastPage:this.lastPage})},r.prototype.gotoPage=function(e){t.warn("ooops, not implemented yet!");return},r.prototype.scroll=function(e){var t,n=w(this.scrollX/(this.viewportWidth/this.barsPerPage));this.scrollPosition=this.viewportWidth/this.barsPerPage*n/this.viewportWidth;switch(e){case">":this.scrollPosition+=1,this.scrollPosition=this.scrollPosition>this.maxScrollPosition?this.maxScrollPosition:this.scrollPosition;break;case">>":this.scrollPosition=this.maxScrollPosition;break;case"<":this.scrollPosition-=1,this.scrollPosition=this.scrollPosition<0?0:this.scrollPosition;break;case"<<":this.scrollPosition=0;break;default:if(isNaN(e))return;this.scrollPosition=parseInt(e)}t=this.scrollPosition*this.viewportWidth,this.scrollLimit=(t+this.viewportWidth)/this.tickWidth,this.currentPage=h(t/this.viewportWidth)+1,this.currentPage===0?this.currentPage=1:this.currentPage>this.maxScrollPosition&&(this.currentPage=this.maxScrollPosition),C(this,"scroll",{x:t})},r.prototype.updateScroll=function(e,t){this.scrollX=e,this.scrollY=t,this.scrollLimit=(e+this.viewportWidth)/this.tickWidth},r.prototype.getEventRect=function(e){var t=this.ticksToX(e.ticks-this.startTicks),n=this.pitchToY(e.number),r=l*this.tickWidth,i=this.pitchHeight;return{x:t,y:n,width:r,height:i,top:n,left:t,bottom:n+i,right:t+r}},r.prototype.getNoteRect=function(e){var t=this.ticksToX(e.ticks-this.startTicks),n=this.pitchToY(e.number),r=e.durationTicks*this.tickWidth,i=this.pitchHeight,s,o,u;e.endless&&(r=(this.song.ticks-e.noteOn.ticks)*this.tickWidth);if(this.paginate){s=e.ticks,o=e.noteOff.ticks;if(!(s<this.startTicks))return!1;u=this.startTicks-s,s=s+u-this.startTicks,t=s*this.tickWidth,o=o>this.endTicks?this.endTicks:o,r=(o-this.startTicks)*this.tickWidth}return{x:t,y:n,width:r,height:i,top:n,left:t,bottom:n+i,right:t+r}},r.prototype.getPartRect=function(e){var t=e.getStats("noteNumber all"),n={top:this.pitchToY(t.max),bottom:this.pitchToY(t.min)+this.pitchHeight,left:this.ticksToX(e.start.ticks-this.startTicks,!0),right:this.ticksToX(e.end.ticks-this.startTicks,!0)};return n.x=n.left,n.y=n.top,n.width=n.right-n.left,n.height=n.bottom-n.top,e.bbox=n,e.stats=t,n},r.prototype.getBBox=function(e){var n,r;if(g(e)==="string")switch(e.substring(0,1)){case"E":n="event";if(event.type!==144||event.endEvent===undefined){t.error("argument not supported, please check documentation");return}r=this.song.findEvent("id = "+e);break;case"P":n="part",r=this.song.getPart(e);break;case"T":n="track";break;default:t.error("argument not supported, please check documentation");return}else switch(e.className){case"AudioEvent":n="audio";break;case"MidiEvent":n="event";break;case"Part":n="part";break;case"Track":n="track";break;default:t.error("argument not supported, please check documentation");return}if(r===undefined){t.error(e,"could not be found");return}switch(n){case"event":return this.getNoteRect(r);case"part":return this.getPartRect(r)}},r.prototype.startMoveNote=function(e,t,n){e.className!=="MidiEvent"&&(e=e.note),this.selectedNote=e,this.selectedNote.moved=0,this.selectedNote.transposed=0,this.startMoveX=t,this.startMoveY=n,this.startMoveTicks=this.xToTicks(t,!0),this.startMovePitch=this.yToPitch(n).number},r.prototype.stopMoveNote=function(){this.selectedNote=undefined},r.prototype.moveNote=function(e,t){if(this.selectedNote===undefined)return;var n=this.yToPitch(t).number,r=this.xToTicks(e),i=n-this.startMovePitch,s=r-this.startMoveTicks,o=[],u,a=this.selectedNote.part,f=this;this.selectedNote.transposed!==i&&(a.transposeNote(this.selectedNote,i-this.selectedNote.transposed),this.selectedNote.transposed=i),this.selectedNote.moved!==s&&(this.selectedNote.part.moveNote(this.selectedNote,s-this.selectedNote.moved),this.selectedNote.moved=s),this.song.update(!1,!0,!0)},r.prototype.startMovePart=function(e,t,n){e.className!=="Part"&&(e=e.part),this.selectedPart=e,this.selectedPart.moved=0,this.selectedPart.transposed=0,this.startMoveX=t,this.startMoveY=n,this.startMoveTicks=this.xToTicks(t,!0),this.startMovePitch=this.yToPitch(n).number},r.prototype.stopMovePart=function(){this.selectedPart=undefined},r.prototype.movePart=function(e,t){if(this.selectedPart===undefined)return;var n=this.yToPitch(t).number,r=this.xToTicks(e),i=n-this.startMovePitch,s=r-this.startMoveTicks,o=[],u,a=this,f=!1;this.selectedPart.transposed!==i&&(this.selectedPart.track.transposePart(this.selectedPart,i-this.selectedPart.transposed),this.selectedPart.transposed=i,f=!0),this.selectedPart.moved!==s&&(this.selectedPart.track.movePart(this.selectedPart,s-this.selectedPart.moved),this.selectedPart.moved=s,f=!0),f===!0&&this.song.update(!1,!0,!0)},r.prototype.getTicksAt=r.prototype.xToTicks=function(e,t){var n=(e+this.scrollX)/this.width*this.numTicks;return t!==!1&&(n=c(n/this.snapTicks)*this.snapTicks),n},r.prototype.getPitchAt=r.prototype.yToPitch=function(e){var t=this.highestNote-c((e+this.scrollY)/this.height*this.pitchRange);return t=S(t),t},r.prototype.getXAt=r.prototype.ticksToX=function(e,t){var n=(e-this.startTicks)*this.tickWidth;return t!==!1&&(n=c(n/this.snapWidth)*this.snapWidth),n},r.prototype.getYAt=r.prototype.pitchToY=function(e){var t=this.height-(e-this.lowestNote+1)*this.pitchHeight;return t},r.prototype.getPositionAt=function(e){var t=this.getTicksAt(e);return this.playhead.set("ticks",t,!1),this.playhead.get()},r.prototype.getPlayheadX=function(e){var t=this.song.ticks/this.song.durationTicks*this.width;return t=e===!0?t-this.scrollX:t,t},r.prototype.setPlayheadToX=function(e){var t=this.xToTicks(e,!1);this.song.setPlayhead("ticks",t)},r.prototype.getPlayheadPosition=function(e){var t=this.song.millis/this.song.durationMillis*this.width;return t=e===!0?t-this.scrollX:t,t},r.prototype.setPlayheadPosition=function(e,t){var n;switch(e){case"x":n=this.xToTicks(t,!1);break;case"ticks":n=t;break;case"millis":n=this.playhead.set("millis",t).ticks;break;case"barsbeats":case"barsandbeats":n=d(this.song,["barsbeats",t]).ticks}this.song.setPlayhead("ticks",n)},r.prototype.getEventAt=function(e,t){var n=this.getSongPosition(e),r=this.getPitchAt(t)},r.prototype.getEventsInRect=function(e,t,n,r){var i=this.getSongPosition(e),s=this.getSongPosition(e+n),o=this.getPitchAt(t+r),u=this.getPitchAt(t)},r.prototype.getNoteAt=function(e,t){var n=this.getSongPosition(e),r=this.getPitchAt(t)},r.prototype.getNotesInRect=function(e,t,n,r){var i=this.getSongPosition(e),s=this.getSongPosition(e+n),o=this.getPitchAt(t+r),u=this.getPitchAt(t)},r.prototype.snap=function(e,t){return{x:this.snapX(e),y:this.snapY(t)}},r.prototype.snapX=function(e){return c((e+this.scrollX)/this.snapWidth)*this.snapWidth},r.prototype.snapY=function(e){return c((e+this.scrollY)/this.snapHeight)*this.snapHeight},r.prototype.setSnapX=function(e){if(e===undefined)return;isNaN(e)&&e.indexOf("ticks")!==-1?(e=e.replace(/ticks/,""),isNaN(e)&&(e=this.song.ppq/4),this.snapTicks=parseInt(e)):(isNaN(e)&&(e=16),e=parseInt(e),this.snapTicks=4/e*this.song.ppq),this.snapValueX=e,this.snapWidth=this.tickWidth*this.snapTicks},r.prototype.setSnapY=function(e){if(e===undefined)return;this.snapValueY=e,this.snapHeight=this.pitchHeight},r.prototype.removeNote=function(e){e.part.removeEvents(e.noteOn,e.noteOff),this.song.update()},r.prototype.removePart=function(e){e.track.removePart(e),this.song.update()},r.prototype.prepareForRecording=function(){this.recordedEventsObj={},this.recordedNotesObj={}},r.prototype.getSnapshot=function(){var e,n,r,i,s,o=[],u=[],a=[],f=[].concat(this.activeEvents),l=[].concat(this.activeNotes),p=[].concat(this.activeParts),v=[],m=[],g=[],y,b,w,E,S,x,T,N,C,k;this.activeEvents=[],this.activeNotes=[],this.activeParts=[],this.activeStateChangedEvents=[],this.activeStateChangedNotes=[],this.activeStateChangedParts=[],this.newNumBars!==this.numBars&&(C=this.numBars,k=this.song.lastBar+1,this.endPosition=d(this.song,["barsbeats",k,1,1,0,!0]),this.verticalLine.reset(d(this.song,["barsbeats",C,1,1,0,!0]),this.endPosition),this.numBars=this.song.bars,this.endTicks=this.endPosition.ticks,this.numTicks=this.song.durationTicks,this.width=this.numTicks*this.tickWidth,this.maxScrollPosition=Math.ceil(this.width/this.viewportWidth),this.numPages=h(this.numBars/this.barsPerPage)),e=this.song.activeEvents;for(S in e)e.hasOwnProperty(S)&&(T=e[S],this.activeEvents.push(T),T.active!==!0&&(T.active=!0,this.activeStateChangedEvents.push(T)));n=this.song.activeNotes;for(S in n)n.hasOwnProperty(S)&&(T=n[S],this.activeNotes.push(T),T.active!==!0&&(T.active=!0,this.activeStateChangedNotes.push(T)));r=this.song.activeParts;for(S in r)r.hasOwnProperty(S)&&(T=r[S],this.activeParts.push(T),T.active!==!0&&(T.active=!0,this.activeStateChangedParts.push(T)));s=this.song.recordedEvents,N=s.length;for(S=0;S<N;S++)T=s[S],this.recordedEventsObj[T.id]===undefined&&(T.bbox=this.getEventRect(T),v.push(T),this.recordedEventsObj[T.id]=T);i=this.song.recordedNotes,N=i.length;for(S=0;S<N;S++)T=i[S],this.recordedNotesObj[T.id]===undefined?(this.recordedNotesObj[T.id]=T,T.bbox=this.getNoteRect(T),m.push(T)):T.endless===!0?(T.bbox=this.getNoteRect(T),g.push(T)):T.endless===!1&&(T.bbox=this.getNoteRect(T),g.push(T),T.endless=undefined);for(S=f.length-1;S>=0;S--){T=f[S];if(T===undefined){t.warn("event is undefined");continue}e[T.id]===undefined&&(o.push(T),T.active!==!1&&(T.active=!1,this.activeStateChangedEvents.push(T)))}for(S=l.length-1;S>=0;S--){T=l[S];if(T===undefined){t.warn("note is undefined");continue}n[T.id]===undefined&&(u.push(T),T.active!==!1&&(T.active=!1,this.activeStateChangedNotes.push(T)))}for(S=p.length-1;S>=0;S--){T=p[S];if(T===undefined){t.warn("part is undefined");continue}r[T.id]===undefined&&(a.push(T),T.active!==!1&&(T.active=!1,this.activeStateChangedParts.push(T)))}this.song.playing&&(this.currentPage=c(this.song.ticks/(this.barsPerPage*this.song.ticksPerBar))+1),y={events:{active:this.activeEvents,inActive:this.nonActiveEvents,recorded:v,"new":this.newEvents,changed:this.changedEvents,removed:this.removedEvents,stateChanged:this.activeStateChangedEvents},notes:{active:this.activeNotes,inActive:u,recorded:m,recording:g,"new":this.newNotes,changed:this.changedNotes,removed:this.removedNotes,stateChanged:this.activeStateChangedNotes},parts:{active:this.activeParts,inActive:a,"new":this.newParts,changed:this.changedParts,removed:this.removedParts,stateChanged:this.activeStateChangedParts},hasNewBars:C!==k,newWidth:this.width,pageNo:this.currentPage,lastPage:this.numPages},this.newEvents=[],this.changedEvents=[],this.removedEvents=[],this.newNotes=[],this.changedNotes=[],this.removedNotes=[],this.newParts=[],this.changedParts=[],this.removedParts=[],T=this.song.parts,w=!1;for(S=T.length-1;S>=0;S--)E=T[S],E.events.length===0&&(E.track.removePart(E),w=!0);return w&&this.song.update(),y},x=function(e,n){e.numTicks=0,e.startBar=n>0?n:0,e.startBar=e.startBar>e.numBars-e.barsPerPage?e.numBars-e.barsPerPage:e.startBar,e.endBar=n+e.barsPerPage,e.endBar=e.endBar>e.numBars?e.numBars:e.endBar,e.endBar=e.endBar<e.barsPerPage?e.barsPerPage:e.endBar,t.log(n,e.startBar,e.endBar,e.numBars,e.numBars-e.barsPerPage);var r;for(r=e.startBar;r<e.endBar;r++)e.numTicks+=e.bars[r].ticksPerBar;e.tickWidth=e.pageWidth/e.numTicks,e.startPosition=e.bars[e.startBar],e.endPosition=e.bars[e.endBar],e.startTicks=e.startPosition.ticks,e.endTicks=e.endPosition.ticks,e.verticalLine.reset(),e.horizontalLine.reset(),e.eventIterator.reset()},T=function(e){e.song.playing()&&e.song.ticks>=e.endTicks&&e.nextPage(),n(function(){T(e)})},N=function(e){if(e.song.playing&&e.interrupt===!1)if(e.song.ticks>=e.scrollLimit)C(e,"scroll",{x:e.scrollX+e.viewportWidth}),e.scrollLimit+=e.viewportWidth/e.tickWidth;else{var t=c(e.song.ticks/e.viewportTicks)*e.viewportTicks*e.tickWidth;e.scrollX!==t&&C(e,"scroll",{x:t})}n(function(){N(e)})},C=function(e,t,n){e.eventListeners[t].forEach(function(e){e(n)})},k=function(e){var t=e.selectedPart,n=e.selectedNote;t!==undefined?(t.track.removePart(t),this.song.update()):n!==undefined&&(n.part.removeNote(n),this.song.update())},e.createKeyEditor=function(e,t){return new r(e,t)},e.protectedScope.addInitMethod(function(){d=e.protectedScope.getPosition,v=e.protectedScope.createPlayhead,S=e.createNote,E=e.debug,c=e.protectedScope.floor,w=e.protectedScope.round,g=e.protectedScope.typeString,y=e.protectedScope.objectToArray,b=e.protectedScope.arrayToObject,m=e.protectedScope.getScaffoldingBars,p=e.protectedScope.createKeyEditorIteratorFactory})}(),function(){"use strict";function s(e,t){this.song=e,this.editor=t,this.updateSong(),this.position=r(this.song,"all","iterators")}var e=window.sequencer,t=.042,n=.02,r,i;s.prototype.updateSong=function(){this.events=this.song.events,this.numEvents=this.events.length,this.notes=this.song.notes,this.numNotes=this.notes.length,this.parts=this.song.parts,this.numParts=this.parts.length},s.prototype.createVerticalLineIterator=function(){var e="bar beat sixteenth",r,i={},s,o,u,a,f,l,c,h,p,d,v,m,g=this.editor,y=this.position,b,w,E,S,x,T;return x=function(){b=y.update("ticks",a),i.bar=b.ticksPerBar,i.beat=b.ticksPerBeat,i.sixteenth=b.ticksPerSixteenth,p=b.nominator,d=b.numSixteenth},w=function(e){e&&(u=e,s<n?u="bar":s<t&&(u="beat"));switch(u){case"sixteenth":r="sixteenth",h++,h>d&&(r="beat",h=1,c++,c>p&&(r="bar",c=1,l++));break;case"beat":r="beat",h=1,c++,c>p&&(r="bar",c=1,l++);break;case"bar":r="bar",h=1,c=1,l++}return a+=i[u],x(),a>f?!1:{x:a*s-o,bar:l,beat:c,sixteenth:h,type:r,position:b}},E=function(e){var r=f-a,o=!1;e&&(u=e,s<n?u="bar":s<t&&(u="beat"));switch(u){case"bar":o=r>=i[u];break;case"beat":o=r>=i[u];break;case"sixteenth":o=r>=i[u]}return o},S=function(e,r){v=e||g.startPosition,m=r||g.endPosition,a=v.ticks,l=v.bar,c=v.beat,h=v.sixteenth,f=m.ticks,s=g.tickWidth,o=0,y.set("ticks",a),s<n?u="bar":s<t&&(u="beat"),x()},T=function(e){u=e,s<n?u="bar":s<t&&(u="beat")},{next:w,reset:S,hasNext:E,setType:T}},s.prototype.createHorizontalLineIterator=function(){var e,t,n,r,s={},o=this.editor,u,a,f;return u=function(n){return s={note:i(t),y:e*r},t--,e++,s},a=function(t){var r=!1;switch(t){case"chromatic":r=e<n}return r},f=function(){e=0,t=o.highestNote,n=o.pitchRange,r=o.pitchHeight},{next:u,reset:f,hasNext:a}},s.prototype.createEventIterator=function(){var t,n,r,i,s,o=this.editor,u=this.position,a=this.events,f=this.numEvents,l="",c,h,p,d;return h=function(e){return l=e||l,r=!0,i++,i===f?!1:(s=a[i],l===""?s.ticks<=n:!1)},c=function(e){return l=e||l,r||h(l),r=!1,s},p=function(){var s;t=o.startTicks,n=o.endTicks,r=!1;if(o.paginate===!0&&e.isPlaying()===!0)return;i=u.get().eventIndex-2},d=function(){var e=Array.prototype.slice.call(arguments);e.forEach(function(e){l+=e+" "})},{next:c,reset:p,hasNext:h,setTypes:d}},s.prototype.createNoteIterator=function(){var t,n,r,i,s,o,u=this.editor,a=this.notes,f=this.numNotes,l="",c,h,p,d;return h=function(e){l=e||l,r=!0,i++;if(i===this.numNotes)return!1;s=!1;for(;i<f;i++){o=a[i];if(o.ticks>=n)break;if(u.paginate){o.ticks<t&&o.noteOff.ticks>t?s=!0:o.ticks<n&&(s=!0);if(s)break}else{s=o.ticks<=n;if(s)break}}return s},c=function(e){return l=e||l,r||h(l),r=!1,o.bbox=u.getNoteRect(o),o},p=function(){var s;t=u.startTicks,n=u.endTicks,r=!1;if(u.paginate===!0&&e.isPlaying()===!0)return;for(i=0;i<this.numNotes;i++){s=this.notes[i];if(s.ticks>=t)break}i--},{next:c,reset:p,hasNext:h}},s.prototype.createPartIterator=function(){var e,t,n,r={},i,s,o;return i=function(t){return n=this.parts[e++],n.bbox=this.editor.getPartRect(n),n},s=function(n){return e<t},o=function(){e=0,t=this.numParts},{next:i,reset:o,hasNext:s}},e.protectedScope.createKeyEditorIteratorFactory=function(e,t){return new s(e,t)},e.protectedScope.addInitMethod(function(){i=e.createNote,r=e.protectedScope.createPlayhead})}(),function(){"use strict";function l(n){return isNaN(n)?(e.debug&&t.log("please provide a number"),!1):n<0||n>127?(e.debug&&t.log("please provide a number between 0 and 127"),!1):n}function c(t,n,r,s){var u,a,f,l,c,h,p,d,v=0,m=[],g=t.song,y,b,w;for(u=n;u<=r;u++){f=i(g,["barsbeats",u]),p=f.nominator,d=f.ticksPerBeat;for(a=0;a<p;a++)h=a===0?t.noteNumberAccented:t.noteNumberNonAccented,c=a===0?t.noteLengthAccented:t.noteLengthNonAccented,l=a===0?t.velocityAccented:t.velocityNonAccented,y=e.createMidiEvent(v,144,h,l),b=e.createMidiEvent(v+c,128,h,0),s==="precount"&&(y.part={id:"precount"},y.track=t.track,b.part={id:"precount"},b.track=t.track),w=o(y,b),m.push(y,b),v+=d}return m}var e=window.sequencer,t=window.console,n,r,i,s,o,u,a={volume:"setVolume",instrument:"setInstrument",noteNumberAccentedTick:"setNoteNumberAccentedTick",noteNumberNonAccentedTick:"setNoteNumberNonAccentedTick",velocityAccentedTick:"setVelocityAccentedTick",velocityNonAccentedTick:"setVelocityNonAccentedTick",noteLengthAccentedTick:"setNoteLengthAccentedTick",noteLengthNonAccentedTick:"setNoteLengthNonAccentedTick"},f;f=function(t){this.song=t,this.track=e.createTrack(this.song.id+"_metronome","metronome"),this.part=e.createPart(),this.track.addPart(this.part),this.track.connect(this.song.gainNode),this.events=[],this.precountEvents=[],this.noteNumberAccented=61,this.noteNumberNonAccented=60,this.volume=1,this.velocityNonAccented=100,this.velocityAccented=100,this.noteLengthNonAccented=t.ppq/4,this.noteLengthAccented=t.ppq/4,this.track.setInstrument("heartbeat/metronome"),this.precountDurationInMillis=0,this.bars=0},f.prototype.init=function(e,t,n){e=e===undefined?"init":e,this.part.numEvents>0&&this.part.removeEvents(this.part.events),this.events=c(this,t,n,e),this.part.addEvents(this.events),this.bars=this.song.bars,u(this.song,this.events)},f.prototype.update=function(e,t){e===0&&(e=1),e!==undefined&&t!==undefined?this.init("update",e,t):this.init("update",1,this.song.bars)},f.prototype.updateConfig=function(){this.init("configure",1,this.bars),this.allNotesOff(),this.song.scheduler.updateSong()},f.prototype.configure=function(e){var t=this;s(e,function(e,n){t[a[n]](e)}),this.updateConfig()},f.prototype.setInstrument=function(t){t.className!=="Instrument"&&(t=e.createInstrument(t)),t!==!1?this.track.setInstrument(t):this.track.setInstrument("heartbeat/metronome"),this.updateConfig()},f.prototype.setNoteLengthAccentedTick=function(n){isNaN(n)&&e.debug>=2&&t.warn("please provide a number"),this.noteLengthAccented=n,this.updateConfig()},f.prototype.setNoteLengthNonAccentedTick=function(n){isNaN(n)&&e.debug>=2&&t.warn("please provide a number"),this.noteLengthNonAccented=n,this.updateConfig()},f.prototype.setVelocityAccentedTick=function(n){n=l(n),n!==!1?this.velocityAccented=n:e.debug>=2&&t.warn("please provide a number"),this.updateConfig()},f.prototype.setVelocityNonAccentedTick=function(n){n=l(n),n!==!1?this.velocityNonAccented=n:e.debug>=2&&t.warn("please provide a number"),this.updateConfig()},f.prototype.setNoteNumberAccentedTick=function(n){n=l(n),n!==!1?this.noteNumberAccented=n:e.debug>=2&&t.warn("please provide a number"),this.updateConfig()},f.prototype.setNoteNumberNonAccentedTick=function(n){n=l(n),n!==!1?this.noteNumberNonAccented=n:e.debug>=2&&t.warn("please provide a number"),this.updateConfig()},f.prototype.reset=function(){this.volume=1,this.track.setInstrument("heartbeat/metronome"),this.noteNumberAccented=61,this.noteNumberNonAccented=60,this.velocityAccented=100,this.velocityNonAccented=100,this.noteLengthAccented=this.song.ppq/4,this.noteLengthNonAccented=this.song.ppq/4},f.prototype.allNotesOff=function(){this.track.instrument&&this.track.instrument.allNotesOff()},f.prototype.createPrecountEvents=function(e){if(e<=0)return;var t=this.song.getPosition("barsbeats",this.song.bar+e);this.index=0,this.millis=0,this.startMillis=this.song.millis,this.precountDurationInMillis=t.millis-this.startMillis,this.precountEvents=c(this,this.song.bar,t.bar,"precount")},f.prototype.getPrecountEvents=function(e){var t=this.precountEvents,n=t.length,r,i,s=[];for(r=this.index;r<n;r++){i=t[r];if(!(i.millis<e))break;s.push(i),this.index++}return s},f.prototype.setVolume=function(e){this.track.setVolume(e)},e.protectedScope.createMetronome=function(e){return new f(e)},e.protectedScope.addInitMethod(function(){n=e.protectedScope.context,r=e.protectedScope.findItem,i=e.protectedScope.getPosition,o=e.createMidiNote,s=e.util.objectForEach,u=e.protectedScope.parseMetronomeEvents})}(),function(){"use strict";var e=window.sequencer,t=window.console,n,r,i,s,o=0;s=function(e){var i,s;this.className="MidiEvent",this.id="M"+o+(new Date).getTime(),this.eventNumber=o,this.channel="any",this.isDirty=!0,this.muted=!1,o++;if(!e)return;if(r(e[0])==="midimessageevent"){t.log("midimessageevent");return}if(r(e[0])==="array")i=e[0];else{if(r(e[0])!=="number"||r(e[1])!=="number")return t.log("wrong number of arguments, please consult documentation"),!1;i=[e[0],e[1]],e.length>=3&&r(e[2])==="number"&&i.push(e[2]),e.length===4&&r(e[3])==="number"&&i.push(e[3]),e.length===5&&r(e[4])==="number"&&i.push(e[4])}this.ticks=i[0],this.status=i[1],this.type=(this.status>>4)*16,this.type>=128?(this.command=this.type,this.channel=(this.status&15)+1):(this.type=this.status,this.channel=i[4]||"any");switch(this.type){case 0:break;case 128:this.data1=i[2],s=n(this.data1),this.note=s,this.noteName=s.fullName,this.noteNumber=s.number,this.octave=s.octave,this.frequency=s.frequency,this.data2=0,this.velocity=this.data2;break;case 144:this.data1=i[2],this.data2=i[3],this.data2===0&&(this.type=128),s=n(this.data1),this.note=s,this.noteName=s.fullName,this.noteNumber=s.number,this.octave=s.octave,this.frequency=s.frequency,this.velocity=this.data2;break;case 81:this.bpm=i[2];break;case 88:this.nominator=i[2],this.denominator=i[3];break;case 176:this.data1=i[2],this.data2=i[3],this.controllerType=i[2],this.controllerValue=i[3];break;case 192:this.data1=i[2],this.programNumber=i[2];break;case 208:this.data1=i[2],this.data2=i[3];break;case 224:this.data1=i[2],this.data2=i[3];break;case 47:break;default:t.warn("not a recognized type of midi event!")}},s.prototype.clone=function(){var e=new s,t;for(t in this)this.hasOwnProperty(t)&&(t!=="clone"&&t!=="id"&&t!=="eventNumber"&&t!=="midiNote"&&(e[t]=this[t]),e.part=undefined,e.track=undefined);return e},s.prototype.transpose=function(e){if(this.type!==128&&this.type!==144){t.error("you can only transpose note on and note off events");return}r(e)==="array"&&(e=parseInt(e[1],10));var i=this.data1+e;i<0?i=0:i>127&&(i=127),this.data1=i;var s=n(this.data1);this.note=s,this.noteName=s.fullName,this.noteNumber=s.number,this.octave=s.octave,this.frequency=s.frequency},s.prototype.setPitch=function(e){if(this.type!==128&&this.type!==144){t.error("you can only set the pitch of note on and note off events");return}r(e)==="array"&&(e=parseInt(e[1],10)),this.data1=e;var i=n(this.data1);this.note=i,this.noteName=i.fullName,this.noteNumber=i.number,this.octave=i.octave,this.frequency=i.frequency,this.endEvent&&this.endEvent.setPitch(e)},s.prototype.setPosition=function(e){this.bpm=this.bpm||e.bpm||-1,this.ticks=this.ticks||e.ticks||this.ticks,this.millis=e.millis||-1,this.seconds=e.seconds||-1,this.hour=e.hour||-1,this.minute=e.minute||-1,this.second=e.second||-1,this.millisecond=e.millisecond||-1,this.timeAsString=e.timeAsString||-1,this.timeAsArray=e.timeAsArray||-1,this.bar=e.bar||-1,this.beat=e.beat||-1,this.sixteenth=e.sixteenth||-1,this.tick=e.tick||-1,this.barsAsString=e.barsAsString||"N/A",this.barsAsArray=e.barsAsArray||"N/A"},s.prototype.reset=function(e,t,n){e=e===undefined?!0:!1,t=t===undefined?!0:!1,n=n===undefined?!0:!1,e&&(this.part=undefined,this.partId=undefined),t&&(this.track=undefined,this.trackId=undefined,this.channel=0),n&&(this.song=undefined)},e.createMidiEvent=function(){var e=Array.prototype.slice.call(arguments),t=e[0].className;return t==="MidiEvent"?e[0].clone():new s(e)},e.protectedScope.addInitMethod(function(){n=e.createNote,r=e.protectedScope.typeString,i=e.protectedScope.copyName})}(),function(){"use strict";function i(n){var r=!1;return n=n.replace(/_/g," "),r=e[n]||!1,r!==!1?r:(n=n.replace(/\s/g,"_"),r=t[n]||!1,r===!1&&sequencer.debug===!0&&console.warn(n,"is not a valid (or supported) midi event name, please consult documentation"),r)}function s(e,t){var i=!1;return t=t||"upper",t==="lower"?(i=n[e]||!1,i===!1&&sequencer.debug===!0&&console.warn(e,"is not a valid (or supported) midi event number, please consult documentation"),i):(i=r[e]||!1,i===!1&&sequencer.debug===!0&&console.warn(e,"is not a valid (or supported) midi event number, please consult documentation"),i)}function o(e){return isNaN(e)?i(e):s(e)}var e={"note off":128,"note on":144,"poly pressure":160,"control change":176,"program change":192,"channel pressure":208,"pitch bend":224,tempo:81,"time signature":88,"end of track":47},t={NOTE_OFF:128,NOTE_ON:144,POLY_PRESSURE:160,CONTROL_CHANGE:176,PROGRAM_CHANGE:192,CHANNEL_PRESSURE:208,PITCH_BEND:224,TEMPO:81,TIME_SIGNATURE:88,END_OF_TRACK:47},n={128:"note off",144:"note on",160:"poly pressure",176:"control change",192:"program change",208:"channel pressure",224:"pitch bend",81:"tempo",88:"time signature",47:"end of track"},r={128:"NOTE_OFF",144:"NOTE_ON",160:"POLY_PRESSURE",176:"CONTROL_CHANGE",192:"PROGRAM_CHANGE",208:"CHANNEL_PRESSURE",224:"PITCH_BEND",81:"TEMPO",88:"TIME_SIGNATURE",47:"END_OF_TRACK"};Object.defineProperty(sequencer,"DUMMY_EVENT",{value:0}),Object.defineProperty(sequencer,"MIDI_NOTE",{value:112}),Object.defineProperty(sequencer,"NOTE_OFF",{value:128}),Object.defineProperty(sequencer,"NOTE_ON",{value:144}),Object.defineProperty(sequencer,"POLY_PRESSURE",{value:160}),Object.defineProperty(sequencer,"CONTROL_CHANGE",{value:176}),Object.defineProperty(sequencer,"PROGRAM_CHANGE",{value:192}),Object.defineProperty(sequencer,"CHANNEL_PRESSURE",{value:208}),Object.defineProperty(sequencer,"PITCH_BEND",{value:224}),Object.defineProperty(sequencer,"SYSTEM_EXCLUSIVE",{value:240}),Object.defineProperty(sequencer,"MIDI_TIMECODE",{value:241}),Object.defineProperty(sequencer,"SONG_POSITION",{value:242}),Object.defineProperty(sequencer,"SONG_SELECT",{value:243}),Object.defineProperty(sequencer,"TUNE_REQUEST",{value:246}),Object.defineProperty(sequencer,"EOX",{value:247}),Object.defineProperty(sequencer,"TIMING_CLOCK",{value:248}),Object.defineProperty(sequencer,"START",{value:250}),Object.defineProperty(sequencer,"CONTINUE",{value:251}),Object.defineProperty(sequencer,"STOP",{value:252}),Object.defineProperty(sequencer,"ACTIVE_SENSING",{value:254}),Object.defineProperty(sequencer,"SYSTEM_RESET",{value:255}),Object.defineProperty(sequencer,"TEMPO",{value:81}),Object.defineProperty(sequencer,"TIME_SIGNATURE",{value:88}),Object.defineProperty(sequencer,"END_OF_TRACK",{value:47}),sequencer.checkEventType=o,sequencer.midiEventNameByNumber=s,sequencer.midiEventNumberByName=i}(),function(){"use strict";function v(e,t){e=undefined,t&&t(!1)}function m(n,r,i){var s,o,u,a,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M;r=new Uint8Array(r),s=f(r),n.base64="",n.numTracks=0,o=0,v=s.tracks.length,e.overrulePPQ===!0&&isNaN(e.defaultPPQ)===!1&&e.defaultPPQ>0?(k=e.defaultPPQ/s.header.ticksPerBeat,n.ppq=e.defaultPPQ):(k=1,n.ppq=s.header.ticksPerBeat),S=[],n.tracks=[];while(o<v){m=s.tracks[o],a=m.length,y=0,b=0,w=-1,p=c(),d=l(),E=[],u=0;for(u=0;u<a;u++){g=m[u],b+=g.deltaTime*k,w===-1&&g.channel!==undefined&&(w=g.channel,d.channel=w),L=g.subtype;switch(g.subtype){case"trackName":d.name=g.text;break;case"instrumentName":g.text&&(d.instrumentName=g.text);break;case"noteOn":x=g.noteNumber,b===y&&A===L&&x===N&&(e.debug>=3&&t.info("note on events on the same tick",u,b,N),E.pop()),N=x,E.push(h(b,144,x,g.velocity));break;case"noteOff":x=g.noteNumber,b===y&&A===L&&x===C&&(e.debug>=3&&t.info("note off events on the same tick",u,b,C),E.pop()),C=x,E.push(h(b,128,x,g.velocity));break;case"endOfTrack":break;case"setTempo":T=6e7/g.microsecondsPerBeat,b===y&&A===L&&(e.debug>=3&&t.info("tempo events on the same tick",u,b,T),S.pop()),n.bpm===undefined&&(n.bpm=T),S.push(h(b,81,T));break;case"timeSignature":b===y&&A===L&&(e.debug>=3&&t.info("time signature events on the same tick",u,b,g.numerator,g.denominator),S.pop()),n.nominator===undefined&&(n.nominator=g.numerator,n.denominator=g.denominator),S.push(h(b,88,g.numerator,g.denominator));break;case"controller":E.push(h(b,176,g.controllerType,g.value));break;case"programChange":E.push(h(b,192,g.programNumber));break;case"channelAftertouch":E.push(h(b,208,g.amount));break;case"pitchBend":E.push(h(b,224,g.value));break;default:}A=L,y=b}E.length>0&&(d.addPart(p),p.addEvents(E),n.tracks.push(d),n.numTracks++),o++}n.timeEvents=S,n.loaded=!0,i()}function g(i,o){if(i.base64!==undefined){m(i,r(i.base64),o);return}if(i.arraybuffer!==undefined){m(i,i.arraybuffer,o);return}s({url:i.url,responseType:i.responseType,onError:function(){v(i,o)},onSuccess:function(s){if(i.responseType==="json"){if(s===null){o(!1);return}if(s.base64===undefined){v(i,o),e.debug&&t.warn("no base64 data");return}s.name!==undefined&&i.name===undefined&&(i.name=s.name),s.folder!==undefined&&i.folder===undefined&&(i.folder=s.folder),i.name===undefined&&(i.name=n(i.url).name),i.localPath=i.folder!==undefined?i.folder+"/"+i.name:i.name,m(i,r(s.base64),o)}else i.name===undefined&&(i.name=n(i.url).name),i.localPath=i.folder!==undefined?i.folder+"/"+i.name:i.name,m(i,s,o)}})}function y(n){var r=o(n.localPath,e.storage.midi,!0),i=n.action;r&&r.className==="MidiFile"&&i!=="overwrite"?e.debug>=2&&(t.warn("there is already a midifile at",n.localPath),v(n)):u(n,n.localPath,e.storage.midi)}var e=window.sequencer,t=window.console,n,r,i,s,o,u,a,f,l,c,h,p=0,d;d=function(e){this.id="MF"+p++ +(new Date).getTime(),this.className="MidiFile",this.url=e.url,this.json=e.json,this.base64=e.base64,this.arraybuffer=e.arraybuffer,this.name=e.name,this.folder=e.folder,this.url!==undefined?this.responseType=this.url.indexOf(".json")===this.url.lastIndexOf(".")?"json":"arraybuffer":this.name===undefined&&this.folder===undefined?(this.name=this.id,this.localPath=this.id):this.localPath=this.folder!==undefined?this.folder+"/"+this.name:this.name},e.addMidiFile=function(n,r){var s=i(n),o,u,a,f;if(s!=="object")return e.debug>=2&&t.warn("can't create a MidiFile with this data",n),!1;if(n.json){u=n.json,a=n.name,f=n.folder;if(i(u)==="string")try{u=JSON.parse(u)}catch(l){return e.debug>=2&&t.warn("can't create a MidiFile with this data",n),!1}if(u.base64===undefined)return e.debug>=2&&t.warn("can't create a MidiFile with this data",n),!1;n={base64:u.base64,name:a===undefined?u.name:a,folder:f===undefined?u.folder:f}}o=new d(n),e.addTask({type:"load midifile",method:g,params:o},function(){y(o),r&&r(o)}),e.startTaskQueue()},e.protectedScope.addInitMethod(function(){s=e.protectedScope.ajax,o=e.protectedScope.findItem,u=e.protectedScope.storeItem,a=e.protectedScope.deleteItem,n=e.protectedScope.parseUrl,i=e.protectedScope.typeString,f=e.protectedScope.parseMidiFile,r=e.protectedScope.base64ToBinary,c=e.createPart,l=e.createTrack,h=e.createMidiEvent})}(),function(){"use strict";var e,t=window.sequencer,n=window.console,r,i,s=0;e=function(e){var i=e.length,o,u,a,f,l,c;if(i===1){o=e[0];if(o===undefined){n.error("please provide at least a note on event");return}this.noteOn=o}else if(i===2){o=e[0],u=e[1];if(o===undefined){n.error("please provide at least a note on event");return}if(o.className==="MidiEvent"&&u&u.className==="MidiEvent"){if(o.ticks>=u.ticks){n.error("MidiNote has wrong duration");return}this.noteOn=o,this.noteOff=u}}else{if(i!==4){n.error("wrong number of arguments, please consult documentation");return}a=e[0],f=e[1],l=e[2],c=e[3];if(a&&f&&a>=f){n.error("MidiNote has wrong duration");return}if(l<0||l>127){n.error("MidiNote has wrong note number");return}if(c<0||c>127){n.error("MidiNote has wrong velocity");return}o=r(a,t.NOTE_ON,l,c),u&&(u=r(f,t.NOTE_OFF,l,0))}o.midiNote=this,this.noteOn=o,u===undefined?this.endless=!0:(u.midiNote=this,this.endless=!1,this.noteOff=u,this.durationTicks=u.ticks-o.ticks,this.durationMillis=u.millis-o.millis),this.note=o.note,this.number=o.noteNumber,this.ticks=o.ticks,this.velocity=o.velocity,this.id="N"+s+(new Date).getTime(),this.name=o.noteName,this.className="MidiNote",this.type=t.MIDI_NOTE,s++},e.prototype.addNoteOff=function(e){var t=this.noteOn;e.midiNote=this,this.endless=!1,this.noteOff=e,this.durationTicks=e.ticks-t.ticks,this.durationMillis=e.millis-t.millis,this.endless=!1},e.prototype.setDuration=function(e){if(e<=0){n.error("duration of a MidiNote has to be greater then 0");return}this.noteOff.ticks=this.noteOn.ticks+e,this.durationTicks=this.noteOff.ticks-this.noteOn.ticks,this.part&&(this.part.needsUpdate=!0)},e.prototype.setEnd=function(e){this.noteOff.ticks=e,this.part&&(this.part.needsUpdate=!0)},e.prototype.setStart=function(e){this.noteOn.ticks=e,this.part&&(this.part.needsUpdate=!0)},e.prototype.setVelocity=function(e){if(e<0||e>127)return;this.velocity=this.noteOn.data1=this.noteOn.velocity=e},e.prototype.setPitch=function(e){if(e<0||e>127)return;this.noteOn.setPitch(e),this.endless===!1&&this.noteOff.setPitch(e),this.name=this.noteOn.noteName},t.protectedScope.addInitMethod(function(){r=t.createMidiEvent,i=t.protectedScope.typeString}),t.createMidiNote=function(){return new e(Array.prototype.slice.call(arguments))}}(),function(){"use strict";function i(e){var t=e.read(4,!0),n=e.readInt32();return{id:t,length:n,data:e.read(n,!1)}}function o(r){var i={};i.deltaTime=r.readVarInt();var o=r.readInt8(),u;if((o&240)==240){if(o==255){i.type="meta";var a=r.readInt8();u=r.readVarInt();switch(a){case 0:i.subtype="sequenceNumber";if(u!==2)throw"Expected length for sequenceNumber event is 2, got "+u;return i.number=r.readInt16(),i;case 1:return i.subtype="text",i.text=r.read(u),i;case 2:return i.subtype="copyrightNotice",i.text=r.read(u),i;case 3:return i.subtype="trackName",i.text=r.read(u),s=i.text,i;case 4:return i.subtype="instrumentName",i.text=r.read(u),i;case 5:return i.subtype="lyrics",i.text=r.read(u),i;case 6:return i.subtype="marker",i.text=r.read(u),i;case 7:return i.subtype="cuePoint",i.text=r.read(u),i;case 32:i.subtype="midiChannelPrefix";if(u!==1)throw"Expected length for midiChannelPrefix event is 1, got "+u;return i.channel=r.readInt8(),i;case 47:i.subtype="endOfTrack";if(u!==0)throw"Expected length for endOfTrack event is 0, got "+u;return i;case 81:i.subtype="setTempo";if(u!==3)throw"Expected length for setTempo event is 3, got "+u;return i.microsecondsPerBeat=(r.readInt8()<<16)+(r.readInt8()<<8)+r.readInt8(),i;case 84:i.subtype="smpteOffset";if(u!==5)throw"Expected length for smpteOffset event is 5, got "+u;var f=r.readInt8();return i.frameRate={0:24,32:25,64:29,96:30}[f&96],i.hour=f&31,i.min=r.readInt8(),i.sec=r.readInt8(),i.frame=r.readInt8(),i.subframe=r.readInt8(),i;case 88:i.subtype="timeSignature";if(u!==4)throw"Expected length for timeSignature event is 4, got "+u;return i.numerator=r.readInt8(),i.denominator=Math.pow(2,r.readInt8()),i.metronome=r.readInt8(),i.thirtyseconds=r.readInt8(),i;case 89:i.subtype="keySignature";if(u!==2)throw"Expected length for keySignature event is 2, got "+u;return i.key=r.readInt8(!0),i.scale=r.readInt8(),i;case 127:return i.subtype="sequencerSpecific",i.data=r.read(u),i;default:return e.debug>=2&&t.warn("Unrecognised meta event subtype: "+a),i.subtype="unknown",i.data=r.read(u),i}return i.data=r.read(u),i}if(o==240)return i.type="sysEx",u=r.readVarInt(),i.data=r.read(u),i;if(o==247)return i.type="dividedSysEx",u=r.readVarInt(),i.data=r.read(u),i;throw"Unrecognised MIDI event type byte: "+o}var l;(o&128)===0?(l=o,o=n):(l=r.readInt8(),n=o);var c=o>>4;i.channel=o&15,i.type="channel";switch(c){case 8:return i.subtype="noteOff",i.noteNumber=l,i.velocity=r.readInt8(),i;case 9:return i.noteNumber=l,i.velocity=r.readInt8(),i.velocity===0?i.subtype="noteOff":i.subtype="noteOn",i;case 10:return i.subtype="noteAftertouch",i.noteNumber=l,i.amount=r.readInt8(),i;case 11:return i.subtype="controller",i.controllerType=l,i.value=r.readInt8(),i;case 12:return i.subtype="programChange",i.programNumber=l,i;case 13:return i.subtype="channelAftertouch",i.amount=l,i;case 14:return i.subtype="pitchBend",i.value=l+(r.readInt8()<<7),i;default:return i.value=r.readInt8(),i.subtype="unknown",i}}function u(e){var t,n,s,u,a=[],f,l,c,h,p;h=i(e);if(h.id!=="MThd"||h.length!==6)throw"Bad .mid file - header not found";p=r(h.data),t=p.readInt16(),n=p.readInt16(),s=p.readInt16();if(s&32768)throw"Expressing time division in SMTPE frames is not supported yet";u=s;var d={formatType:t,trackCount:n,ticksPerBeat:u};for(f=0;f<n;f++){a[f]=[],l=i(e);if(l.id!=="MTrk")throw"Unexpected chunk - expected MTrk, got "+l.id;c=r(l.data);while(!c.eof()){var v=o(c);a[f].push(v)}}return{header:d,tracks:a}}var e=window.sequencer,t=window.console,n,r,s;e.protectedScope.parseMidiFile=function(e){return u(r(e))},e.protectedScope.addInitMethod(function(){r=e.protectedScope.createStream})}(),function(){"use strict";function r(e){function r(r,i){var s,o;i=i===undefined?!0:i;if(i){s="";for(o=0;o<r;o++,t++)s+=n(e[t]);return s}s=[];for(o=0;o<r;o++,t++)s.push(e[t]);return s}function i(){var n=(e[t]<<24)+(e[t+1]<<16)+(e[t+2]<<8)+e[t+3];return t+=4,n}function s(){var n=(e[t]<<8)+e[t+1];return t+=2,n}function o(n){var r=e[t];return n&&r>127&&(r-=256),t+=1,r}function u(){return t>=e.length}function a(){var e=0;for(;;){var t=o();if(!(t&128))return e+t;e+=t&127,e<<=7}}var t=0;return{eof:u,read:r,readInt32:i,readInt16:s,readInt8:o,readVarInt:a}}var e=window.sequencer,t=window.console,n=String.fromCharCode;e.protectedScope.createStream=r}(),function(){"use strict";function p(n){var r,s,o,u,a,h;if(c===!0){n();return}c=!0,navigator.requestMIDIAccess!==undefined?navigator.requestMIDIAccess().then(function(p){r=p.inputs(),h={};for(u=0,o=r.length;u<o;u++)s=r[u],a=s.name,h[a]===undefined&&(h[a]=[]),h[a].push(s);i(h,function(t,n){var r,i,s=t.length;if(s===1)i=t[0],i.label=n,f.push({label:i.label,id:i.id}),e.midiInputs[i.id]=i;else for(r=0;r<s;r++)i=t[r],i.label=n+" "+(r+1),f.push({label:i.label,id:i.id}),e.midiInputs[i.id]=i}),f.sort(function(e,t){var n=e.label.toLowerCase(),r=t.label.toLowerCase();return n<r?-1:n>r?1:0}),e.numMidiInputs=f.length,r=p.outputs(),h={};for(u=0,o=r.length;u<o;u++)s=r[u],a=s.name,h[a]===undefined&&(h[a]=[]),h[a].push(s);i(h,function(t,n){var r,i,s=t.length;if(s===1)i=t[0],i.label=n,l.push({label:i.label,id:i.id}),e.midiOutputs[i.id]=i;else for(r=0;r<s;r++)i=t[r],i.label=n+" "+(r+1),l.push({label:i.label,id:i.id}),e.midiOutputs[i.id]=i}),l.sort(function(e,t){var n=e.label.toLowerCase(),r=t.label.toLowerCase();return n<r?-1:n>r?1:0}),e.numMidiOutputs=l.length,p.addEventListener("onconnect",function(e){t.log("device connected",e)},!1),p.addEventListener("ondisconnect",function(e){t.log("device disconnected",e)},!1),e.webmidi=!0,n()},function(r){t.log("MIDI could not be initialized:",r),n()}):(e.browser==="chrome"?t.log("Web MIDI API not enabled"):t.log("Web MIDI API not supported"),n())}function d(t){a=function(e){g(e,t,this)},i(e.midiInputs,function(e){e.addEventListener("midimessage",a),t.midiInputs[e.id]=e}),i(e.midiOutputs,function(e){t.midiOutputs[e.id]=e}),t.numMidiInputs=e.numMidiInputs,t.numMidiOutputs=e.numMidiOutputs}function v(n,r,i){var s=e.midiInputs[n],o=i.tracks,u=i.numTracks-1,f,l;r=r===undefined?!0:r;if(s===undefined){e.debug===!0&&t.log("no midi input with id",n,"found");return}r===!1?(delete i.midiInputs[n],s.removeEventListener("midimessage",a),i.numMidiInputs--):s!==undefined&&(i.midiInputs[n]=s,s.addEventListener("midimessage",a),i.numMidiInputs++);for(f=u;f>=0;f--)l=o[f],l.setMidiInput(n,r)}function m(n,r,i){var s=e.midiOutputs[n],o=i.tracks,u=i.numTracks-1,a,f,l;r=r===undefined?!0:r;if(s===undefined){e.debug===!0&&t.log("no midi output with id",n,"found");return}r===!1?(delete i.midiOutputs[n],i.numMidiOutputs--,l=i.scheduler.lastEventTime+100,s.send([176,123,0],l),s.send([176,121,0],l)):s!==undefined&&(i.midiOutputs[n]=s,i.numMidiOutputs++);for(a=u;a>=0;a--)f=o[a],f.setMidiOutput(n,r)}function g(e,t,n){var r=e.data,s,u,a=t.tracks,f=t.numTracks,l,c;l=o(t.ticks,r[0],r[1],r[2]);for(s=0;s<f;s++)u=a[s],u.monitor===!0&&u.midiInputs[n.id]!==undefined&&y(l,u,n);c=t.midiEventListeners[l.type];if(c===undefined)return;i(c,function(e){e(l,n)})}function y(e,t,r){var o=t.song,u,a,f;e.recordMillis=n.currentTime*1e3,e.state="recorded";if(e.type===144)u=s(e),t.recordingNotes[e.data1]=u;else if(e.type===128){u=t.recordingNotes[e.data1];if(u===undefined)return;u.addNoteOff(e),delete t.recordingNotes[e.data1]}(o.prerolling||o.recording)&&t.recordEnabled?(e.type===144&&t.song.recordedNotes.push(u),t.recordPart.addEvent(e),t.song.recordedEvents.push(e)):t.enableRetrospectiveRecording&&t.retrospectiveRecording.push(e),a=t.midiEventListeners[e.type],a!==undefined&&i(a,function(t){t(e,r)}),f=t.channel;if(f==="any"||f===undefined||isNaN(f)===!0)f=0;i(t.midiOutputs,function(t){(e.type===128||e.type===144||e.type===176)&&t.send([e.type,e.data1,e.data2])}),t.routeToMidiOut===!1&&(e.track=t,t.instrument.processEvent(e))}function b(t,n){t=u.call(t);var s=h++,o={},a=[],f,l;return l=function(t,n,i){for(n=0;n<i;n++){var s=t[n],u=r(s);u==="array"?l(s,0,s.length):u==="function"?f=s:isNaN(s)===!1?(s=parseInt(s,10),e.checkEventType(s)!==!1&&(o[s]=s)):u==="string"&&e.checkEventType(s)!==!1&&(s=e.midiEventNumberByName(s),o[s]=s)}},l(t,0,t.length),i(o,function(e){n.midiEventListeners[e]===undefined&&(n.midiEventListeners[e]={}),n.midiEventListeners[e][s]=f,a.push(e+"_"+s)}),a.length===1?a[0]:a}function w(e,t){var n;e=e.split("_"),n=e[0],e=e[1],delete t.midiEventListeners[n][e]}function E(){}function S(e,n){var r=document.createElement("select"),s,o,u=e.type,a=e.id||u,f=e.div,l=e.firstOption;if(u!=="input"&&u!=="output"){t.log('please set type to "input" or "output"');return}return l===undefined&&(l=u==="input"?"choose MIDI in":"choose MIDI out"),r.id=a,o=u==="input"?n.midiInputs:n.midiOutputs,l!==!1&&(s=document.createElement("option"),s.value=-1,s.innerHTML=l,r.appendChild(s)),i(o,function(e){s=document.createElement("option"),s.value=e.id,s.innerHTML=e.label,r.appendChild(s)}),f&&f.appendChild(r),r}function x(t,n){var r,s;if(n===e)for(r=0,s=f.length;r<s;r++)t(n.midiInputs[f[r].id],r);else i(n.midiInputs,function(e){t(e,r)})}function T(t,n){var r,s;if(n===e)for(r=0,s=l.length;r<s;r++)t(n.midiOutputs[l[r].id],r);else i(n.midiOutputs,function(e,n){t(e,n)})}var e=window.sequencer,t=window.console,n,r,i,s,o,u=Array.prototype.slice,a,f=[],l=[],c=!1,h=0;e.getMidiPortsAsDropdown=function(){S(e)},e.getMidiInputsAsDropdown=function(t){return t=t||{type:"input"},S(t,e)},e.getMidiOutputsAsDropdown=function(t){return t=t||{type:"output"},S(t,e)},e.getMidiInputs=function(t){x(t,e)},e.getMidiOutputs=function(t){T(t,e)},e.protectedScope.addInitMethod(function(){n=e.protectedScope.context,s=e.createMidiNote,o=e.createMidiEvent,r=e.protectedScope.typeString,i=e.protectedScope.objectForEach}),e.protectedScope.initMidi=p,e.protectedScope.initMidiSong=d,e.protectedScope.getMidiInputs=x,e.protectedScope.getMidiOutputs=T,e.protectedScope.setMidiInputSong=v,e.protectedScope.setMidiOutputSong=m,e.protectedScope.addMidiEventListener=b,e.protectedScope.getMidiPortsAsDropdown=S,e.protectedScope.removeMidiEventListener=w,e.protectedScope.removeMidiEventListeners=E}(),function(){"use strict";function N(e){var t=[].concat(i,s,u),n=e.tracks,r=e.tracks.length+1,o,f,l,c,h,p,d,v,m;t=t.concat(L(r.toString(16),2),a),t=t.concat(C(e.timeEvents,e.durationTicks,"tempo"));for(o=0,f=n.length;o<f;o++)l=n[o],t=t.concat(C(l.events,e.durationTicks,l.name,l.instrumentId));f=t.length,d=new ArrayBuffer(f),m=new Uint8Array(d);for(o=0;o<f;o++)m[o]=t[o];c=new Blob([m],{type:"application/x-midi",endings:"transparent"}),saveAs(c,e.name)}function C(e,t,n,i){var s,o,u,a,l,c,h=0,p=0,d=[];n&&(d.push(0),d.push(255),d.push(3),d=d.concat(A(n.length)),d=d.concat(O(n))),i&&(d.push(0),d.push(255),d.push(4),d=d.concat(A(i.length)),d=d.concat(O(i)));for(o=0,u=e.length;o<u;o++){a=e[o],p=a.ticks-h,p=A(p),d=d.concat(p);if(a.type===128||a.type===144)l=a.type+a.channel,d.push(l),d.push(a.noteNumber),d.push(a.velocity);else if(a.type===81){d.push(255),d.push(81),d.push(3);var v=Math.round(6e7/a.bpm);d=d.concat(L(v.toString(16),3))}else if(a.type===88){var m=a.denominator;m===2?m=1:m===4?m=2:m===8?m=3:m===16?m=4:m===32&&(m=5),d.push(255),d.push(88),d.push(4),d.push(a.nominator),d.push(m),d.push(r/a.nominator),d.push(8)}h=a.ticks}return p=t-h,p=A(p),d=d.concat(p),d.push(255),d.push(47),d.push(0),c=d.length,s=L(c.toString(16),4),[].concat(f,s,d)}function k(e){return String.fromCharCode.apply(null,e)}function L(e,t){if(t)while(e.length/2<t)e="0"+e;var n=[];for(var r=e.length-1;r>=0;r-=2){var i=r===0?e[r]:e[r-1]+e[r];n.unshift(parseInt(i,16))}return n}function A(e){var t=e&127;while(e>>=7)t<<=8,t|=e&127|128;var n=[];for(;;){n.push(t&255);if(!(t&128))break;t>>=8}return n}function O(e){return n.map.call(e,function(e){return e.charCodeAt(0)})}var e=window.sequencer,t=window.console,n=Array.prototype,r=e.defaultPPQ,i=["M".charCodeAt(0),"T".charCodeAt(0),"h".charCodeAt(0),"d".charCodeAt(0)],s=[0,0,0,6],o=[0,0],u=[0,1],a=L(r.toString(16),2),f=["M".charCodeAt(0),"T".charCodeAt(0),"r".charCodeAt(0),"k".charCodeAt(0)],l=0,c=1,h=2,p=3,d=4,v=5,m=6,g=7,y=32,b=47,w=81,E=84,S=88,x=89,T=127;e.protectedScope.saveToMidiFile=N,e.saveSongAsMidiFile=N}(),function(){"use strict";var e,t,n,r,i,s,o,u,a,f=Math.pow;t={sharp:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],flat:["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],"enharmonic-sharp":["B#","C#","C##","D#","D##","E#","F#","F##","G#","G##","A#","A##"],"enharmonic-flat":["Dbb","Db","Ebb","Eb","Fb","Gbb","Gb","Abb","Ab","Bbb","Bb","Cb"]},o=function(){var t=Array.prototype.slice.call(arguments),o=t.length,f,l=!1,c=!1,h,p,d,v,m,g=t[0],y=t[1],b=t[2];if(o===1&&!isNaN(g))g<0||g>127?(c="please provide a note number >= 0 and <= 127",g):(d=g,f=r(d),p=f[0],h=f[1]);else if(o===1&&e(g)==="string"){f=i(g);if(!f)c=g+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave";else{p=f[0],h=f[1],d=n(p,h);if(!d)c=g+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave";else if(d<0||d>127)c="please provide a note between C0 and G10"}}else if(o===2&&e(g)==="string"&&!isNaN(y)){f=i(g,y);if(!f)c=g+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb";else{p=f[0],h=f[1],d=n(p,h);if(!d)c=p+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb";else if(d<0||d>127)c="please provide a note between C0 and G10"}}else if(o===2&&e(g)==="string"&&e(y)==="string"){f=i(g);if(!f)c=g+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave";else{v=u(y),v||(v=sequencer.noteNameMode,l=y+" is not a valid note name mode, using "+v),p=f[0],h=f[1],d=n(p,h);if(!d)c=p+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave";else if(d<0||d>127)c="please provide a note between C0 and G10";p=r(d,v)[0]}}else if(o===2&&e(g)==="number"&&e(y)==="string")g<0||g>127?(c="please provide a note number >= 0 and <= 127",g):(v=u(y),v||(v=sequencer.noteNameMode,l=y+" is not a valid note name mode, using "+v),d=g,f=r(d,v),p=f[0],h=f[1],p=r(d,v)[0]);else if(o===3&&e(g)==="string"&&!isNaN(y)&&e(b)==="string"){f=i(g,y);if(!f)c=g+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave";else{v=u(b),v||(v=sequencer.noteNameMode,l=b+" is not a valid note name mode, using "+v),p=f[0],h=f[1],d=n(p,h);if(!d)c=p+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave";else if(d<0||d>127)c="please provide a note between C0 and G10";p=r(d,v)[0]}}else c="wrong arguments, please consult documentation";return c?(console.error(c),!1):(l&&console.warn(l),m=s(d),{name:p,octave:h,fullName:p+h,number:d,frequency:m,blackKey:a(d)})},r=function(e,n){n=n||sequencer.noteNameMode;var r=Math.floor(e/12-1),i=t[n][e%12];return[i,r]},n=function(e,n,r){var i,s,o,u,a;for(i in t)if(t.hasOwnProperty(i)){r=t[i];for(o=0,u=r.length;o<u;o+=1)if(r[o]===e){s=o;break}}return s===-1?!1:(a=s+12+n*12,a)},s=function(e){return sequencer.pitch*f(2,(e-69)/12)},i=function(){var t=Array.prototype.slice.call(arguments),n=t.length,r=t[0],i=t[1],s,o,u,a,f;if(n===1&&e(r)==="string"){s=r.length,a="",f="";for(o=0;o<s;o++)u=r[o],isNaN(u)&&u!=="-"?a+=u:f+=u;f===""&&(f=0)}else{if(n!==2||e(r)!=="string"||!!isNaN(i))return!1;a=r,f=i}return f=parseInt(f,10),a=a.substring(0,1).toUpperCase()+a.substring(1),[a,f]},u=function(e){var t=!1;switch(e){case"sharp":case"flat":case"enharmonic-sharp":case"enharmonic-flat":t=e}return t},a=function(e){var t;switch(!0){case e%12===1:case e%12===3:case e%12===6:case e%12===8:case e%12===10:t=!0;break;default:t=!1}return t},sequencer.getNoteNumber=function(){var e=o.apply(this,arguments);return e?e.number:!1},sequencer.getNoteName=function(){var e=o.apply(this,arguments);return e?e.name:!1},sequencer.getNoteNameFromNoteNumber=function(e,t){return r(e,t)},sequencer.getNoteOctave=function(){var e=o.apply(this,arguments);return e?e.octave:!1},sequencer.getFullNoteName=function(){var e=o.apply(this,arguments);return e?e.fullName:!1},sequencer.getFrequency=function(){var e=o.apply(this,arguments);return e?e.frequency:!1},sequencer.isBlackKey=function(){var e=o.apply(this,arguments);return e?e.blackKey:!1},Object.defineProperty(sequencer,"SHARP",{value:"sharp"}),Object.defineProperty(sequencer,"FLAT",{value:"flat"}),Object.defineProperty(sequencer,"ENHARMONIC_SHARP",{value:"enharmonic-sharp"}),Object.defineProperty(sequencer,"ENHARMONIC_FLAT",{value:"enharmonic-flat"}),sequencer.createNote=o,sequencer.protectedScope.addInitMethod(function(){e=sequencer.protectedScope.typeString})}(),function(){"use strict";function b(e,t){var n,r,b=0,S=0,x,T;r=t.length,t.sort(function(e,t){return e.ticks-t.ticks}),w(e.timeEvents[0]);for(T=b;T<r;T++){n=t[T],x=n.ticks-S,l+=x;while(l>=p){f++,l-=p;while(f>d){f-=d,a++;while(a>s)a-=s,u++}}switch(n.type){case 81:y=n.bpm,g=n.millis,v=n.millisPerTick,m=n.secondsPerTick;break;case 88:i=n.factor,s=n.nominator,o=n.denominator,d=n.numSixteenth,c=n.ticksPerBar,h=n.ticksPerBeat,p=n.ticksPerSixteenth,g=n.millis;break;default:g+=x*v,E(n)}S=n.ticks}e.lastEventTmp=n}function w(e){y=e.bpm,i=e.factor,s=e.nominator,o=e.denominator,c=e.ticksPerBar,h=e.ticksPerBeat,p=e.ticksPerSixteenth,d=e.numSixteenth,v=e.millisPerTick,m=e.secondsPerTick,g=e.millis,u=e.bar,a=e.beat,f=e.sixteenth,l=e.tick}function E(t){var b,w;b=e.getNiceTime(g),t.bpm=y,t.factor=i,t.nominator=s,t.denominator=o,t.ticksPerBar=c,t.ticksPerBeat=h,t.ticksPerSixteenth=p,t.numSixteenth=d,t.millisPerTick=v,t.secondsPerTick=m,t.millis=n(g*r)/r,t.hour=b.hour,t.minute=b.minute,t.second=b.second,t.millisecond=b.millisecond,t.timeAsString=b.timeAsString,t.timeAsArray=b.timeAsArray,t.bar=u,t.beat=a,t.sixteenth=f,t.tick=l,w=l===0?"000":l<10?"00"+l:l<100?"0"+l:l,t.barsAsString=u+":"+a+":"+f+":"+w,t.barsAsArray=[u,a,f,l],t.state="clean"}var e=window.sequencer,t=window.console,n=Math.round,r=Math.pow(10,e.precision),i,s,o,u,a,f,l,c,h,p,d,v,m,g,y;e.protectedScope.parseMidiEvents=b,e.protectedScope.addInitMethod(function(){})}(),function(){"use strict";function T(){m=1/a*60/i/r,v=m*1e3}function N(){s=4/u,w=s*4,g=r*s,y=g*o,b=r/4}function C(e){var t,n,r,s=0;k(e),T(),N(),E.sort(function(e,t){return e.ticks-t.ticks});for(s=0;s<S;s++){n=E[s],n.song=e,t=n.ticks-p,h+=t,p=n.ticks,r=n.type,d+=t*v;while(h>=b){c++,h-=b;while(c>w){c-=w,l++;while(l>o)l-=o,f++}}switch(r){case 81:i=n.bpm,T();break;case 88:o=n.nominator,u=n.denominator,N();break;default:continue}L(n)}e.lastEventTmp=n}function k(e){a=e.playbackSpeed,E=e.timeEvents,S=E.length,r=e.ppq,i=e.bpm,o=e.nominator,u=e.denominator,x=0,f=1,l=1,c=1,h=0,p=0,d=0}function L(t){t.bpm=i,t.nominator=o,t.denominator=u,t.ticksPerBar=y,t.ticksPerBeat=g,t.ticksPerSixteenth=b,t.factor=s,t.numSixteenth=w,t.secondsPerTick=m,t.millisPerTick=v,t.ticks=p,t.millis=d,t.seconds=d/1e3,t.bar=f,t.beat=l,t.sixteenth=c,t.tick=h,t.barsAsString=f+":"+l+":"+c+":"+h,t.barsAsArray=[f,l,c,h];var n=e.getNiceTime(d);t.hour=n.hour,t.minute=n.minute,t.second=n.second,t.millisecond=n.millisecond,t.timeAsString=n.timeAsString,t.timeAsArray=n.timeAsArray,t.isDirty=!1}var e=window.sequencer,t=window.console,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x;e.protectedScope.parseTimeEvents=C,e.protectedScope.addInitMethod(function(){n=e.createMidiEvent})}(),function(){"use strict";var e=window.sequencer,t=window.console,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g=0,y;y=function(e){this.className="Part",this.id="P"+g++ +""+(new Date).getTime(),this.partIndex=g,this.name=e||this.id,this.events=[],this.eventsById={},this.numEvents=0,this.notes=[],this.notesById={},this.numNotes=0,this.dirtyEvents={},this.dirtyNotes={},this.transposed=0,this.moved=0,this.song=undefined,this.autoSize="right",this.ticks=0,this.millis=0,this.start={ticks:this.ticks,millis:this.millis},this.end={ticks:0,millis:0},this.duration={ticks:0,millis:0},this.startPosition=undefined,this.endPosition=undefined,this.needsUpdate=!1,this.state="clean",this.mute=!1,this.solo=!1},d=function(n,r){n=Array.prototype.slice.call(n);var i=0,o=0,u,a,l,c=n[0],h=[],p=[];if(s(c)==="array"){for(o=c.length-1;o>=0;o--)l=c[o],a=f(l,r),a&&h.push(a);i=h.length===0?0:1}u=n.length;for(o=i;o<u;o++)l=n[o],a=f(l,r),a?h.push(a):p.push(l);return h.length===0?(e.debug&&t.warn("no events added",r.name),!1):(p.length===1&&s(p[0])==="array"&&(p=p[0]),{events:h,config:p})},f=function(e,t){var n=!1;return e?e.className==="MidiEvent"||e.className==="AudioEvent"?n=e:s(e)==="array"&&e.length===4?n=r(e):s(e)==="string"?n=t.eventsById[e]:isNaN(e)===!1&&(n=t.events[e]):n=!1,n},l=function(t,n,r){if(t===!1)return;var i,s,o=t.events,u=n.ticks,a=o.length,f=n.track,l=n.eventsById;for(i=0;i<a;i++){s=o[i];if(s.type===e.END_OF_TRACK||s.className!=="MidiEvent"&&s.className!=="AudioEvent")continue;s.part!==undefined&&(s=s.clone()),s.part=n,s.partId=n.id,r&&(u+=s.ticks,s.ticks=u),f!==undefined&&(s.track=f,s.trackId=f?f.id:undefined),s.state!=="recorded"&&(s.state="new"),l[s.id]=s}n.state!=="new"&&(n.state="changed"),n.needsUpdate=!0},p=function(e,t){if(e===!1)return;var n,r,i=e.events,s=e.config[0];for(n=i.length-1;n>=0;n--)r=i[n],r.transpose(s),r.state!=="new"&&(r.state="changed");t.needsUpdate=!0,t.state!=="new"&&t.track&&(t.state="changed",t.track.needsUpdate=!0)},c=function(e,n){if(e===!1)return;var r,i,s,o=e.events,u=e.config[0];if(isNaN(u)){t.warn("Part.moveEvent(s) -> please provide a number");return}for(r=o.length-1;r>=0;r--)i=o[r],s=i.ticks+u,s<0&&(s=0),i.ticks=s,i.state!=="new"&&(i.state="changed");n.needsUpdate=!0,n.state!=="new"&&n.track&&(n.state="changed",n.track.needsUpdate=!0)},h=function(e,n){var r,i,s=[];for(r=e.length-1;r>=0;r--){i=f(e[r],n);if(i===!1)continue;if(i.part!==n){t.warn("can't remove: this event belongs to part",i.part.id);continue}i.state="removed",i.reset(),s.push(i)}return n.needsUpdate=!0,s},v=function(e){var t=e.notes,n=e.lowestNote,r=e.highestNote,i,s,o,u;for(o=t.length-1;o>=0;o--)u=t[o],u.setPitch(n+(r-u.number)),u.isDirty=!0,i=u.noteOn,s=u.noteOff,i.state="changed",s.state="changed",u.state="changed";e.needsUpdate=!0,e.state!=="new"&&e.track&&(e.state="changed",e.track.needsUpdate=!0)},m=function(e,t){var n=e.notes,r,i,s,o,u,a;t=t||e.duration.ticks;for(a=n.length-1;a>=0;a--)r=n[a],i=r.noteOn,s=r.noteOff,o=t-s.ticks,u=t-i.ticks,i.ticks=o,s.ticks=u,r.ticks=o,i.state="changed",s.state="changed",r.state="changed";e.needsUpdate=!0,e.state!=="new"&&e.track&&(e.state="changed",e.track.needsUpdate=!0)},y.prototype.addEvent=y.prototype.addEvents=function(){var e=d(arguments,this);l(e,this,!1)},y.prototype.addEventsRelative=function(){var e=d(arguments,this);l(e,this,!0)},y.prototype.removeEvents=function(){var e=d(arguments,this);return e===!1?!1:h(e.events,this)},y.prototype.moveEvent=y.prototype.moveEvents=function(){var e=d(arguments,this);c(e,this)},y.prototype.moveNote=function(e,t){c({events:[e.noteOn,e.noteOff],config:[t]},this)},y.prototype.transposeEvents=function(){var e=d(arguments,this);p(e,this)},y.prototype.transposeAllEvents=function(e){p({events:this.events,config:[e]},this)},y.prototype.transposeNote=function(e,t){p({events:[e.noteOn,e.noteOff],config:[t]},this)},y.prototype.reverseByTicks=function(e){this.needsUpdate&&this.update(),m(this,e)},y.prototype.reverseByPitch=function(){this.needsUpdate&&this.update(),v(this)},y.prototype.findEvents=function(e){return o(this,e)},y.prototype.findNotes=function(e){return u(this,e)},y.prototype.getStats=function(e){return a(this,e)},y.prototype.getIndex=function(){var e,t,n;if(this.track){e=this.track.parts;for(n=this.track.numParts-1;n>=0;n--){t=e[n];if(t.id===this.id)return n}}return-1},y.prototype.copy=function(){var e=new y(i(this.name)),t=this.ticks,n=this.eventsById,r=[],s,o,u;e.song=undefined,e.track=undefined,e.trackId=undefined;for(o in n)n.hasOwnProperty(o)&&(u=n[o],s=u.clone(),s.ticks=s.ticks-t,r.push(s));return e.addEvents(r),e},y.prototype.setSolo=function(e){e===undefined&&(e=!this.solo),this.mute=!1,this.solo=e,this.track&&this.track.setPartSolo(this,e)},y.prototype.reset=function(e,t){var n=this.eventsById,r,i;t&&(this.song=undefined),e&&(this.track=undefined),this.trackId=undefined,this.start.millis=undefined,this.end.millis=undefined;for(r in n)n.hasOwnProperty(r)&&(i=n[r],i.ticks-=this.ticks,i.reset(!1,e,t));this.ticks=0,this.needsUpdate=!0},y.prototype.update=function(){var t,r,i,s,o,u,a,f,l,c,h,p,d=[],v=this,m=this.id,g=this.track,y=this.track?this.track.id:undefined;this.events=[];for(o in this.eventsById)this.eventsById.hasOwnProperty(o)&&(u=this.eventsById[o],u.state!=="clean"&&(this.dirtyEvents[u.id]=u),u.state!=="removed"&&this.events.push(u));this.events.sort(function(e,t){return e.ticks-t.ticks});for(t=0,r=this.notes.length;t<r;t++){f=this.notes[t];if(f.noteOn.state==="removed"||f.noteOff!==undefined&&f.noteOff.state==="removed")f.state="removed",this.dirtyNotes[f.id]=f,delete this.notesById[f.id];else if(f.noteOn.state==="changed"||f.noteOff!==undefined&&f.noteOff.state==="changed")f.state="changed",this.dirtyNotes[f.id]=f}for(t=0,r=this.events.length;t<r;t++){u=this.events[t],a=u.noteNumber;if(u.type===e.NOTE_ON)u.midiNote===undefined&&(d[a]===undefined&&(d[a]=[]),d[a].push(u),f=n(u),f.part=v,f.partId=m,f.track=g,f.trackId=y,f.state="new",this.notesById[f.id]=f,this.dirtyNotes[f.id]=f);else if(u.type===e.NOTE_OFF)if(u.midiNote===undefined){l=d[a];if(l)f=l.shift(),f&&f.midiNote&&(f.state="changed",this.dirtyNotes[f.midiNote.id]=f.midiNote,f.midiNote.addNoteOff(u));else{s=this.notes.length;for(i=s-1;i>=0;i--){f=this.notes[i];if(f.number===u.noteNumber){f.state="changed",f.addNoteOff(u),this.dirtyNotes[f.id]=f;break}}}}else this.notesById[u.midiNote.id]===undefined&&(f=u.midiNote,f.part=v,f.partId=m,f.track=g,f.trackId=y,this.notesById[f.id]=f)}this.notes=[];for(o in this.notesById)this.notesById.hasOwnProperty(o)&&(f=this.notesById[o],this.notes.push(f));this.notes.sort(function(e,t){return e.ticks-t.ticks}),this.numEvents=this.events.length,this.numNotes=this.notes.length,c=this.events[0],h=this.events[this.numEvents-1];if(c){c.ticks<this.ticks&&(this.autoSize="both");switch(this.autoSize){case"right":this.start.ticks=this.ticks,this.end.ticks=h.ticks,this.duration.ticks=h.ticks-this.start.ticks;break;case"both":this.start.ticks=c.ticks,this.end.ticks=h.ticks,this.duration.ticks=h.ticks-c.ticks}}p=this.getStats("noteNumber all"),this.lowestNote=p.min,this.highestNote=p.max,this.ticks=this.start.ticks,this.state==="clean"&&(this.state="changed"),this.needsUpdate=!1},e.createPart=function(){return new y},e.protectedScope.addInitMethod(function(){n=e.createMidiNote,r=e.createMidiEvent,i=e.protectedScope.copyName,s=e.protectedScope.typeString,o=e.findEvent,u=e.findNote,a=e.getStats})}(),function(){"use strict";var e=window.sequencer,t=window.console,n=0,r=10,i,s,o,u;s=function(e,t,r,i){this.id="POS"+n++ +""+(new Date).getTime(),this.song=e,this.type=t||"",this.name=r||this.id,this.data=i||{},this.lastEvent=undefined,this.activeParts=[],this.activeNotes=[],this.activeEvents=[]},s.prototype.set=function(e,t){return this.unit=e,this.currentValue=t,this.eventIndex=0,this.noteIndex=0,this.partIndex=0,this.calculate(),this.data},s.prototype.get=function(){return this.data},s.prototype.update=function(e,t){return t===0?this.data:(this.unit=e,this.currentValue+=t,this.calculate(),this.data)},s.prototype.updateSong=function(){this.events=this.song.songAndTimeEvents,this.numEvents=this.events.length,this.notes=this.song.notes,this.numNotes=this.song.numNotes,this.parts=this.song.parts,this.numParts=this.song.numParts,this.set("millis",this.song.millis||0)},s.prototype.setType=function(e){this.type=e,this.set(this.unit,this.currentValue)},s.prototype.addType=function(e){this.type+=" "+e,this.set(this.unit,this.currentValue)},s.prototype.removeType=function(e){var t=this.type.split(" ");this.type="",t.forEach(function(t){t!==e&&(this.type+=e+" ")}),this.type.trim(),this.set(this.currentValue)},s.prototype.calculate=function(){var n,i,s,a,f,l=[],c=[],h=[],p=[],d=[],v=[];for(n=this.eventIndex;n<this.numEvents;n++){i=this.events[n];if(!(i[this.unit]<=this.currentValue))break;i.type!==e.MIDI_NOTE&&i.type!==e.DUMMY_EVENT&&v.push(i),this.lastEvent=i,this.eventIndex++}this.lastEvent===undefined&&(this.lastEvent=this.song.timeEvents[0]),f=o(this.song,this.unit,this.currentValue,"all",this.lastEvent),this.data.eventIndex=this.eventIndex,this.data.millis=f.millis,this.data.ticks=f.ticks;if(this.type.indexOf("all")!==-1){var m=this.data;u(f,function(e,t){m[t]=e})}else this.type.indexOf("barsbeats")!==-1?(this.data.bar=f.bar,this.data.beat=f.beat,this.data.sixteenth=f.sixteenth,this.data.tick=f.tick,this.data.barsAsString=f.barsAsString,this.data.ticksPerBar=f.ticksPerBar,this.data.ticksPerBeat=f.ticksPerBeat,this.data.ticksPerSixteenth=f.ticksPerSixteenth,this.data.numSixteenth=f.numSixteenth):this.type.indexOf("time")!==-1?(this.data.hour=f.hour,this.data.minute=f.minute,this.data.second=f.second,this.data.millisecond=f.millisecond,this.data.timeAsString=f.timeAsString):this.type.indexOf("percentage")!==-1&&(this.data.percentage=f.percentage);if(this.type.indexOf("events")!==-1||this.type.indexOf("all")!==-1){for(n=this.activeEvents.length-1;n>=0;n--){i=this.activeEvents[n];if(i.type===81||i.type===88)continue;if(i.state.indexOf("removed")===0||this.song.eventsById[i.id]===undefined)continue;i[this.unit]<=this.currentValue&&i[this.unit]>this.currentValue-r&&h.push(i)}this.activeEvents=[].concat(h);for(n=v.length-1;n>=0;n--)i=v[n],i[this.unit]>this.currentValue-r&&this.activeEvents.push(i);this.song.activeEvents={};for(n=this.activeEvents.length-1;n>=0;n--)i=this.activeEvents[n],this.song.activeEvents[i.id]=i}if(this.type.indexOf("notes")!==-1||this.type.indexOf("all")!==-1){for(n=this.noteIndex;n<this.numNotes;n++){s=this.notes[n];if(!(s.noteOn[this.unit]<=this.currentValue))break;d.push(s),this.noteIndex++}for(n=this.activeNotes.length-1;n>=0;n--){s=this.activeNotes[n];if(s.noteOn.state.indexOf("removed")===0||this.song.notesById[s.id]===undefined)continue;if(s.noteOff===undefined){e.debug&&t.warn("note with id",s.id,"has no noteOff event",s.noteOn.track.name);continue}s.noteOn[this.unit]<=this.currentValue&&s.noteOff[this.unit]>this.currentValue&&c.push(s)}this.activeNotes=[].concat(c);for(n=d.length-1;n>=0;n--){s=d[n];if(s.noteOff===undefined){e.debug&&t.warn("note with id",s.id,"has no noteOff event",s.noteOn.track.name);continue}s.noteOff[this.unit]>this.currentValue&&this.activeNotes.push(s)}this.song.activeNotes={};for(n=this.activeNotes.length-1;n>=0;n--)s=this.activeNotes[n],this.song.activeNotes[s.id]=s}if(this.type.indexOf("parts")!==-1||this.type.indexOf("all")!==-1){for(n=this.partIndex;n<this.numParts;n++){a=this.parts[n];if(!(a.start[this.unit]<=this.currentValue))break;p.push(a),this.partIndex++}for(n=this.activeParts.length-1;n>=0;n--)a=this.activeParts[n],a.start[this.unit]<=this.currentValue&&a.end[this.unit]>this.currentValue&&l.push(a);this.activeParts=[].concat(l);for(n=p.length-1;n>=0;n--)a=p[n],a.end[this.unit]>this.currentValue&&this.activeParts.push(a);this.song.activeParts={};for(n=this.activeParts.length-1;n>=0;n--)a=this.activeParts[n],this.song.activeParts[a.id]=a}this.busy===!0&&(this.busy=!1)},e.protectedScope.createPlayhead=function(e,t,n,r){return new s(e,t,n,r)},e.protectedScope.addInitMethod(function(){o=e.protectedScope.getPosition2,u=e.protectedScope.objectForEach,i=e.debug})}(),function(){"use strict";function z(e,t,n){var r=e.timeEvents,i,s;for(i=r.length-1;i>=0;i--){s=r[i];if(s[t]<=n)return N=i,s}}function W(e,t,n,r,i){return t==="millis"?q(e,n,i):t==="ticks"&&R(e,n,i),r==="all"&&j(),B(e)}var e=window.sequencer,t=window.console,n,r,i,s="barsandbeats barsbeats time millis ticks perc percentage",o="barsandbeats barsbeats time millis ticks all",u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C="all",k=!0,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U;L=function(e,t,n){return k=n===undefined?!0:!1,q(e,t),m},A=function(e,t,n){return k=n===undefined?!0:!1,R(e,t),g},O=function(e,t,n){return t=["barsbeats"].concat(t),F(e,t,"millis",n),g},M=function(e,t,n){return t=["barsbeats"].concat(t),F(e,t,"ticks",n),m},_=function(e,t,n){return k=n===undefined?!0:!1,R(e,t),j(),C="barsandbeats",B()},D=function(e,t,n){return k=n===undefined?!0:!1,q(e,t),j(),C="barsandbeats",B()},q=function(e,t,n){var r=e.lastEvent;return k===!1&&t>r.millis&&(t=r.millis),n===undefined&&(n=z(e,"millis",t)),H(n),n.millis===t?(b=0,y=0):(b=t-n.millis,y=b/p),g+=b,m+=y,m},R=function(e,t,n){var r=e.lastEvent;return k===!1&&t>r.ticks&&(t=r.ticks),n===undefined&&(n=z(e,"ticks",t)),H(n),n.ticks===t?(y=0,b=0):(y=t-m,b=y*p),m+=y,g+=b,g},U=function(e,t,n,r,i,s){var o=0,u,f,d,T,C=e.lastEvent;k===!1&&t>C.bar&&(t=C.bar),t=P(t),n=P(n),r=P(r),i=P(i,!0),s===undefined&&(s=z(e,"bar",t)),H(s);while(i>=h)r++,i-=h;while(r>v)n++,r-=v;while(n>a)t++,n-=a;s=z(e,"bar",t,N);for(o=N;o>=0;o--){s=e.timeEvents[o];if(s.bar<=t){H(s);break}}T=i-x,d=r-S,f=n-E,u=t-w,b=u*c*p,b+=f*l*p,b+=d*h*p,b+=T*p,y=b/p,w=t,E=n,S=r,x=i,g+=b,m+=y},j=function(){var e=n(y);while(e>=h){S++,e-=h;while(S>v){S-=v,E++;while(E>a)E-=a,w++}}x=n(e)},H=function(e){u=e.bpm,a=e.nominator,f=e.denominator,c=e.ticksPerBar,l=e.ticksPerBeat,h=e.ticksPerSixteenth,v=e.numSixteenth,p=e.millisPerTick,d=e.secondsPerTick,w=e.bar,E=e.beat,S=e.sixteenth,x=e.tick,m=e.ticks,g=e.millis},B=function(t){var r,i,s={};switch(C){case"millis":s.millis=n(g*1e3)/1e3,s.millisRounded=n(g);break;case"ticks":s.ticks=n(m);break;case"barsbeats":case"barsandbeats":s.bar=w,s.beat=E,s.sixteenth=S,s.tick=x,i=x===0?"000":x<10?"00"+x:x<100?"0"+x:x,s.barsAsString=w+":"+E+":"+S+":"+i;break;case"time":r=e.getNiceTime(g),s.hour=r.hour,s.minute=r.minute,s.second=r.second,s.millisecond=r.millisecond,s.timeAsString=r.timeAsString;break;case"all":s.millis=n(g*1e3)/1e3,s.millisRounded=n(g),s.ticks=n(m),s.bar=w,s.beat=E,s.sixteenth=S,s.tick=x,i=x===0?"000":x<10?"00"+x:x<100?"0"+x:x,s.barsAsString=w+":"+E+":"+S+":"+i,r=e.getNiceTime(g),s.hour=r.hour,s.minute=r.minute,s.second=r.second,s.millisecond=r.millisecond,s.timeAsString=r.timeAsString,s.bpm=n(u*t.playbackSpeed,3),s.nominator=a,s.denominator=f,s.ticksPerBar=c,s.ticksPerBeat=l,s.ticksPerSixteenth=h,s.numSixteenth=v,s.millisPerTick=p,s.secondsPerTick=d,s.percentage=m/t.durationTicks}return s},P=function(e,t){return e=isNaN(e)?t?0:1:e,e=n(e),t?e=e<0?0:e:e=e<1?1:e,e},I=function(e){C="all",k=!0;if(i(e)==="array"){var t=e.length,n,r,u,a;T=e[0],i(e[0])==="array"&&(e=e[0],T=e[0],t=e.length),n=[T];if(s.indexOf(T)!==-1){for(r=1;r<t;r++){u=e[r];if(u===!0||u===!1)k=u;else if(isNaN(u)){if(o.indexOf(u)===-1)return!1;C=u}else n.push(u)}return a=n.length,a!==2&&a!==3&&a!==5?!1:n}}return!1},F=function(e,n){var i=I(n),s,o,u;if(i===!1){t.error("wrong position data");return}switch(T){case"barsbeats":case"barsandbeats":return U(e,i[1],i[2],i[3],i[4]),B(e);case"time":return s=0,o=i[1]||0,s+=o*60*60*1e3,o=i[2]||0,s+=o*60*1e3,o=i[3]||0,s+=o*1e3,o=i[4]||0,s+=o,q(e,s),j(),B(e);case"millis":return q(e,i[1]),j(),B(e);case"ticks":return R(e,i[1]),j(),B(e);case"perc":case"percentage":return u=i[2],m=i[1]*e.durationTicks,u!==undefined&&(m=r(m/u)*u),R(e,m),j(),o=B(e),o}return!1},e.protectedScope.getPosition=F,e.protectedScope.getPosition2=W,e.protectedScope.checkPosition=I,e.protectedScope.millisToTicks=L,e.protectedScope.ticksToMillis=A,e.protectedScope.ticksToBars=_,e.protectedScope.millisToBars=D,e.protectedScope.barsToTicks=M,e.protectedScope.barsToMillis=O,e.protectedScope.addInitMethod(function(){n=e.protectedScope.round,r=e.protectedScope.floor,i=e.protectedScope.typeString})}(),function(){"use strict";function o(n,r,o,u){var a;r=""+r,r=r.toUpperCase(),o=o||e.defaultPPQ;if(r===0)return{};var f,l,c,h,p,d,v=u||{};v.events===undefined&&(v.events={}),v.tracks===undefined&&(v.tracks={}),r.indexOf("TICKS")!==-1?d=parseInt(r.replace(/TICKS/,""),10):d=s[r]*o;if(d===undefined){e.debug&&t.warn("invalid quantize value");return}for(f=n.length-1;f>=0;f--)l=n[f],v.events[l.id]={event:l,ticks:l.ticks},l.type!==128&&(c=l.ticks,h=i(c/d)*d,p=h-c,l.ticks=h,l.state="changed",l.part.needsUpdate=!0,l.track.needsUpdate=!0,a=l.track,v.tracks[a.id]===undefined&&(v.tracks[a.id]={track:a,quantizedEvents:[]}),v.tracks[a.id].quantizedEvents.push(l),l.midiNote!==undefined&&(l.midiNote.noteOff.ticks+=p,l.midiNote.noteOff.state="changed",l.midiNote.state="changed",v.tracks[a.id].quantizedEvents.push(l.midiNote.noteOff)));return v}function u(e,t,n,r){var i=r||{}}var e=window.sequencer,t=window.console,n,r=Math.floor,i=Math.round,s={1:4,"1.":6,"1..":7,"1...":7.5,"1T":2/3*4,2:2,"2.":3,"2..":3.5,"2...":3.75,"2T":2/3*2,4:1,"4.":1.5,"4..":1.75,"4...":1.875,"4T":2/3*1,8:.5,"8.":.75,"8..":.875,"8...":.9375,"8T":2/3*1/2,16:.25,"16.":.375,"16..":.4375,"16...":.46875,"16T":2/3*1/4,32:1/8,"32.":.1875,"32..":.21875,"32...":.234375,"32T":2/3*1/8,64:1/16,"64.":.09375,"64..":.109375,"64...":.1171875,"64T":2/3*1/16,128:1/32,"128.":1.5/32,"128..":1.75/32,"128...":1.875/32,"128T":2/3*1/32};e.protectedScope.addInitMethod(function(){n=e.protectedScope.copyObject}),e.quantize=o,e.fixedLength=u}(),function(){"use strict";var e=window.sequencer,t=window.console,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m=function(e){this.id=o(),this.output=n.createGainNode(),this.output.connect(e.track.input),this.buffer=e.buffer,this.noteNumber=e.noteNumber,this.stopCallback=function(){},this.track=e.track};f=function(e,n){e.source.onended=function(){e.stopCallback(e)},n=n||0;try{e.source.stop(n)}catch(r){t.log(r)}},l=function(e){var t=n.currentTime,r,i,s;switch(e.releaseEnvelope){case"linear":e.output.gain.linearRampToValueAtTime(e.volume,t),e.output.gain.linearRampToValueAtTime(0,t+e.releaseDuration);break;case"equal power":r=a(100,"fadeOut",e.volume),e.output.gain.setValueCurveAtTime(r,t,e.releaseDuration);break;case"array":s=e.releaseEnvelopeArray.length,r=new Float32Array(s);for(i=0;i<s;i++)r[i]=e.releaseEnvelopeArray[i]*e.volume;e.output.gain.setValueCurveAtTime(r,t,e.releaseDuration)}},m.prototype.addData=function(e){this.sourceId=e.sourceId,this.noteName=e.noteName,this.midiNote=e.midiNote},m.prototype.createSource=function(){this.source=n.createBufferSource(),this.source.buffer=this.buffer},m.prototype.route=function(){this.source.connect(this.output)},m.prototype.start=function(e,n){if(this.source!==undefined){t.error("this should never happen");return}this.volume=n/127,this.output.gain.value=this.volume,this.createSource(),this.phase="decay",this.route(),i===!0&&(this.source.start=this.source.noteOn,this.source.stop=this.source.noteOff);try{this.source.start(e)}catch(r){t.warn(r)}},m.prototype.stop=function(n,r){if(this.source===undefined){e.debug&&t.log("Sample.stop() source is undefined");return}if(n===0||n===undefined)n=e.getTime();this.stopCallback=r,this.release?(this.source.loop=!1,this.startReleasePhase=n,this.stopTime=n+this.releaseDuration):f(this,n)},m.prototype.unschedule=function(e,i){var s=n.currentTime,o=this,u=e===null?100:e;this.source.onended=undefined,this.output.gain.cancelScheduledValues(s);try{this.output.gain.linearRampToValueAtTime(0,s+u/1e3),r["unschedule_"+this.id]={time:s+u/1e3,execute:function(){if(!o){t.log("sample is gone");return}o.panner&&o.panner.node.disconnect(0),o.source!==undefined&&(o.source.disconnect(0),o.source=undefined),i&&i(o)}}}catch(a){t.log(a)}},m.prototype.update=function(e){var r=this.track.name==="Sonata # 3"&&this.track.song.bar>=6&&this.track.song.bar<=10;this.autopan&&this.panner.setPosition(e),this.startReleasePhase!==undefined&&n.currentTime>=this.startReleasePhase&&this.phase==="decay"?(r===!0&&t.log(this.phase,"-> release",this.releaseDuration),this.phase="release",l(this)):this.stopTime!==undefined&&n.currentTime>=this.stopTime&&this.phase==="release"&&(r===!0&&t.log(this.phase,"-> stopped",this.stopTime,n.currentTime),this.phase="stopped",f(this))},e.createSample=function(e){var n=!1;return n&&t.log(e),e.oscillator?(n&&t.log("synth"),new c(e)):e.sustain&&e.release&&e.panning?(n&&t.log("sustain, release, panning"),new v(e)):e.release&&e.panning?(n&&t.log("release, panning"),new d(e)):e.release&&e.sustain?(n&&t.log("release, sustain"),new p(e)):e.release?(n&&t.log("release"),new h(e)):(n&&t.log("simple"),new m(e))},e.protectedScope.addInitMethod(function(){var t=e.protectedScope.createClass;n=e.protectedScope.context,r=e.protectedScope.timedTasks,a=e.util.getEqualPowerCurve,i=e.legacy,o=e.protectedScope.getSampleId,s=e.protectedScope.typeString,u=e.createPanner,h=t(m,function(e){this.release=!0,this.releaseDuration=e.release_duration/1e3,this.releaseEnvelope=e.release_envelope}),p=t(m,function(e){this.release=!0,this.sustainStart=e.sustain_start/1e3,this.sustainEnd=e.sustain_end/1e3,this.releaseDuration=e.release_duration/1e3,this.releaseEnvelope=e.release_envelope,this.releaseEnvelope===undefined?this.releaseEnvelope="equal power":s(this.releaseEnvelope)==="array"&&(this.releaseEnvelopeArray=e.release_envelope_array,this.releaseEnvelope="array")}),p.prototype.route=function(){this.source.loop=!0,this.source.loopStart=this.sustainStart,this.source.loopEnd=this.sustainEnd,this.source.connect(this.output)},d=t(m,function(e){this.release=!0,this.releaseDuration=e.release_duration/1e3,this.releaseEnvelope=e.release_envelope,this.releaseEnvelope===undefined?this.releaseEnvelope="equal power":s(this.releaseEnvelope)==="array"&&(this.releaseEnvelopeArray=e.release_envelope_array,this.releaseEnvelope="array"),this.panPosition=e.panPosition}),d.prototype.route=function(){this.panner=u(),this.panner.setPosition(this.panPosition||0),this.source.connect(this.panner.node),this.panner.node.connect(this.output)},v=t(m,function(e){this.release=!0,this.sustainStart=e.sustain_start/1e3,this.sustainEnd=e.sustain_end/1e3,this.releaseDuration=e.release_duration/1e3,this.releaseEnvelope=e.release_envelope,this.releaseEnvelope===undefined?this.releaseEnvelope="equal power":s(this.releaseEnvelope)==="array"&&(this.releaseEnvelopeArray=e.release_envelope_array,this.releaseEnvelope="array"),this.panPosition=e.panPosition}),v.prototype.route=function(){this.source.loop=!0,this.source.loopStart=this.sustainStart,this.source.loopEnd=this.sustainEnd,this.panner=u(),this.panner.setPosition(this.panPosition||0),this.source.connect(this.panner.node),this.panner.node.connect(this.output)},c=t(m,function(e){this.release=!0,this.panPosition=0,this.autopan=e.autopan||!1,this.frequency=e.event.frequency,this.waveForm=e.wave_form||0,this.releaseDuration=e.release_duration/1e3||1.5,this.releaseEnvelope=e.release_envelope||"equal power"}),c.prototype.createSource=function(){this.source=n.createOscillator(),this.source.type=this.waveForm,this.source.frequency.value=this.frequency},c.prototype.route=function(){this.volume*=.3,this.output.gain.value=this.volume,this.autopan?(this.panner=u(),this.panner.setPosition(0),this.source.connect(this.panner.node),this.panner.node.connect(this.output)):this.source.connect(this.output)}})}(),function(){"use strict";function m(e,t){var n,r=t.mapping,i,s,o,u,a,f,l,c,h,p;e.samples=[],e.samplesById={},c=t.remote_path,c=c===undefined?!1:c;for(n in r)r.hasOwnProperty(n)&&(h={id:n,folder:e.folder+"/"+e.name},c!==!1?(i=r[n],i.indexOf("http://")===0||i.indexOf("https://")===0?h.url=i:(o=i,a=i.lastIndexOf("/"),a!==-1&&(o=i.substring(a+1)),s=i.substring(0,a),f=i.lastIndexOf("."),p=t.extension,f!==-1&&(u=i.substring(f+1),u.length>=3&&u.length<=4&&(p=u,o=i.substring(a,f))),i=c+"/"+s+"/"+o+"."+p,i=i.replace(/\/{2,}/g,"/"),i=i.replace(/^\//,""),i=i.replace(/$\//,""),h.url=i)):(l=r[n],l.d!==undefined?(h.base64=r[n].d,l.s!==undefined&&(h.sustain=l.s),l.r!==undefined&&(h.release=l.r)):h.base64=r[n],e.samplesById[n]=h),e.samples.push(h))}function g(n,r){E(n.samples,function(e){},function(){n.loaded=!0,n.parseTime=c,e.debug>=2&&t.info("parsing",n.name,"took",c*1e3,"ms"),r&&r()})}function y(e,t){e.reset(),e=undefined,t(!1)}function b(n){var o=r(n.localPath,e.storage.samplepacks,!0),u=n.action,a,f,l;if(o&&o.className==="SamplePack")if(u==="overwrite"){f=o.samples;for(a=f.length-1;a>=0;a--)l=f[a],s(l.name+"/"+l.folder,e.storage.audio)}else{if(u!=="append")return e.debug>=2&&t.warn("there is already a samplepack at",n.localPath),!1;f=o.samples;for(a=f.length-1;a>=0;a--)n.samples.push(f[a])}return i(n,n.localPath,e.storage.samplepacks),!0}function w(r,i){r.hasMapping!==!0?n({url:r.url,responseType:"json",onError:function(){y(r,i)},onSuccess:function(n){if(n===null){i(!1);return}if(n.mapping===undefined){e.debug>=2&&t.warn("can't create a SamplePack with this data",n),y(r,i);return}n.name!==undefined&&r.name===undefined&&(r.name=n.name),n.folder!==undefined&&r.folder===undefined&&(r.folder=n.folder),r.name===undefined&&(r.name=u(r.url).name),r.action=n.action,r.localPath=r.folder!==undefined?r.folder+"/"+r.name:r.name,b(r)===!0?(m(r,n),g(r,i)):i(!1)}}):b(r)===!0?g(r,i):i(!1)}function E(e,t,n){function u(a){i(a,h+"/"+p,l.audio),t&&t(a),r++,r<s?(o=e[r],S(o,u)):n()}var r=0,s=e.length,o=e[r];S(o,u)}function S(e,i){var s,o=e.url,u=e.base64;p=e.id,h=e.folder,s=r(h+"/"+p,l.audio,!0),s!==!1?i(s):u?(u!=="TWAAAP"?(s=a(u),x(s,i)):i(s),e.base64=""):o?n({url:o,responseType:"arraybuffer",onError:function(){i()},onSuccess:function(e){x(e,i)}}):t.error("could not load sample",h+"/"+p)}function x(n,r){var i=e.getTime();if(n!==null)try{f.decodeAudioData(n,function(t){c+=e.getTime()-i,r(t)},function(e){t.log("error decoding audiodata",p,e),r()})}catch(s){t.log(p,s),r()}}var e=window.sequencer,t=window.console,n,r,i,s,o,u,a,f,l,c,h,p,d=0,v;v=function(e){this.id="SP"+d++ +(new Date).getTime(),this.className="SamplePack",this.loaded=!1,this.loadTime=0,this.parseTime=c=0,this.url=e.url,this.name=e.name,this.folder=e.folder,this.info=e.info||e.samplepack_info,this.author=e.author||e.samplepack_author,this.license=e.license||e.samplepack_license,this.compression=e.compression||e.samplepack_compression,this.compression===undefined&&e.compression_type!==undefined&&(this.compression=e.compression_type+" "+e.compression_level),this.pack=e.pack,this.filesize=e.filesize,this.filesize===undefined&&this.pack!==undefined&&(this.filesize=this.pack.filesize),e.mapping?(this.name===undefined&&this.folder===undefined?(this.name=this.id,this.localPath=this.id):this.localPath=this.folder!==undefined?this.folder+"/"+this.name:this.name,this.hasMapping=!0,this.action=e.action,m(this,e)):e.url&&(this.url=e.url)},v.prototype.reset=function(){this.samples=[]},e.addSamplePack=function(n,r,i){var s=o(n),u,a,f,l;i=i===undefined?!1:i;if(s!=="object")return e.debug>=2&&t.warn("can't create a SamplePack with this data",n),!1;if(n.json){a=n.json,f=n.name,l=n.folder;if(o(a)==="string")try{a=JSON.parse(a)}catch(c){return e.debug>=2&&t.warn("can't create a SamplePack with this data",n),!1}if(a.mapping===undefined)return e.debug>=2&&t.warn("can't create a SamplePack with this data",n),!1;n={mapping:a.mapping,name:f===undefined?a.name:f,folder:l===undefined?a.folder:l}}u=new v(n),e.addTask({type:"load sample pack",method:w,params:u},function(){r&&r(u)},i),e.startTaskQueue()},e.protectedScope.addInitMethod(function(){l=e.storage,n=e.protectedScope.ajax,f=e.protectedScope.context,r=e.protectedScope.findItem,u=e.protectedScope.parseUrl,i=e.protectedScope.storeItem,s=e.protectedScope.deleteItem,o=e.protectedScope.typeString,a=e.protectedScope.base64ToBinary})}(),function(){"use strict";function o(e,t,r,i){var s;for(t=0;t<r;t++){s=e[t];if(s===undefined)continue;s.className==="MidiEvent"?i.push(s):s.className==="MidiNote"?i.push(s.noteOn):n(s)==="array"&&o(s,0,s.length)}}var e=window.sequencer,t=window.console,n,r,i=e.bufferTime*1e3,s;s=function(e){this.song=e,this.looped=!1,this.notes={}},s.prototype.updateSong=function(){this.events=this.song.songAndMetronomeEvents,this.numEvents=this.events.length,this.index=0,this.notes={},this.setIndex(this.song.millis),this.looped=!1},s.prototype.setIndex=function(e){var t;for(t=0;t<this.numEvents;t++)if(this.events[t].millis>=e){this.index=t;break}},s.prototype.getEvents=function(t){var n,r,s=[],o;if(this.looped===!0)return s;if(this.song.doLoop&&t>=this.song.loopEnd&&this.looped===!1&&this.song.millis<this.song.loopEnd){this.looped=!0;for(n=this.index;n<this.numEvents;n++){r=this.events[n];if(!(r.millis<this.song.loopEnd))break;s.push(r),this.index++}for(n in this.notes)this.notes.hasOwnProperty(n)&&(o=this.notes[n].noteOn,r=e.createMidiEvent(this.song.loopEndTicks-1,128,o.data1,0),r.millis=this.song.loopEnd-1,r.part=o.part,r.track=o.track,r.midiNote=o.midiNote,s.push(r));this.notes={},this.setIndex(this.song.loopStart),t=this.song.loopStart+i}for(n=this.index;n<this.numEvents;n++){r=this.events[n];if(!(r.millis<t))break;s.push(r),r.midiNote!==undefined&&(r.type===144?this.notes[r.midiNote.id]=r.midiNote:r.type===128&&delete this.notes[r.midiNote.id]),this.index++}return s},s.prototype.update=function(){var t,n,i,s,o,u,a,f,l,c,h,p;this.inTransition=!1,this.song.precounting===!0?(l=this.song.metronome.millis,c=l+e.bufferTime*1e3,h=this.song.metronome.getPrecountEvents(c),c>this.song.metronome.endMillis&&(c=this.song.millis+e.bufferTime*1e3,h=h.concat(this.getEvents(c)),this.inTransition=!0)):(l=this.song.millis,c=l+e.bufferTime*1e3,h=this.getEvents(c)),p=h.length;for(t=0;t<p;t++){n=h[t],s=n.track;if(n.mute===!0||n.part.mute===!0||n.track.mute===!0||n.track.type==="metronome"&&this.song.useMetronome===!1)continue;this.inTransition===!0?n.part.id==="precount"?(u=this.song.metronome.startTime,a=this.song.metronome.startTime2,f=0):(u=this.song.startTime,a=this.song.startTime2,f=this.song.startMillis):this.song.precounting===!0?(u=this.song.metronome.startTime,a=this.song.metronome.startTime2,f=0):(u=this.song.startTime,a=this.song.startTime2,f=this.song.startMillis);if(s.routeToMidiOut===!1)i=(u+n.millis-f)/1e3,i<e.getTime()&&this.looped===!0&&(i+=(this.song.loopEnd-this.song.loopStart)/1e3),s.instrument.processEvent(n,i);else{i=a+n.millis-f,i<e.getTime()&&this.looped===!0&&(i+=this.song.loopEnd-this.song.loopStart),o=s.channel;if(o==="any"||o===undefined||isNaN(o)===!0)o=0;r(s.midiOutputs,function(e){n.type===128||n.type===144||n.type===176?e.send([n.type+o,n.data1,n.data2],i):n.type===192&&e.send([n.type+o,n.data1],i)}),this.lastEventTime=i}}},s.prototype.unschedule=function(){var e=Array.prototype.slice.call(arguments),t=[],n,r,i,s;o(e,0,e.length,t);for(n=t.length-1;n>=0;n--)r=t[n],i=r.track,s=i.instrument,s&&s.unscheduleEvent(r)},s.prototype.reschedule=function(){var e,t,n=this.song.numTracks,r=this.song.tracks;for(e=0;e<n;e++)t=r[e],t.instrument.reschedule(this.song)},e.protectedScope.addInitMethod(function(){n=e.protectedScope.typeString,r=e.protectedScope.objectForEach}),e.protectedScope.createScheduler=function(e){return new s(e)}}(),function(){"use strict";function w(e){y[e.id]=e}function E(e){delete y[e.id]}var e=window.sequencer,t=window.console,n=Array.prototype.slice,r,i,s,o,u,a,f,l,c,h=0,p,d,v={},m,g=[],y={},b={};e.getSnapshot=function(e,n){if(e===undefined){t.error("song is undefined");return}n=n||e.id;var r=b[n],i=e.activeEvents,o=e.activeNotes,u=e.activeParts,a=[],f=[],l=[],c,h,p,d,v,m,g;if(r!==undefined){c=r.activeEvents,h=r.activeNotes,p=r.activeParts;for(g=c.length-1;g>=0;g--)d=c[g],i[d.id]===undefined&&e.eventsLib[d.id]!==undefined&&a.push(d);for(g=h.length-1;g>=0;g--)v=h[g],o[v.id]===undefined&&e.notesLib[v.id]!==undefined&&f.push(v);for(g=p.length-1;g>=0;g--)m=p[g],u[m.id]===undefined&&l.push(m)}return r={activeEvents:s(i),activeNotes:s(o),activeParts:s(u),nonActiveEvents:a,nonActiveNotes:f,nonActiveParts:l},b[n]=r,r},p=function(n){var r,i,s,o=e.getTime();for(r in f)f.hasOwnProperty(r)&&(s=f[r],s.time>=o&&(s.execute(),s=null,delete f[r]));for(r in l)l.hasOwnProperty(r)&&l[r]();for(r in c)c.hasOwnProperty(r)&&c[r]();h>=10?(i=(n-d)/1e3,e.diff=i,i>e.bufferTime&&e.autoAdjustBufferTime===!0&&(e.debug&&t.log("adjusted buffertime:"+e.bufferTime+" -> "+i),e.bufferTime=i)):h++,d=n,l={},window.requestAnimationFrame(p)},e.processEvent=e.processEvents=function(){var t=n.call(arguments),i,s,o,f,l,c,h,p=60,d,g,y,b,w,E;m=[],i=function(e,t,n){for(t=0;t<n;t++){s=e[t],g=r(s);if(s===undefined)continue;g==="midimessageevent"?(e=s.data,d=u(0,e[0],e[1],e[2]),m.push(d)):s.className==="MidiEvent"?m.push(s):g==="array"?i(s,0,s.length):g==="string"?y=s:isNaN(s)===!1&&(p=s)}},i(t,0,t.length),b=e.createPart(),w=e.createTrack(),w.setInstrument(y),v[w.instrumentId]===undefined?(v[w.instrumentId]=w,w.addPart(b),w.connect(a.destination)):(w=v[w.instrumentId],b=w.parts[0]),b.addEvents(m),w.update(),f=m.length,c=e.getTime(),E=60/p/e.defaultPPQ;for(o=0;o<f;o++)h=m[o],l=c+h.ticks*E+.002,w.instrument.processEvent(h,l)},e.stopProcessEvent=e.stopProcessEvents=function(){o(v,function(e){e.instrument.allNotesOff(),e=undefined}),v={}},e.play=function(){var t=n.call(arguments),i=[],s=[],o=[],u=[],a=[],f,l,c,h=!1,p,d,v,m,g,b,E;c=function(e,t,n,f){for(t=0;t<n;t++){l=e[t];if(l===undefined)continue;r(l)==="string"?E=l:l.className==="Song"?(m===undefined&&(m=l.bpm,g=l.nominator,b=l.denominator),u.push(l)):l.className==="Track"?(m===undefined&&(p=l.song,p!==undefined&&(m=p.bpm,g=p.nominator,b=p.denominator)),o.push(l)):l.className==="Part"?(m===undefined&&(p=l.song,p!==undefined&&(m=p.bpm,g=p.nominator,b=p.denominator)),s.push(l)):l.className==="MidiEvent"||l.className==="AudioEvent"?(m===undefined&&(v=l.part,v!==undefined&&(p=v.song,p!==undefined&&(m=p.bpm,g=p.nominator,b=p.denominator))),l.type===81||l.type===88?a.push(l):i.push(l)):r(l)==="array"?c(l,0,l.length,"    "):l===!0||l===!1?h=l:l.indexOf("S")===0&&(p=y[l],p&&p.play())}},c(t,0,t.length,"  ");for(f=u.length-1;f>=0;f--)p=u[f],o=o.concat(p.tracks),a=a.concat(p.timeEvents);return s.length>0&&(d=e.createTrack(),d.instrument=E,d.addParts(s),o.push(d)),i.length>0&&(d=e.createTrack(),d.instrument=E,v=e.createPart(),v.addEvents(i),d.addPart(v),o.push(d)),p=e.createSong({bpm:m||120,nominator:g||4,denominator:b||4,timeEvents:a,tracks:o}),w(p),p.play(),p},e.setAnimationFrameType=function(e,t){e=e||"default",e=e.toLowerCase(),t=t||15;switch(e){case"settimeout":window.requestAnimationFrame=function(e){setTimeout(e,t)};break;default:window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.requestAnimationFrame}},e.protectedScope.updateInstruments=function(){var e,t,n,r,i;for(e in y)if(y.hasOwnProperty(e)){i=y[e],n=i.tracks;for(t=n.length-1;t>=0;t--)r=n[t],r.instrument.reset()}},e.allNotesOff=function(){o(y,function(e){e.allNotesOff()})},window.onblur=function(){if(e.pauseOnBlur===!1)return;e.allNotesOff(),g=[],o(y,function(n){n.playing===!0&&(e.debug&&t.log("pause song",n.id),g.push(n),n.pause())})},window.onfocus=function(){if(e.pauseOnBlur===!1)return;var t,n,r,i=g.length;for(r=0;r<i;r++)t=g[r],n=t.millis,t.stop(),t.setPlayhead("millis",n),e.restartOnFocus&&t.play();g=[]},e.protectedScope.addSong=w,e.protectedScope.removeSong=E,e.protectedScope.addInitMethod(function(){s=e.protectedScope.objectToArray,i=e.protectedScope.isEmptyObject,i=e.protectedScope.isEmptyObject,o=e.protectedScope.objectForEach,f=e.protectedScope.timedTasks,l=e.protectedScope.scheduledTasks,c=e.protectedScope.repetitiveTasks,r=e.protectedScope.typeString,a=e.protectedScope.context,u=e.createMidiEvent,p()})}(),function(){"use strict";function ot(e,r){function s(e,t,n){var o,u,a;for(t=0;t<n;t++)o=e[t],u=I(o),u==="array"?s(o,0,o.length):u==="string"?(a=r.eventsById[o],a!==undefined&&i.push(o)):o.className==="MidiEvent"&&i.push(o)}var i=[];return e=n.call(e),t.log(e),s(e,0,e.length),i}var e=window.sequencer,t=window.console,n=Array.prototype.slice,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,V,$,J,K,Q,G,Y,Z,et,tt,nt,rt=0,it,st;st=function(n){n=n||{},this.id="S"+rt++ +""+(new Date).getTime(),this.name=n.name||this.id,this.className="Song",$(this),this.midiInputs={},this.midiOutputs={},d(this),this.bpm=n.bpm||120,this.ppq=n.ppq||e.defaultPPQ,this.bars=n.bars||30,this.lastBar=this.bars,this.lowestNote=n.lowestNote||0,this.highestNote=n.highestNote||127,this.pitchRange=this.highestNote-this.lowestNote+1,this.nominator=n.nominator||4,this.denominator=n.denominator||4,this.factor=4/this.denominator,this.ticksPerBeat=this.ppq*this.factor,this.ticksPerBar=this.ticksPerBeat*this.nominator,this.millisPerTick=6e4/this.bpm/this.ppq,this.quantizeValue=n.quantizeValue||"8",this.fixedLengthValue=n.fixedLengthValue||!1,this.positionType=n.positionType||"all",this.useMetronome=n.useMetronome,this.fixedLength=n.fixedLength===!0,this.playbackSpeed=1,this.defaultInstrument=n.defaultInstrument||e.defaultInstrument,this.recordId=-1,this.autoQuantize=!1,this.loop=n.loop||!1,this.doLoop=!1,this.illegalLoop=!0,this.loopStart=0,this.loopEnd=0,this.loopedTime=0,this.useMetronome!==!0&&this.useMetronome!==!1&&(this.useMetronome=!1),this.grid=undefined,n.timeEvents&&n.timeEvents.length>0?(this.timeEvents=[].concat(n.timeEvents),this.tempoEvent=nt(e.TEMPO,this)[0],this.timeSignatureEvent=nt(e.TIME_SIGNATURE,this)[0],this.tempoEvent===undefined?(this.tempoEvent=r(0,e.TEMPO,this.bpm),this.timeEvents.unshift(this.tempoEvent)):this.bpm=this.tempoEvent.bpm,this.timeSignatureEvent===undefined?(this.timeSignatureEvent=r(0,e.TIME_SIGNATURE,this.nominator,this.denominator),this.timeEvents.unshift(this.timeSignatureEvent)):(this.nominator=this.timeSignatureEvent.nominator,this.denominator=this.timeSignatureEvent.denominator)):(this.tempoEvent=r(0,e.TEMPO,this.bpm),this.timeSignatureEvent=r(0,e.TIME_SIGNATURE,this.nominator,this.denominator),this.timeEvents=[this.tempoEvent,this.timeSignatureEvent]),n.timeEvents!==undefined&&n.bpm!==undefined&&this.bpm!==n.bpm&&this.setTempo(n.bpm,!1),n.timeEvents!==undefined&&(n.nominator!==undefined||n.denominator!==undefined)&&(this.nominator!==n.nominator||this.denominator!==n.denominator)&&this.setTimeSignature(n.nominator||this.nominator,n.denominator||this.denominator,!1),this.tracks=[],this.parts=[],this.notes=[],this.events=[],this.allEvents=[],this.tracksById={},this.tracksByName={},this.partsById={},this.notesById={},this.eventsById={},this.activeEvents,this.activeNotes,this.activeParts,this.recordedNotes=[],this.recordedEvents=[],this.recordingNotes={},this.numTracks=0,this.numParts=0,this.numNotes=0,this.numEvents=0,this.instruments=[],this.playing=!1,this.paused=!1,this.stopped=!0,this.recording=!1,this.prerolling=!1,this.precounting=!1,this.preroll=!0,this.precount=0,this.listeners={},this.playhead=i(this,this.positionType,this.id,this),this.playheadRecording=i(this,"all",this.id+"_recording"),this.scheduler=o(this),this.followEvent=s(this),this.volume=1,this.gainNode=c.createGainNode(),this.gainNode.gain.value=this.volume,this.metronome=u(this,M),this.connect(),n.className==="MidiFile"&&n.loaded===!1&&e.debug&&t.warn("midifile",n.name,"has not yet been loaded!"),n.tracks&&this.addTracks(n.tracks),n.parts&&this.addParts(n.parts),n.events&&this.addEvents(n.events),n.events||n.parts||n.tracks?(n.bars===undefined&&(this.lastBar=0),this.lastEvent=r([this.lastBar,e.END_OF_TRACK])):this.lastEvent=r([this.bars*this.ticksPerBar,e.END_OF_TRACK]),this.update(!0),this.numTimeEvents=this.timeEvents.length,this.playhead.set("ticks",0),this.midiEventListeners={}},Z=function(e,t){var n=!1;return e===undefined?n=!1:n.className==="Part"?n=e:I(e)==="string"?n=t.partsById[e]:isNaN(e)===!1&&(n=t.parts[e]),n},G=function(e,t){var n=!1;return e===undefined?n=!1:e.className==="Track"?n=e:I(e)==="string"?(n=t.tracksById[e],n===undefined&&(n=t.tracksByName[e])):isNaN(e)===!1&&(n=t.tracks[e]),n},Y=function(e,t){var n=t.tracksById,r=t.tracksByName,i=[],s,o,u,a;for(s=e.length-1;s>=0;s--){a=G(e[s]);if(a===!1)continue;a.song!==undefined&&(a=a.copy()),a.song=t,a.instrument.song=t,a.quantizeValue=t.quantizeValue,a.connect(t.gainNode),a.state="new",a.needsUpdate=!0,n[a.id]=a,r[a.name]=a,i.push(a.id),V(a.partsById,function(e){e.state="new"})}return i},tt=function(e,n){var r,i,s=n.tracksById,o=[];for(r=e.length-1;r>=0;r--){i=G(e[r]);if(i.song!==undefined&&i.song!==n){t.warn("can't remove: this track belongs to song",i.song.id);continue}if(i===!1)continue;i.state="removed",i.disconnect(n.gainNode),i.reset(),o.push(o)}return o},et=function(e){var t,n,r=[];for(n=e.length-1;n>=0;n--)t=Z(e[n],this),t&&r.push(t);return r},nt=function(e,t){var n=[];return t.timeEvents.forEach(function(t){t.type===e&&n.push(t)}),n},K=function(t){var n=e.getTime()*1e3,r=n-t.timeStamp;t.diff=r,t.timeStamp=n;if(t.precounting===!0){t.metronome.millis+=r,t.scheduler.update(r);return}t.playhead.update("millis",r),t.followEvent.update(),t.scheduler.update(r),t.doLoop&&t.scheduler.looped&&t.millis>t.loopEnd?(t.scheduler.looped=!1,t.playhead.set("millis",t.loopStart),t.loopedTime+=t.loopEnd-t.loopStart,t.startTime+=t.loopEnd-t.loopStart):t.millis>=t.durationMillis&&(t.playhead.update("millis",t.durationMillis-t.millis),t.pause(),t.endOfSong=!0,M(t,"end"))},st.prototype.remove=function(){J(this)},st.prototype.play=function(){var n,r;if(this.playing){this.pause();return}this.doLoop=this.illegalLoop===!1&&this.loop===!0,this.endOfSong&&(this.playhead.set("millis",0),this.scheduler.setIndex(0)),this.timeStamp=e.getTime()*1e3,this.startTime=this.timeStamp;try{this.startTime2=window.performance.now()}catch(i){e.debug&&t.log("window.performance.now() not supported")}this.precounting&&(this.metronome.startTime=this.startTime,this.metronome.startTime2=this.startTime2,this.startTime+=this.metronome.precountDurationInMillis,this.startTime2+=this.metronome.precountDurationInMillis,n=this,r=this.startTime/1e3,p.playAfterPrecount=function(){e.getTime()>=r&&(n.precounting=!1,n.prerolling=!1,n.recording=!0,n.playing=!0,M(n,"record_start"),M(n,"play"),p.playAfterPrecount=undefined,delete p.playAfterPrecount)}),this.startMillis=this.millis,K(this),n=this,p[this.id]=function(){K(n)},this.paused=!1,this.stopped=!1,this.endOfSong=!1,this.precounting!==!0&&(this.playing=!0,M(this,"play"))},st.prototype.pause=function(){if(this.recording===!0||this.precounting===!0){this.stop();return}if(this.stopped||this.paused){this.play();return}delete p[this.id],this.allNotesOff(),this.playing=!1,this.paused=!0,M(this,"pause")},st.prototype.stop=function(){if(this.stopped){this.playhead.set("millis",0),this.scheduler.setIndex(0);return}(this.recording===!0||this.precounting===!0)&&this.stopRecording(),delete p[this.id],V(h,function(e,t){if(t.indexOf("unschedule_")===0||t.indexOf("event_")===0)e=null,delete h[t]}),this.allNotesOff(),this.playing=!1,this.paused=!1,this.stopped=!0,this.endOfSong=!1,this.playhead.set("millis",0),this.scheduler.setIndex(0),M(this,"stop")},st.prototype.startRecording=st.prototype.record=function(e){if(this.recording===!0||this.precounting===!0){this.stop();return}this.playing?(this.precount=0,this.recordStartMillis=this.millis):e===undefined?(this.precount=0,this.recordStartMillis=this.millis):(this.setPlayhead("barsbeats",this.bar),this.metronome.createPrecountEvents(e),this.precount=e,this.recordStartMillis=this.millis-this.metronome.precountDurationInMillis),this.recordTimestamp=c.currentTime*1e3,this.recordId="REC"+(new Date).getTime(),this.recordedNotes=[],this.recordedEvents=[],this.recordingNotes={};var t,n;for(t=this.numTracks-1;t>=0;t--)n=this.tracks[t],n.prepareForRecording(this.recordId);this.keyEditor!==undefined&&this.keyEditor.prepareForRecording(this.recordId),this.playing===!1?(this.precount>0?(this.precounting=!0,this.prerolling=this.preroll,this.prerolling?M(this,"record_preroll"):M(this,"record_precount")):(this.recording=!0,M(this,"record_start")),this.play()):(this.recording=!0,this.precounting=!1,M(this,"record_start"))},st.prototype.stopRecording=function(){this.recording=!1,this.prerolling=!1,this.precounting=!1,delete p.playAfterPrecount;var e,t,n,r={};for(e=this.numTracks-1;e>=0;e--)t=this.tracks[e],n=t.stopRecording(this.recordId),n!==undefined&&(r[t.name]=n);return this.update(),M(this,"record_stop",r),r},st.prototype.undoRecording=function(e){var t,n;if(e===undefined)for(t=this.numTracks-1;t>=0;t--)this.tracks[t].undoRecording(this.recordId);else n=this.tracksByName,V(e,function(e,t){var r=n[t];r.undoRecording(e)})},st.prototype.quantize=function(){var t,r,i,s,o=n.call(arguments),u=o.length,a,f={};for(t=0;t<u;t++)i=o[t],s=I(i),s==="string"||s==="number"?a=i:s==="object"&&(f=i);for(t=this.numTracks-1;t>=0;t--)r=this.tracks[t],a===undefined&&(a=r.quantizeValue),e.quantize(r.events,a,this.ppq,f);return f},st.prototype.undoQuantize=function(n){if(n===undefined){e.debug>=2&&t.warn("please pass a quantize history object");return}var r,i;for(r=this.numTracks-1;r>=0;r--)i=this.tracks[r],i.undoQuantize(n)},st.prototype.quantizeRecording=function(e){var t,n;for(t=this.numTracks-1;t>=0;t--)n=this.tracks[t],n.recordId===this.recordId&&n.quantizeRecording(e)},st.prototype.setLeftLocator=function(){var e=S(this,n.call(arguments));e!==undefined&&(this.loopStartPosition=e,this.loopStart=e.millis,this.loopStartTicks=e.ticks),this.illegalLoop=this.loopStart>=this.loopEnd,this.doLoop=this.illegalLoop===!1&&this.loop===!0},st.prototype.setRightLocator=function(){var e=S(this,n.call(arguments)),t=this.illegalLoop;e!==undefined&&(this.loopEndPosition=e,this.loopEnd=e.millis,this.loopEndTicks=e.ticks),this.illegalLoop=this.loopEnd<=this.loopStart,this.doLoop=this.illegalLoop===!1&&this.loop===!0},st.prototype.setLoop=function(n){if(n===undefined)this.loop=!this.loop;else{if(n!==!0&&n!==!1){e.debug>=1&&t.error('pass "true", "false" or no value');return}this.loop=n}this.doLoop=this.illegalLoop===!1&&this.loop===!0},st.prototype.setPlayhead=function(){this.scheduler.looped=!1,this.timeStamp=e.getTime()*1e3,this.startTime=this.timeStamp;try{this.startTime2=window.performance.now()}catch(r){e.debug&&t.log("window.performance.now() not supported")}this.playing&&this.allNotesOff();var i=S(this,n.call(arguments)),s=i.millis;this.startMillis=s,this.playhead.set("millis",s),this.scheduler.setIndex(s)},st.prototype.addEventListener=function(){A.apply(this,arguments)},st.prototype.removeEventListener=function(){A.apply(this,arguments)},st.prototype.addEvent=st.prototype.addEvents=function(){var t,n;return t=this.tracks[0],t===undefined&&(t=e.createTrack(),this.addTrack(t)),t.needsUpdate&&t.update(),n=t.parts[0],n===undefined&&(n=e.createPart(),t.addPart(n)),n.addEvents.apply(n,arguments),this},st.prototype.addPart=st.prototype.addParts=function(){var t=this.tracks[0];return t===undefined&&(t=e.createTrack(),this.addTrack(t)),t.addParts.apply(t,arguments),this},st.prototype.addTrack=function(){var e=Q(arguments),n=e[0],r=e.length;if(I(n)==="array"||r>1)t.warn("please use addTracks() if you want to get more that one tracks"),e=[n];return Y(e,this)[0]},st.prototype.addTracks=function(){return Y(Q(arguments),this)},st.prototype.addSong=st.prototype.addSongs=function(){},st.prototype.getTrack=function(e){return G(e,this)},st.prototype.getTracks=function(){var e=Q(arguments),t,n,r=[];for(n=e.length-1;n>=0;n--)t=G(e[n],this),t&&r.push(t);return r},st.prototype.getPart=function(){var e=Q(arguments);return e.length>1&&t.warn("please use getParts() if you want to get more that one part"),et.call(this,e)[0]},st.prototype.getParts=function(){var e=Q(arguments);return et.call(this,e)},st.prototype.removeTrack=function(){var e=Q(arguments);return e.length>1&&t.warn("please use removeTracks() if you want to remove more that one tracks"),tt(e,this)[0]},st.prototype.removeTracks=function(){return tt(Q(arguments),this)},st.prototype.setPlaybackSpeed=function(e){if(e<.01||e>100){t.error("playback speed has to be > 0.01 and < 100");return}var n=this.ticks,r,i,s;this.playbackSpeed=e,this.update(!0),this.loopStartTicks!==undefined&&(r=this.getPosition("ticks",this.loopStartTicks),this.loopStart=r.millis,this.loopStartTicks=r.ticks),this.loopEndTicks!==undefined&&(i=this.getPosition("ticks",this.loopEndTicks),this.loopEnd=i.millis,this.loopEndTicks=i.ticks),s=this.getPosition("ticks",n),this.setPlayhead("ticks",s.ticks)},st.prototype.gridToSong=function(e,t,n,r){return H(this,e,t,n,r)},st.prototype.noteToGrid=function(e,t){return B(e,t,this)},st.prototype.eventToGrid=function(e,t,n){return j(e,t,n,this)},st.prototype.positionToGrid=function(e,t){return F(e,t,this)},st.prototype.getPosition=function(){return S(this,n.call(arguments))},st.prototype.ticksToMillis=function(e,t){return T(this,e,t)},st.prototype.millisToTicks=function(e,t){return x(this,e,t)},st.prototype.ticksToBars=function(e,t){return N(this,e,t)},st.prototype.millisToBars=function(e,t){return C(this,e,t)},st.prototype.barsToTicks=function(){return k(this,n.call(arguments))},st.prototype.barsToMillis=function(){return L(this,n.call(arguments))},st.prototype.findEvent=st.prototype.findEvents=function(e){return W(this,e)},st.prototype.findNote=st.prototype.findNotes=function(e){return X(this,e)},st.prototype.getStats=function(e){return z(this,e)},st.prototype.createGrid=function(e){return this.grid===undefined?this.grid=it(this,e):this.grid.update(e),this.grid},st.prototype.update=function(e){_(this,e),this.playhead.updateSong(),this.playheadRecording.updateSong(),this.scheduler.updateSong(),this.scheduler.reschedule(),this.followEvent.updateSong()},st.prototype.updateGrid=function(e){return this.grid.update(e),this.grid},st.prototype.updateTempoEvent=function(n,r){if(n.type!==e.TEMPO){e.debug>=4&&t.error("this is not a tempo event");return}if(n.song!==this){e.debug>=4&&t.error("this event has not been added to this song yet");return}var i=this.ticks,s=this.percentage;n.bpm=r,this.update(!0),this.updatePlayheadAndLocators(i)},st.prototype.updateTimeSignatureEvent=function(n,r,i){if(n.type!==e.TIME_SIGNATURE){e.debug>=4&&t.error("this is not a time signature event");return}if(n.song!==this){e.debug>=4&&t.error("this event has not been added to this song yet");return}var s=this.ticks,o=this.percentage;n.nominator=r||n.nominator,n.denominator=i||n.denominator,this.update(!0),this.updatePlayheadAndLocators(s)},st.prototype.getTempoEvents=function(){return nt(e.TEMPO,this)},st.prototype.getTimeSignatureEvents=function(){return nt(e.TIME_SIGNATURE,this)},st.prototype.updatePlayheadAndLocators=function(e){var t,n,r=this.loopStartPosition,i=this.loopEndPosition,s;r!==undefined&&(t=this.getPosition("ticks",r.ticks),this.loopStart=t.millis,this.loopStartTicks=t.ticks,this.loopStartPosition=t),i!==undefined&&(n=this.getPosition("ticks",i.ticks),n.ticks>this.durationTicks&&(n=this.getPosition("ticks",this.bars)),this.loopEnd=n.millis,this.loopEndTicks=n.ticks,this.loopEndPosition=n),s=this.getPosition("ticks",e),this.doLoop&&s.ticks>this.durationTicks?this.setPlayhead("ticks",0):this.setPlayhead("ticks",s.ticks)},st.prototype.setTempo=function(t,n){var r=nt(e.TEMPO,this),i,s,o=this.ticks,u=this.percentage,a=t/r[0].bpm;for(i=r.length-1;i>=0;i--)s=r[i],s.bpm=a*s.bpm;this.bpm=t;if(n===!1)return;this.update(!0),this.updatePlayheadAndLocators(o)},st.prototype.setTimeSignature=function(t,n,r){var i=nt(e.TIME_SIGNATURE,this),s,o,u=this.percentage,a=this.ticks;for(s=i.length-1;s>=0;s--)o=i[s],o.nominator=t,o.denominator=n;this.nominator=t,this.denominator=n;if(r===!1)return;this.update(!0),this.updatePlayheadAndLocators(a)},st.prototype.resetTempo=function(t){var n=nt(e.TEMPO,this)[0],r=this.timeEvents;n.bpm=t,r=R(r,function(e){return e.type===81?!0:!1}),this.numTimeEvents=r.length,this.update(!0)},st.prototype.resetTimeSignature=function(t,n){var r=nt(e.TIME_SIGNATURE,this)[0],i=this.timeEvents,s=this.ticks;r.nominator=t,r.denominator=n,i=R(i,function(e){return e.type===88?!0:!1}),this.numTimeEvents=i.length,this.update(!0),this.updatePlayheadAndLocators(s)},st.prototype.addTimeEvent=st.prototype.addTimeEvents=function(){var t=Q(arguments),n=this.ticks,r,i,s;for(r=t.length-1;r>=0;r--)i=t[r],i.className==="MidiEvent"&&(i.type===e.TEMPO?this.timeEvents.push(i):i.type===e.TIME_SIGNATURE&&(s=this.getPosition("ticks",i.ticks),s.beat>s.nominator/2?s=this.getPosition("barsbeats",s.bar+1):s=this.getPosition("barsbeats",s.bar),i.ticks=s.ticks,this.timeEvents.push(i)));this.numTimeEvents=this.timeEvents.length,this.update(!0),this.updatePlayheadAndLocators(n)},st.prototype.removeTimeEvent=st.prototype.removeTimeEvents=function(){var e=Q(arguments),t,n=e.length,r,i=this.ticks,s=[];for(t=0;t<n;t++)r=e[t],r!==this.tempoEvent&&r!==this.timeSignatureEvent&&s.push(r);this.timeEvents=q(s,this.timeEvents),this.numTimeEvents=this.timeEvents.length,this.update(!0),this.updatePlayheadAndLocators(i)},st.prototype.removeDoubleTimeEvents=function(){var e=[],t,n,r,i,s={81:{},88:{}};for(t=this.timeEvents.length-1;t>=0;t--){n=this.timeEvents[t];if(s[n.type][n.ticks]!==undefined)continue;i=n.type,r=n.ticks,s[i][r]=n,r===0&&(i===81?this.tempoEvent=n:i===88&&(this.timeSignatureEvent=n))}V(s[81],function(t){e.push(t)}),V(s[88],function(t){e.push(t)}),this.timeEvents=e,this.update(!0)},st.prototype.setPitchRange=function(e,t){var n=this;n.lowestNote=e,n.highestNote=t,n.numNotes=n.pitchRange=n.highestNote-n.lowestNote+1},st.prototype.trim=function(){D(this,!0)},st.prototype.setDurationInBars=function(e){var t=this,n=t.findEvent("bar > "+e),r=[],i=[],s=[],o={},u={};return n.forEach(function(e){var t=e.trackId,n=e.partId;o[t]===undefined&&(o[t]=[]),o[t].push(e),u[n]===undefined&&(u[n]=e.part)}),V(o,function(e,n){var r=t.getTrack(n);r.removeEvents(e),i.push(r)}),V(u,function(e,t){e.events.length===0?(e.track.removePart(e),r.push(e)):s.push(e)}),t.bars=e,t.lastBar=e,{removedEvents:n,removedParts:r,changedTracks:i,changedParts:s}},st.prototype.addEffect=function(){},st.prototype.removeEffect=function(){},st.prototype.setVolume=function(){function u(e,t,n){for(t=0;t<n;t++){var r=e[t],o=I(r);o==="array"?u(r,0,r.length):o==="number"?s=r:r.className==="Track"&&i.push(r)}}var e=n.call(arguments),r=e.length,i=[],s,o;if(r===1){s=e[0];if(isNaN(s)){t.warn("please pass a number");return}this.volume=s<0?0:s>1?1:s,this.gainNode.gain.value=this.volume}else{u(e,0,r);for(o=i.length-1;o>=0;o--)i[o].setVolume(s)}},st.prototype.getVolume=function(){return this.gainNode.gain.value},st.prototype.connect=function(){this.gainNode.connect(l)},st.prototype.disconnect=function(){this.gainNode.disconnect(l)},st.prototype.cleanUp=function(){this.disconnect(l)},st.prototype.getMidiInputs=function(e){b(e,this)},st.prototype.getMidiOutputs=function(e){w(e,this)},st.prototype.setTrackSolo=function(e,t){var n,r;for(n=this.numTracks-1;n>=0;n--)r=this.tracks[n],t===!0?r.mute=r===e?!t:t:t===!1&&(r.mute=!1),r.solo=r===e?t:!1},st.prototype.muteAllTracks=function(e){var t,n;for(t=this.numTracks-1;t>=0;t--)n=this.tracks[t],n.mute=e},st.prototype.setMetronomeVolume=function(e){this.metronome.setVolume(e)},st.prototype.configureMetronome=function(e){this.metronome.configure(e)},st.prototype.resetMetronome=function(){this.metronome.reset()},st.prototype.setPrecount=function(e){this.precount=e},st.prototype.allNotesOff=function(){V(this.tracks,function(e){e.instrument.allNotesOff()}),this.metronome.allNotesOff(),this.resetExternalMidiDevices()},st.prototype.resetExternalMidiDevices=function(){var e=this.scheduler.lastEventTime+100;V(this.midiOutputs,function(t){t.send([176,123,0],e),t.send([176,121,0],e)})},st.prototype.addMidiEventListener=function(){return v(arguments,this)},st.prototype.removeMidiEventListener=function(e){m(e,this)},st.prototype.removeMidiEventListeners=function(){m(arguments,this)},st.prototype.getMidiInputsAsDropdown=function(e){return e=e||{type:"input"},E(e,this)},st.prototype.getMidiOutputsAsDropdown=function(e){return e=e||{type:"output"},E(e,this)},st.prototype.setMidiInput=function(e,t){g(e,t,this)},st.prototype.setMidiOutput=function(e,t){y(e,t,this)},st.prototype.getNoteLengthName=function(e){return U(this,e)},e.createSong=function(e){return new st(e)},e.protectedScope.addInitMethod(function(){c=e.protectedScope.context,h=e.protectedScope.timedTasks,p=e.protectedScope.repetitiveTasks,l=e.protectedScope.masterGainNode,r=e.createMidiEvent,a=e.protectedScope.parseTimeEvents,it=e.protectedScope.createGrid,d=e.protectedScope.initMidiSong,g=e.protectedScope.setMidiInputSong,y=e.protectedScope.setMidiOutputSong,b=e.protectedScope.getMidiInputs,w=e.protectedScope.getMidiOutputs,v=e.protectedScope.addMidiEventListener,E=e.protectedScope.getMidiPortsAsDropdown,m=e.protectedScope.removeMidiEventListener,S=e.protectedScope.getPosition,x=e.protectedScope.millisToTicks,T=e.protectedScope.ticksToMillis,N=e.protectedScope.ticksToBars,C=e.protectedScope.millisToBars,k=e.protectedScope.barsToTicks,L=e.protectedScope.barsToMillis,I=e.protectedScope.typeString,q=e.protectedScope.removeFromArray,R=e.protectedScope.removeFromArray2,W=e.findEvent,X=e.findNote,z=e.getStats,H=e.gridToSong,B=e.noteToGrid,j=e.eventToGrid,F=e.positionToGrid,Q=e.protectedScope.getArguments,V=e.protectedScope.objectForEach,U=e.protectedScope.getNoteLengthName,_=e.protectedScope.update,D=e.protectedScope.checkDuration,P=e.protectedScope.addMetronomeEvents,f=e.protectedScope.followEvent,i=e.protectedScope.createPlayhead,o=e.protectedScope.createScheduler,s=e.protectedScope.createFollowEvent,u=e.protectedScope.createMetronome,A=e.protectedScope.songAddEventListener,O=e.protectedScope.songRemoveEventListener,M=e.protectedScope.songDispatchEvent,$=e.protectedScope.addSong,J=e.protectedScope.removeSong})}(),function(){"use strict";var e=window.sequencer,t=window.console,n=Array.prototype,r="play stop pause end record_start record_stop sustain_pedal",i=0,s,o,u;u=function(){var e,t,r,i=n.slice.call(arguments),s=i.length,o=i[0],u=i[1],a=[];if(s>2){e=2;while(e<s)a.push(i[e]),e++}a.push(o),t=o.listeners[u];if(t===undefined)return;for(e=t.length-1;e>=0;e--)r=t[e],r.callback.apply(null,a)},s=function(){var e=Array.prototype.slice.call(arguments),t,n=e[0];switch(n){case"play":case"stop":case"pause":case"end":case"record_start":case"record_stop":case"record_precount":case"record_preroll":case"loop_off":case"loop_on":case"sustain_pedal":return this.listeners[n]===undefined&&(this.listeners[n]=[]),t=n+"_"+i++,this.listeners[n].push({id:t,callback:e[1]}),t;default:return this.followEvent.addEventListener(n,e[1],e[2])}},o=function(){var e=Array.prototype.slice.call(arguments),n,i=e[0],s=e[1],o,u,a=[],f,l;i.indexOf("_")!==-1?(n=i.split("_"),o=n[0],u=i):o=i;if(r.indexOf(o)===-1)return this.followEvent.removeEventListener(e);switch(o){case"play":case"stop":case"pause":case"end":case"record_start":case"record_stop":case"record_precount":case"record_preroll":case"loop_off":case"loop_on":case"sustain_pedal":n=this.listeners[o];for(f=n.length-1;f>=0;f--)l=n[f],u!==undefined?l.id!==u&&a.push(l):s!==undefined&&l.callback!==s&&a.push(l);this.listeners[o]=[].concat(a);break;default:t.error("unsupported event")}},e.protectedScope.songAddEventListener=s,e.protectedScope.songRemoveEventListener=o,e.protectedScope.songDispatchEvent=u,e.protectedScope.addInitMethod(function(){})}(),function(){"use strict";var e,t,n,r,i,s=0,o={bar:1,beat:1,sixteenth:1,tick:0,ticks:1,barsbeats:1,barsandbeats:1,hour:1,minute:1,second:1,millisecond:0,millis:1,time:1},u="= == === > >= < <= != !== %=",a=new RegExp(" "+u.replace(/\s+/g," | ")+" "),f,l,c;c=function(e){this.song=e,this.allListenersById={},this.allListenersByType={},this.searchPatterns=[],this.eventListenersBySearchstring={},this.positionListenersBySearchstring={},this.allListenersByType={event:{instance:{},searchstring:{}},position:{ticks:[],repetitive:{},conditional_simple:{},conditional_complex:{}}}},c.prototype.updateSong=function(){var t,n,r,i,o,u,a,f=[],l,c,h;l=this.allListenersByType.event.instance;for(i in l)if(l.hasOwnProperty(i)&&this.song.eventsById[i]===undefined){f=l[i];for(t=f.length-1;t>=0;t--)h=f[t],delete this.allListenersById[h];delete l[i]}l=this.allListenersByType.event.searchstring,f=[];for(i in l)l.hasOwnProperty(i)&&(f=f.concat(l[i]));for(t=f.length-1;t>=0;t--)delete this.allListenersById[f[t]];this.allListenersByType.event.searchstring={},u=this.allListenersByType.event.searchstring;for(t=this.searchPatterns.length-1;t>=0;t--){a=this.searchPatterns[t],o=e(this.song,a.searchstring),u.type==="note"&&(o=e(o,"type = NOTE_ON OR type = NOTE_OFF"));for(n=o.length-1;n>=0;n--)r=o[n],h="event_"+s++,c={id:h,event:event,type:a.type,subtype:a.subtype,callback:a.callback},this.allListenersById[h]=c,u[r.id]===undefined&&(u[r.id]=[]),u[r.id].push(h)}},c.prototype.update=function(){var e,t=this.song,n=t.ticks,r=[],i,s;r=this.song.playhead.activeEvents,i=r.length;for(e=0;e<i;e++)s=r[e],this.callEventListeners(s.id,s);this.callListenersPositionTicks(n),t.bar!==this.bar&&(this.bar=t.bar,this.callListenersPositionRepetitive("bar"),this.callListenersPositionConditionalSimple("bar",this.bar),this.callListenersPositionConditionalComplex("bar",this.bar)),t.beat!==this.beat&&(this.beat=t.beat,this.callListenersPositionRepetitive("beat"),this.callListenersPositionConditionalSimple("beat",this.beat),this.callListenersPositionConditionalComplex("beat",this.beat)),t.sixteenth!==this.sixteenth&&(this.sixteenth=t.sixteenth,this.callListenersPositionRepetitive("sixteenth"),this.callListenersPositionConditionalSimple("sixteenth",this.sixteenth),this.callListenersPositionConditionalComplex("sixteenth",this.sixteenth)),t.hour!==this.hour&&(this.hour=t.hour,this.callListenersPositionRepetitive("hour"),this.callListenersPositionConditionalSimple("hour",this.hour),this.callListenersPositionConditionalComplex("hour",this.hour)),t.minute!==this.minute&&(this.minute=t.minute,this.callListenersPositionRepetitive("minute"),this.callListenersPositionConditionalSimple("minute",this.minute),this.callListenersPositionConditionalComplex("minute",this.minute)),t.second!==this.second&&(this.second=t.second,this.callListenersPositionRepetitive("second"),this.callListenersPositionConditionalSimple("second",this.second),this.callListenersPositionConditionalComplex("second",this.second))},c.prototype.callEventListeners=function(e,t){var n,r,i,s,o=[];i=this.allListenersByType.event.instance,i[e]&&(o=o.concat(i[e])),i=this.allListenersByType.event.searchstring,i[e]&&(o=o.concat(i[e]));if(o)for(n=o.length-1;n>=0;n--)r=o[n],s=this.allListenersById[r],s.callback(t)},c.prototype.callListenersPositionRepetitive=function(e){var t,n=this.allListenersByType.position.repetitive[e],r=this;n&&n.forEach(function(e){t=r.allListenersById[e],t.callback(t.searchstring)})},c.prototype.callListenersPositionConditionalSimple=function(e,t){var n,r,i,s=!1,o=this.allListenersByType.position.conditional_simple[e],u=this;o&&o.forEach(function(e){n=u.allListenersById[e],r=n.data,i=n.operator;switch(i){case">":s=t>r;break;case"<":s=t<r;break;case"%=":s=(t+1)%(r+1)===0;break;case"!=":case"!==":s=t!==r;break;case"===":s=t===r}s===!0&&n.callback(n.searchstring)})},c.prototype.callListenersPositionConditionalComplex=function(e,t){var n,r,i,s,o,u=this.allListenersByType.position.conditional_complex[e],a=this;u&&u.forEach(function(e){n=a.allListenersById[e],r=n.value1,i=n.value2,s=n.operator1,o=n.operator2,s==="<"?(t<r||t>i)&&n.callback(n.searchstring):s===">"&&t>r&&t<i&&n.callback(n.searchstring)})},c.prototype.callListenersPositionTicks=function(e){var t=this.allListenersByType.position.ticks,n,r=t.length,i;for(n=0;n<r;n++)i=this.allListenersById[t[n]],e>=i.ticks&&!i.called&&(i.callback(i.searchstring),i.called=!0)},c.prototype.addEventListener=function(n,r,i){var o,u,a,l,c,h,p,d,v=[],m=t(r);if(t(i)!=="function")return console.error(i,"is not a function; please provide a function for callback"),-1;if(n==="position")return d=this.addPositionEventListener(r,i),d;if(m==="string"){u=e(this.song,r),this.searchPatterns.push({searchstring:r,callback:i,type:"event",subtype:"searchstring"});if(u.length===0)return-1;h="searchstring",l=this.allListenersByType.event.searchstring,this.eventListenersBySearchstring[r]=c=[]}else{u=f(n,r);if(u===-1)return-1;h="instance",l=this.allListenersByType.event.instance}n==="note"&&(u=e(u,"type = NOTE_ON OR type = NOTE_OFF"));for(o=u.length-1;o>=0;o--)a=u[o],d="event_"+s++,p={id:d,event:a,type:n,subtype:h,callback:i},this.allListenersById[d]=p,l[a.id]===undefined&&(l[a.id]=[]),l[a.id].push(d),v.push(d),h==="searchstring"&&c.push(d);return h==="searchstring"||m==="array"||n==="note"?v:v[0]},c.prototype.addPositionEventListener=function(e,r){var i,a,f,c,h=e.split(/[\s+]/g),p=h.length,d=h[0],v=h[1],m=h[2],g=h[3],y=h[4],b=t(m);console.log(e,h,p);if(p!==1&&p!==3&&p!==5)return console.error("invalid search string, please consult documentation"),!1;if(o[d]!==1)return console.error(d,"is not a supported event id, please consult documentation"),-1;if(v==="="||v==="==")v="===";switch(d){case"barsbeats":case"barsandbeats":case"time":case"ticks":case"millis":if(v===undefined||v!=="===")return console.error(d,"can only be used conditionally with the operators '===', '==' or '='"),-1;g&&console.warn("this position event type can only be used with a single condition, ignoring second condition");break;case"bar":case"beat":case"sixteenth":case"hour":case"minute":case"second":if(m&&isNaN(m))return console.error("please provide a number"),-1;if(y&&isNaN(y))return console.error("please provide a number"),-1}if(v&&u.indexOf(v)===-1)return console.error(v,"is not a supported operator, please use any of",u),-1;if(v&&m===undefined){console.error("operator without value");return}if(g&&u.indexOf(v)===-1)return console.error(g,"is not a supported operator, please use any of",u),-1;if(g&&y===undefined){console.error("operator without value");return}if(v&&g&&l(v,g)===!1)return console.error("you can't use "+v+" together with "+g),-1;if(t(r)!=="function")return console.error(r,"is not a function; please provide a function for callback"),-1;switch(d){case"bar":case"beat":case"sixteenth":m-=1,y-=1;case"hour":case"minute":case"second":m-=0,y-=0,v&&(v==="<="?(m++,v="<"):v===">="&&(m--,v=">")),g&&(g==="<="?(y++,g="<"):g===">="&&(y--,g=">"));break;case"ticks":m-=0;break;case"barsbeats":case"barsandbeats":isNaN(m)?b==="string"?(m=m.replace(/[\[\]\s]/g,""),m=m.split(","),m=n(this.song,["barsbeats",m[0],m[1]||1,m[2]||1,m[3]||0]).ticks):console.error("please provide a number or an array of numbers"):m=n(this.song,["barsbeats",m,1,1,0]).ticks,d="ticks";break;case"millis":m=n(this.song,["millis",m]).ticks,d="ticks";break;case"time":isNaN(m)?b==="string"?(m=m.replace(/[\[\]\s]/g,""),console.log(m),m=m.split(","),m.length===1?(c=m[0]*60*1e3,m=n(this.song,["millis",c]).ticks):m=n(this.song,["time",m[0],m[1],m[2],m[3]]).ticks):console.error("please provide a number or an array of numbers"):(c=m*60*1e3,m=n(this.song,["millis",c]).ticks),console.log(m),d="ticks"}return a="position_"+s++,d==="ticks"?(f={id:a,callback:r,type:"position",subtype:"ticks",ticks:m,searchstring:e},this.allListenersByType.position.ticks.push(a)):!v&&!g?(f={id:a,callback:r,type:"position",subtype:"repetitive",position_type:d,searchstring:e},i=this.allListenersByType.position.repetitive,i[d]===undefined&&(i[d]=[]),i[d].push(a)):v&&!g?(f={id:a,callback:r,type:"position",subtype:"conditional_simple",position_type:d,data:m,operator:v,searchstring:e},i=this.allListenersByType.position.conditional_simple,i[d]===undefined&&(i[d]=[]),i[d].push(a)):v&&g&&(f={id:a,callback:r,type:"position",subtype:"conditional_complex",position_type:d,value1:m,value2:y,operator1:v,operator2:g,searchstring:e},i=this.allListenersByType.position.conditional_complex,i[d]===undefined&&(i[d]=[]),i[d].push(a)),this.allListenersById[a]=f,this.positionListenersBySearchstring[e]=a,a},c.prototype.removeEventListener=function(e){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E=[],S=[],x;e=Array.prototype.slice.call(e[0]),n=e[0],r=e.length;if(r===1){t(n)==="array"?f=n:f=[n];for(m=f.length-1;m>=0;m--){a=f[m];if(this.allListenersById[a]!==undefined){c=this.allListenersById[a],i=c.type,s=c.subtype;if(i==="position"){w=this.allListenersByType[i][s][c.position_type];for(g=w.length-1;g>=0;g--)h=w[g],h!==a&&E.push(h);this.allListenersByType[c.type][c.subtype][c.position_type]=[].concat(E),delete this.allListenersById[a]}else if(i==="event"||i==="note"){p=c.event,d=p.id,w=this.allListenersByType.event[s][d];for(g=w.length-1;g>=0;g--){h=w[g],c=this.allListenersById[h];if(h!==a){E.push(h);break}}this.allListenersByType.event[s][d]=[].concat(E),delete this.allListenersById[a]}console.log(this.allListenersById,this.allListenersByType)}else console.warn("no event listener found with id",a)}}else if(r===2||r===3){i=e[0],o=e[1],u=e[2],x=t(o);switch(i){case"position":if(x==="string"){a=this.positionListenersBySearchstring[o],c=this.allListenersById[a],w=this.allListenersByType[c.type][c.subtype][c.position_type];for(m=w.length-1;m>=0;m--)h=w[m],h!==a&&E.push(h);this.allListenersByType[c.type][c.subtype][c.position_type]=[].concat(E),delete this.allListenersById[a],delete this.positionListenersBySearchstring[o]}break;case"event":case"note":if(x==="string"){w=this.eventListenersBySearchstring[o];for(m=w.length-1;m>=0;m--)S.push(w[m]);v=this.allListenersByType.event.searchstring;for(d in v)if(v.hasOwnProperty(d)){w=v[d],E=[];for(m=w.length-1;m>=0;m--){h=w[m],b=!1;for(g=S.length-1;g>=0;g--)if(h===S[g]){b=!0;break}b===!1?E.push(h):delete this.allListenersById[w[m]]}this.allListenersByType.event.searchstring[d]=[].concat(E)}delete this.eventListenersBySearchstring[o]}else if(x==="object"){if(o.className!=="MidiEvent"&&o.className!=="MidiNote"){console.error("please provide a midi event or a midi note");return}o.className==="MidiNote"?a=o.noteOn.id:o.className==="MidiEvent"&&(a=o.id),this.allListenersByType.event.instance[a]!==undefined?(i="instance",w=this.allListenersByType.event.instance[a]):this.allListenersByType.event.searchstring[a]!==undefined&&(i="searchstring",w=this.allListenersByType.event.searchstring[a]);if(w===undefined){console.warn("no event listener bound to event with id",a);return}o.className==="MidiNote"&&(f=this.allListenersByType.event[i][o.noteOff.id],w=w.concat(f));for(m=w.length-1;m>=0;m--)h=w[m],c=this.allListenersById[h],u&&c.callback!==u?E.push(c.id):delete this.allListenersById[c.id],this.allListenersByType.event[i][c.event.id]=[].concat(E)}}}},f=function(e,n){var r=t(n),i=[],s,o;if(r!=="array"&&n!==undefined&&n.className!=="MidiEvent"&&n.className!=="MidiNote")return console.error(n," is not valid data for event type 'event', please consult documentation"),-1;if(r==="array")for(s=n.length-1;s>=0;s--){o=n[s];if(e==="event"&&o.className!=="MidiEvent"){console.warn("skipping",o,"because it is not a MidiEvent");continue}if(e==="note"&&o.className!=="MidiNote"){console.warn("skipping",o,"because it is not a MidiNote");continue}i.push(o)}else if(e==="event"){if(n.className!=="MidiEvent")return console.error(n," is not a MidiEvent"),-1;i=[n]}else if(e==="note"){if(n.className!=="MidiNote")return console.error(n," is not a MidiNote"),-1;i=[n.noteOn,n.noteOff]}return i},l=function(e,t){switch(e){case"=":case"==":case"===":return!1}switch(t){case"=":case"==":case"===":return!1}return!0},sequencer.protectedScope.createFollowEvent=function(e){return new c(e)},sequencer.protectedScope.addInitMethod(function(){t=sequencer.protectedScope.typeString,n=sequencer.protectedScope.getPosition,i=sequencer.midiEventNumberByName,r=sequencer.midiEventNameByNumber,e=sequencer.findEvent})}(),function(){"use strict";var e,t,n,r,i,s,o,u,a,f;f=function(n,r,i,s,o){var u,a,f,l;if(n===undefined){console.error("please provide a song");return}if(r===undefined||i===undefined){console.error("please provide a coordinate");return}if(s===undefined||o===undefined){console.error("please provide width and height");return}return u=t(r/s*n.ticks),a=n.highestNote-t(i/o*n.pitchRange),f=e(n,["ticks",u]),a=sequencer.createNote(a),{position:f,note:a}},sequencer.positionToSong=sequencer.coordinatesToPosition=sequencer.gridToSong=function(){var e=Array.prototype.slice.call(arguments),t=e.length,n=e[0];return t===4&&n.className!=="Song"?f(sequencer.getSong(),n,e[1],e[2],e[3]):f(n,e[1],e[2],e[3],e[4])},sequencer.songToGrid=function(){var e=Array.prototype.slice.call(arguments),t=e.length,n=e[0],r=e[1];switch(t){case 3:o(n,r,e[2]);break;case 4:n==="x"?s(r,e[2],e[3]):n==="y"&&u(r,e[2],e[3]);break;case 6:break;default:console.error("wrong number of arguments")}},o=function(e,t,n,r){r===undefined&&(r=sequencer.getSong());if(e.type!==sequencer.NOTE_ON&&e.type!==sequencer.NOTE_OFF)return console.error("please provide a NOTE_ON or a NOTE_OFF event"),null;var i=e.millis/r.durationMillis*t,o,a=sequencer.createNote(e.noteNumber);return{x:s(["ticks",e.ticks],t,r),y:u(a,n,r)}},s=function(n,i,s){s===undefined&&(s=sequencer.getSong());if(r(n)==="array"||n.type!=="ticks")n=e(s,n);var o=t(n.ticks/s.quantizeTicks)*s.quantizeTicks;return o/=s.ticks,o*=i,o},u=function(e,t,n){n===undefined&&(n=sequencer.getSong());var r=e.number,i;return r<n.lowestNote||r>n.highestNote?(console.error("note is out of range of the pitch range of this song"),null):(i=(r-n.highestNote)/n.pitchRange,i=i<0?-i:i,i*=t,i)},sequencer.protectedScope.addInitMethod(function(){e=sequencer.protectedScope.getPosition,t=sequencer.protectedScope.floor,n=sequencer.protectedScope.round,r=sequencer.protectedScope.typeString})}(),function(){"use strict";function f(e,t){var r=e.lastEventTmp,i,s;e.fixedLength?e.lastBar=e.bars:t?e.lastBar=r.bar:e.lastBar=Math.max(e.lastBar,r.bar),e.bars=parseInt(e.lastBar),i=n(e,["barsandbeats",e.bars,r.nominator,r.numSixteenth,r.ticksPerSixteenth,!0]),e.durationTicks=i.ticks,e.durationMillis=i.millis;for(s in i)i.hasOwnProperty(s)&&(e.lastEvent[s]=i[s])}function l(e,t){var n=t.concat(e.timeEvents);i(e,n),t=t.concat(e.events),t.sort(function(e,t){return e.ticks-t.ticks}),e.songAndMetronomeEvents=[].concat(t)}function c(e,t){var n,r;for(n=t.length-1;n>=0;n--)r=t[n],r.startPosition=e.getPosition("ticks",r.start.ticks),r.endPosition=e.getPosition("ticks",r.end.ticks),r.start.millis=r.startPosition.millis,r.end.millis=r.endPosition.millis,r.duration.millis=r.end.millis-r.start.millis,r.state="clean"}function h(t,n){var r,i;for(r=n.length-1;r>=0;r--)i=n[r],i.endless===!0?(i.durationTicks=e.ticks-i.noteOn.ticks,i.durationMillis=e.millis-i.noteOn.millis):(i.durationTicks=i.noteOff.ticks-i.noteOn.ticks,i.durationMillis=i.noteOff.millis-i.noteOn.millis),i.ticks=i.noteOn.ticks,i.millis=i.noteOn.millis,i.number=i.noteOn.noteNumber,i.state="clean"}function p(t,n){var r,i,s,o,u,a=t.recordTimestamp,f=t.recordStartMillis,l=f,c=n.length,h=t.playheadRecording;h.set("millis",f);for(r=0;r<c;r++)o=n[r],u=o.recordMillis-a+f,s=h.update("millis",u-l),l=u,i=e.getNiceTime(s.millis),o.ticks=s.ticks,o.bpm=s.bpm,o.factor=s.factor,o.nominator=s.nominator,o.denominator=s.denominator,o.ticksPerBar=s.ticksPerBar,o.ticksPerBeat=s.ticksPerBeat,o.ticksPerSixteenth=s.ticksPerSixteenth,o.numSixteenth=s.numSixteenth,o.millisPerTick=s.millisPerTick,o.secondsPerTick=s.secondsPerTick,o.millis=s.millis,o.seconds=s.millis/1e3,o.hour=i.hour,o.minute=i.minute,o.second=i.second,o.millisecond=i.millisecond,o.timeAsString=i.timeAsString,o.timeAsArray=i.timeAsArray,o.bar=s.bar,o.beat=s.beat,o.sixteenth=s.sixteenth,o.tick=s.tick,o.barsAsString=s.bar+":"+s.beat+":"+s.sixteenth+":"+s.tick,o.barsAsArray=[s.bar,s.beat,s.sixteenth,s.tick],o.state="clean";t.recordStartMillis=undefined,t.recordTimestamp=undefined}function d(e){var t=e.length,n,r,i=-1e5,s,o=[];for(n=0;n<t;n++)r=e[n],s===undefined&&(s=[]),s.push(r),r.ticks!==i&&(s.length>1?(s.sort(function(e,t){return t.type===144&&e.type===128?!1:t.type===144&&e.type===176&&e.data1===64&&e.data2===127?!1:t.type===176&&t.data1===64&&t.data2===127&&e.type===128?!1:t.type===128&&e.type===176&&e.data1===64&&e.data2===0?!1:t.type===144&&e.type===176&&e.data1===64&&e.data2===0?!1:e.type===176&&e.data1===64&&e.data2===0&&t.type===176&&t.data1===64&&t.data2===127?!1:!0}),o=o.concat(s),s=undefined):o.push(s[0])),i=r.ticks}var e=window.sequencer,t=window.console,n,r,i,s,o,u,a;u=function(t,n){if(e.playing===!0){o.updateSong=function(){a(t,n)};return}a(t,n)},a=function(e,t){var n,s,o,u,a,l,d,v,m,g,y,b=[],w=[],E=[],S=[],x=[],T=[],N=[],C=[],k=[],L=[],A=[],O=[],M=[],_=[],D=[],P=[],H=[],B=[],j=[],F={},I={},q={};t===!0&&r(e);for(s in e.tracksById)if(e.tracksById.hasOwnProperty(s)){l=e.tracksById[s],l.needsUpdate===!0&&l.update();for(o in l.partsById)if(l.partsById.hasOwnProperty(o)){d=l.partsById[o],d.needsUpdate===!0&&d.update(),g=d.dirtyEvents;for(u in g)if(g.hasOwnProperty(u)){v=g[u];switch(v.state){case"new":b.push(v);break;case"recorded":S.push(v);break;case"changed":w.push(v);break;case"removed":E.push(v),delete d.eventsById[u]}}y=d.dirtyNotes;for(u in y)if(y.hasOwnProperty(u)){m=y[u];switch(m.state){case"new":x.push(m);break;case"changed":T.push(m);break;case"removed":N.push(m),delete d.notesById[u]}}d.dirtyEvents={},d.dirtyNotes={},d.state!=="removed"?(H=H.concat(d.notes),P=P.concat(d.events)):(N=N.concat(d.notes),E=E.concat(d.events));switch(d.state){case"new":C.push(d),q[d.id]=d;break;case"changed":k.push(d),q[d.id]=d;break;case"removed":L.push(d),delete l.partsById[d.id]}}B=B.concat(l.parts);switch(l.state){case"clean":l.index=j.length,j.push(l);break;case"new":A.push(l),l.state="clean",l.index=j.length,j.push(l);break;case"changed":O.push(l),l.state="clean",l.index=j.length,j.push(l);break;case"removed":M.push(l),delete e.tracksById[l.id]}}S.length>0&&p(e,S),D=[].concat(P,e.timeEvents),D.sort(function(e,t){return e.ticks-t.ticks}),P.sort(function(e,t){return e.ticks-t.ticks}),H.sort(function(e,t){return e.ticks-t.ticks}),B.sort(function(e,t){return e.ticks-t.ticks});for(n=P.length-1;n>=0;n--)v=P[n],F[v.id]=v;for(n=H.length-1;n>=0;n--)m=H[n],I[m.id]=m;t===!1?(a=e.timeEvents.concat(b,w),i(e,a),a=[].concat(x,T),h(e,a),a=[].concat(C,k),c(e,a)):(a=e.timeEvents.concat(P),i(e,a),h(e,H),c(e,B)),f(e),e.metronome.bars!==e.bars?e.metronome.update():t===!0&&e.metronome.update(),_=[].concat(P,e.metronome.events),_.sort(function(e,t){return e.ticks-t.ticks}),e.songAndMetronomeEvents=_,e.songAndTimeEvents=D,e.events=P,e.notes=H,e.parts=B,e.tracks=j,e.numEvents=P.length,e.numNotes=H.length,e.numParts=B.length,e.numTracks=j.length,e.eventsById=F,e.notesById=I,e.partsById=q,e.newEvents=b,e.changedEvents=w,e.removedEvents=E,e.newNotes=x,e.changedNotes=T,e.removedNotes=N,e.newParts=C,e.changedParts=k,e.removedParts=L,e.grid!==undefined&&e.grid.update(),e.keyEditor!==undefined&&e.keyEditor.updateSong({numBars:e.bars,newEvents:b,changedEvents:w,removedEvents:E,newNotes:x,changedNotes:T,removedNotes:N,newParts:C,changedParts:k,removedParts:L})},e.protectedScope.update=u,e.protectedScope.checkDuration=f,e.protectedScope.parseMetronomeEvents=l,e.protectedScope.addInitMethod(function(){n=e.protectedScope.getPosition,i=e.protectedScope.parseMidiEvents,r=e.protectedScope.parseTimeEvents,s=e.protectedScope.getInstrument,o=e.protectedScope.scheduledTasks})}(),function(){"use strict";function S(e,t){var n=!1;return e?e.className==="Part"?n=e:s(e)==="string"?n=t.partsById[e]:isNaN(e)===!1&&(n=t.parts[e]):n=!1,n}function x(e,t){var n=!1;return e?e.className==="MidiEvent"?n=e:s(e)==="array"&&e.length===4?n=l(e):s(e)==="string"?n=t.eventsById[e]:isNaN(e)===!1&&(n=t.events[e]):n=!1,n}function T(e,n){e=Array.prototype.slice.call(e);var r=0,i=0,o,u,a,f=e[0],l=[],c=[];if(s(f)==="array"){for(i=f.length-1;i>=0;i--)a=f[i],u=S(a,n),u&&l.push(u);r=l.length===0?0:1}o=e.length;for(i=r;i<o;i++)a=e[i],u=S(a,n),u?l.push(u):c.push(a);return l.length===0?(t.warn("no parts added"),!1):{parts:l,config:c}}function N(e,r){e=Array.prototype.slice.call(e);var i=0,o=0,u,a,f,l=e[0],c=[],h=[];if(s(l)==="array"){for(o=l.length-1;o>=0;o--)f=l[o],a=x(f,r),a&&c.push(a);i=1}u=e.length;for(o=i;o<u;o++)f=e[o],a=x(f,r),a?c.push(a):h.push(f);return c.length===0&&n>=2&&t.info("Please provide one or more events, or an array of events"),h.length===1&&s(h[0])==="array"&&(h=h[0]),{events:c,config:h}}function C(e,n){var r,i;e=f(e);if(e===!1)return!1;r=e[0];if(n===undefined&&r!=="ticks")return t.error("Track has not been added to a song yet, you can only use tick values"),!1;switch(r){case"ticks":i=e[1];break;case"millis":i=n.millisToTicks(e[1]);break;case"barsbeats":case"barsandbeats":case"time":e=n.getPosition(e,"ticks"),i=e.ticks}return i}function k(e,n){if(e===!1)return;var r,i,s,o,u,a,f,l=n.song,c=e.parts,h=c.length,p=n.partsById;for(r=0;r<h;r++){o=S(c[r]);if(o===!1){t.error(o,"is not a part");continue}o.track!==undefined&&(o=o.copy()),o.track!==undefined&&(o=o.copy()),o.song=l,o.track=n,o.trackId=n.id,u=o.eventsById,a=o.ticks,f=a!==0;for(i in u)u.hasOwnProperty(i)&&(s=u[i],s.track=n,s.channel=n.channel,s.trackId=n.id,f&&(s.ticks+=a),s.state="new");o.state="new",o.needsUpdate=!0,p[o.id]=o}n.needsUpdate=!0}function L(e,t){if(e===!1)return;var n,r,i=e.parts,s=e.config[0],o=s,u;for(u=i.length-1;u>=0;u--)r=i[u],n=r.ticks+s,n<0&&(n=0,o=-r.ticks),r.ticks=n,r.moveEvents(r.events,o),r.state!=="new"&&(r.state="changed");t.needsUpdate=!0}function A(e,n){if(e===!1)return;var r,i,s,o,u=n.song,a=e.parts,f=e.config;for(r=a.length-1;r>=0;r--){i=a[r],s=C(f[r],u);if(s===!1){t.warn("wrong position data, skipping part",i.id);continue}o=s-i.ticks,i.ticks=s,i.moveAllEvents(o),i.state!=="new"&&(i.state="changed")}n.needsUpdate=!0}function O(e,n){if(e===!1)return;var r,i,s=[],o=e.parts;if(o===undefined)return t.log("weird situation, check this when it happens"),[];for(r=o.length-1;r>=0;r--){i=o[r];if(i.track!==undefined&&i.track!==n){t.warn("can't remove: this part belongs to track",i.track.id);continue}s.push(i),i.state="removed",i.reset(!0,!0)}return n.needsUpdate=!0,s.length===1?s[0]:s}function M(e,n){if(e===!1)return;var r,i,s,o,u={},a=[],f=e;for(r=f.length-1;r>=0;r--){o=f[r];if(o.track!==undefined&&o.track!==n){t.warn("can't remove: this event belongs to track",o.track.id);continue}s=o.partId,u[s]===undefined&&(u[s]=[]),u[s].push(o),a.push(o)}for(s in u)u.hasOwnProperty(s)&&(i=n.partsById[s],i.removeEvents(u[s]));return n.needsUpdate=!0,a}function _(t){var n;t.song!==undefined&&t.song.defaultInstrument!==undefined&&(n=u(t.song.defaultInstrument,e.storage.instruments));if(n===!1||n===undefined)n=u(e.defaultInstrument,e.storage.instruments);return n}var e=window.sequencer,t=window.console,n=e.debug,r=Array.prototype.slice,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w=0,E;E=function(e,t,n){this.className="Track",this.id="T"+w++ +""+(new Date).getTime(),this.type=t||"instrument",this.name=e||this.id,this.song=n,this.instrumentName="",this.events=[],this.eventsById={},this.notes=[],this.notesById={},this.parts=[],this.partsById={},this.numParts=0,this.numEvents=0,this.needsUpdate=!1,this.effects={},this.numEffects=0,this.volume=1,this.input=h.createGainNode(),this.input.gain.value=1,this.output=h.createGainNode(),this.output.gain.value=this.volume,this.panner=d(),this.input.connect(this.panner.node),this.panner.node.connect(this.output),this.lastEffect=this.input,this.midiInputs={},this.midiOutputs={},this.routeToMidiOut=!1,this.midiEventListeners={},this.monitor=!1,this.recordEnabled=!1,this.mute=!1,this.solo=!1,this.channel="any",this.quantizeValue=0,this.fixedLengthValue=0,this.autoQuantize=!1,this.retrospectiveRecording=[],this.recordingNotes={},this.enableRetrospectiveRecording=!1,t!=="metronome"&&this.setInstrument(this.instrumentName)},E.prototype.addPart=E.prototype.addParts=function(){var e=T(arguments,this);k(e,this)},E.prototype.addPartAt=E.prototype.addPartsAt=function(){var e=T(arguments,this),n,r,i,s,o;if(e===!1)return;r=e.parts,n=e.config;if(n===undefined)return t.error("please provide position data"),!1;for(i=r.length-1;i>=0;i--){s=r[i],n[0]==="ticks"?o=n[1]:o=C(n[i],this.song);if(o===!1)continue;s.ticks+=o}k(e,this)},E.prototype.movePart=E.prototype.moveParts=function(){var e=T(arguments,this);L(e,this)},E.prototype.movePartTo=E.prototype.movePartsTo=function(){t.log("movePartTo",arguments);var e=T(arguments,this);A(e,this)},E.prototype.moveAllParts=function(e){this.moveParts({parts:this.parts,config:[e]})},E.prototype.copyPart=E.prototype.copyParts=function(){var e=T(arguments,this),n,r=[];if(e===!1)return;if(n.length===0){t.error("no parts");return}return n=e.parts,n.forEach(function(e){r.push(e.copy())}),r.length===1?r[0]:r},E.prototype.removePart=E.prototype.removeParts=function(){var e=T(arguments,this);return O(e,this)},E.prototype.getPart=function(e){return S(e)},E.prototype.getParts=function(){var e=Array.prototype.slice.call(arguments),t,n=[],r;return r=function(e,i){t=e[i],s(t)==="array"?r(t,0):n.push(S(t))},r(e,0),n},E.prototype.getPartAt=E.prototype.getPartsAt=function(e){var n=C(e,this.song),r=this.parts,i=[];if(n===!1){t.error("please provide position as array, for instance: ['barsandbeats',5,1,2,0]");return}return r.forEach(function(e){e.ticks===n&&i.push(e)}),i},E.prototype.getPartFromTo=E.prototype.getPartsFromTo=function(e,n){var r=this.parts,i=[],s=C(e,this.song),o=C(n,this.song);if(s===!1){t.error("invalid position data for from position");return}if(o===!1){t.error("invalid position data for from position");return}return r.forEach(function(e){(s>=e.start.ticks&&s<=e.end.ticks||o>=e.start.ticks&&o<=e.end.ticks)&&i.push(e)}),i},E.prototype.getPartBetween=E.prototype.getPartBetween=function(e,n){var r=this.parts,i=[],s=C(e,this.song),o=C(o,this.song);if(s===!1||o===!1){t.error("please provide position as array, for instance: ['barsandbeats',5,1,2,0]");return}return r.forEach(function(e){e.start.ticks>=s&&e.end.ticks<=o&&i.push(e)}),i},E.prototype.copy=function(){var e=new E(o(this.name)),t,n,r,i=this.parts,s=[];e.song=null,e.instrumentId=this.instrumentId,e.numEffects=this.numEffects;if(this.numEffects>0){e.effects={};for(n in this.effects)this.effects.hasOwnProperty(n)&&(r=this.effects[n],e.effects[r.id]=r.copy())}for(n=i.length-1;n>=0;n--)t=i[n],s.push(t.copy());return e.addParts(s),e},E.prototype.removeEvent=E.prototype.removeEvents=function(){var e=N(arguments,this);M(e.events,this)},E.prototype.removeEventsFromTo=function(e,n){t.warn("removeEventsFromTo() is temporarily disabled")},E.prototype.removeEventAt=E.prototype.removeEventsAt=function(e){t.warn("removeEventAt() is temporarily disabled")},E.prototype.removeAllEvents=function(){M(this.events,this)},E.prototype.transposePart=function(e,t){var n=e.getStats("noteNumber all"),r=0,i=127,s;this.song&&(r=this.song.lowestNote,i=this.song.highestNote);if(n.min+t<r){s=r-n.min;return}if(n.max+t>i){s=i=n.max;return}e.transposeAllEvents(t)},E.prototype.reset=function(){var e,t;this.song=null;for(e in this.partsById)this.partsById.hasOwnProperty(e)&&(t=this.partsById[e],t.reset(!1,!0));this.needsUpdate=!0},E.prototype.findEvent=function(e){return g(this,e)},E.prototype.findNote=function(e){return y(this,e)},E.prototype.getStats=function(e){return b(this,e)},E.prototype.update=function(){this.parts=[],this.notes=[],this.events=[];var e,t,n,r,i;for(t in this.partsById)this.partsById.hasOwnProperty(t)&&(n=this.partsById[t],n.needsUpdate===!0&&n.update(),n.state!=="removed"&&(this.parts.push(n),this.notes=this.notes.concat(n.notes),this.events=this.events.concat(n.events)));this.parts.sort(function(e,t){return e.ticks-t.ticks}),this.notes.sort(function(e,t){return e.ticks-t.ticks}),this.events.sort(function(e,t){return e.ticks-t.ticks}),this.numEvents=this.events.length,this.numNotes=this.notes.length,this.numParts=this.parts.length;for(e=this.numEvents-1;e>=0;e--)r=this.events[e],this.eventsById[r.id]=r;for(e=this.numNotes-1;e>=0;e--)i=this.notes[e],this.notesById[i.id]=i;this.needsUpdate=!1},E.prototype.getIndex=function(){var e=-1,t=this.song.tracks,n=t.length,r,i;if(n>0)for(i=0;i<n;i++){r=t[i];if(r.id===this.id){e=i;break}}return e},E.prototype.addEffect=function(e,t){if(!e)return;this.effects[e.id]=e,this.numEffects++,this.lastEffect!==undefined&&(this.lastEffect.disconnect(0),e.setInput(this.lastEffect)),e.output.connect(this.panner.node),this.lastEffect=e.output},E.prototype.removeEffect=function(e){if(e===!1)return;delete this.effects[e.id],this.numEffects--},E.prototype.setEffectPosition=function(e,t){var n,r,i=this.numEffects-1;if(t<0||t>i)return;e.position=t;for(n=0;n<i-1;n++)r=this.effects[n],r.position>=t&&r!==e&&(r.position+=1)},E.prototype.setSolo=function(e){e===undefined&&(e=!this.solo),this.mute=!1,this.solo=e,this.song&&this.song.setTrackSolo(this,e)},E.prototype.setPartSolo=function(e,t){var n,r;for(n=this.numParts-1;n>=0;n--)r=this.parts[n],t===!0?r.mute=r===e?!t:t:t===!1&&(r.mute=!1),r.solo=r===e?t:!1},E.prototype.setVolume=function(n){isNaN(n)?e.debug>=1&&t.error("please pass a number"):n<0||n>1?e.debug>=1&&t.error("please pass a float between 0 and 1"):(this.volume=n,this.output.gain.value=this.volume)},E.prototype.getVolume=function(){return this.volume},E.prototype.setPanning=function(e){this.panner.setPosition(e)},E.prototype.connect=function(e){this.output.connect(e)},E.prototype.disconnect=function(e){this.output.disconnect(0)},E.prototype.setInstrument=function(e){if(e===""||e===undefined||e===!1)e=_(this);var t=p(e);t===!1&&(t=p(_(this))),t.track=this,this.instrument&&this.instrument.allNotesOff(),this.instrument=t,this.instrumentId=t.name,this.song&&(this.instrument.song=this.song)},E.prototype.setMidiInput=function(t,n){var r,i,s=this.midiInputs,o;n=n===undefined?!0:n;if(t==="all"){o=this.song!==undefined?this.song.midiInputs:e.midiInputs,a(o,function(e,t){n===!0?s[t]=e:delete s[t]});return}r=this.song.midiInputs[t];if(r===undefined)return;n?this.midiInputs[t]=r:delete this.midiInputs[t]},E.prototype.setMidiOutput=function(e,t){t=t===undefined?!0:t;var n=this.song.midiOutputs[e],r=this;if(n===undefined)return;t===!0&&this.instrument.allNotesOff(),t?this.midiOutputs[e]=n:delete this.midiOutputs[e],this.routeToMidiOut=!1,a(this.midiOutputs,function(e,t){e!==!1&&(r.routeToMidiOut=!0)})},E.prototype.prepareForRecording=function(t){if(this.recordEnabled===!1)return;this.recordId=t,this.recordPart=e.createPart(),this.addPart(this.recordPart),this.recordingNotes={}},E.prototype.stopRecording=function(e){if(this.recordId!==e)return;this.recordingNotes={};if(this.autoQuantize||this.song.autoQuantize)n>=1&&t.log("performing auto quantize"),this.quantizeRecording();return this.recordPart.update(),this.recordPart.events},E.prototype.undoRecording=function(e){var t=s(e);t==="string"?this.recordId===e&&this.removePart(this.recordPart):t==="array"&&this.removeEvents(e)},E.prototype.quantizeRecording=function(t){return t=t||this.quantizeValue,e.quantize(this.recordPart.events,t,this.song.ppq)},E.prototype.quantize=function(){var t,n,i,o=r.call(arguments),u=o.length,a,f={};for(t=0;t<u;t++)n=o[t],i=s(n),i==="string"||i==="number"?a=n:i==="object"&&(f=n);return a===undefined&&(a=this.quantizeValue),e.quantize(this.events,a,this.song.ppq,history)},E.prototype.undoQuantize=function(n){if(n===undefined){e.debug>=2&&t.warn("please pass a quantize history object");return}var r=n.tracks[this.id].quantizedEvents,i=r.length,s,o;for(s=0;s<i;s++)o=r[s],o.ticks=n.events[o.id].ticks},E.prototype.addMidiEventListener=function(){return v(arguments,this)},E.prototype.removeMidiEventListener=function(e){m(e,this)},e.protectedScope.Track=E,e.createTrack=function(e,t,n){return new E(e,t,n)},e.protectedScope.addInitMethod(function(){var t=e.protectedScope;b=e.getStats,g=e.findEvent,y=e.findNote,i=e.createPart,l=e.createMidiEvent,c=e.createMidiNote,p=e.createInstrument,d=e.createPanner,h=t.context,u=t.findItem,v=t.addMidiEventListener,m=t.removeMidiEventListener,f=t.checkPosition,a=t.objectForEach,s=t.typeString,o=t.copyName})}(),function(){"use strict";function o(){window.Pitchshift&&(s=new t(i,r.sampleRate,"FFT"))}function u(e,t,i){if(s===undefined){n.log("include Kiev II");return}if(t===0&&i){i(e);return}var o=e.numberOfChannels,u,a,f,l,c=[],h,p,d;for(u=0;u<o;u++){a=e.getChannelData(u),f=a.length,l=new Float32Array(f),h=Math.pow(1.0595,t),s.process(h,a.length,4,a);for(p=0;p<f;p++)l[p]=s.outdata[p];c[u]=l}d=r.createBuffer(o,f,e.sampleRate);for(u=0;u<o;u++)d.getChannelData(u).set(c[u]);i(d)}var e=window.sequencer,t=window.Pitchshift,n=window.console,r,i=2048,s;e.protectedScope.transpose=u,e.protectedScope.addInitMethod(function(){r=e.protectedScope.context,o()})}(),function(){"use strict";function l(e){if(typeof e!="object")return typeof e;if(e===null)return"null";var t=Object.prototype.toString.call(e).match(/\[object\s(\w+)\]/)[1];return t.toLowerCase()}function c(e){var t,n,r,i,s,o="";return s=e/1e3,t=y(s/3600),n=y(s%3600/60),r=y(s%60),i=g((s-t*3600-n*60-r)*1e3),o+=t+":",o+=n<10?"0"+n:n,o+=":",o+=r<10?"0"+r:r,o+=":",o+=i===0?"000":i<10?"00"+i:i<100?"0"+i:i,{hour:t,minute:n,second:r,millisecond:i,timeAsString:o,timeAsArray:[t,n,r,i]}}function h(e){var t,n;if(e===null||typeof e!="object")return e;n=e.constructor();for(t in e)e.hasOwnProperty(t)&&(n[t]=h(e[t]));return n}function p(e){var t,n={};if(l(e)!=="object")return{};for(t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n}function d(e){var t=e.indexOf("_copy"),n,r;return t===-1?n=e+"_copy":(r=e.substring(t+5),r===""?n=e+"2":n=e.slice(0,-1)+(parseInt(r,10)+1)),n}function v(e,t){var n,r,i,s,o=[],u,a,f;l(e)!=="array"&&(e=[e]),i=t.length,s=e.length;for(n=0;n<i;n++){a=t[n],u=!1;for(r=0;r<s;r++){f=e[r];if(a===f){u=!0;break}}u===!1&&o.push(a)}return o}function m(e,t){var n,r=e.length,i,s=[];for(n=0;n<r;n++)i=e[n],t(i)===!1&&s.push(i);return s}function g(e,t){if(t===undefined||t<=0)return i(e);var n=r(10,t);return i(e*n)/n}function y(e,t){if(t===undefined||t<=0)return s(e);var n=r(10,t);return s(e*n)/n}function b(e,t){if(e===undefined)return!1;var n,r=!0;t=t||"";for(n in e)if(e.hasOwnProperty(n)&&t.indexOf(n)===-1){r=!1;break}return r}function w(e,t){var n,r=e;for(n in r)r.hasOwnProperty(n)&&t(r[n],n)}function E(e){var t,n=[];for(t in e)e.hasOwnProperty(t)&&n.push(e[t]);return n}function S(e,t){var n,r={};for(n=e.length-1;n>=0;n--)r[e[n][t]]=e[n];return r}function x(e,t){var n;return n=function(){this.parent=e,arguments.length>0&&(e.apply(this,arguments),t!==undefined&&t.apply(this,arguments))},n.prototype=Object.create(e.prototype),n}function T(e){var t=new XMLHttpRequest,n=e.method===undefined?"GET":e.method,r;t.onreadystatechange=function(){t.request===404&&e.onError(404)},t.onload=function(){if(t.status!==200){e.onError(t.status);return}e.responseType==="json"?(r=t.response.length,e.onSuccess(JSON.parse(t.response),r)):e.onSuccess(t.response)},t.onerror=function(t){e.onError(t)},t.open(n,e.url,!0),e.overrideMimeType&&t.overrideMimeType(e.overrideMimeType),e.responseType&&(e.responseType==="json"?t.responseType="text":t.responseType=e.responseType),n==="POST"&&t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.data?t.send(e.data):t.send()}function N(e,t,n){var r,i;for(r in e){if(f!==!1)return;if(e.hasOwnProperty(r)){i=e[r];if(i!==undefined&&i.className==="Folder"){if(r===t){f=i;return}N(i,t,n+".")}}}}function C(e,t,n,r){var i,s;for(i in e)if(e.hasOwnProperty(i)){if(i==="id"||i==="path"||i==="className")continue;s=e[i];if(s===undefined)continue;s.className==="Folder"?n===!0&&C(s,t,n,r+"."):s.name===undefined?t.push({name:i,data:s}):t.push(s)}}function k(e,t,n){n=n===undefined?!0:n;var r=H(e),i=r.length,s,o,u,a=r[i-1],l=[];if(i===0)C(t,l,n,".");else{s=t;for(o=0;o<i;o++){u=r[o],s=s[u];if(s===undefined)break}s?C(s,l,n,"."):(f=!1,N(t,a,"."),C(f,l,n,"."))}return l.sort(function(e,t){var n=e.name.toLowerCase(),r=t.name.toLowerCase();return n<r?-1:n>r?1:0}),l}function L(e,t,n){var r,i,s;for(r in e){if(a!==!1)return;if(e.hasOwnProperty(r)){i=e[r],s=l(i);if(r===t){a=i;break}i!==undefined&&i.className==="Folder"&&(n+=".",L(i,t,n))}}}function A(e,t,n){n=n===undefined?!1:n;if(e===undefined||e==="")return t;var r,i,s,o,u,f,l;s=H(e),l=s.pop(),o=s.length;if(l==="")return t;a=!1;if(s.length>0){u=t;for(r=0;r<o;r++){i=s[r],u=u[i];if(u===undefined)break}u&&(f=u[l])}return f===undefined&&(n===!0?f=t[l]:(L(t,l,"."),f=a)),f===undefined&&(f=!1),f}function O(e,t,n){var r,i,s,o,u,a="";i=H(t),s=i.length,o=n;for(u=0;u<s;u++){r=i[u],a+="/"+r,o[r]===undefined&&(o[r]={path:a,className:"Folder"});if(u===s-1){o[r]=e;break}o=o[r]}}function M(e,t){var n,r,i,s=t;n=A(e,t,!0);if(!n)return!1;if(n.className==="Folder")for(i in n)n.hasOwnProperty(i)&&i!=="className"&&delete n[i];e=H(e);while(e.length>1){i=0,s=t;while(i<e.length-1)s=s[e[i++]];r=e[i],n=s[r],n.className==="Folder"?b(n,"path className")&&delete s[r]:delete s[r],e.pop()}return e.length===1&&e[0]!==""&&(r=e[0],n=t[r],n.className==="Folder"?b(t[r],"path className")&&delete t[r]:delete t[r]),!0}function _(e){var t,n,r,i,s;t=e||"",n=[],r=t.length,i=String.fromCharCode;for(s=0;s<r;s++)n[s]=i(t.charCodeAt(s)&255);return n.join("")}function D(e){var t,n,r,i,s;t=e||"",r=t.length,n=new Uint8Array(r),i=String.fromCharCode;for(s=0;s<r;s++)n[s]=i(t.charCodeAt(s)&255);return n}function P(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",n,r,i,s,o,u,a,f,l,c,h,p,d,v=0;n=Math.ceil(3*e.length/4),i=new ArrayBuffer(n),r=new Uint8Array(i),s=t.indexOf(e.charAt(e.length-1)),o=t.indexOf(e.charAt(e.length-1)),s==64&&n--,o==64&&n--,e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");for(d=0;d<n;d+=3)l=t.indexOf(e.charAt(v++)),c=t.indexOf(e.charAt(v++)),h=t.indexOf(e.charAt(v++)),p=t.indexOf(e.charAt(v++)),u=l<<2|c>>4,a=(c&15)<<4|h>>2,f=(h&3)<<6|p,r[d]=u,h!=64&&(r[d+1]=a),p!=64&&(r[d+2]=f);return i}function H(e){return e===undefined?[]:(e=e.replace(/undefined/g,""),e=e.replace(/\/{2,}/g,"/"),e=e.replace(/^\//,""),e=e.replace(/\/$/,""),e=e.split("/"),e)}function B(e){var t="",n=e,r="",i,s,o;return e=e.replace(/\/{2,}/g,"/"),e=e.replace(/^\//,""),e=e.replace(/\/$/,""),i=e.lastIndexOf("/"),i!==-1&&(n=e.substring(i+1),t=e.substring(0,i)),s=e.lastIndexOf("."),s!==-1&&(o=e.substring(s+1),o.length>=3&&o.length<=4&&(r=o,n=e.substring(i+1,s))),{path:t,name:n,ext:r}}function j(e,t,n,r,i){if(t===0){r&&r();return}var s=n[e];s.load(function(){i&&i(arguments),e++,e<t?j(e,t,n,r,i):r&&r()})}function F(e){var t=[],r,i;return e=n.call(e),r=function(e,n,s){for(n=0;n<s;n++)i=e[n],l(i)==="array"?r(i,0,i.length):t.push(i)},r(e,0,e.length),t}function I(e,t,n){var r,i,s,o=new Float32Array(e);for(r=0;r<e;r++)s=r/e,t==="fadeIn"?i=Math.cos((1-s)*.5*Math.PI)*n:t==="fadeOut"&&(i=Math.cos(s*.5*Math.PI)*n),o[r]=i,r===e-1&&(o[r]=t==="fadeIn"?1:0);return o}function q(e,t,n,r,i){var s=n-t,o=i-r,u;return u=(e-t)*o/s+r,u}function R(e,t,n){var r,i,s;for(r in e)e.hasOwnProperty(r)&&(i=e[r],i.className===t?n.push(i):(s=l(i),s==="object"&&L(i,t,n)))}function U(e){function s(n){var r=t.valueAsNumber;e.onMouseDown&&e.onMouseDown(r,n),i.onMouseDown&&i.onMouseDown(r,n)}function o(n){var r=t.valueAsNumber;e.onMouseUp&&e.onMouseUp(r,n),i.onMouseUp&&i.onMouseUp(r,n)}function u(n){var r=t.valueAsNumber;e.onMouseMove&&e.onMouseMove(r,n),i.onMouseMove&&i.onMouseMove(r,n)}function a(n){var r=t.valueAsNumber;e.onChange&&e.onChange(r,n),i.onChange&&i.onChange(r,n)}var t=e.slider,n=e.message,r=e.label,i;return e.label===undefined&&(r=t.parentNode.firstChild),e.initialSliderValue!==undefined&&(t.value=e.initialSliderValue),e.initialLabelValue!==undefined&&(r.innerHTML=n.replace("{value}",e.initialLabelValue)),e.min!==undefined&&(t.min=e.min),e.max!==undefined&&(t.max=e.max),e.step!==undefined&&(t.step=e.step),t.addEventListener("mousedown",function(e){setTimeout(s,0,e),t.addEventListener("mousemove",u,!1)},!1),t.addEventListener("mouseup",function(e){setTimeout(o,0,e),t.removeEventListener("mousemove",u,!1)},!1),t.addEventListener("change",function(e){a(e)},!1),i={getValue:function(){return e.getValue?e.getValue(t.valueAsNumber):t.valueAsNumber},setValue:function(n){e.setValue?t.value=e.setValue(n):t.value=n},setLabel:function(e){r.innerHTML=n.replace("{value}",e)},elem:t},i.set=function(e){setLabel(e),setValue(e)},i}function z(e){function i(){var i=u();e.onMouseMove!==undefined&&e.onMouseMove(t.valueAsNumber,i),r.innerHTML=n.replace("{value}",i)}function s(){var i=u();e.onMouseUp!==undefined&&e.onMouseUp(t.valueAsNumber,i),r.innerHTML=n.replace("{value}",i)}function o(){var i=u();e.onMouseDown!==undefined&&e.onMouseDown(t.valueAsNumber,i),r.innerHTML=n.replace("{value}",i)}function u(){var n=t.valueAsNumber;return e.calculate!==undefined&&(n=e.calculate(n)),n}function a(t){return e.calculateFromLabel!==undefined&&(t=e.calculateFromLabel(t)),t}var t=e.slider,n=e.message,r=t.parentNode.firstChild;return e.initialValueSlider&&(t.value=e.initialValueSlider,r.innerHTML=n.replace("{value}",u())),e.initialValueLabel&&(r.innerHTML=n.replace("{value}",e.initialValueLabel),t.value=a(e.initialValueLabel)),t.addEventListener("mousedown",function(){setTimeout(o,0),t.addEventListener("mousemove",i,!1)},!1),t.addEventListener("mouseup",function(){setTimeout(s,0),t.removeEventListener("mousemove",i,!1)},!1),{updateSlider:function(e){t.value=e,r.innerHTML=n.replace("{value}",u(e))},updateLabel:function(e){r.innerHTML=n.replace("{value}",e),t.value=a(e)},getValue1:function(){return t.valueAsNumber},getValue2:function(){return u(t.valueAsNumber)}}}function W(e,t,n){var r=o()*(t-e)+e;return n===!0?i(r):r}function X(t){var n,r=0,i=[],s,o,u,a,f,l,c,h,p,d;t=t||{},d=t.ppq||e.defaultPPQ,u=t.numNotes||20,f=t.noteLength||d/2,l=t.minVelocity||30,c=t.maxVelocity||127,h=t.minNoteNumber||60,p=t.maxNoteNumber||127,f>d&&(f=d);for(n=0;n<u;n++)a=W(h,p,!0),o=W(l,c,!0),s=e.createMidiEvent(r,e.NOTE_ON,a,o),i.push(s),r+=f,s=e.createMidiEvent(r,e.NOTE_OFF,a,0),i.push(s),r+=d-f;return i}function V(){function f(e,t,n){var r,i,s,o,u;for(o=t;o<n;o++){r=e[o],i=l(r);if(i==="array")c(r);else if(i==="object")if(r.className==="Part"||r.className==="Track"||r.className==="Song")c(r.events);else if(r.className==="MidiFile")for(u=r.numTracks-1;u>=0;u--)s=r.tracks[u],s.needsUpdate===!0&&(s.update(),s.events&&c(s.events))}}function c(e){for(u=e.length-1;u>=0;u--)a=e[u],a.ticks=o*a.ticks,a.state!=="new"&&(a.state="changed")}var r=n.call(arguments),i=r[0],s=r[1],o=s/i,u,a;if(isNaN(i)||isNaN(s)){e.debug===4&&t.error("PPQ values must be numbers");return}f(r,2,r.length)}function $(e,t){for(var n in u)if(u.hasOwnProperty(n)&&t===e.ppq/n)return u[n];return!1}function J(e){return g(6e7/e)}function K(e){var t,n=e.indexOf("http://");return n!==-1&&(t=e.substring(n),n=t.indexOf(" "),n!==-1&&(t=t.substring(0,n))),'<a href="'+t+'"></a>'}var e=window.sequencer,t=window.console,n=Array.prototype.slice,r=Math.pow,i=Math.round,s=Math.floor,o=Math.random,u={1:"quarter",2:"eighth",4:"sixteenth",8:"32th",16:"64th"},a,f;e.util.round=g,e.util.floor=y,e.util.remap=q,e.util.getRandom=W,e.util.createSlider=U,e.util.createSlider2=z,e.util.getRandomNotes=X,e.util.getEqualPowerCurve=I,e.util.objectForEach=w,e.util.insertLink=K,e.protectedScope.getNoteLengthName=$,e.protectedScope.toBinaryString=_,e.protectedScope.base64ToBinary=P,e.protectedScope.toUint8Array=D,e.protectedScope.getArguments=F,e.protectedScope.pathToArray=H,e.protectedScope.parseUrl=B,e.protectedScope.loadLoop=j,e.protectedScope.findItem=A,e.protectedScope.storeItem=O,e.protectedScope.deleteItem=M,e.protectedScope.toBinaryString=_,e.protectedScope.ajax=T,e.protectedScope.copyObject=p,e.protectedScope.findItemsInFolder=k,e.convertPPQ=V,e.getNiceTime=c,e.protectedScope.isEmptyObject=b,e.protectedScope.objectForEach=w,e.protectedScope.objectToArray=E,e.protectedScope.arrayToObject=S,e.protectedScope.createClass=x,e.protectedScope.clone=h,e.protectedScope.round=g,e.protectedScope.floor=y,e.protectedScope.typeString=l,e.protectedScope.copyName=d,e.protectedScope.removeFromArray=v,e.protectedScope.removeFromArray2=m,e.protectedScope.filterItemsByClassName=R,e.getMicrosecondsFromBPM=J}(),function(){"use strict";var e,t=!1,n=[];sequencer.protectedScope.callInitMethods(),e=sequencer.protectedScope.initMidi,delete sequencer.protectedScope,sequencer.ready=function(e){t===!0?e():n.push(e)},sequencer.addInstrument({name:"sinewave",folder:"heartbeat",autopan:!1,attack:200,keyrange:[21,108],release_duration:50}),sequencer.addInstrument({name:"metronome",folder:"heartbeat",sample_path:"heartbeat/metronome",keyrange:[60,61],mapping:{60:{n:"lowtick"},61:{n:"hightick"}}}),sequencer.addSamplePack({name:"metronome",folder:"heartbeat",mapping:{hightick:"//tQxAAACgR/TRSXgAFvIe//HoADsAAACIf14Q80CDFyMVitoKEHHrIWhbUSgTQlj0thODQNBDFAyRKbxAeKx5E1d48iaze970prMN+/fx3cHAQBAEAQB8HwfB/+CBz//6gTB8+8QqgZgACACZpJZbaLhsAArBNB5ohTR0Wz4p+yqbeP5AqQmxICFuNjO8cIQ0249vkk1CQljjj0kwJCUUii2YqGT/2qCpWW+f//9rmY6e/1n9f//+VSA6Do5lsrUpbbbaAAA3EpLY2AAAAE6//7UsQHgAxwn0m4/IABZBCloyNAANTp4HApkSX5yVzWtxxF2J85s9slypC61KouNn15gS2eCbFgrM4syKyGTvxE5nCH7E3lnHb8fhm7duWJuVVZBRSd9ZfYt2caKV8w1k5NbPH+Vw46rpkkUAAAAAEAVIQsmjfBtQOiQOYYBCw8nhSOBIOBslJMljAeOELEWJVSXFHHeOAcRiiz+QEjhSQtQZa1K/GkRYnS2bME1+BQZGs/nQcea/5kYt55//lDIoneukxBTUUzLjk5LjWqqqqq//tSxAcDwAABpBwAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqo=",lowtick:"//tQxAAACIxNUVSWABGxme23MLACpQAAAABOPzn/CHmgQQsjC4JmwoAGA9WcCQYOTN7r16+85Re+BAQWDgIfE74nB8H/5cHz/g4c9QIOrP//DHggCH/6wfP7ZuFIAglJyRJNuS0BgMaQCKXUbLHHcOfsVatuMrw0VTdSmDIEMdkAiDuDwqoO+EwTj2Q4JRWtbqaeIE7gQmhW01YxRQmvc5KlCBKHfTW/02P3NNUsxOe1vUf/2Ww82GqWcdnQfYtY2s6DP/+taHdnUgEk2m04Df/7UsQFAAuox2X89YAxdJlntaYiEJjkhWy+noTEtxrN6JRSJLapHyuaBis66OtH0knjY9DF4r4ca7PS3R17oc7tu59cydHdLW03v/mGxxNTTfuW1EJGExlbaqmDXLa5HrcVABE80tOmDmrWAAQA1GxnNt3XtMNdi7FHzisCU0Yqvw9LCCYedI2ow+rXAdEAEg5qXyqIkSiOC2QCzFDTdbrutb1uMdZKX9Q4IDLWFWK4mP/qYuv3qkNizgOBGBA8BTuVO//9KmiVipAAFqzJ68C6//tSxAWAC5T7SeegsWFpm6b0/CGQS4ZosBfC3vDvPBrQhKHogTOzYWUXrE2ui4AMDzswNUECcdCDBGH/y8lTFsL7/IXh4sqYtQgcalCWzH//MrImcp3st6l/0c7Ca2SVydf///FPUHUpAAAAI7AIDX0YQV7KaRYXxhXHenFVTVyo8xjUqfJ0nblUPzgNgjFWEYwg63xVjHjGPpX3cxNQbljKbumE1GtHVQ9tUzs02tN7xQ0pc1D5Vx8JRybqmoQr6gSQAAIQIEglFKQuKwOQpQT/+1LECAEMEMsrLTBUwWgY5JWGCpil3Z6JX4eeJaUHlpzyjgUKd6mV8w5EwDAWgR9ZFp0gVJY8nDhOZLkJ5G15/StV3uOXvrXlY0ds8idYZLgohUDJdTqrrl97u2IEHDgFwAoXZqMACNNxUBc1hzjU74QqbjEXij9ua2yJqJqPwUOPBdtqKJznWJ9W5qTDXlCYtk1aXizY5SFqp150hKkyrPxtxa7ZlCXqTJd11rIk3/qzG+3gJDsoDBUYeID//qoAAAOwkl5tjWjkchSKSAnTFf/7UsQIg8i8gPpmBHAAAAA0gAAABEchSFgdjmaHzIHTBgcsrBQwIOhka5sspeoYMDR5YFBAgcfFmaxT+sUbizP6hX/Ff/izf//VTEFNRTMuOTkuNVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV"}}),sequencer.addTask({type:"init midi",method:e,params:[]},function(){n.forEach(function(e){e()}),sequencer.debug>=4&&console.log("sequencer ready"),t=!0},!0),sequencer.startTaskQueue()}()