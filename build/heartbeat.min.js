/*

heartbeat
(c) 2013 - 2018 abudaan
https://github.com/abudaan/heartbeat/wiki/license


In util.js the method base64ToBinary() is based on Daniel Guerrero's code:

https://github.com/danguer/blog-examples/blob/master/js/base64-binary.js
https://github.com/danguer/blog-examples/blob/master/LICENSE


In util.js the method toBinaryString(), midi_parse.js and midi_stream.js are based on Matt Westcott & Ben Fishman's code:

https://github.com/gasman/jasmid
https://github.com/gasman/jasmid/blob/master/LICENSE


In util.js Mozilla's atob and btoa alternatives are included:
https://developer.mozilla.org/en-US/docs/Web/API/WindowBase64/Base64_encoding_and_decoding#Solution_.232_.E2.80.93_rewriting_atob()_and_btoa()_using_TypedArrays_and_UTF-8


The code in midi_write.js is based on Sergi Mansilla's code:

https://github.com/sergi/jsmidi
https://github.com/sergi/jsmidi/blob/master/README.md


Audio recording:
https://github.com/akrennmair/libmp3lame-js
https://github.com/kobigurk/libmp3lame-js
https://github.com/nusofthq/Recordmp3js


If a browser doesn't support WebMIDI, heartbeat will try to fallback to Sema's Jazz plugin:

http://jazz-soft.net/
https://github.com/jazz-soft/JZZ

*//*
 *	FileSaver.js
 *  A saveAs() FileSaver implementation.
 *  2014-01-24
 *
 *  By Eli Grey, http://eligrey.com
 *  License: X11/MIT
 *    See LICENSE.md
 *//*global self *//*jslint bitwise: true, indent: 4, laxbreak: true, laxcomma: true, smarttabs: true, plusplus: true *//*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */var saveAs=saveAs||typeof navigator!="undefined"&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(e){"use strict";if(typeof navigator!="undefined"&&/MSIE [1-9]\./.test(navigator.userAgent))return;var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=e.URL||e.webkitURL||e,i=t.createElementNS("http://www.w3.org/1999/xhtml","a"),s=!e.externalHost&&"download"in i,o=function(n){var r=t.createEvent("MouseEvents");r.initMouseEvent("click",!0,!1,e,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(r)},u=e.webkitRequestFileSystem,a=e.requestFileSystem||u||e.mozRequestFileSystem,f=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},l="application/octet-stream",c=0,h=[],p=function(){var e=h.length;while(e--){var t=h[e];typeof t=="string"?r.revokeObjectURL(t):t.remove()}h.length=0},d=function(e,t,n){t=[].concat(t);var r=t.length;while(r--){var i=e["on"+t[r]];if(typeof i=="function")try{i.call(e,n||e)}catch(s){f(s)}}},v=function(r,o){var f=this,p=r.type,v=!1,m,g,y=function(){var e=n().createObjectURL(r);return h.push(e),e},b=function(){d(f,"writestart progress write writeend".split(" "))},w=function(){if(v||!m)m=y(r);g?g.location.href=m:window.open(m,"_blank"),f.readyState=f.DONE,b()},E=function(e){return function(){if(f.readyState!==f.DONE)return e.apply(this,arguments)}},S={create:!0,exclusive:!1},x;f.readyState=f.INIT,o||(o="download");if(s){m=y(r),t=e.document,i=t.createElementNS("http://www.w3.org/1999/xhtml","a"),i.href=m,i.download=o;var T=t.createEvent("MouseEvents");T.initMouseEvent("click",!0,!1,e,0,0,0,0,0,!1,!1,!1,!1,0,null),i.dispatchEvent(T),f.readyState=f.DONE,b();return}e.chrome&&p&&p!==l&&(x=r.slice||r.webkitSlice,r=x.call(r,0,r.size,l),v=!0),u&&o!=="download"&&(o+=".download");if(p===l||u)g=e;if(!a){w();return}c+=r.size,a(e.TEMPORARY,c,E(function(e){e.root.getDirectory("saved",S,E(function(e){var t=function(){e.getFile(o,S,E(function(e){e.createWriter(E(function(t){t.onwriteend=function(t){g.location.href=e.toURL(),h.push(e),f.readyState=f.DONE,d(f,"writeend",t)},t.onerror=function(){var e=t.error;e.code!==e.ABORT_ERR&&w()},"writestart progress write abort".split(" ").forEach(function(e){t["on"+e]=f["on"+e]}),t.write(r),f.abort=function(){t.abort(),f.readyState=f.DONE},f.readyState=f.WRITING}),w)}),w)};e.getFile(o,{create:!1},E(function(e){e.remove(),t()}),E(function(e){e.code===e.NOT_FOUND_ERR?t():w()}))}),w)}),w)},m=v.prototype,g=function(e,t){return new v(e,t)};return m.abort=function(){var e=this;e.readyState=e.DONE,d(e,"abort")},m.readyState=m.INIT=0,m.WRITING=1,m.DONE=2,m.error=m.onwritestart=m.onprogress=m.onwrite=m.onabort=m.onerror=m.onwriteend=null,e.addEventListener("unload",p,!1),g.unload=function(){p(),e.removeEventListener("unload",p,!1)},g}(typeof self!="undefined"&&self||typeof window!="undefined"&&window||this.content);typeof module!="undefined"&&module!==null?module.exports=saveAs:typeof define!="undefined"&&define!==null&&define.amd!=null&&define([],function(){return saveAs}),function(){"use strict";var e=window.alert,t=window.console,n,r=[],i=!1,s,o,u,a,f=0,l=["threshold","knee","ratio","reduction","attack","release"],c=navigator.userAgent,h,p,d=!1;c.match(/(iPad|iPhone|iPod)/g)?h="ios":c.indexOf("Android")!==-1?h="android":c.indexOf("Linux")!==-1?h="linux":c.indexOf("Macintosh")!==-1?h="osx":c.indexOf("Windows")!==-1&&(h="windows"),c.indexOf("Chrome")!==-1?(p="chrome",c.indexOf("OPR")!==-1?p="opera":c.indexOf("Chromium")!==-1&&(p="chromium")):c.indexOf("Safari")!==-1?p="safari":c.indexOf("Firefox")!==-1?p="firefox":c.indexOf("Trident")!==-1&&(p="Internet Explorer"),h==="ios"&&c.indexOf("CriOS")!==-1&&(p="chrome");if(window.AudioContext)o=new window.AudioContext;else if(window.webkitAudioContext)o=new window.webkitAudioContext;else if(window.oAudioContext)o=new window.oAudioContext;else{if(!window.msAudioContext){window.sequencer={browser:p,os:h},e("The WebAudio API hasn't been implemented in "+p+", please use any other browser"),window.sequencer.ready=function(e){e()};return}o=new window.msAudioContext}o.createGainNode===undefined&&(o.createGainNode=o.createGain),s=o.createBufferSource(),s.start===undefined&&(d=!0),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame,window.Blob=window.Blob||window.webkitBlob||window.mozBlob,a=o.createDynamicsCompressor(),a.connect(o.destination),u=o.createGainNode(),u.connect(o.destination),u.gain.value=1,n={context:o,masterGainNode:u,masterCompressor:a,useDelta:!1,timedTasks:{},scheduledTasks:{},repetitiveTasks:{},getSampleId:function(){return"S"+f++ +(new Date).getTime()},addInitMethod:function(e){r.push(e)},callInitMethods:function(){var e,t=r.length;for(e=0;e<t;e++)r[e]()}},window.sequencer={name:"qambi",protectedScope:n,ui:{},ua:c,os:h,browser:p,legacy:!1,midi:!1,webmidi:!1,webaudio:!0,jazz:!1,ogg:!1,mp3:!1,record_audio:navigator.getUserMedia!==undefined,bitrate_mp3_encoding:128,util:{},debug:4,defaultInstrument:"sinewave",pitch:440,bufferTime:.35,autoAdjustBufferTime:!1,noteNameMode:"sharp",minimalSongLength:6e4,pauseOnBlur:!1,restartOnFocus:!0,defaultPPQ:960,overrulePPQ:!0,precision:3,midiInputs:{},midiOutputs:{},storage:{midi:{id:"midi"},audio:{id:"audio",recordings:{}},instruments:{id:"instruments"},samplepacks:{id:"samplepacks"},assetpacks:{id:"assetpacks"}},getAudioContext:function(){return o},getTime:function(){return o.currentTime},setMasterVolume:function(e){e=e<0?0:e>1?1:e,u.gain.value=e},getMasterVolume:function(){return u.gain.value},getCompressionReduction:function(){return a.reduction.value},enableMasterCompressor:function(e){e?(u.disconnect(0),u.connect(a),a.disconnect(0),a.connect(o.destination)):(a.disconnect(0),u.disconnect(0),u.connect(o.destination))},configureMasterCompressor:function(e){var t,n;for(t=l.length;t>=0;t--)n=l[t],e[n]!==undefined&&(a[n].value=e[n])},unlockWebAudio:function(){if(i===!0)return;typeof o.resume=="function"&&o.resume();var e=o.createOscillator(),t=o.createGainNode();t.gain.value=0,e.connect(t),t.connect(o.destination),e.noteOn!==undefined&&(e.start=e.noteOn,e.stop=e.noteOff),e.start(0),e.stop(.001),i=!0}},Object.defineProperty(sequencer,"ERROR",{value:1}),Object.defineProperty(sequencer,"WARN",{value:2}),Object.defineProperty(sequencer,"INFO",{value:3}),Object.defineProperty(sequencer,"LOG",{value:4})}()(function(){"use strict";function y(e,n){function b(t){v[r.id]=!0;for(u=g.length-1;u>=0;u--){f=g[u];if(f===!1)continue;l=f.taskIds;if(l!==undefined){c=!0;for(a=l.length-1;a>=0;a--)v[l[a]]!==!0&&(c=!1);if(c){var i=f.method;g[u]=!1,setTimeout(function(){i(t)},0)}}}e++,y(e,n)}var r,i,s,u,a,f,l,c;if(e===m.length){for(u=g.length-1;u>=0;u--){f=g[u];if(f===!1)continue;var h=f.method;setTimeout(function(){h()},0)}v={},m=[],g=[],d=0,p=!1,n&&(t.log("onTaskQueueDone"),n());return}r=m[e],s=r.scope||null,i=r.params||[],o(i)!=="array"&&(i=[i]),i.push(b),r.method.apply(s,i)}var e=window.sequencer,t=window.console,n,r,i,s,o,u,a,f,l,c,h,p=!1,d=0,v={},m=[],g=[];e.removeMidiFile=function(e){var t,n=[],i,o;e.className==="MidiFile"?(t=e,e=t.localPath):t=r(e,l.midi),t.className==="MidiFile"?n.push(t):(o=t,f(o,function(e){e.className==="MidiFile"&&n.push(e)}));for(i=n.length-1;i>=0;i--)t=n[i],s(t.localPath,l.midi)},e.removeInstrument=function(e,t){var n,i=[],o,u,a,h;e.className==="InstrumentConfig"?(n=e,e=n.localPath):n=r(e,l.instruments);if(n.className==="InstrumentConfig")i.push(n);else{u=n;for(o in u)u.hasOwnProperty(o)&&(n=u[o],n.className==="InstrumentConfig"&&i.push(n))}for(o=i.length-1;o>=0;o--)n=i[o],a=n.mapping,h=n.sample_path,t===!0&&(f(a,function(e){s(h+"/"+e.n,l.audio)}),s(h,l.samplepacks)),s(n.localPath,l.instruments);c()},e.removeSamplePack=function(e){var t,n=[],i,o,u,a,h;e.className==="SamplePack"?(t=e,e=t.localPath):t=r(e,l.samplepacks),t.className==="SamplePack"?n.push(t):(h=t,f(h,function(e){e.className==="SamplePack"&&n.push(e)}));for(i=n.length-1;i>=0;i--){t=n[i],o=t.samples;for(a=o.length-1;a>=0;a--)u=o[a],s(u.folder+"/"+u.id,l.audio);t.reset(),s(t.localPath,l.samplepacks)}c()},e.removeAssetPack=function(e){var t,n;e.className==="AssetPack"?(t=e,e=t.localPath):t=r(e,l.assetpacks),t.className==="AssetPack"?t.unload():(n=t,f(n,function(e){e.className==="AssetPack"&&e.unload()}))},e.startTaskQueue=function(e){if(p===!0)return;p=!0,y(0,e)},e.addTask=function(t,n,r){return t.id="task"+d++,m.push(t),n!==undefined&&(r===!0?e.addCallbackAfterTask(n):e.addCallbackAfterTask(n,[t.id])),t.id},e.addCallbackAfterTask=function(e,t){g.push({method:e,taskIds:t})},e.getInstrument=function(e,t){return r(e,l.instruments,t)},e.getMidiFile=function(e,t){return r(e,l.midi,t)},e.getSamplePack=function(e,t){return r(e,l.samplepacks,t)},e.getSample=function(e,t){return r(e,l.audio,t)},e.getAssetPack=function(e,t){return r(e,l.assetpacks,t)},e.getSamplePacks=function(e,t){return h(e,l.samplepacks,t)},e.getAssetPacks=function(e,t){return h(e,l.assetpacks,t)},e.getSamples=function(e,t){return h(e,l.audio,t)},e.getInstruments=function(e,t){return h(e,l.instruments,t)},e.getMidiFiles=function(e,t){return h(e,l.midi,t)},e.protectedScope.addInitMethod(function(){l=e.storage,n=e.protectedScope.loadLoop,r=e.protectedScope.findItem,i=e.protectedScope.storeItem,s=e.protectedScope.deleteItem,o=e.protectedScope.typeString,u=e.protectedScope.getArguments,a=e.protectedScope.isEmptyObject,f=e.protectedScope.objectForEach,c=e.protectedScope.updateInstruments,h=e.protectedScope.findItemsInFolder})}()),function(){"use strict";function g(e,t){e=null,t(!1)}function y(n){var r=u(n.localPath,e.storage.assetpacks,!0),i=n.action;return r&&r.className==="AssetPack"&&i!=="overwrite"?(e.debug>=2&&t.warn("there is already an AssetPack at",n.localPath),!0):(a(n,n.localPath,e.storage.assetpacks),!1)}function b(e,t){e.url!==undefined?i({url:e.url,responseType:"json",onError:function(n){g(e,t)},onSuccess:function(n,r){if(n===null){t(!1);return}e.loaded=!0,n.name!==undefined&&e.name===undefined&&(e.name=n.name),n.folder!==undefined&&e.folder===undefined&&(e.folder=n.folder),e.name===undefined&&(e.name=o(e.url).name),e.localPath=e.folder!==undefined?e.folder+"/"+e.name:e.name,e.filesize=r,n.instruments&&(e.instruments=e.instruments.concat(n.instruments)),n.samplepacks&&(e.samplepacks=e.samplepacks.concat(n.samplepacks)),n.midifiles&&(e.midifiles=e.midifiles.concat(n.midifiles)),w(e,t)}}):(e.localPath=e.folder!==undefined?e.folder+"/"+e.name:e.name,w(e,t))}function w(t,n){var r,i,s,o=y(t),a=t.localPath;if(o===!0){t=u(a,e.storage.assetpacks,!0),n(t);return}if(t.url!==undefined){var f=e.storage.assetpacks,l,c,h=null;for(c in f){l=f[c];if(l.className!=="AssetPack")continue;if(l.id!==t.id&&l.url===t.url){h=l;break}}if(h!==null){a=t.localPath,p(a),t=null,t=u(h.localPath,e.storage.assetpacks,!0),n(t);return}}i=t.midifiles;for(r=i.length-1;r>=0;r--)s=i[r],s.pack=t,e.addMidiFile(s);i=t.instruments;for(r=i.length-1;r>=0;r--)s=i[r],s.pack=t,e.addInstrument(s);i=t.samplepacks;for(r=i.length-1;r>=0;r--)s=i[r],s.pack=t,e.addSamplePack(s);n(t)}var e=window.sequencer,t=window.console,n=0,r,i,s,o,u,a,f,l,c,h,p,d,v,m;m=function(e){this.id="AP"+n++ +(new Date).getTime(),this.name=this.id,this.className="AssetPack",this.loaded=!1,this.midifiles=e.midifiles||[],this.samplepacks=e.samplepacks||[],this.instruments=e.instruments||[],this.url=e.url;var t=this;c(e,function(e,n){t[n]=e})},m.prototype.unload=function(){var e,t,n;t=this.midifiles;for(e=t.length-1;e>=0;e--)n=t[e],h(n.folder+"/"+n.name);t=this.instruments;for(e=t.length-1;e>=0;e--)n=t[e],d(n.folder+"/"+n.name);t=this.samplepacks;for(e=t.length-1;e>=0;e--)n=t[e],v(n.folder+"/"+n.name);f(this.localPath,r.assetpacks)},e.addAssetPack=function(n,r){var i=l(n),s,o,u,a;if(i!=="object")return e.debug>=2&&t.warn("can't create an AssetPack with this data",n),!1;r===undefined&&(r=function(){});if(n.json){o=n.json,u=n.name,a=n.folder;if(l(o)==="string")try{o=JSON.parse(o)}catch(f){return e.debug>=2&&t.warn("can't create an AssetPack with this data",n),!1}if(o.instruments===undefined&&o.midifiles===undefined&&o.samplepacks===undefined)return e.debug>=2&&t.warn("can't create an AssetPack with this data",n),!1;n={midifiles:o.midifiles,instruments:o.instruments,samplepacks:o.samplepacks,name:u===undefined?o.name:u,folder:a===undefined?o.folder:a}}e.addTask({type:"load asset pack",method:b,params:new m(n)},function(e){n=null,r(e)},!0),e.startTaskQueue()},e.protectedScope.addInitMethod(function(){i=e.protectedScope.ajax,s=e.protectedScope.round,o=e.protectedScope.parseUrl,u=e.protectedScope.findItem,a=e.protectedScope.storeItem,f=e.protectedScope.deleteItem,l=e.protectedScope.typeString,c=e.protectedScope.objectForEach,r=e.storage,h=e.removeMidiFile,d=e.removeInstrument,v=e.removeSamplePack,p=e.removeAssetPack})}(),function(){"use strict";var e=window.console,t=window.sequencer,n=Array.prototype.slice,r,i,s=0;i=function(n){if(n===undefined)return;n.ticks===undefined?this.ticks=0:this.ticks=n.ticks,this.buffer=n.buffer,this.sampleId=n.sampleId,this.path=n.path;if(this.buffer===undefined&&this.path===undefined){t.debug>=t.WARN&&e.warn("please provide an AudioBuffer or a path to a sample in the sequencer.storage object");return}if(this.buffer!==undefined&&r(this.buffer)!=="audiobuffer"){t.debug>=t.WARN&&e.warn("buffer has to be an AudioBuffer");return}if(this.path!==undefined){if(r(this.path)!=="string"){t.debug>=t.WARN&&e.warn("path has to be a String");return}this.sampleId=this.path,this.sampleId=this.sampleId.replace(/^\//,""),this.sampleId=this.sampleId.replace(/\/$/,""),this.sampleId=this.sampleId.split("/"),this.sampleId=this.sampleId[this.sampleId.length-1],this.buffer=t.getSample(this.path);if(this.buffer===!1){t.debug>=t.WARN&&e.warn("no sample found at",this.path);return}this.buffer=t.getSample(this.path)}this.durationTicks=n.durationTicks,this.durationMillis=n.durationMillis,this.durationTicks===undefined&&this.durationMillis===undefined&&(this.duration=this.buffer.duration,this.durationMillis=this.duration*1e3),this.muted=!1,n.velocity===undefined?this.velocity=127:this.velocity=n.velocity,this.sampleOffsetTicks=n.sampleOffsetTicks,this.sampleOffsetMillis=n.sampleOffsetMillis,this.sampleOffsetMillis===undefined&&this.sampleOffsetTicks===undefined?(this.sampleOffsetTicks=0,this.sampleOffsetMillis=0,this.sampleOffset=0):this.sampleOffsetMillis!==undefined&&(this.sampleOffset=this.sampleOffsetMillis/1e3),this.latencyCompensation=n.latencyCompensation,this.latencyCompensation===undefined&&(this.latencyCompensation=0),this.playheadOffset=0,this.className="AudioEvent",this.time=0,this.type="audio",this.id="A"+s+(new Date).getTime()},i.prototype.update=function(){var e;this.duration===undefined?(e=this.song.getPosition("ticks",this.ticks+this.durationTicks),this.durationMillis=e.millis-this.millis,this.duration=this.durationMillis/1e3):this.durationTicks===undefined&&(e=this.song.getPosition("millis",this.millis+this.durationMillis),this.durationTicks=e.ticks-this.ticks),this.sampleOffset===undefined?(e=this.song.getPosition("ticks",this.ticks+this.sampleOffsetTicks),this.sampleOffsetMillis=e.millis-this.millis,this.sampleOffset=this.sampleOffsetMillis/1e3):this.sampleOffsetTicks===undefined&&(e=this.song.getPosition("millis",this.millis+this.sampleOffsetMillis),this.sampleOffsetTicks=e.ticks-this.ticks),this.endTicks=this.ticks+this.durationTicks,this.endMillis=this.millis+this.durationMillis},i.prototype.stopSample=function(e){this.track.audio.stopSample(this,e)},i.prototype.setSampleOffset=function(n,r){n==="millis"?(this.sampleOffsetMillis=r,this.sampleOffset=r/1e3,this.durationTicks=undefined,this.song!==undefined&&this.update()):n==="ticks"?(this.sampleOffsetTicks=r,this.sampleOffset=undefined,this.sampleOffsetMillis=undefined,this.song!==undefined&&this.update()):t.debug>=t.WARN&&e.warn('you have to provide a type "ticks" or "millis" and a value')},i.prototype.setDuration=function(n,r){n==="millis"?(this.durationMillis=r,this.duration=r/1e3,this.durationTicks=undefined,this.song!==undefined&&this.update()):n==="ticks"?(this.durationTicks=r,this.duration=undefined,this.durationMillis=undefined,this.song!==undefined&&this.update()):t.debug>=t.WARN&&e.warn('you have to provide a type "ticks" or "millis" and a value')},i.prototype.clone=i.prototype.copy=function(){var e=new i,t;for(t in this)this.hasOwnProperty(t)&&(t!=="id"&&t!=="eventNumber"&&(e[t]=this[t]),e.song=undefined,e.track=undefined,e.trackId=undefined,e.part=undefined,e.partId=undefined);return e},i.prototype.reset=function(e,t,n){e=e===undefined?!0:!1,t=t===undefined?!0:!1,n=n===undefined?!0:!1,e&&(this.part=undefined,this.partId=undefined),t&&(this.track=undefined,this.trackId=undefined,this.channel=0),n&&(this.song=undefined)},i.prototype.move=function(n){if(isNaN(n)){t.debug>=1&&e.error("please provide a number");return}this.ticks+=parseInt(n,10),this.song!==undefined&&this.update(),this.state!=="new"&&(this.state="changed"),this.part!==undefined&&(this.part.needsUpdate=!0)},i.prototype.moveTo=function(){var r=n.call(arguments);r[0]==="ticks"&&isNaN(r[1])===!1?this.ticks=parseInt(r[1],10):this.song===undefined?t.debug>=1&&e.error("The audio event has not been added to a song yet; you can only move to ticks values"):(r=this.song.getPosition(r),r===!1?t.debug>=1&&e.error("wrong position data"):this.ticks=r.ticks),this.song!==undefined&&this.update(),this.state!=="new"&&(this.state="changed"),this.part!==undefined&&(this.part.needsUpdate=!0)},t.createAudioEvent=function(e){return e.className==="AudioEvent"?e.clone():new i(e)},t.protectedScope.addInitMethod(function(){r=t.protectedScope.typeString})}(),function(){"use strict";function p(e){this.track=e,this.song=e.song,this.audioEvents={},this.callback=null,this.worker=s(),this.waveformConfig=e.waveformConfig||h;var t=this;this.worker.onmessage=function(e){v(t,e.data.wavArrayBuffer,e.data.interleavedSamples,e.data.id)}}function d(t,i,s,o,u){var a,f=o.length,l=r(i),c=n.createBuffer(1,f,n.sampleRate),h=c.getChannelData(0),p={id:t.recordId,audioBuffer:null,wavArrayBuffer:i,wav:{blob:new Blob([new Uint8Array(i)],{type:"audio/wav"}),base64:l,dataUrl:"data:audio/wav;base64,"+l},waveform:{}};for(a=0;a<f;a++)h[a]=o[a];p.audioBuffer=c,u==="new"?(p.planarSamples=o,p.interleavedSamples=s):(p.planarSamples=e.storage.audio.recordings[t.recordId].planarSamples,p.interleavedSamples=e.storage.audio.recordings[t.recordId].interleavedSamples),e.storage.audio.recordings[t.recordId]=p,t.callback!==null&&(t.callback(p),t.callback=null)}function v(i,s,u,a){n.decodeAudioData(s,function(t){var n=r(s),f={id:i.recordId,audioBuffer:t,wavArrayBuffer:s,wav:{blob:new Blob([new Uint8Array(s)],{type:"audio/wav"}),base64:n,dataUrl:"data:audio/wav;base64,"+n},waveform:{}};a==="new"?f.interleavedSamples=u:f.interleavedSamples=e.storage.audio.recordings[i.recordId].interleavedSamples,o(t,i.waveformConfig,function(t){f.waveform={dataUrls:t},e.storage.audio.recordings[i.recordId]=f,i.callback!==null&&(i.callback(f),i.callback=null)})},function(){e.debug>=e.WARN&&t.warn("no valid audiodata")})}function m(n){navigator.getUserMedia({audio:!0},function(e){u=!0,a=e,n()},function(r){e.debug>=e.WARN&&t.log(r),u=!1,n()})}var e=window.sequencer,t=window.console,n,r,i,s,o,u=null,a,f=8192,l,c,h={height:200,width:800,sampleStep:1,color:"#71DE71",bgcolor:"#000"};p.prototype.prepare=function(e,t){var n=this;this.recordId=e,u===null?m(function(){t(u),a!==undefined&&n.start()}):(t(u),a!==undefined&&this.start())},p.prototype.start=function(){var e=this,t=this.track.song;e.worker.postMessage({command:"init",sampleRate:n.sampleRate}),this.scriptProcessor=n.createScriptProcessor(f,1,1),this.scriptProcessor.onaudioprocess=function(n){n.inputBuffer.numberOfChannels===1?e.worker.postMessage({command:"record_mono",buffer:n.inputBuffer.getChannelData(0)}):e.worker.postMessage({command:"record_stereo",buffer:[n.inputBuffer.getChannelData(0),n.inputBuffer.getChannelData(1)]}),t.recording===!1&&t.precounting===!1&&e.createAudio()},this.sourceNode=n.createMediaStreamSource(a),this.sourceNode.connect(this.scriptProcessor),this.scriptProcessor.connect(n.destination)},p.prototype.stop=function(e){this.stopRecordingTimestamp=n.currentTime*1e3,this.timestamp=window.performance.now();if(this.sourceNode===undefined){e();return}this.callback=e},p.prototype.createAudio=function(){this.sourceNode.disconnect(this.scriptProcessor),this.scriptProcessor.disconnect(n.destination),this.scriptProcessor.onaudioprocess=null,this.sourceNode=null,this.scriptProcessors=null;var e=parseInt((this.song.metronome.precountDurationInMillis+this.song.audioRecordingLatency)/l),t=-1;this.worker.postMessage({command:"get_wavfile",bufferIndexStart:e,bufferIndexEnd:t})},p.prototype.setAudioRecordingLatency=function(t,n,r){var i=parseInt(n/l),s=-1;this.callback=r,this.worker.postMessage({command:"update_wavfile",samples:e.storage.audio.recordings[t].interleavedSamples,bufferIndexStart:i,bufferIndexEnd:s})},p.prototype.cleanup=function(){if(a===undefined){this.worker.terminate();return}this.scriptProcessor.disconnect(),this.scriptProcessor.onaudioprocess=null,this.sourceNode.disconnect(),this.scriptProcessor=null,this.sourceNode=null,this.worker.terminate()},e.protectedScope.createAudioRecorder=function(t){return e.record_audio===!1?!1:new p(t)},e.protectedScope.addInitMethod(function(){r=e.util.encode64,n=e.protectedScope.context,o=e.getWaveformData,s=e.protectedScope.createAudioRecorderWorker,l=1/n.sampleRate*1e3,i=e.protectedScope.songDispatchEvent,c=f*l})}(),function(){"use strict";var e=window.console,t=window.sequencer,n=Array.prototype.slice,r,i,s,o;o=function(e){this.track=e,this.className="AudioTrack",this.scheduledSamples={},this.recorder=i(e)},s=function(e){delete this.scheduledSamples[e.id],e=null},o.prototype.setAudioRecordingLatency=function(e,t,n){this.recorder.setAudioRecordingLatency(e,t,n)},o.prototype.processEvent=function(e){var n=t.createSample({buffer:e.buffer,track:e.track});e.sample=n,e.offset=e.sampleOffset+e.playheadOffset,e.playheadOffset=0,n.start(e),this.scheduledSamples[n.id]=n},o.prototype.stopSample=function(e,t){if(e.sample===undefined)return;e.sample.stop(t,s.bind(this))},o.prototype.allNotesOff=function(){var e,t,n=this.scheduledSamples;for(e in n)n.hasOwnProperty(e)&&(t=n[e],t&&t.unschedule(0,s.bind(this)));this.scheduledSamples={}},o.prototype.prepareForRecording=function(e,t){if(this.recorder===!1)return!1;this.recorder.prepare(e,t)},o.prototype.stopRecording=function(e){this.recorder.stop(function(t){e(t)})},t.protectedScope.createAudioTrack=function(e){return new o(e)},t.protectedScope.addInitMethod(function(){r=t.protectedScope.typeString,i=t.protectedScope.createAudioRecorder})}(),function(){"use strict";function p(e){this.id="FX"+n++ +""+(new Date).getTime(),this.type=e.type,this.buffer=e.buffer,this.config=e,this.bypass=!1,this.amount=0,this.output=r.createGainNode(),this.wetGain=r.createGainNode(),this.dryGain=r.createGainNode(),this.output.gain.value=1,this.wetGain.gain.value=this.amount,this.dryGain.gain.value=1-this.amount}var e=window.sequencer,t=window.console,n=0,r,i=1e-17,s,o,u,a,f,l,c,h;p.prototype.setInput=function(e){e.connect(this.dryGain),this.dryGain.connect(this.output),e.connect(this.node),this.node.connect(this.wetGain),this.wetGain.connect(this.output)},p.prototype.setAmount=function(e){this.amount=e<0?0:e>1?1:e,this.wetGain.gain.value=this.amount,this.dryGain.gain.value=1-this.amount},p.prototype.copy=function(){switch(this.type){case"reverb":return new u(this.config);case"panner":return new a(this.config);case"panner2":return new f(this.config);case"delay":return new l(this.config);case"compressor":return new h(this.config)}},e.createReverb=function(e){var n=o(e);if(n===!1)return t.warn("no reverb with id",e,"loaded"),!1;var r={type:"reverb",buffer:n};return new u(r)},e.createPanner=function(e){return e=e||{},e.type="panner",new a(e)},e.createPanner2=function(e){return e=e||{},e.type="panner2",new f(e)},e.createDelay=function(e){return e=e||{},e.type="delay",new l(e)},e.createCompressor=function(e){return e=e||{},e.type="compressor",new h(e)},e.createBiQuadFilter=function(e){return e=e||{},e.type="biquadfilter",new c(e)},e.protectedScope.addInitMethod(function(){r=e.protectedScope.context,s=e.protectedScope.createClass,o=e.getSample,u=s(p,function(e){this.node=r.createConvolver(),this.node.buffer=e.buffer}),a=s(p,function(e){this.node=r.createPanner(),this.node.panningModel="equalpower",this.node.setPosition(i,i,i)}),f=s(p,function(e){this.node=r.createPanner(),this.node.panningModel="HRTF",this.node.setPosition(i,i,i)}),l=s(p,function(e){this.node=r.createDelay(),this.node.delayTime.value=.3}),h=s(p,function(e){this.node=r.createDynamicsCompressor()}),c=s(p,function(e){this.node=r.createBiquadFilter(),this.node.type=0,this.node.Q.value=4,this.node.frequency.value=1600}),a.prototype.setPosition=function(e){var t=e,n=0,r=1-Math.abs(t);t=t===0?i:t,n=n===0?i:n,r=r===0?i:r,this.node.setPosition(t,n,r)},f.prototype.setPosition=function(e){var t=parseInt(e),n=t+90,r,s,o;n>90&&(n=180-n),r=Math.sin(t*(Math.PI/180)),s=0,o=Math.sin(n*(Math.PI/180)),r=r===0?i:r,s=s===0?i:s,o=o===0?i:o,this.node.setPosition(r,s,o)},l.prototype.setTime=function(e){this.node.delayTime.value=e}})}(),function(){"use strict";var e=sequencer.createNote,t=sequencer.findEvent,n=sequencer.protectedScope.round,r=sequencer.protectedScope.getEvents,i=sequencer.protectedScope.typeString,s="max min avg all",o="data1 data2 velocity noteNumber noteName frequency",u;u=function(){var u=Array.prototype.slice.call(arguments),a=u.length,f,l,c,h,p,d,v,m,g,y,b,w=128,E=-1,S=0,x=0,T=!1;c=r(u[0]);if(c.length===0)return-1;h=u[1];if(i(h)!=="string")return console.error("please provide a search string like for instance get('velocity max bar >= 1 < 8')"),-1;a>2&&console.warn("ignoring invalid arguments, please consult documentation"),h=h.split(" "),p=h.length,f=h[0],l=h[1];if(o.indexOf(f)===-1)return console.error("you can't use 'min', 'max' or 'avg'","on the property",f),-1;if(s.indexOf(l)===-1)return console.error(l,"is not a valid operator"),-1;p>2&&(p===6&&console.warn("ignoring cruft found in search string, please consult documentation"),h.shift(),h.shift(),c=t(c,h.join(" "))),f==="noteName"&&(f="noteNumber",T=!0);for(d=0,v=c.length;d<v;d++)m=c[d],g=m[f],g>E&&(E=g,b=m.noteName),g<w&&(w=g,y=m.noteName),g!==undefined&&(S+=g);x=S/v,T&&(x=n(x),x=e(x).name,w=y,E=b);if(l==="max")return E;if(l==="min")return w;if(l==="avg")return x;if(l==="all")return{min:w,max:E,avg:x}},sequencer.getStats=u,sequencer.protectedScope.addInitMethod(function(){e=sequencer.createNote,t=sequencer.findEvent,n=sequencer.protectedScope.round,r=sequencer.protectedScope.getEvents,i=sequencer.protectedScope.typeString})}(),function(){"use strict";var e,t,n,r,i,s,o={barsbeats:["bar","beat","sixteenth","tick"],time:["hour","minute","second","millisecond"]},u="OR AND NOT XOR",a=new RegExp(" "+u.replace(/\s+/g," | ")+" "),f={bar:1,beat:1,sixteenth:1,tick:1,ticks:1,barsbeats:1,musical_time:1,hour:1,minute:1,second:1,millisecond:1,millis:1,time:1,linear_time:1,id:1,type:1,data1:1,data2:1,velocity:1,noteNumber:1,frequency:1,noteName:1},l,c,h,p,d,v,m,g,y,b,w,E;l=function(){var e=Array.prototype.slice.call(arguments),n,r,o,u,f,l,c,p,v,m,g,y,S,x,T;g=h(e[0]),y=[];if(g.length===0)return console.warn("findEvent: no events"),y;if(t(e[1])!=="string")return console.error("please provide a search string like for instance findEvent('beat = 2 AND velocity > 60 < 100');"),y;o=e[1],u=o.split(" "),r=u.length,s=[];for(n=0;n<r;n++)f=u[n],a.test(" "+f+" ")&&s.push(f);u=o.split(a),r=u.length,i=[];for(n=0;n<r;n++)d(u[n].split(" "));r=i.length,v=0,m=-1;for(n=0;n<r;n++)l=i[v++],f=s[m++],f==="AND"?y=E(y,l):f==="NOT"?y=E(y,l,!0):f==="XOR"?(x=E(g,l),y=b(y,x)):(S=E(g,l),y=y.concat(S)),c=l,p=f;return w(y)},b=function(e,t){var n,r=e.length,i,s=t.length,o,u,a,f=[];for(n=0;n<r;n++){a=!0,o=e[n],u=o.id;for(i=0;i<s;i++)if(t[i].id===u){a=!1;break}a&&f.push(o)}for(i=0;i<s;i++){a=!0,o=t[i],u=o.id;for(n=0;n<r;n++)if(e[n].id===u){a=!1;break}a&&f.push(o)}return f},w=function(e){var t,n=e.length,r,i,s,o=[];e.sort(function(e,t){return e.eventNumber-t.eventNumber});for(t=0;t<n;t++)r=e[t],i=r.id,i!==s&&o.push(r),s=i;return o},E=function(e,t,n){var r=[],i=t.property,s=t.operator1,o=t.operator2,u=t.value1,a=t.value2,f=e.length,l,c,h=!1;n=n||!1,n&&(s=y(s),o=y(o));for(c=0;c<f;c++)l=e[c],h=m(i,l[i],s,u,o,a),h&&r.push(l);return r},m=function(e,n,i,s,o,u){var a=!1,f=!1;if(n===undefined)return a;switch(e){case"noteName":if(i==="=")return s.length===3&&n.length===4?a=n.indexOf(s)===0:s.length===4&&n.length===5&&(a=n.indexOf(s)===0),a;break;case"type":t(s)!=="number"&&isNaN(s)&&(s=r(s));break;case"bar":case"beat":case"sixteenth":}t(n)==="string"?(t(s)!=="string"&&(s="'"+s+"'"),u&&t(u)!=="string"&&(u="'"+u+"'"),f=!0):t(n)==="number"&&(t(s)!=="number"&&(s=parseInt(s)),u&&t(u)!=="number"&&(u=parseInt(u)));switch(i){case"=":case"==":case"===":a=n===s;break;case"*=":a=n.indexOf(s)!==-1;break;case"^=":a=n.indexOf(s)===0;break;case"$=":a=n.indexOf(s)===n.length-s.length;break;case"%=":f?a=!1:a=n%s===0;break;case"!*=":a=n.indexOf(s)===-1;break;case"!^=":a=n.indexOf(s)!==0;break;case"!$=":a=n.indexOf(s)!==n.length-s.length;break;case"!%=":f?a=!0:a=n%s!==0;break;case"!=":case"!==":f?a=n.indexOf(s)===-1:a=n!==s;break;case">":o?a=g(n,i,s,o,u):a=n>s;break;case">=":o?a=g(n,i,s,o,u):a=n>=s;break;case"<":o?a=g(n,i,s,o,u):a=n<s;break;case"<=":o?a=g(n,i,s,o,u):a=n<=s;break;default:console.warn("eval is evil!")}return a},g=function(e,t,n,r,i){var s=!1;switch(t){case">":switch(r){case"<":s=e>n&&e<i;break;case"<=":s=e>n&&e<=i}break;case">=":switch(r){case"<":s=e>=n&&e<i;break;case"<=":s=e>=n&&e<=i}break;case"<":switch(r){case">":s=e<n||e>i;break;case">=":s=e<n||e>=i}break;case"<=":switch(r){case">":s=e<=n||e>i;break;case">=":s=e<=n||e>=i}}return s},h=function(e){var n,r,i,s=[];return t(e)==="array"?s=e:e.className===undefined?console.warn(e):e.className==="Track"||e.className==="Part"?s=e.events:e.className==="Song"&&(s=e.eventsMidiTime),s},d=function(e){var t={property:e[0],operator1:e[1],value1:e[2],operator2:e[3],value2:e[4]},n=e[0],r=e[1],u=e[2],a=e[3],l=e[4],c;if(f[n]!==1)return console.error(n,"is not a supported property"),!1;t=v(t);if(n==="barsbeats"||n==="time"){u=p(u,n);for(c=0;c<4;c++)t={},t.property=o[n][c],t.operator1=r,t.value1=u[c],i.push(t),s.push("AND");s.pop();if(l){l=p(l,n);for(c=0;c<4;c++)t={},t.property=o[n][c],t.operator2=a,t.value2=l[c],i.push(t),s.push("AND");s.pop()}}else i.push(t)},p=function(e,n){e=e.replace(/(\[|\])/g,""),t(e)!=="array"&&(n==="barsbeats"?e.indexOf(",")===-1?e=[e,1,1,0]:e=e.split(","):n==="time"&&(e.indexOf(",")===-1?e=[0,e,0,0]:e=e.split(",")));switch(e.length){case 1:n==="barsbeats"?e.push(1,1,0):n==="time"&&e.push(0,0,0);break;case 2:n==="barsbeats"?e.push(1,0):n==="time"&&e.push(0,0);break;case 3:e.push(0)}return e},v=function(t){var n=t.operator1,r=t.operator2,i=function(e){return e==="<"||e===">"||e==="<="||e===">="?!0:!1},s=function(e){return e==="="||e==="=="||e==="==="?!0:!1};return t.property==="noteName"&&(i(n)||s(n))&&(t.property="noteNumber",t.value1=e(t.value1
).number),t.property==="noteName"&&(i(r)||s(r))&&(t.property="noteNumber",t.value2=e(t.value2).number),i(n)&&!i(r)&&(delete t.operator2,delete t.value2),t},y=function(e){var t;switch(e){case"=":case"==":case"===":t="!==";break;case"!=":case"!==":t="===";break;case"<":t=">=";break;case">":t="<=";break;case"<=":t=">";break;case">=":t="<";break;case"*=":case"^=":case"&=":case"%=":t="!"+e;break;default:t=e}return t},c=function(){var e=l.apply(this,arguments),t=e.length,r,i,s,o={},u,a=[];for(r=0;r<t;r++)i=e[r],i.type===sequencer.NOTE_ON?(o[i.noteNumber]===undefined&&(o[i.noteNumber]=[]),o[i.noteNumber].push(i)):i.type===sequencer.NOTE_OFF&&(u=o[i.noteNumber],u&&(s=u.shift(),a.push(n(s,i))),u.length===0&&delete o[i.noteNumber]);return a.sort(function(e,t){return e.sortIndex-t.sortIndex}),a},sequencer.findEvent=l,sequencer.findNote=c,sequencer.protectedScope.getEvents=h,sequencer.protectedScope.addInitMethod(function(){e=sequencer.createNote,t=sequencer.protectedScope.typeString,n=sequencer.createMidiNote,r=sequencer.midiEventNumberByName})}(),function(){"use strict";function S(e){e=null}function x(e,t,n,r){var i;for(t=0;t<n;t++){i=e[t];if(i===undefined)continue;i.className==="MidiNote"?r.push(i.noteOn):f(i)==="array"&&x(i,0,i.length)}}function T(e){return{getValue:function(e){return Math.sin(e*2*Math.PI)}}}var e=window.sequencer,t=window.console,n=e.debug,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E;w=function(e){this.className="Instrument",this.config=e,this.scheduledEvents={},this.scheduledSamples={},this.sustainPedalDown=!1,this.sustainPedalSamples={},this.sampleDataByNoteNumber={},this.sampleData=[],this.info=e.info||e.instrument_info,this.author=e.author||e.instrument_author,this.license=e.license||e.instrument_license,this.pack=e.pack,this.parse()},w.prototype.reset=function(){var t=e.getInstrument(this.config.localPath),n=e.getSamplePack(this.config.sample_path);if(n===!1||t===!1)this.scheduledEvents={},this.scheduledSamples={},this.sustainPedalSamples={},this.sampleDataByNoteNumber={},this.sampleData=[],this.update&&delete o[this.updateTaskId],t===!1&&this.track.setInstrument()},w.prototype.parse=function(){function _(n){var r,i;if(n.n)m=C[n.n];else{g=[d,p,p.toLowerCase()];for(i=2;i>=0;i--){m=C[g[i]];if(m!==undefined){A[y]={n:g[i]};break}}}if(m===undefined){e.debug&&t.log("no buffer found for "+y+" ("+O.name+")"),x=!1;return}x={noteNumber:d,buffer:m,bufferId:n.n,autopan:O.autopan},k.sustain===!0&&(x.sustain=!0,E=!0),n.s!==undefined?(x.sustain_start=n.s[0],x.sustain_end=n.s[1],x.sustain=!0,E=!0):k.sustain===!0&&(r=N.samplesById[n.n].sustain,r!==undefined?(x.sustain_start=r[0],x.sustain_end=r[1]):x.sustain=!1),k.release_duration!==undefined&&(x.release_duration=k.release_duration,x.release_envelope=k.release_envelope||O.releaseEnvelope,x.release=!0,E=!0),n.r!==undefined&&(f(n.r)==="array"?(x.release_duration=n.r[0],x.release_envelope=n.r[1]||O.releaseEnvelope):isNaN(n.r)||(x.release_duration=n.r,x.release_envelope=O.releaseEnvelope),x.release=!0,E=!0),n.p!==undefined&&(x.panPosition=n.p,x.panning=!0)}var n,r,s,u,a,l,c,h,p,d,v,m,g,y,b,w,E,S,x,N,C,k=this.config,L=k.notename_mode===undefined?e.noteNameMode:k.notename_mode,A=k.mapping,O=this;if(k.name===undefined)return t.error("instruments must have a name",k),!1;if(A===undefined)return t.error("instruments must have a mapping to samples",k),!1;this.name=k.name,this.folder=k.folder||"",this.autopan=k.autopan||!1,this.singlePitch=k.single_pitch||!1,this.samplePath=k.sample_path||this.name,this.keyScalingRelease=k.keyscaling_release,this.keyScalingPanning=k.keyscaling_panning,this.keyRange=k.keyrange||k.key_range,v=this.samplePath.split("/"),N=i.samplepacks;for(n=0,r=v.length;n<r;n++){if(N===undefined){e.debug&&t.log("sample pack not found",v.join("/"));return}N=N[v[n]]}C=i.audio;try{for(n=0,r=v.length;n<r;n++)C=C[v[n]]}catch(M){e.debug&&t.log('sample pack "'+v[n]+'" is not loaded');return}if(C===undefined){e.debug&&t.log("sample pack not found",v.join("/"));return}if(f(A)==="array"){this.keyRange=A,A={};for(n=this.keyRange[0];n<=this.keyRange[1];n++)A[n]=""}this.keyRange===undefined?(this.lowestNote=128,this.highestNote=-1):(this.lowestNote=this.keyRange[0],this.highestNote=this.keyRange[1],this.numNotes=this.highestNote-this.lowestNote),k.release_duration!==undefined?this.releaseDuration=k.release_duration:this.releaseDuration=0,this.releaseEnvelope=k.release_envelope||"equal power",this.autopan&&(this.autoPanner=T()),this.samplepack=N;for(y in A)if(A.hasOwnProperty(y)){b=A[y],isNaN(y)?(l=y.length,c=y.substring(l-1),h=y.substring(0,l-1),p=y,d=e.getNoteNumber(h,c)):(p=e.getNoteNameFromNoteNumber(y,L),p=p.join(""),d=y),d=parseInt(d,10),this.keyRange===undefined&&(this.lowestNote=d<this.lowestNote?d:this.lowestNote,this.highestNote=d>this.highestNote?d:this.highestNote);if(f(b)==="array"){this.multiLayered=!0;for(n=0,r=b.length;n<r;n++){w=b[n],_(w),this.sampleDataByNoteNumber[d]===undefined&&(this.sampleDataByNoteNumber[d]=[]),u=w.v[0],a=w.v[1];for(s=u;s<=a;s++)this.sampleDataByNoteNumber[d][s]=x;this.sampleData.push(x)}}else _(b),this.sampleDataByNoteNumber[d]=x,this.sampleData.push(x)}this.keyRange===undefined&&(this.numNotes=this.highestNote-this.lowestNote,this.keyRange=[this.lowestNote,this.highestNote]),this.config.mapping=A;if(this.singlePitch)for(n=127;n>=0;n--)this.sampleData[n]=x,this.sampleDataByNoteNumber[n]=x;E&&(this.updateTaskId="update_"+this.name+"_"+(new Date).getTime(),o[this.updateTaskId]=function(){O.autopan?O.update(this.autoPanner.getValue()):O.update()})},w.prototype.getInfoAsHTML=function(){var t="",n="",r="",i=this.samplepack;return this.info!==undefined&&(n+="<tr><td>info</td><td>"+this.info+"</td></tr>"),this.author!==undefined&&(n+="<tr><td>author</td><td>"+this.author+"</td></tr>"),this.license!==undefined&&(n+="<tr><td>license</td><td>"+this.license+"</td></tr>"),n+="<tr><td>keyrange</td><td>"+this.lowestNote+"("+e.getFullNoteName(this.lowestNote)+")",n+=" - "+this.highestNote+"("+e.getFullNoteName(this.highestNote)+")</td></tr>",n!==""&&(n='<table><th colspan="2">instrument</th>'+n+"</table>",t+=n),i===undefined?t:(i.info!==undefined&&(r+="<tr><td>info</td><td>"+i.info+"</td></tr>"),i.author!==undefined&&(r+="<tr><td>author</td><td>"+i.author+"</td></tr>"),i.license!==undefined&&(r+="<tr><td>license</td><td>"+i.license+"</td></tr>"),i.compression!==undefined&&(r+="<tr><td>compression</td><td>"+i.compression+"</td></tr>"),i.filesize!==undefined&&(r+="<tr><td>filesize</td><td>"+g(i.filesize/1024/1024,2)+" MiB</td></tr>"),r!==""&&(r='<table><th colspan="2">samplepack</th>'+r+"</table>",t+=r),t)},w.prototype.getInfo=function(){var e={instrument:{},samplepack:{}};return this.info!==undefined&&(e.instrument.info=this.info),this.author!==undefined&&(e.instrument.author=this.author),this.license!==undefined&&(e.instrument.license=this.license),this.keyrange!==undefined&&(e.instrument.keyrange=this.keyrange),this.info!==undefined&&(e.samplepack.info=this.info),this.author!==undefined&&(e.samplepack.author=this.author),this.license!==undefined&&(e.samplepack.license=this.license),this.compression!==undefined&&(e.samplepack.compression=this.compression),this.filesize!==undefined&&(e.samplepack.filesize=g(this.samplepack.filesize/1024/1024,2)),e},w.prototype.createSample=function(e){var n=e.noteNumber,r=e.velocity,i=this.sampleDataByNoteNumber[n],s=f(i);return s==="array"&&(i=i[r]),i===undefined||i===!1?{start:function(){t.warn("no audio data loaded for",n)},stop:function(){},update:function(){},addData:function(){},unschedule:function(){}}:(i.track=e.track,p(i))},w.prototype.setKeyScalingPanning=function(e,t){var n,r,i=this.sampleData.length,s,o;if(e===!1)for(n=0;n<i;n++)r=this.sampleData[n],r.panning=!1;if(isNaN(e)===!1&&isNaN(t)===!1){s=(t-e)/this.numNotes,o=e;for(n=0;n<i;n++)r=this.sampleData[n],r.panning=!0,r.panPosition=o,o+=s}},w.prototype.setRelease=function(e,t){if(e===undefined)return;this.releaseEnvelope=t||this.releaseEnvelope,this.keyScalingRelease=undefined;var n,r,i=this.sampleData.length;for(n=0;n<i;n++)r=this.sampleData[n],r.release=!0,r.release_duration=e,r.release_envelope=this.releaseEnvelope;this.releaseDuration=e},w.prototype.setKeyScalingRelease=function(e,t,n){var r,i,s=this.sampleData.length,o,u;this.releaseEnvelope=n||this.releaseEnvelope;if(isNaN(e)===!1&&isNaN(t)===!1){this.keyScalingRelease=[e,t],this.releaseDuration=0,o=(t-e)/this.numNotes,u=e;for(r=0;r<s;r++)i=this.sampleData[r],i.release_duration=u,i.release_envelope=u,u+=o}},w.prototype.transpose=function(e,n,r){function s(o,u){var a;r&&r("transposing sample "+(o+1)+" of "+i),o<i?(a=u[o],setTimeout(function(){b(a.buffer,e,function(e){a.buffer=e,s(++o,u)})},10)):n&&(t.log("ready"),n())}if(b===undefined){t.log("transpose is still experimental");return}var i=this.sampleData.length;s(0,this.sampleData)},w.prototype.processEvent=function(e){var t=e.type,n,r,i,s;e.time===undefined&&(e.time=0),t===128||t===144?t===128?(this.sustainPedalDown===!0&&(e.sustainPedalDown=!0),this.stopNote(e)):this.playNote(e):e.type===176&&(n=e.data1,r=e.data2,n===64?r===127?(this.sustainPedalDown=!0,v(this.track.song,"sustain_pedal","down")):r===0&&(this.sustainPedalDown=!1,v(this.track.song,"sustain_pedal","up"),this.stopSustain(e.time)):n===10?(i=this.track,i.setPanning(m(r,0,127,-1,1))):n===7&&(i=this.track,s=i.output,s.gain.setValueAtTime(r/127,e.time)))},w.prototype.stopSustain=function(e){var t,n=this.scheduledSamples,r=this.sustainPedalSamples;h(r,function(r){r!==undefined&&(t=r.midiNote,t.noteOn.sustainPedalDown=undefined,t.noteOff.sustainPedalDown=undefined,r.stop(e,function(e){n[e.sourceId]=null,delete n[e.sourceId]}))}),this.sustainPedalSamples={}},w.prototype.playNote=function(n){var r,i;if(!n.midiNote){e.debug&&t.warn("playNote() no midi note");return}i=n.midiNote.id,r=this.scheduledSamples[i],r!==undefined&&r.unschedule(0),r=this.createSample(n),r.addData({midiNote:n.midiNote,noteName:n.midiNote.note.fullName,sourceId:i}),this.scheduledSamples[i]=r,r.start(n)},w.prototype.stopNote=function(n){if(n.midiNote===undefined){e.debug&&t.warn("stopNote() no midi note",n.ticks,n.noteNumber);return}var r=n.midiNote.id,i=this.scheduledSamples[r],s=this.scheduledSamples,o=this.sustainPedalSamples;if(n.sustainPedalDown===!0){o[r]=i;return}if(i===undefined)return;i.stop(n.time,function(){s[r]=null,delete s[r]})},w.prototype.hasScheduledSamples=function(){return c(this.scheduledSamples)},w.prototype.reschedule=function(t){var n=t.millis,r=n+e.bufferTime*1e3,i=n+20,s=this.scheduledSamples,o,u,a;for(o in s)if(s.hasOwnProperty(o)){a=s[o],u=a.midiNote;if(u===undefined||u.state==="removed")a.unschedule(0,S),delete s[o];else{if(u.noteOn.millis>=n&&u.noteOff.millis<r&&a.noteName===u.fullName)continue;delete s[o],a.unschedule(null,S)}}},w.prototype.unschedule=function(){var e=Array.prototype.slice.call(arguments),t=[],n,r,i,o;x(e,0,e.length,t);for(n=t.length-1;n>=0;n--)r=t[n],r.midiNote!==undefined?(i=r.midiNote.id,o=this.scheduledSamples[i],o!==undefined&&(o.unschedule(0,S),delete this.scheduledSamples[i])):r.className==="MidiEvent"&&(i=r.id,delete s["event_"+i],delete this.scheduledEvents[i])},w.prototype.allNotesOff=function(){var e,t,n=this.scheduledSamples;this.stopSustain(0),this.sustainPedalDown=!1;if(n===undefined||c(n)===!0)return;for(t in n)n.hasOwnProperty(t)&&(e=n[t],e&&e.unschedule(0,S));this.scheduledSamples={},h(this.scheduledEvents,function(e,t){delete s["event_"+t]}),this.scheduledEvents={}},w.prototype.allNotesOffPart=function(e){var t,n,r=this.scheduledSamples;this.stopSustain(0),this.sustainPedalDown=!1;if(r===undefined||c(r)===!0)return;for(n in r)r.hasOwnProperty(n)&&(t=r[n],t&&t.unschedule(0,S));this.scheduledSamples={},h(this.scheduledEvents,function(e,t){delete s["event_"+t]}),this.scheduledEvents={}},w.prototype.update=function(e){var t,n;for(t in this.scheduledSamples)this.scheduledSamples.hasOwnProperty(t)&&(n=this.scheduledSamples[t],n&&n.update(e))},e.createInstrument=function(e){var r=f(e),s,o;return r==="object"?(e.className==="Instrument"?o=e:e.className==="InstrumentConfig"&&(e.name==="sinewave"?o=new E(e):o=new w(e)),o):(r==="string"&&(s=u(e,i.instruments)),s===!1||s.className!=="InstrumentConfig"?(n>=2&&t.info("can not create instrument from",e),!1):(s.name==="sinewave"?o=new E(s):o=new w(s),o))},e.protectedScope.addInitMethod(function(){var t=e.protectedScope;i=e.storage,p=e.createSample,d=e.createReverb,v=e.protectedScope.songDispatchEvent,r=t.context,s=t.timedTasks,o=t.repetitiveTasks,h=t.objectForEach,c=t.isEmptyObject,u=t.findItem,a=t.storeItem,f=t.typeString,l=t.pathToArray,b=t.transpose,E=t.createClass(w),m=e.util.remap,g=e.util.round,y=e.util.getEqualPowerCurve,E.prototype.parse=function(){var e=this,t=this.config;this.name="SineWave",this.waveForm=t.wave_form||"sine",this.autopan=t.autopan||!1,this.folder=t.folder||"heartbeat",this.releaseDuration=t.release_duration||1500,this.autopan&&(this.autoPanner=T()),o["update_"+this.name+"_"+(new Date).getTime()]=function(){e.autopan?e.update(Math.sin(r.currentTime*2*Math.PI)):e.update()}},E.prototype.createSample=function(e){var t={oscillator:!0,track:e.track,event:e,autopan:this.autopan,wave_form:this.waveForm,release_envelope:"equal power",release_duration:this.releaseDuration};return p(t)},e.createSimpleSynth=function(e){return e=e||{},new E(e)}})}(),function(){"use strict";function l(e,t){e=undefined,t&&t(!1)}function c(n){var r=i(n.localPath,e.storage.instruments,!0),o=n.action;r&&r.className==="InstrumentConfig"&&o!=="overwrite"?e.debug>=2&&(t.warn("there is already an Instrument at",n.localPath),l(n)):s(n,n.localPath,e.storage.instruments)}function h(e,t){if(e.url===undefined){e.localPath=e.folder!==undefined?e.folder+"/"+e.name:e.name,t();return}n({url:e.url,responseType:"json",onError:function(){l(e,t)},onSuccess:function(n){if(n===null){t(!1);return}n.name!==undefined&&e.name===undefined&&(e.name=n.name),n.folder!==undefined&&e.folder===undefined&&(e.folder=n.folder),e.name===undefined&&(e.name=r(e.url).name),e.localPath=e.folder!==undefined?e.folder+"/"+e.name:e.name,u(n,function(t,n){n!=="name"&&n!=="folder"&&(e[n]=t)}),t()}})}var e=window.sequencer,t=window.console,n,r,i,s,o,u,a=0,f;f=function(e){this.id="IC"+a++ +(new Date).getTime(),this.className="InstrumentConfig";var t=this;u(e,function(e,n){t[n]=e})},e.addInstrument=function(n,r,i){var s=o(n),u,a,l,p;if(s!=="object")return e.debug>=2&&t.warn("can't add an Instrument with this data",n),!1;if(n.json){a=n.json,l=n.name,p=n.folder;if(o(a)==="string")try{a=JSON.parse(a)}catch(d){return e.debug>=2&&t.warn("can't add an Instrument with this data",n),!1}if(a.mapping===undefined)return e.debug>=2&&t.warn("can't add an Instrument with this data",n),!1;n={mapping:a.mapping,name:l===undefined?a.name:l,folder:p===undefined?a.folder:p}}u=new f(n),e.addTask({type:"load instrument config",method:h,params:u},function(e){c(u),r&&r(u)},i),e.startTaskQueue()},e.protectedScope.addInitMethod(function(){n=e.protectedScope.ajax,i=e.protectedScope.findItem,r=e.protectedScope.parseUrl,s=e.protectedScope.storeItem,o=e.protectedScope.typeString,u=e.protectedScope.objectForEach})}(),function(){"use strict";var e=window.sequencer,t=window.console,n=window.requestAnimationFrame,r,i="newEvents newNotes newParts changedEvents changedNotes changedParts removedEvents removedNotes removedParts".split(" "),s=.1,o=10,u=4,a=0,f="chromatic",l=2,c=Math.ceil,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k;r=function(e,t){this.song=e,this.song.keyEditor=this,this.playhead=d(this.song,"barsbeats ticks millis","keyeditor"),this.numBars=e.bars,this.newNumBars=this.numBars,this.eventListeners={},this.interrupt=!1,this.iteratorFactory=h(this.song,this),this.verticalLine=this.iteratorFactory.createVerticalLineIterator(this),this.horizontalLine=this.iteratorFactory.createHorizontalLineIterator(this),this.eventIterator=this.iteratorFactory.createEventIterator(this),this.noteIterator=this.iteratorFactory.createNoteIterator(this),this.partIterator=this.iteratorFactory.createPartIterator(this),this.exactFitVertical=t.exactFitVertical||!1,this.exactFitHorizontal=t.exactFitHorizontal||!1,this.activeEvents=[],this.activeNotes=[],this.activeParts=[],this.newEvents=[],this.newNotes=[],this.newParts=[],this.changedEvents=[],this.changedNotes=[],this.changedParts=[],this.removedEvents=[],this.removedNotes=[],this.removedParts=[],this.recordedNotesObj={},this.recordedEventsObj={},this.snapshot={activeEvents:this.activeEvents,activeNotes:this.activeNotes,activeParts:this.activeParts,newEvents:this.newEvents,newNotes:this.newNotes,newParts:this.newParts,changedEvents:this.changedEvents,changedNotes:this.changedNotes,changedParts:this.changedParts,removedEvents:this.removedEvents,removedNotes:this.removedNotes,removedParts:this.removedParts},t.paginate?(this.paginate=!0,this.pageNo=0,this.barsPerPage=t.barsPerPage,this.pageWidth=t.pageWidth,this.pageHeight=t.pageHeight,this.width=this.pageWidth,this.lowestNote=t.lowestNote||e.lowestNote,this.highestNote=t.highestNote||e.highestNote,this.pitchRange=this.highestNote-this.lowestNote,this.exactFitVertical?(this.pitchHeight=this.height/this.pitchRange,this.height=this.pageHeight):(this.pitchHeight=t.pitchHeight||o,this.height=this.pitchHeight*this.pitchRange),x(this,0),T(this)):(this.setStartPosition(t.startPosition||1),this.setEndPosition(t.endPosition||e.bars+1),this.numTicks=this.endTicks-this.startTicks,t.width?(this.width=t.width,this.tickWidth=this.width/this.numTicks):t.tickWidth?(this.tickWidth=t.tickWidth,this.width=this.numTicks*this.tickWidth,this.exactFitHorizontal=!1):t.barsPerPage&&t.viewportWidth?(this.barsPerPage=t.barsPerPage,this.viewportWidth=t.viewportWidth,this.tickWidth=this.viewportWidth/(this.startPosition.ticksPerBar*this.barsPerPage),this.width=this.numTicks*this.tickWidth,this.scrollX=0,this.scrollPosition=0,this.viewportTicks=this.viewportWidth/this.tickWidth,this.maxScrollPosition=c(this.width/this.viewportWidth),this.scrollLimit=this.viewportWidth/this.tickWidth,N(this),this.exactFitHorizontal=!1):t.viewportWidth?(this.viewportWidth=this.width=t.viewportWidth,this.tickWidth=this.viewportWidth/this.numTicks,this.exactFitHorizontal=!0):(this.tickWidth=s,this.width=this.numTicks*this.tickWidth,this.exactFitHorizontal=!1),this.lowestNote=t.lowestNote||e.lowestNote,this.highestNote=t.highestNote||e.highestNote,this.pitchRange=t.pitchRange||this.highestNote-this.lowestNote+1,t.height?(this.height=t.height,this.pitchHeight=this.height/this.pitchRange):t.pitchHeight?(this.pitchHeight=t.pitchHeight,this.height=this.pitchRange*this.pitchHeight,this.exactFitVertical=!1):t.viewportHeight?(this.viewportHeight=this.height=t.viewportHeight,this.pitchHeight=this.viewportHeight/this.pitchRange,this.exactFitVertical=!0):(this.pitchHeight=o,this.height=this.pitchRange*this.pitchHeight,this.exactFitVertical=!1)),this.scrollX=0,this.scrollY=0,this.currentPage=1,this.numPages=c(this.width/this.viewportWidth),this.snapValueX=t.snapX===undefined?a:t.snapX,this.snapValueY=t.snapY===undefined?f:t.snapY,this.setSnapX(this.snapValueX),this.setSnapY(this.snapValueY)},r.prototype.setBarsPerPage=function(e){this.interrupt=!0;var t=w(this.scrollX/(this.viewportWidth/this.barsPerPage));this.barsPerPage=e,this.tickWidth=this.viewportWidth/(this.startPosition.ticksPerBar*this.barsPerPage),this.viewportTicks=this.viewportWidth/this.tickWidth,this.width=this.numTicks*this.tickWidth,this.verticalLine.reset(),this.horizontalLine.reset(),this.eventIterator.reset(),this.partIterator.reset(),this.scrollLimit=this.viewportWidth/this.tickWidth,this.maxScrollPosition=c(this.width/this.viewportWidth),this.snapWidth=this.tickWidth*this.snapTicks,this.numPages=c(this.numBars/this.barsPerPage),this.currentPage=E(this.song.ticks/(this.barsPerPage*this.song.ticksPerBar))+1,C(this,"scale",{}),this.song.playing?this.scrollPosition=E(this.song.ticks/this.viewportTicks):(this.scrollPosition=this.viewportWidth/this.barsPerPage*t/this.viewportWidth,C(this,"scroll",{x:this.scrollPosition*this.viewportWidth})),this.interrupt=!1},r.prototype.setViewport=function(e,t){var n=!1;this.barsPerPage&&e!==this.viewportWidth?(this.viewportWidth=e,this.tickWidth=this.viewportWidth/(this.startPosition.ticksPerBar*this.barsPerPage),this.viewportTicks=this.viewportWidth/this.tickWidth,this.width=this.numTicks*this.tickWidth,n=!0):this.exactFitHorizontal===!0&&e!==this.width&&(this.viewportWidth=this.width=e,this.tickWidth=this.width/this.numTicks,n=!0),this.exactFitVertical===!0&&t!==this.height&&(this.viewportHeight=this.height=t,this.pitchHeight=this.height/this.pitchRange,n=!0),n&&(this.verticalLine.reset(),this.horizontalLine.reset(),this.eventIterator.reset(),this.noteIterator.reset(),this.partIterator.reset(),C(this,"draw",{}))},r.prototype.updateSong=function(e){this.iteratorFactory.updateSong();var t,n=0,r,s,o,u;for(n=i.length-1;n>=0;n--){t=i[n];switch(t){case"newNotes":case"changedNotes":o=e[t];for(r=o.length-1;r>=0;r--)u=o[r],u.bbox=this.getNoteRect(u);break;case"newParts":case"changedParts":o=e[t];for(r=o.length-1;r>=0;r--)u=o[r],u.bbox=this.getPartRect(u)}}this.newNumBars=e.numBars,this.newEvents=this.newEvents.concat(e.newEvents),this.changedEvents=this.changedEvents.concat(e.changedEvents),this.removedEvents=this.removedEvents.concat(e.removedEvents),this.removedEventsObj=y(this.removedEvents,"id"),this.newNotes=this.newNotes.concat(e.newNotes),this.changedNotes=this.changedNotes.concat(e.changedNotes),this.removedNotes=this.removedNotes.concat(e.removedNotes),this.removedNotesObj=y(this.removedNotes,"id"),this.newParts=this.newParts.concat(e.newParts),this.changedParts=this.changedParts.concat(e.changedParts),this.removedParts=this.removedParts.concat(e.removedParts),this.removedPartsObj=y(this.removedParts,"id")},r.prototype.setStartPosition=function(e){m(e)!=="array"&&(e=["barsandbeats",e,1,1,0]),this.startPosition=p(this.song,e),this.startTicks=this.startPosition.ticks,this.startMillis=this.startPosition.millis},r.prototype.setEndPosition=function(e){m(e)!=="array"&&(e=["barsandbeats",e,1,1,0]),this.endPosition=p(this.song,e),this.endTicks=this.endPosition.ticks,this.endMillis=this.endPosition.millis},r.prototype.addEventListener=function(e,t){var n=e.split(" "),r,i=this,s;n.forEach(function(e){r=i.eventListeners[e],r===undefined&&(i.eventListeners[e]=[],r=i.eventListeners[e]),s=e+"-"+r.length,r.push(t)})},r.prototype.nextPage=function(){x(this,this.startBar+this.barsPerPage),C(this,"pagechange",{pageNo:this.pageNo,lastPage:this.lastPage})},r.prototype.prevPage=function(){x(this,this.startBar-this.barsPerPage),C(this,"pagechange",{pageNo:this.pageNo,lastPage:this.lastPage})},r.prototype.gotoPage=function(e){t.warn("ooops, not implemented yet!");return},r.prototype.scroll=function(e){var t,n=w(this.scrollX/(this.viewportWidth/this.barsPerPage));this.scrollPosition=this.viewportWidth/this.barsPerPage*n/this.viewportWidth;switch(e){case">":this.scrollPosition+=1,this.scrollPosition=this.scrollPosition>this.maxScrollPosition?this.maxScrollPosition:this.scrollPosition;break;case">>":this.scrollPosition=this.maxScrollPosition;break;case"<":this.scrollPosition-=1,this.scrollPosition=this.scrollPosition<0?0:this.scrollPosition;break;case"<<":this.scrollPosition=0;break;default:if(isNaN(e))return;this.scrollPosition=parseInt(e)}t=this.scrollPosition*this.viewportWidth,this.scrollLimit=(t+this.viewportWidth)/this.tickWidth,this.currentPage=c(t/this.viewportWidth)+1,this.currentPage===0?this.currentPage=1:this.currentPage>this.maxScrollPosition&&(this.currentPage=this.maxScrollPosition),C(this,"scroll",{x:t})},r.prototype.updateScroll=function(e,t){this.scrollX=e,this.scrollY=t,this.scrollLimit=(e+this.viewportWidth)/this.tickWidth},r.prototype.getEventRect=function(e){var t=this.ticksToX(e.ticks-this.startTicks,!1),n=this.pitchToY(e.number),r=l*this.tickWidth,i=this.pitchHeight;return{x:t,y:n,width:r,height:i,top:n,left:t,bottom:n+i,right:t+r}},r.prototype.getNoteRect=function(e){var t=this.ticksToX(e.ticks-this.startTicks,!1),n=this.pitchToY(e.number),r=e.durationTicks*this.tickWidth,i=this.pitchHeight,s,o,u;e.endless&&(r=(this.song.ticks-e.noteOn.ticks)*this.tickWidth);if(this.paginate){s=e.ticks,o=e.noteOff.ticks;if(!(s<this.startTicks))return!1;u=this.startTicks-s,s=s+u-this.startTicks,t=s*this.tickWidth,o=o>this.endTicks?this.endTicks:o,r=(o-this.startTicks)*this.tickWidth}return{x:t,y:n,width:r,height:i,top:n,left:t,bottom:n+i,right:t+r}},r.prototype.getPartRect=function(e){var t=e.getStats("noteNumber all"),n={top:this.pitchToY(t.max),bottom:this.pitchToY(t.min)+this.pitchHeight,left:this.ticksToX(e.start.ticks-this.startTicks,!1),right:this.ticksToX(e.end.ticks-this.startTicks,!1)};return n.x=n.left,n.y=n.top,n.width=n.right-n.left,n.height=n.bottom-n.top,e.bbox=n,e.stats=t,n},r.prototype.getBBox=function(e){var n,r;if(m(e)==="string")switch(e.substring(0,1)){case"E":n="event";if(event.type!==144||event.endEvent===undefined){t.error("argument not supported, please check documentation");return}r=this.song.findEvent("id = "+e);break;case"P":n="part",r=this.song.getPart(e);break;case"T":n="track";break;default:t.error("argument not supported, please check documentation");return}else switch(e.className){case"AudioEvent":n="audio";break;case"MidiEvent":n="event";break;case"Part":n="part";break;case"Track":n="track";break;default:t.error("argument not supported, please check documentation");return}if(r===undefined){t.error(e,"could not be found");return}switch(n){case"event":return this.getNoteRect(r);case"part":return this.getPartRect(r)}},r.prototype.startMoveNote=function(n,r,i){if(n.className!=="MidiNote"){e.debug>=e.WARN&&t.warn(n,"is not a MidiNote");return}this.selectedNote=n,this.gripX=r-this.selectedNote.bbox.x},r.prototype.stopMoveNote=function(){this.selectedNote=undefined},r.prototype.moveNote=function(e,t){if(this.selectedNote===undefined)return;var n=this.yToPitch(t).number,r=this.selectedNote.pitch,i=this.xToTicks(e-this.gripX),s=this.selectedNote.ticks,o=this.selectedNote.part,u=!1;n!==r&&(o.transposeNote(this.selectedNote,n-r),u=!0),i!==s&&(o.moveNote(this.selectedNote,i-s),u=!0),u===!0&&this.song.update()},r.prototype.startMovePart=function(n,r,i){if(n.className!=="Part"){e.debug>=e.WARN&&t.warn(n,"is not a Part");return}this.selectedPart=n,this.selectedPart.pitch=this.yToPitch(i).number,this.gripX=r-this.selectedPart.bbox.x},r.prototype.stopMovePart=function(){this.selectedPart=undefined},r.prototype.movePart=function(e,t){if(this.selectedPart===undefined)return;var n=this.yToPitch(t).number,r=this.selectedPart.pitch,i=this.xToTicks(e-this.gripX),s=this.selectedPart.ticks,o=!1;n!==r&&(this.selectedPart.track.transposePart(this.selectedPart,n-r),this.selectedPart.pitch=n,o=!0),i!==s&&(this.selectedPart.track.movePart(this.selectedPart,i-s),o=!0),o===!0&&this.song.update()},r.prototype.getTicksAt=r.prototype.xToTicks=function(e,t){var n=(e+this.scrollX)/this.width*this.numTicks;return t!==!1&&this.snapTicks!==0&&(n=w(n/this.snapTicks)*this.snapTicks),n},r.prototype.getPitchAt=r.prototype.yToPitch=function(e){var t=this.highestNote-w((e+this.scrollY)/this.height*this.pitchRange);return t=S(t),t},r.prototype.getXAt=r.prototype.ticksToX=function(e,t){var n=(e-this.startTicks)*this.tickWidth;return t!==!1&&this.snapWidth!==0&&(n=w(n/this.snapWidth)*this.snapWidth),n},r.prototype.getYAt=r.prototype.pitchToY=function(e){var t=this.height-(e-this.lowestNote+1)*this.pitchHeight;return t},r.prototype.getPositionAt=function(e){var t=this.getTicksAt(e);return this.playhead.set("ticks",t,!1),this.playhead.get()},r.prototype.getPlayheadX=function(e){var t=this.song.ticks/this.song.durationTicks*this.width;return t=e===!0?t-this.scrollX:t,t},r.prototype.setPlayheadToX=function(e){var t=this.xToTicks(e,!1);this.song.setPlayhead("ticks",t)},r.prototype.getPlayheadPosition=function(e){var t=this.song.ticks/this.song.durationTicks*this.width;return t=e===!0?t-this.scrollX:t,t},r.prototype.setPlayheadPosition=function(e,t){var n;switch(e){case"x":n=this.xToTicks(t,!1);break;case"ticks":n=t;break;case"millis":n=this.playhead.set("millis",t).ticks;break;case"barsbeats":case"barsandbeats":n=p(this.song,["barsbeats",t]).ticks}this.song.setPlayhead("ticks",n)},r.prototype.getEventAt=function(e,t){var n=this.getSongPosition(e),r=this.getPitchAt(t)},r.prototype.getEventsInRect=function(e,t,n,r){var i=this.getSongPosition(e),s=this.getSongPosition(e+n),o=this.getPitchAt(t+r),u=this.getPitchAt(t)},r.prototype.getNoteAt=function(e,t){var n=this.getSongPosition(e),r=this.getPitchAt(t)},r.prototype.getNotesInRect=function(e,t,n,r){var i=this.getSongPosition(e),s=this.getSongPosition(e+n),o=this.getPitchAt(t+r),u=this.getPitchAt(t)},r.prototype.snap=function(e,t){return{x:this.snapX(e),y:this.snapY(t)}},r.prototype.snapX=function(e){return w((e+this.scrollX)/this.snapWidth)*this.snapWidth},r.prototype.snapY=function(e){return w((e+this.scrollY)/this.snapHeight)*this.snapHeight},r.prototype.setSnapX=function(e){if(e===undefined)return;var t=4/this.song.denominator;e==="off"?this.snapTicks=0:e==="tick"?this.snapTicks=1:e==="beat"?this.snapTicks=this.song.ppq*t:e==="bar"?this.snapTicks=this.song.ppq*this.song.nominator*t:isNaN(e)&&e.indexOf("ticks")!==-1?(this.snapTicks=e.replace(/ticks/,""),isNaN(this.snapTicks)?this.snapTicks=this.song.ppq/4:this.snapTicks=parseInt(this.snapTicks)):isNaN(e)||e===0?(e=0,this.snapTicks=0):(e=parseInt(e),this.snapTicks=4/e*this.song.ppq),this.snapValueX=e,this.snapWidth=this.tickWidth*this.snapTicks},r.prototype.setSnapY=function(e){if(e===undefined)return;this.snapValueY=e,this.snapHeight=this.pitchHeight},r.prototype.removeNote=function(e){e.part.removeEvents(e.noteOn,e.noteOff),this.song.update()},r.prototype.removePart=function(e){e.track.removePart(e),this.song.update()},r.prototype.prepareForRecording=function(){this.recordedEventsObj={},this.recordedNotesObj={}},r.prototype.getSnapshot=function(){var e,n,r,i,s,o=[],u=[],a=[],f=[].concat(this.activeEvents),l=[].concat(this.activeNotes),h=[].concat(this.activeParts),d=[],v=[],m=[],g,y,b,w,S,x,T,N,C,k;this.activeEvents=[],this.activeNotes=[],this.activeParts=[],this.activeStateChangedEvents=[],this.activeStateChangedNotes=[],this.activeStateChangedParts=[],this.newNumBars!==this.numBars&&(C=this.numBars,k=this.song.lastBar+1,this.endPosition=p(this.song,["barsbeats",k,1,1,0,!0]),this.verticalLine.reset(p(this.song,["barsbeats",C,1,1,0,!0]),this.endPosition),this.numBars=this.song.bars,this.endTicks=this.endPosition.ticks,this.numTicks=this.song.durationTicks,this.width=this.numTicks*this.tickWidth,this.maxScrollPosition=c(this.width/this.viewportWidth),this.numPages=c(this.numBars/this.barsPerPage)),e=this.song.activeEvents;for(S in e)e.hasOwnProperty(S)&&(T=e[S],this.activeEvents.push(T),T.active!==!0&&(T.active=!0,this.activeStateChangedEvents.push(T)));n=this.song.activeNotes;for(S in n)n.hasOwnProperty(S)&&(T=n[S],this.activeNotes.push(T),T.active!==!0&&(T.active=!0,this.activeStateChangedNotes.push(T)));r=this.song.activeParts;for(S in r)r.hasOwnProperty(S)&&(T=r[S],this.activeParts.push(T),T.active!==!0&&(T.active=!0,this.activeStateChangedParts.push(T)));s=this.song.recordedEvents;if(s){N=s.length;for(S=0;S<N;S++)T=s[S],this.recordedEventsObj[T.id]===undefined&&(T.bbox=this.getEventRect(T),d.push(T),this.recordedEventsObj[T.id]=T)}i=this.song.recordedNotes;if(i){N=i.length;for(S=0;S<N;S++)T=i[S],this.recordedNotesObj[T.id]===undefined?(this.recordedNotesObj[T.id]=T,T.bbox=this.getNoteRect(T),v.push(T)):T.endless===!0?(T.bbox=this.getNoteRect(T),m.push(T)):T.endless===!1&&(T.bbox=this.getNoteRect(T),m.push(T),T.endless=undefined)}for(S=f.length-1;S>=0;S--){T=f[S];if(T===undefined){t.warn("event is undefined");continue}e[T.id]===undefined&&(o.push(T),T.active!==!1&&(T.active=!1,this.activeStateChangedEvents.push(T)))}for(S=l.length-1;S>=0;S--){T=l[S];if(T===undefined){t.warn("note is undefined");continue}n[T.id]===undefined&&(u.push(T),T.active!==!1&&(T.active=!1,this.activeStateChangedNotes.push(T)))}for(S=h.length-1;S>=0;S--){T=h[S];if(T===undefined){t.warn("part is undefined");continue}r[T.id]===undefined&&(a.push(T),T.active!==!1&&(T.active=!1,this.activeStateChangedParts.push(T)))}return this.song.playing&&(this.currentPage=E(this.song.ticks/(this.barsPerPage*this.song.ticksPerBar))+1),g={events:{active:this.activeEvents,inActive:this.nonActiveEvents,recorded:d,"new":this.newEvents,changed:this.changedEvents,removed:this.removedEvents,stateChanged:this.activeStateChangedEvents},notes:{active:this.activeNotes,inActive:u,recorded:v,recording:m,"new":this.newNotes,changed:this.changedNotes,removed:this.removedNotes,stateChanged:this.activeStateChangedNotes},parts:{active:this.activeParts,inActive:a,"new":this.newParts,changed:this.changedParts,removed:this.removedParts
,stateChanged:this.activeStateChangedParts},hasNewBars:C!==k,newWidth:this.width,pageNo:this.currentPage,lastPage:this.numPages},this.newEvents=[],this.changedEvents=[],this.removedEvents=[],this.newNotes=[],this.changedNotes=[],this.removedNotes=[],this.newParts=[],this.changedParts=[],this.removedParts=[],g},x=function(e,n){e.numTicks=0,e.startBar=n>0?n:0,e.startBar=e.startBar>e.numBars-e.barsPerPage?e.numBars-e.barsPerPage:e.startBar,e.endBar=n+e.barsPerPage,e.endBar=e.endBar>e.numBars?e.numBars:e.endBar,e.endBar=e.endBar<e.barsPerPage?e.barsPerPage:e.endBar,t.log(n,e.startBar,e.endBar,e.numBars,e.numBars-e.barsPerPage);var r;for(r=e.startBar;r<e.endBar;r++)e.numTicks+=e.bars[r].ticksPerBar;e.tickWidth=e.pageWidth/e.numTicks,e.startPosition=e.bars[e.startBar],e.endPosition=e.bars[e.endBar],e.startTicks=e.startPosition.ticks,e.endTicks=e.endPosition.ticks,e.verticalLine.reset(),e.horizontalLine.reset(),e.eventIterator.reset()},T=function(e){e.song.playing()&&e.song.ticks>=e.endTicks&&e.nextPage(),n(function(){T(e)})},N=function(e){if(e.song.playing&&e.interrupt===!1)if(e.song.ticks>=e.scrollLimit)C(e,"scroll",{x:e.scrollX+e.viewportWidth}),e.scrollLimit+=e.viewportWidth/e.tickWidth;else{var t=E(e.song.ticks/e.viewportTicks)*e.viewportTicks*e.tickWidth;e.scrollX!==t&&C(e,"scroll",{x:t})}n(function(){N(e)})},C=function(e,t,n){var r=e.eventListeners[t];r&&r.forEach(function(e){e(n)})},k=function(e){var t=e.selectedPart,n=e.selectedNote;t!==undefined?(t.track.removePart(t),this.song.update()):n!==undefined&&(n.part.removeNote(n),this.song.update())},e.createKeyEditor=function(e,t){return new r(e,t)},e.protectedScope.addInitMethod(function(){p=e.protectedScope.getPosition,d=e.protectedScope.createPlayhead,S=e.createNote,b=e.debug,E=e.protectedScope.floor,w=e.protectedScope.round,m=e.protectedScope.typeString,g=e.protectedScope.objectToArray,y=e.protectedScope.arrayToObject,v=e.protectedScope.getScaffoldingBars,h=e.protectedScope.createKeyEditorIteratorFactory})}(),function(){"use strict";function s(e,t){this.song=e,this.editor=t,this.position=r(this.song,"all","iterators"),this.updateSong()}var e=window.sequencer,t=.042,n=.02,r,i;s.prototype.updateSong=function(){this.events=this.song.events,this.numEvents=this.events.length,this.notes=this.song.notes,this.numNotes=this.notes.length,this.parts=this.song.parts,this.numParts=this.parts.length,this.position.updateSong()},s.prototype.createVerticalLineIterator=function(){var e="bar beat sixteenth",r,i={},s,o,u,a,f,l,c,h,p,d,v,m,g=this.editor,y=this.position,b,w,E,S,x,T;return x=function(){b=y.update("ticks",a),i.bar=b.ticksPerBar,i.beat=b.ticksPerBeat,i.sixteenth=b.ticksPerSixteenth,p=b.nominator,d=b.numSixteenth},w=function(e){e&&(u=e,s<n?u="bar":s<t&&(u="beat"));switch(u){case"sixteenth":r="sixteenth",h++,h>d&&(r="beat",h=1,c++,c>p&&(r="bar",c=1,l++));break;case"beat":r="beat",h=1,c++,c>p&&(r="bar",c=1,l++);break;case"bar":r="bar",h=1,c=1,l++}return a+=i[u],x(),a>f?!1:{x:a*s-o,bar:l,beat:c,sixteenth:h,type:r,position:b}},E=function(e){var r=f-a,o=!1;e&&(u=e,s<n?u="bar":s<t&&(u="beat"));switch(u){case"bar":o=r>=i[u];break;case"beat":o=r>=i[u];break;case"sixteenth":o=r>=i[u]}return o},S=function(e,r){v=e||g.startPosition,m=r||g.endPosition,a=v.ticks,l=v.bar,c=v.beat,h=v.sixteenth,f=m.ticks,s=g.tickWidth,o=0,y.set("ticks",a),s<n?u="bar":s<t&&(u="beat"),x()},T=function(e){u=e,s<n?u="bar":s<t&&(u="beat")},{next:w,reset:S,hasNext:E,setType:T}},s.prototype.createHorizontalLineIterator=function(){var e,t,n,r,s={},o=this.editor,u,a,f;return u=function(n){return s={note:i(t),y:e*r},t--,e++,s},a=function(t){var r=!1;switch(t){case"chromatic":r=e<n}return r},f=function(){e=0,t=o.highestNote,n=o.pitchRange,r=o.pitchHeight},{next:u,reset:f,hasNext:a}},s.prototype.createEventIterator=function(){var t,n,r,i,s,o=this.editor,u=this.position,a=this.events,f=this.numEvents,l="",c,h,p,d;return h=function(e){return l=e||l,r=!0,i++,i===f?!1:(s=a[i],l===""?s.ticks<=n:!1)},c=function(e){return l=e||l,r||h(l),r=!1,s},p=function(){var s;t=o.startTicks,n=o.endTicks,r=!1;if(o.paginate===!0&&e.isPlaying()===!0)return;i=u.get().eventIndex-2},d=function(){var e=Array.prototype.slice.call(arguments);e.forEach(function(e){l+=e+" "})},{next:c,reset:p,hasNext:h,setTypes:d}},s.prototype.createNoteIterator=function(){var t,n,r,i,s,o,u=this.editor,a=this.song,f=this.notes,l=this.numNotes,c="",h,p,d,v;return p=function(e){c=e||c,r=!0,i++;if(i===this.numNotes)return!1;s=!1;for(;i<l;i++){o=f[i];if(o.ticks>=n)break;if(u.paginate){o.ticks<t&&o.noteOff.ticks>t?s=!0:o.ticks<n&&(s=!0);if(s)break}else{s=o.ticks<=n;if(s)break}}return s},h=function(e){return c=e||c,r||p(c),r=!1,o.bbox=u.getNoteRect(o),o},d=function(){var s;t=u.startTicks,n=u.endTicks,f=a.notes,l=a.numNotes,r=!1;if(u.paginate===!0&&e.isPlaying()===!0)return;for(i=0;i<l;i++){s=f[i];if(s.ticks>=t)break}i--},{next:h,reset:d,hasNext:p}},s.prototype.createPartIterator=function(){var e,t,n,r={},i=this.editor,s=this.song,o=this.parts,u,a,f;return u=function(t){return n=o[e++],n.bbox=i.getPartRect(n),n},a=function(n){return e<t},f=function(){o=s.parts,t=s.numParts,e=0},{next:u,reset:f,hasNext:a}},e.protectedScope.createKeyEditorIteratorFactory=function(e,t){return new s(e,t)},e.protectedScope.addInitMethod(function(){i=e.createNote,r=e.protectedScope.createPlayhead})}(),function(){"use strict";function c(n){return isNaN(n)?(e.debug&&t.log("please provide a number"),!1):n<0||n>127?(e.debug&&t.log("please provide a number between 0 and 127"),!1):n}function h(t,n,r,s){var u,a,f,l,c,h,p,d,v=0,m=[],g=t.song,y,b,w;for(u=n;u<=r;u++){f=i(g,["barsbeats",u]),p=f.nominator,d=f.ticksPerBeat;for(a=0;a<p;a++)h=a===0?t.noteNumberAccented:t.noteNumberNonAccented,c=a===0?t.noteLengthAccented:t.noteLengthNonAccented,l=a===0?t.velocityAccented:t.velocityNonAccented,y=e.createMidiEvent(v,144,h,l),b=e.createMidiEvent(v+c,128,h,0),s==="precount"&&(y.part={id:"precount"},y.track=t.track,b.part={id:"precount"},b.track=t.track),w=o(y,b),m.push(y,b),v+=d}return m}var e=window.sequencer,t=window.console,n,r,i,s,o,u,a,f={volume:"setVolume",instrument:"setInstrument",noteNumberAccentedTick:"setNoteNumberAccentedTick",noteNumberNonAccentedTick:"setNoteNumberNonAccentedTick",velocityAccentedTick:"setVelocityAccentedTick",velocityNonAccentedTick:"setVelocityNonAccentedTick",noteLengthAccentedTick:"setNoteLengthAccentedTick",noteLengthNonAccentedTick:"setNoteLengthNonAccentedTick"},l;l=function(t){this.song=t,this.track=e.createTrack(this.song.id+"_metronome","metronome"),this.part=e.createPart(),this.track.addPart(this.part),this.track.connect(this.song.gainNode),this.events=[],this.precountEvents=[],this.noteNumberAccented=61,this.noteNumberNonAccented=60,this.volume=1,this.velocityNonAccented=100,this.velocityAccented=100,this.noteLengthNonAccented=t.ppq/4,this.noteLengthAccented=t.ppq/4,this.track.setInstrument("heartbeat/metronome"),this.precountDurationInMillis=0,this.bars=0},l.prototype.init=function(e,t,n){e=e===undefined?"init":e,this.part.numEvents>0&&this.part.removeEvents(this.part.events),this.events=h(this,t,n,e),this.numEvents=this.events.length,this.part.addEvents(this.events),this.bars=this.song.bars,a(this.song,this.events)},l.prototype.update=function(e,t){e===0&&(e=1),e!==undefined&&t!==undefined?this.init("update",e,t):this.init("update",1,this.song.bars)},l.prototype.updateConfig=function(){this.init("configure",1,this.bars),this.allNotesOff(),this.song.scheduler.updateSong()},l.prototype.configure=function(e){var t=this;s(e,function(e,n){t[f[n]](e)}),this.updateConfig()},l.prototype.setInstrument=function(t){t.className!=="Instrument"&&(t=e.createInstrument(t)),t!==!1?this.track.setInstrument(t):this.track.setInstrument("heartbeat/metronome"),this.updateConfig()},l.prototype.setNoteLengthAccentedTick=function(n){isNaN(n)&&e.debug>=2&&t.warn("please provide a number"),this.noteLengthAccented=n,this.updateConfig()},l.prototype.setNoteLengthNonAccentedTick=function(n){isNaN(n)&&e.debug>=2&&t.warn("please provide a number"),this.noteLengthNonAccented=n,this.updateConfig()},l.prototype.setVelocityAccentedTick=function(n){n=c(n),n!==!1?this.velocityAccented=n:e.debug>=2&&t.warn("please provide a number"),this.updateConfig()},l.prototype.setVelocityNonAccentedTick=function(n){n=c(n),n!==!1?this.velocityNonAccented=n:e.debug>=2&&t.warn("please provide a number"),this.updateConfig()},l.prototype.setNoteNumberAccentedTick=function(n){n=c(n),n!==!1?this.noteNumberAccented=n:e.debug>=2&&t.warn("please provide a number"),this.updateConfig()},l.prototype.setNoteNumberNonAccentedTick=function(n){n=c(n),n!==!1?this.noteNumberNonAccented=n:e.debug>=2&&t.warn("please provide a number"),this.updateConfig()},l.prototype.reset=function(){this.volume=1,this.track.setInstrument("heartbeat/metronome"),this.noteNumberAccented=61,this.noteNumberNonAccented=60,this.velocityAccented=100,this.velocityNonAccented=100,this.noteLengthAccented=this.song.ppq/4,this.noteLengthNonAccented=this.song.ppq/4},l.prototype.allNotesOff=function(){this.track.instrument&&this.track.instrument.allNotesOff()},l.prototype.createPrecountEvents=function(e){if(e<=0)return;var t=this.song.getPosition("barsbeats",this.song.bar+e);this.index=0,this.millis=0,this.startMillis=this.song.millis,this.precountDurationInMillis=t.millis-this.startMillis,this.precountEvents=h(this,this.song.bar,t.bar-1,"precount"),u(this.song,this.precountEvents)},l.prototype.getPrecountEvents=function(e){var t=this.precountEvents,n=t.length,r,i,s=[];for(r=this.index;r<n;r++){i=t[r];if(!(i.millis<e))break;i.time=this.startTime+i.millis,s.push(i),this.index++}return s},l.prototype.setVolume=function(e){this.track.setVolume(e)},e.protectedScope.createMetronome=function(e){return new l(e)},e.protectedScope.addInitMethod(function(){n=e.protectedScope.context,r=e.protectedScope.findItem,i=e.protectedScope.getPosition,o=e.createMidiNote,s=e.util.objectForEach,u=e.protectedScope.parseEvents,a=e.protectedScope.parseMetronomeEvents})}(),function(){"use strict";var e=window.sequencer,t=window.console,n=Array.prototype.slice,r,i,s,o=0;s=function(n){var s,u;this.className="MidiEvent",this.id="M"+o+(new Date).getTime(),this.eventNumber=o,this.channel="any",this.time=0,this.muted=!1,o++;if(!n)return;if(i(n[0])==="midimessageevent"){t.log("midimessageevent");return}if(i(n[0])==="array")s=n[0];else{if(i(n[0])!=="number"||i(n[1])!=="number")return e.debug>=1&&t.error("wrong number of arguments, please consult documentation"),!1;s=[n[0],n[1]],n.length>=3&&i(n[2])==="number"&&s.push(n[2]),n.length===4&&i(n[3])==="number"&&s.push(n[3]),n.length===5&&i(n[4])==="number"&&s.push(n[4])}this.ticks=s[0],this.status=s[1],this.type=(this.status>>4)*16,this.type>=128?(this.command=this.type,this.channel=(this.status&15)+1):(this.type=this.status,this.channel=s[4]||"any"),this.sortIndex=this.type+this.ticks;switch(this.type){case 0:break;case 128:this.data1=s[2],u=r(this.data1),this.note=u,this.noteName=u.fullName,this.noteNumber=u.number,this.octave=u.octave,this.frequency=u.frequency,this.data2=0,this.velocity=this.data2;break;case 144:this.data1=s[2],this.data2=s[3],this.data2===0&&(this.type=128),u=r(this.data1),this.note=u,this.noteName=u.fullName,this.noteNumber=u.number,this.octave=u.octave,this.frequency=u.frequency,this.velocity=this.data2;break;case 81:this.bpm=s[2];break;case 88:this.nominator=s[2],this.denominator=s[3];break;case 176:this.data1=s[2],this.data2=s[3],this.controllerType=s[2],this.controllerValue=s[3];break;case 192:this.data1=s[2],this.programNumber=s[2];break;case 208:this.data1=s[2],this.data2=s[3];break;case 224:this.data1=s[2],this.data2=s[3];break;case 47:break;default:t.warn("not a recognized type of midi event!")}},s.prototype.clone=s.prototype.copy=function(){var e=new s,t;for(t in this)this.hasOwnProperty(t)&&(t!=="id"&&t!=="eventNumber"&&t!=="midiNote"&&(e[t]=this[t]),e.song=undefined,e.track=undefined,e.trackId=undefined,e.part=undefined,e.partId=undefined);return e},s.prototype.transpose=function(n){if(this.type!==128&&this.type!==144){e.debug>=1&&t.error("you can only transpose note on and note off events");return}if(i(n)==="array"){var s=n[0];s!=="hertz"&&(s==="semi"||s==="semitone")&&(n=n[1])}else if(isNaN(n)===!0){e.debug>=1&&t.error("please provide a number");return}var o=this.data1+parseInt(n,10);o<0?o=0:o>127&&(o=127),this.data1=o;var u=r(this.data1);this.note=u,this.noteName=u.fullName,this.noteNumber=u.number,this.octave=u.octave,this.frequency=u.frequency,this.midiNote!==undefined&&(this.midiNote.pitch=this.data1),this.state!=="new"&&(this.state="changed"),this.part!==undefined&&(this.part.needsUpdate=!0)},s.prototype.setPitch=function(n){if(this.type!==128&&this.type!==144){e.debug>=1&&t.error("you can only set the pitch of note on and note off events");return}if(i(n)==="array"){var s=n[0];s!=="hertz"&&(s==="semi"||s==="semitone")&&(n=n[1])}else if(isNaN(n)===!0){e.debug>=1&&t.error("please provide a number");return}this.data1=parseInt(n,10);var o=r(this.data1);this.note=o,this.noteName=o.fullName,this.noteNumber=o.number,this.octave=o.octave,this.frequency=o.frequency,this.midiNote!==undefined&&(this.midiNote.pitch=this.data1),this.state!=="new"&&(this.state="changed"),this.part!==undefined&&(this.part.needsUpdate=!0)},s.prototype.move=function(n){if(isNaN(n)){e.debug>=1&&t.error("please provide a number");return}this.ticks+=parseInt(n,10),this.state!=="new"&&(this.state="changed"),this.part!==undefined&&(this.part.needsUpdate=!0)},s.prototype.moveTo=function(){var r=n.call(arguments);r[0]==="ticks"&&isNaN(r[1])===!1?this.ticks=parseInt(r[1],10):this.song===undefined?e.debug>=1&&t.error("The midi event has not been added to a song yet; you can only move to ticks values"):(r=this.song.getPosition(r),r===!1?e.debug>=1&&t.error("wrong position data"):this.ticks=r.ticks),this.state!=="new"&&(this.state="changed"),this.part!==undefined&&(this.part.needsUpdate=!0)},s.prototype.reset=function(e,t,n){e=e===undefined?!0:!1,t=t===undefined?!0:!1,n=n===undefined?!0:!1,e&&(this.part=undefined,this.partId=undefined),t&&(this.track=undefined,this.trackId=undefined,this.channel=0),n&&(this.song=undefined)},s.prototype.update=function(){},e.createMidiEvent=function(){var e=n.call(arguments),t=e[0].className;return t==="MidiEvent"?e[0].copy():new s(e)},e.protectedScope.addInitMethod(function(){r=e.createNote,i=e.protectedScope.typeString})}(),function(){"use strict";function i(n){var r=!1;return n=n.replace(/_/g," "),r=e[n]||!1,r!==!1?r:(n=n.replace(/\s/g,"_"),r=t[n]||!1,r===!1&&sequencer.debug===!0&&console.warn(n,"is not a valid (or supported) midi event name, please consult documentation"),r)}function s(e,t){var i=!1;return t=t||"upper",t==="lower"?(i=n[e]||!1,i===!1&&sequencer.debug===!0&&console.warn(e,"is not a valid (or supported) midi event number, please consult documentation"),i):(i=r[e]||!1,i===!1&&sequencer.debug===!0&&console.warn(e,"is not a valid (or supported) midi event number, please consult documentation"),i)}function o(e){return isNaN(e)?i(e):s(e)}var e={"note off":128,"note on":144,"poly pressure":160,"control change":176,"program change":192,"channel pressure":208,"pitch bend":224,tempo:81,"time signature":88,"end of track":47},t={NOTE_OFF:128,NOTE_ON:144,POLY_PRESSURE:160,CONTROL_CHANGE:176,PROGRAM_CHANGE:192,CHANNEL_PRESSURE:208,PITCH_BEND:224,TEMPO:81,TIME_SIGNATURE:88,END_OF_TRACK:47},n={128:"note off",144:"note on",160:"poly pressure",176:"control change",192:"program change",208:"channel pressure",224:"pitch bend",81:"tempo",88:"time signature",47:"end of track"},r={128:"NOTE_OFF",144:"NOTE_ON",160:"POLY_PRESSURE",176:"CONTROL_CHANGE",192:"PROGRAM_CHANGE",208:"CHANNEL_PRESSURE",224:"PITCH_BEND",81:"TEMPO",88:"TIME_SIGNATURE",47:"END_OF_TRACK"};Object.defineProperty(sequencer,"DUMMY_EVENT",{value:0}),Object.defineProperty(sequencer,"MIDI_NOTE",{value:112}),Object.defineProperty(sequencer,"NOTE_OFF",{value:128}),Object.defineProperty(sequencer,"NOTE_ON",{value:144}),Object.defineProperty(sequencer,"POLY_PRESSURE",{value:160}),Object.defineProperty(sequencer,"CONTROL_CHANGE",{value:176}),Object.defineProperty(sequencer,"PROGRAM_CHANGE",{value:192}),Object.defineProperty(sequencer,"CHANNEL_PRESSURE",{value:208}),Object.defineProperty(sequencer,"PITCH_BEND",{value:224}),Object.defineProperty(sequencer,"SYSTEM_EXCLUSIVE",{value:240}),Object.defineProperty(sequencer,"MIDI_TIMECODE",{value:241}),Object.defineProperty(sequencer,"SONG_POSITION",{value:242}),Object.defineProperty(sequencer,"SONG_SELECT",{value:243}),Object.defineProperty(sequencer,"TUNE_REQUEST",{value:246}),Object.defineProperty(sequencer,"EOX",{value:247}),Object.defineProperty(sequencer,"TIMING_CLOCK",{value:248}),Object.defineProperty(sequencer,"START",{value:250}),Object.defineProperty(sequencer,"CONTINUE",{value:251}),Object.defineProperty(sequencer,"STOP",{value:252}),Object.defineProperty(sequencer,"ACTIVE_SENSING",{value:254}),Object.defineProperty(sequencer,"SYSTEM_RESET",{value:255}),Object.defineProperty(sequencer,"TEMPO",{value:81}),Object.defineProperty(sequencer,"TIME_SIGNATURE",{value:88}),Object.defineProperty(sequencer,"END_OF_TRACK",{value:47}),sequencer.checkEventType=o,sequencer.midiEventNameByNumber=s,sequencer.midiEventNumberByName=i}(),function(){"use strict";function v(e,t){e=undefined,t&&t(!1)}function m(n,r,i){var s,o,u,a,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B;r=new Uint8Array(r),s=f(r),n.base64="",n.numTracks=0,o=0,v=s.tracks.length,e.overrulePPQ===!0&&isNaN(e.defaultPPQ)===!1&&e.defaultPPQ>0?(k=e.defaultPPQ/s.header.ticksPerBeat,n.ppq=e.defaultPPQ):(k=1,n.ppq=s.header.ticksPerBeat),S=[],n.tracks=[];while(o<v){m=s.tracks[o],a=m.length,y=0,b=0,w=-1,p=c(),d=l(),E=[],u=0,_=0,D=0,P=0,H={},B={};for(u=0;u<a;u++){g=m[u],b+=g.deltaTime*k,w===-1&&g.channel!==undefined&&(w=g.channel,d.channel=w),L=g.subtype,L==="noteOn"?_++:L==="noteOff"?D++:P++;switch(g.subtype){case"trackName":d.name=g.text;break;case"instrumentName":g.text&&(d.instrumentName=g.text);break;case"noteOn":E.push(h(b,144,g.noteNumber,g.velocity));break;case"noteOff":E.push(h(b,128,g.noteNumber,g.velocity));break;case"endOfTrack":break;case"setTempo":T=6e7/g.microsecondsPerBeat,b===y&&A===L&&(e.debug>=3&&t.info("tempo events on the same tick",u,b,T),S.pop()),n.bpm===undefined&&(n.bpm=T),S.push(h(b,81,T));break;case"timeSignature":b===y&&A===L&&(e.debug>=3&&t.info("time signature events on the same tick",u,b,g.numerator,g.denominator),S.pop()),n.nominator===undefined&&(n.nominator=g.numerator,n.denominator=g.denominator),S.push(h(b,88,g.numerator,g.denominator));break;case"controller":E.push(h(b,176,g.controllerType,g.value));break;case"programChange":E.push(h(b,192,g.programNumber));break;case"channelAftertouch":E.push(h(b,208,g.amount));break;case"pitchBend":E.push(h(b,224,g.value));break;default:}A=L,y=b}E.length>0&&(d.addPart(p),p.addEvents(E),n.tracks.push(d),n.numTracks++),o++}n.timeEvents=S,n.autoSize=!0,n.loaded=!0,i(n)}function g(i,o){if(i.base64!==undefined){m(i,r(i.base64),o);return}if(i.arraybuffer!==undefined){m(i,i.arraybuffer,o);return}s({url:i.url,responseType:i.responseType,onError:function(){v(i,o)},onSuccess:function(s){if(i.responseType==="json"){if(s===null){o(!1);return}if(s.base64===undefined){v(i,o),e.debug&&t.warn("no base64 data");return}s.name!==undefined&&i.name===undefined&&(i.name=s.name),s.folder!==undefined&&i.folder===undefined&&(i.folder=s.folder),i.name===undefined&&(i.name=n(i.url).name),i.localPath=i.folder!==undefined?i.folder+"/"+i.name:i.name,m(i,r(s.base64),o)}else i.name===undefined&&(i.name=n(i.url).name),i.localPath=i.folder!==undefined?i.folder+"/"+i.name:i.name,m(i,s,o)}})}function y(n){var r=o(n.localPath,e.storage.midi,!0),i=n.action;r&&r.className==="MidiFile"&&i!=="overwrite"?e.debug>=2&&(t.warn("there is already a midifile at",n.localPath),v(n)):u(n,n.localPath,e.storage.midi)}function b(e){function n(n,i){t.addEventListener("loadend",function(){m({},t.result,function(e){n(e)})}),t.addEventListener("error",function(e){i(e)}),e.blob!==undefined?t.readAsArrayBuffer(e.blob):e.arraybuffer!==undefined?m({},e.arraybuffer,function(e){n(e)}):e.base64!==undefined&&m({},r(e.base64),function(e){n(e)})}var t=new FileReader;this._promise=new Promise(n)}var e=window.sequencer,t=window.console,n,r,i,s,o,u,a,f,l,c,h,p=0,d;d=function(e){this.id="MF"+p++ +(new Date).getTime(),this.className="MidiFile",this.url=e.url,this.json=e.json,this.base64=e.base64,this.arraybuffer=e.arraybuffer,this.name=e.name,this.folder=e.folder,this.url!==undefined?this.responseType=this.url.indexOf(".json")===this.url.lastIndexOf(".")?"json":"arraybuffer":this.name===undefined&&this.folder===undefined?(this.name=this.id,this.localPath=this.id):this.localPath=this.folder!==undefined?this.folder+"/"+this.name:this.name},e.addMidiFile=function(n,r){var s=i(n),o,u,a,f;if(s!=="object")return e.debug>=2&&t.warn("can't create a MidiFile with this data",n),!1;if(n.json){u=n.json,a=n.name,f=n.folder;if(i(u)==="string")try{u=JSON.parse(u)}catch(l){return e.debug>=2&&t.warn("can't create a MidiFile with this data",n),!1}if(u.base64===undefined)return e.debug>=2&&t.warn("can't create a MidiFile with this data",n),!1;n={base64:u.base64,name:a===undefined?u.name:a,folder:f===undefined?u.folder:f}}o=new d(n),e.addTask({type:"load midifile",method:g,params:o},function(){y(o),r&&r(o)}),e.startTaskQueue()},e.createMidiFile=function(e){var t=new b(e);return t._promise},e.protectedScope.addInitMethod(function(){s=e.protectedScope.ajax,o=e.protectedScope.findItem,u=e.protectedScope.storeItem,a=e.protectedScope.deleteItem,n=e.protectedScope.parseUrl,i=e.protectedScope.typeString,f=e.protectedScope.parseMidiFile,r=e.protectedScope.base64ToBinary,c=e.createPart,l=e.createTrack,h=e.createMidiEvent})}(),function(){"use strict";var e,t=window.sequencer,n=window.console,r,i,s=0;e=function(e){var i=e.length,o,u,a,f,l,c;if(i===1){o=e[0];if(o===undefined){n.error("please provide at least a note on event");return}this.noteOn=o}else if(i===2){o=e[0],u=e[1];if(o===undefined){n.error("please provide at least a note on event");return}if(o.className==="MidiEvent"&&u&u.className==="MidiEvent"){if(o.ticks>=u.ticks){n.error("MidiNote has wrong duration");return}this.noteOn=o,this.noteOff=u}}else{if(i!==4){n.error("wrong number of arguments, please consult documentation");return}a=e[0],f=e[1],l=e[2],c=e[3];if(a&&f&&a>=f){n.error("MidiNote has wrong duration");return}if(l<0||l>127){n.error("MidiNote has wrong note number");return}if(c<0||c>127){n.error("MidiNote has wrong velocity");return}o=r(a,t.NOTE_ON,l,c),u&&(u=r(f,t.NOTE_OFF,l,0))}o.midiNote=this,this.noteOn=o,u===undefined?this.endless=!0:(u.midiNote=this,this.endless=!1,this.noteOff=u,this.durationTicks=u.ticks-o.ticks,this.durationMillis=u.millis-o.millis),this.note=o.note,this.number=o.noteNumber,this.ticks=o.ticks,this.pitch=o.data1,this.velocity=o.velocity,this.id="N"+s+(new Date).getTime(),this.name=o.noteName,this.className="MidiNote",this.type=t.MIDI_NOTE,s++},e.prototype.addNoteOff=function(e){this.noteOff!==undefined&&(n.log(e.ticks,e.noteNumber,this.id,"override note off event"),this.noteOff.midiNote=undefined);var t=this.noteOn;e.midiNote=this,this.endless=!1,this.noteOff=e,this.durationTicks=e.ticks-t.ticks,this.durationMillis=e.millis-t.millis,this.endless=!1},e.prototype.setPitch=function(e){if(e<0||e>127)return;this.noteOn.setPitch(e),this.endless===!1&&this.noteOff.setPitch(e),this.number=this.noteOn.noteNumber,this.name=this.noteOn.noteName,this.pitch=e},e.prototype.mute=function(e){e!==undefined?this.mute=e:this.mute=!this.mute},t.protectedScope.addInitMethod(function(){r=t.createMidiEvent,i=t.protectedScope.typeString}),t.createMidiNote=function(){return new e(Array.prototype.slice.call(arguments))}}(),function(){"use strict";function o(e){var t=e.read(4,!0),n=e.readInt32();return{id:t,length:n,data:e.read(n,!1)}}function u(e){var t={};t.deltaTime=e.readVarInt();var s=e.readInt8(),o;if((s&240)==240){if(s==255){t.type="meta";var u=e.readInt8();o=e.readVarInt();switch(u){case 0:t.subtype="sequenceNumber";if(o!==2)throw"Expected length for sequenceNumber event is 2, got "+o;return t.number=e.readInt16(),t;case 1:return t.subtype="text",t.text=e.read(o),t;case 2:return t.subtype="copyrightNotice",t.text=e.read(o),t;case 3:return t.subtype="trackName",t.text=e.read(o),r=t.text,t;case 4:return t.subtype="instrumentName",t.text=e.read(o),i=t.text,t;case 5:return t.subtype="lyrics",t.text=e.read(o),t;case 6:return t.subtype="marker",t.text=e.read(o),t;case 7:return t.subtype="cuePoint",t.text=e.read(o),t;case 32:t.subtype="midiChannelPrefix";if(o!==1)throw"Expected length for midiChannelPrefix event is 1, got "+o;return t.channel=e.readInt8(),t;case 47:t.subtype="endOfTrack";if(o!==0)throw"Expected length for endOfTrack event is 0, got "+o;return t;case 81:t.subtype="setTempo";if(o!==3)throw"Expected length for setTempo event is 3, got "+o;return t.microsecondsPerBeat=(e.readInt8()<<16)+(e.readInt8()<<8)+e.readInt8(),t;case 84:t.subtype="smpteOffset";if(o!==5)throw"Expected length for smpteOffset event is 5, got "+o;var a=e.readInt8();return t.frameRate={0:24,32:25,64:29,96:30}[a&96],t.hour=a&31,t.min=e.readInt8(),t.sec=e.readInt8(),t.frame=e.readInt8(),t.subframe=e.readInt8(),t;case 88:t.subtype="timeSignature";if(o!==4)throw"Expected length for timeSignature event is 4, got "+o;return t.numerator=e.readInt8(),t.denominator=Math.pow(2,e.readInt8()),t.metronome=e.readInt8(),t.thirtyseconds=e.readInt8(),t;case 89:t.subtype="keySignature";if(o!==2)throw"Expected length for keySignature event is 2, got "+o;return t.key=e.readInt8(!0),t.scale=e.readInt8(),t;case 127:return t.subtype="sequencerSpecific",t.data=e.read(o),t;default:return t.subtype="unknown",t.data=e.read(o),t}return t.data=e.read(o),t}if(s==240)return t.type="sysEx",o=e.readVarInt(),t.data=e.read(o),t;if(s==247)return t.type="dividedSysEx",o=e.readVarInt(),t.data=e.read(o),t;throw"Unrecognised MIDI event type byte: "+s}var f;(s&128)===0?(f=s,s=n):(f=e.readInt8(),n=s);var l=s>>4;t.channel=s&15,t.type="channel";switch(l){case 8:return t.subtype="noteOff",t.noteNumber=f,t.velocity=e.readInt8(),t;case 9:return t.noteNumber=f,t.velocity=e.readInt8(),t.velocity===0?t.subtype="noteOff":t.subtype="noteOn",t;case 10:return t.subtype="noteAftertouch",t.noteNumber=f,t.amount=e.readInt8(),t;case 11:return t.subtype="controller",t.controllerType=f,t.value=e.readInt8(),t;case 12:return t.subtype="programChange",t.programNumber=f,t;case 13:return t.subtype="channelAftertouch",t.amount=f,t;case 14:return t.subtype="pitchBend",t.value=f+(e.readInt8()<<7),t;default:return t.value=e.readInt8(),t.subtype="unknown",t}}function a(e){var t,n,i,a,f=[],l,c=[],h,p,d,v;d=o(e);if(d.id!=="MThd"||d.length!==6)throw"Bad .mid file - header not found";v=s(d.data),t=v.readInt16(),n=v.readInt16(),i=v.readInt16();if(i&32768)throw"Expressing time division in SMTPE frames is not supported yet";a=i;var m={formatType:t,trackCount:n,ticksPerBeat:a};for(l=0;l<n;l++){f[l]=[],c[l]=r,h=o(e);if(h.id!=="MTrk")throw"Unexpected chunk - expected MTrk, got "+h.id;p=s(h.data);while(!p.eof()){var g=u(p);f[l].push(g)}}return{header:m,tracks:f,trackNames:c}}var e=window.sequencer,t=window.console,n,r,i,s;e.protectedScope.parseMidiFile=function(e){return a(s(e))},e.protectedScope.addInitMethod(function(){s=e.protectedScope.createStream})}(),function(){"use strict";function r(e){function r(r,i){var s,o;i=i===undefined?!0:i;if(i){s="";for(o=0;o<r;o++,t++)s+=n(e[t]);return s}s=[];for(o=0;o<r;o++,t++)s.push(e[t]);return s}function i(){var n=(e[t]<<24)+(e[t+1]<<16)+(e[t+2]<<8)+e[t+3];return t+=4,n}function s(){var n=(e[t]<<8)+e[t+1];return t+=2,n}function o(n){var r=e[t];return n&&r>127&&(r-=256),t+=1,r}function u(){return t>=e.length}function a(){var e=0;for(;;){var t=o();if(!(t&128))return e+t;e+=t&127,e<<=7}}var t=0;return{eof:u,read:r,readInt32:i,readInt16:s,readInt8:o,readVarInt:a}}var e=window.sequencer,t=window.console,n=String.fromCharCode;e.protectedScope.createStream=r}(),function(){"use strict";function d(n){if(h===!0){n();return}h=!0,navigator.requestMIDIAccess!==undefined?navigator.requestMIDIAccess().then(function(r){r._jazzInstances!==undefined?(e.jazz=r._jazzInstances[0]._Jazz.version,e.midi=!0):(e.webmidi=!0,e.midi=!0),f=r,f.onstatechange=v,v(),n()},function(r){t.log("MIDI could not be initialized:",r),n()}):(e.browser==="chrome"?t.log("Web MIDI API not enabled"):t.log("Web MIDI API not supported"),n())}function v(t){var n,r;l=[],c=[],n=f.inputs,n.forEach(function(t){l.push({name:t.name,id:t.id}),e.midiInputs[t.id]=t}),l.sort(function(e,t){var n=e.name.toLowerCase(),r=t.name.toLowerCase();return n<r?-1:n>r?1:0}),e.numMidiInputs=l.length,r=f.outputs,r.forEach(function(t){c.push({name:t.name,id:t.id}),e.midiOutputs[t.id]=t}),c.sort(function(e,t){var n=e.name.toLowerCase(),r=t.name.toLowerCase();return n<r?-1:n>r?1:0}),e.numMidiOutputs=c.length}function m(t){a=function(e){b(e,t,this)},i(e.midiInputs,function(e){e.onmidimessage=a,t.midiInputs[e.id]=e}),i(e.midiOutputs,function(e){t.midiOutputs[e.id]=e}),t.numMidiInputs=e.numMidiInputs,t.numMidiOutputs=e.numMidiOutputs}function g(n,r,i){var s=e.midiInputs[n],o=i.tracks,u=i.numTracks-1,f,l;r=r===undefined?!0:r;if(s===undefined){e.debug===!0&&t.log("no midi input with id",n,"found");return}r===!1?(delete i.midiInputs[n],s.onmidimessage=null,i.numMidiInputs--):s!==undefined&&(i.midiInputs[n]=s,s.onmidimessage=a,i.numMidiInputs++);for(f=u;f>=0;f--)l=o[f],l.setMidiInput(n,r)}function y(n,r,i){var s=e.midiOutputs[n],o=i.tracks,u=i.numTracks-1,a,f,l;r=r===undefined?!0:r;if(s===undefined){e.debug===!0&&t.log("no midi output with id",n,"found");return}r===!1?(delete i.midiOutputs[n],i.numMidiOutputs--,l=i.scheduler.lastEventTime+100,s.send([176,123,0],l),s.send([176,121,0],l)):s!==undefined&&(i.midiOutputs[n]=s,i.numMidiOutputs++);for(a=u;a>=0;a--)f=o[a],f.setMidiOutput(n,r)}function b(e,t,n){var r=e.data,s,u,a=t.tracks,f=t.numTracks,l,c;l=o(t.ticks,r[0],r[1],r[2]);for(s=0;s<f;s++)u=a[s],u.monitor===!0&&u.midiInputs[n.id]!==undefined&&w(l,u,n);c=t.midiEventListeners[l.type];if(c===undefined)return;i(c,function(e){e(l,n)})}function w(e,t,r){var o=t.song,u,a,f;e.recordMillis=n.currentTime*1e3,e.state="recorded";if(e.type===144)u=s(e),t.recordingNotes[e.data1]=u;else if(e.type===128){u=t.recordingNotes[e.data1];if(u===undefined)return;u.addNoteOff(e),delete t.recordingNotes[e.data1]}(o.prerolling||o.recording)&&t.recordEnabled==="midi"?(e.type===144&&t.song.recordedNotes.push(u),t.recordPart.addEvent(e),t.song.recordedEvents.push(e)):t.enableRetrospectiveRecording&&t.retrospectiveRecording.push(e),a=t.midiEventListeners[e.type],a!==undefined&&i(a,function(t){t(e,r)}),f=t.channel;if(f==="any"||f===undefined||isNaN(f)===!0)f=0;i(t.midiOutputs,function(t){(e.type===128||e.type===144||e.type===176)&&t.send([e.type,e.data1,e.data2])}),t.routeToMidiOut===!1&&(e.track=t,t.instrument.processEvent(e))}function E(t,n){t=u.call(t);var s=p++,o={},a=[],f,l;return l=function(t,n,i){for(n=0;n<i;n++){var s=t[n],u=r(s);u==="array"?l(s,0,s.length):u==="function"?f=s:isNaN(s)===!1?(s=parseInt(s,10),e.checkEventType(s)!==!1&&(o[s]=s)):u==="string"&&e.checkEventType(s)!==!1&&(s=e.midiEventNumberByName(s),o[s]=s)}},l(t,0,t.length),i(o,function(e){n.midiEventListeners[e]===undefined&&(n.midiEventListeners[e]={}),n.midiEventListeners[e][s]=f,a.push(e+"_"+s)}),a.length===1?a[0]:a}function S(e,t){var n;e=e.split("_"),n=e[0],e=e[1],delete t.midiEventListeners[n][e]}function x(){}function T(e,n){var r=document.createElement("select"),s,o,u=e.type,a=e.id||u,f=e.div,l=e.firstOption;if(u!=="input"&&u!=="output"){t.log('please set type to "input" or "output"');return}return l===undefined&&(l=u==="input"?"choose MIDI in":"choose MIDI out"),r.id=a,o=u==="input"?n.midiInputs:n.midiOutputs,l!==!1&&(s=document.createElement("option"),s.value=-1,s.innerHTML=l,r.appendChild(s)),i(o,function(e){s=document.createElement("option"),s.value=e.id,s.innerHTML=e.name,r.appendChild(s)}),f&&f.appendChild(r),r}function N(t,n){var r,s;if(n===e)for(r=0,s=l.length;r<s;r++)t(n.midiInputs[l[r].id],r);else i(n.midiInputs,function(e){t(e,r)})}function C(t,n){var r,s;if(n===e)for(r=0,s=c.length;r<s;r++)t(n.midiOutputs[c[r].id],r);else i(n.midiOutputs,function(e,n){t(e,n)})}var e=window.sequencer,t=window.console,n,r,i,s,o,u=Array.prototype.slice,a,f,l,c,h=!1,p=0;e.getMidiPortsAsDropdown=function(){T(e)},e.getMidiInputsAsDropdown=function(t){return t=t||{type:"input"},T(t,e)},e.getMidiOutputsAsDropdown=function(t){return t=t||{type:"output"},T(t,e)},e.getMidiInputs=function(t){N(t,e)},e.getMidiOutputs=function(t){C(t,e)},e.protectedScope.addInitMethod(function(){n=e.protectedScope.context,s=e.createMidiNote,o=e.createMidiEvent,r=e.protectedScope.typeString,i=
e.protectedScope.objectForEach}),e.protectedScope.initMidi=d,e.protectedScope.initMidiSong=m,e.protectedScope.getMidiInputs=N,e.protectedScope.getMidiOutputs=C,e.protectedScope.setMidiInputSong=g,e.protectedScope.setMidiOutputSong=y,e.protectedScope.addMidiEventListener=E,e.protectedScope.getMidiPortsAsDropdown=T,e.protectedScope.removeMidiEventListener=S,e.protectedScope.removeMidiEventListeners=x,e.protectedScope.handleMidiMessageTrack=w}(),function(){"use strict";function N(e){var t=[].concat(i,s,u),n=e.tracks,r=e.tracks.length+1,o,f,l,c,h,p,d,v,m;t=t.concat(L(r.toString(16),2),a),t=t.concat(C(e.timeEvents,e.durationTicks,"tempo"));for(o=0,f=n.length;o<f;o++)l=n[o],t=t.concat(C(l.events,e.durationTicks,l.name,l.instrumentId));f=t.length,d=new ArrayBuffer(f),m=new Uint8Array(d);for(o=0;o<f;o++)m[o]=t[o];c=new Blob([m],{type:"application/x-midi",endings:"transparent"}),saveAs(c,e.name)}function C(e,t,n,i){var s,o,u,a,l,c,h=0,p=0,d=[];n&&(d.push(0),d.push(255),d.push(3),d=d.concat(A(n.length)),d=d.concat(O(n))),i&&(d.push(0),d.push(255),d.push(4),d=d.concat(A(i.length)),d=d.concat(O(i)));for(o=0,u=e.length;o<u;o++){a=e[o],p=a.ticks-h,p=A(p),d=d.concat(p);if(a.type===128||a.type===144)l=a.type+a.channel,d.push(l),d.push(a.noteNumber),d.push(a.velocity);else if(a.type===81){d.push(255),d.push(81),d.push(3);var v=Math.round(6e7/a.bpm);d=d.concat(L(v.toString(16),3))}else if(a.type===88){var m=a.denominator;m===2?m=1:m===4?m=2:m===8?m=3:m===16?m=4:m===32&&(m=5),d.push(255),d.push(88),d.push(4),d.push(a.nominator),d.push(m),d.push(r/a.nominator),d.push(8)}h=a.ticks}return p=t-h,p=A(p),d=d.concat(p),d.push(255),d.push(47),d.push(0),c=d.length,s=L(c.toString(16),4),[].concat(f,s,d)}function k(e){return String.fromCharCode.apply(null,e)}function L(e,t){if(t)while(e.length/2<t)e="0"+e;var n=[];for(var r=e.length-1;r>=0;r-=2){var i=r===0?e[r]:e[r-1]+e[r];n.unshift(parseInt(i,16))}return n}function A(e){var t=e&127;while(e>>=7)t<<=8,t|=e&127|128;var n=[];for(;;){n.push(t&255);if(!(t&128))break;t>>=8}return n}function O(e){return n.map.call(e,function(e){return e.charCodeAt(0)})}var e=window.sequencer,t=window.console,n=Array.prototype,r=e.defaultPPQ,i=["M".charCodeAt(0),"T".charCodeAt(0),"h".charCodeAt(0),"d".charCodeAt(0)],s=[0,0,0,6],o=[0,0],u=[0,1],a=L(r.toString(16),2),f=["M".charCodeAt(0),"T".charCodeAt(0),"r".charCodeAt(0),"k".charCodeAt(0)],l=0,c=1,h=2,p=3,d=4,v=5,m=6,g=7,y=32,b=47,w=81,E=84,S=88,x=89,T=127;e.protectedScope.saveToMidiFile=N,e.saveSongAsMidiFile=N}(),function(){"use strict";function l(e){}var e,t,n,r,i,s,o,u,a,f=Math.pow;t={sharp:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],flat:["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],"enharmonic-sharp":["B#","C#","C##","D#","D##","E#","F#","F##","G#","G##","A#","A##"],"enharmonic-flat":["Dbb","Db","Ebb","Eb","Fb","Gbb","Gb","Abb","Ab","Bbb","Bb","Cb"]},o=function(){var t=Array.prototype.slice.call(arguments),o=t.length,f,l=!1,c=!1,h,p,d,v,m,g=t[0],y=t[1],b=t[2];if(o===1&&!isNaN(g))g<0||g>127?(c="please provide a note number >= 0 and <= 127",g):(d=g,f=r(d),p=f[0],h=f[1]);else if(o===1&&e(g)==="string"){f=i(g);if(!f)c=g+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave";else{p=f[0],h=f[1],d=n(p,h);if(!d)c=g+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave";else if(d<0||d>127)c="please provide a note between C0 and G10"}}else if(o===2&&e(g)==="string"&&!isNaN(y)){f=i(g,y);if(!f)c=g+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb";else{p=f[0],h=f[1],d=n(p,h);if(!d)c=p+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb";else if(d<0||d>127)c="please provide a note between C0 and G10"}}else if(o===2&&e(g)==="string"&&e(y)==="string"){f=i(g);if(!f)c=g+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave";else{v=u(y),v||(v=sequencer.noteNameMode,l=y+" is not a valid note name mode, using "+v),p=f[0],h=f[1],d=n(p,h);if(!d)c=p+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave";else if(d<0||d>127)c="please provide a note between C0 and G10";p=r(d,v)[0]}}else if(o===2&&e(g)==="number"&&e(y)==="string")g<0||g>127?(c="please provide a note number >= 0 and <= 127",g):(v=u(y),v||(v=sequencer.noteNameMode,l=y+" is not a valid note name mode, using "+v),d=g,f=r(d,v),p=f[0],h=f[1],p=r(d,v)[0]);else if(o===3&&e(g)==="string"&&!isNaN(y)&&e(b)==="string"){f=i(g,y);if(!f)c=g+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave";else{v=u(b),v||(v=sequencer.noteNameMode,l=b+" is not a valid note name mode, using "+v),p=f[0],h=f[1],d=n(p,h);if(!d)c=p+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave";else if(d<0||d>127)c="please provide a note between C0 and G10";p=r(d,v)[0]}}else c="wrong arguments, please consult documentation";return c?(console.error(c),!1):(l&&console.warn(l),m=s(d),{name:p,octave:h,fullName:p+h,number:d,frequency:m,blackKey:a(d)})},r=function(e,n){n=n||sequencer.noteNameMode;var r=Math.floor(e/12-1),i=t[n][e%12];return[i,r]},n=function(e,n,r){var i,s,o,u,a;for(i in t)if(t.hasOwnProperty(i)){r=t[i];for(o=0,u=r.length;o<u;o+=1)if(r[o]===e){s=o;break}}return s===-1?!1:(a=s+12+n*12,a)},s=function(e){return sequencer.pitch*f(2,(e-69)/12)},i=function(){var t=Array.prototype.slice.call(arguments),n=t.length,r=t[0],i=t[1],s,o,u,a,f;if(n===1&&e(r)==="string"){s=r.length,a="",f="";for(o=0;o<s;o++)u=r[o],isNaN(u)&&u!=="-"?a+=u:f+=u;f===""&&(f=0)}else{if(n!==2||e(r)!=="string"||!!isNaN(i))return!1;a=r,f=i}return f=parseInt(f,10),a=a.substring(0,1).toUpperCase()+a.substring(1),[a,f]},u=function(e){var t=!1;switch(e){case"sharp":case"flat":case"enharmonic-sharp":case"enharmonic-flat":t=e}return t},a=function(e){var t;switch(!0){case e%12===1:case e%12===3:case e%12===6:case e%12===8:case e%12===10:t=!0;break;default:t=!1}return t},sequencer.getNoteNumber=function(){var e=o.apply(this,arguments);return e?e.number:!1},sequencer.getNoteName=function(){var e=o.apply(this,arguments);return e?e.name:!1},sequencer.getNoteNameFromNoteNumber=function(e,t){return r(e,t)},sequencer.getNoteOctave=function(){var e=o.apply(this,arguments);return e?e.octave:!1},sequencer.getFullNoteName=function(){var e=o.apply(this,arguments);return e?e.fullName:!1},sequencer.getFrequency=function(){var e=o.apply(this,arguments);return e?e.frequency:!1},sequencer.isBlackKey=function(){var e=o.apply(this,arguments);return e?e.blackKey:!1},Object.defineProperty(sequencer,"SHARP",{value:"sharp"}),Object.defineProperty(sequencer,"FLAT",{value:"flat"}),Object.defineProperty(sequencer,"ENHARMONIC_SHARP",{value:"enharmonic-sharp"}),Object.defineProperty(sequencer,"ENHARMONIC_FLAT",{value:"enharmonic-flat"}),sequencer.createNote=o,sequencer.protectedScope.addInitMethod(function(){e=sequencer.protectedScope.typeString})}(),function(){"use strict";function b(e,t){var n,r,b=0,S=0,x,T;r=t.length,t.sort(function(e,t){return e.sortIndex-t.sortIndex}),w(e.timeEvents[0]);for(T=b;T<r;T++){n=t[T],x=n.ticks-S,l+=x;while(l>=p){f++,l-=p;while(f>d){f-=d,a++;while(a>s)a-=s,u++}}switch(n.type){case 81:y=n.bpm,g=n.millis,v=n.millisPerTick,m=n.secondsPerTick;break;case 88:i=n.factor,s=n.nominator,o=n.denominator,d=n.numSixteenth,c=n.ticksPerBar,h=n.ticksPerBeat,p=n.ticksPerSixteenth,g=n.millis;break;default:g+=x*v,E(n)}S=n.ticks}e.lastEventTmp=n}function w(e){y=e.bpm,i=e.factor,s=e.nominator,o=e.denominator,c=e.ticksPerBar,h=e.ticksPerBeat,p=e.ticksPerSixteenth,d=e.numSixteenth,v=e.millisPerTick,m=e.secondsPerTick,g=e.millis,u=e.bar,a=e.beat,f=e.sixteenth,l=e.tick}function E(t){var b,w;b=e.getNiceTime(g),t.bpm=y,t.factor=i,t.nominator=s,t.denominator=o,t.ticksPerBar=c,t.ticksPerBeat=h,t.ticksPerSixteenth=p,t.numSixteenth=d,t.millisPerTick=v,t.secondsPerTick=m,t.millis=n(g*r)/r,t.hour=b.hour,t.minute=b.minute,t.second=b.second,t.millisecond=b.millisecond,t.timeAsString=b.timeAsString,t.timeAsArray=b.timeAsArray,t.bar=u,t.beat=a,t.sixteenth=f,t.tick=l,w=l===0?"000":l<10?"00"+l:l<100?"0"+l:l,t.barsAsString=u+":"+a+":"+f+":"+w,t.barsAsArray=[u,a,f,l],t.state="clean",t.update()}var e=window.sequencer,t=window.console,n=Math.round,r=Math.pow(10,e.precision),i,s,o,u,a,f,l,c,h,p,d,v,m,g,y;e.protectedScope.parseEvents=b,e.protectedScope.addInitMethod(function(){})}(),function(){"use strict";function T(){m=1/a*60/i/r,v=m*1e3}function N(){s=4/u,w=s*4,g=r*s,y=g*o,b=r/4}function C(e){var n,r,s,a=0;if(e===undefined){E=[],t.log("reset",E);return}k(e),T(),N(),E.sort(function(e,t){return e.ticks-t.ticks});for(a=0;a<S;a++){r=E[a],r.song=e,n=r.ticks-p,h+=n,p=r.ticks,s=r.type,d+=n*v;while(h>=b){c++,h-=b;while(c>w){c-=w,l++;while(l>o)l-=o,f++}}switch(s){case 81:i=r.bpm,T();break;case 88:o=r.nominator,u=r.denominator,N();break;default:continue}L(r)}e.lastEventTmp=r}function k(e){a=e.playbackSpeed,E=e.timeEvents,S=E.length,r=e.ppq,i=e.bpm,o=e.nominator,u=e.denominator,x=0,f=1,l=1,c=1,h=0,p=0,d=0}function L(t){t.bpm=i,t.nominator=o,t.denominator=u,t.ticksPerBar=y,t.ticksPerBeat=g,t.ticksPerSixteenth=b,t.factor=s,t.numSixteenth=w,t.secondsPerTick=m,t.millisPerTick=v,t.ticks=p,t.millis=d,t.seconds=d/1e3,t.bar=f,t.beat=l,t.sixteenth=c,t.tick=h;var n=h===0?"000":h<10?"00"+h:h<100?"0"+h:h;t.barsAsString=f+":"+l+":"+c+":"+n,t.barsAsArray=[f,l,c,h];var r=e.getNiceTime(d);t.hour=r.hour,t.minute=r.minute,t.second=r.second,t.millisecond=r.millisecond,t.timeAsString=r.timeAsString,t.timeAsArray=r.timeAsArray}var e=window.sequencer,t=window.console,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x;e.protectedScope.parseTimeEvents=C,e.protectedScope.addInitMethod(function(){n=e.createMidiEvent})}(),function(){"use strict";var e=window.sequencer,t=window.console,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g=0,y;y=function(e){this.className="Part",this.id="P"+g++ +""+(new Date).getTime(),this.partIndex=g,this.name=e||this.id,this.events=[],this.eventsById={},this.numEvents=0,this.notes=[],this.notesById={},this.numNotes=0,this.dirtyEvents={},this.dirtyNotes={},this.song=undefined,this.autoSize="right",this.ticks=0,this.millis=0,this.start={ticks:this.ticks,millis:this.millis},this.end={ticks:0,millis:0},this.duration={ticks:0,millis:0},this.startPosition=undefined,this.endPosition=undefined,this.needsUpdate=!1,this.state="clean",this.mute=!1,this.solo=!1,this.keepWhenEmpty=!0},d=function(n,r){n=Array.prototype.slice.call(n);var i=0,o=0,u,a,l,c=n[0],h=[],p=[];if(s(c)==="array"){for(o=c.length-1;o>=0;o--)l=c[o],a=f(l,r),a&&h.push(a);i=h.length===0?0:1}u=n.length;for(o=i;o<u;o++)l=n[o],a=f(l,r),a?h.push(a):p.push(l);return h.length===0?(e.debug&&t.warn("no events added",r.name),!1):(p.length===1&&s(p[0])==="array"&&(p=p[0]),{events:h,config:p})},f=function(e,t){var n=!1;return e?e.className==="MidiEvent"||e.className==="AudioEvent"?n=e:s(e)==="array"&&e.length===4?n=r(e):s(e)==="string"?n=t.eventsById[e]:isNaN(e)===!1&&(n=t.events[e]):n=!1,n},l=function(t,n,r){if(t===!1)return;var i,s,o=t.events,u=n.ticks,a=o.length,f=n.track,l=n.eventsById;for(i=0;i<a;i++){s=o[i];if(s.type===e.END_OF_TRACK||s.className!=="MidiEvent"&&s.className!=="AudioEvent")continue;s.className==="AudioEvent"&&n.hasAudioEvents!==!0&&(n.hasAudioEvents=!0),s.part!==undefined&&(s=s.clone()),s.part=n,s.partId=n.id,r&&(u+=s.ticks,s.ticks=u),s.track=f,s.trackId=f?f.id:undefined,s.song=undefined,f!==undefined&&(s.song=f.song),s.state!=="recorded"&&(s.state="new"),l[s.id]=s}n.state!=="new"&&(n.state="changed"),n.needsUpdate=!0},p=function(e,t){if(e===!1)return;var n,r,i=e.events,s=e.config[0];for(n=i.length-1;n>=0;n--)r=i[n],r.transpose(s);t.state!=="new"&&t.track!==undefined&&(t.state="changed",t.track.needsUpdate=!0)},c=function(e,n){if(e===!1)return;var r,i,s,o=e.events,u=e.config[0];if(isNaN(u)){t.warn("Part.moveEvent(s) -> please provide a number");return}for(r=o.length-1;r>=0;r--)i=o[r],s=i.ticks+u,s<0&&(s=0),i.ticks=s,i.state!=="new"&&(i.state="changed");n.needsUpdate=!0,n.state!=="new"&&n.track&&(n.state="changed",n.track.needsUpdate=!0)},h=function(e,n){var r,i,s=[];for(r=e.length-1;r>=0;r--){i=f(e[r],n);if(i===!1)continue;if(i.part!==n){t.warn("can't remove: this event belongs to part",i.part.id);continue}i.state="removed",i.reset(),s.push(i)}return n.track!==undefined&&(n.track.needsUpdate=!0),n.needsUpdate=!0,s},v=function(e){var t=e.notes,n=e.lowestNote,r=e.highestNote,i,s,o,u;for(o=t.length-1;o>=0;o--)u=t[o],u.setPitch(n+(r-u.number)),i=u.noteOn,s=u.noteOff,i.state="changed",s.state="changed",u.state="changed";e.needsUpdate=!0,e.state!=="new"&&e.track&&(e.state="changed",e.track.needsUpdate=!0)},m=function(e,t){var n=e.notes,r,i,s,o,u,a;t=t||e.duration.ticks;for(a=n.length-1;a>=0;a--)r=n[a],i=r.noteOn,s=r.noteOff,o=t-s.ticks,u=t-i.ticks,i.ticks=o,s.ticks=u,r.ticks=o,i.state="changed",s.state="changed",r.state="changed";e.needsUpdate=!0,e.state!=="new"&&e.track&&(e.state="changed",e.track.needsUpdate=!0)},y.prototype.addEvent=y.prototype.addEvents=function(){var e=d(arguments,this);l(e,this,!1)},y.prototype.addEventsRelative=function(){var e=d(arguments,this);l(e,this,!0)},y.prototype.removeEvent=y.prototype.removeEvents=function(){var e=d(arguments,this);return e===!1?!1:h(e.events,this)},y.prototype.moveEvent=y.prototype.moveEvents=function(){var e=d(arguments,this);c(e,this)},y.prototype.moveAllEvents=function(e){c({events:this.events,config:[e]},this)},y.prototype.moveNote=function(e,t){c({events:[e.noteOn,e.noteOff],config:[t]},this)},y.prototype.transposeEvents=function(){var e=d(arguments,this);p(e,this)},y.prototype.transposeAllEvents=function(e){p({events:this.events,config:[e]},this)},y.prototype.transposeNote=function(e,t){p({events:[e.noteOn,e.noteOff],config:[t]},this)},y.prototype.reverseByTicks=function(e){this.needsUpdate&&this.update(),m(this,e)},y.prototype.reverseByPitch=function(){this.needsUpdate&&this.update(),v(this)},y.prototype.findEvents=function(e){return o(this,e)},y.prototype.findNotes=function(e){return u(this,e)},y.prototype.getStats=function(e){return a(this,e)},y.prototype.getIndex=function(){var e,t,n;if(this.track){e=this.track.parts;for(n=this.track.numParts-1;n>=0;n--){t=e[n];if(t.id===this.id)return n}}return-1},y.prototype.copy=function(){var e=new y(i(this.name)),t=this.ticks,n=this.eventsById,r=[],s,o,u;e.song=undefined,e.track=undefined,e.trackId=undefined;for(o in n)n.hasOwnProperty(o)&&(u=n[o],s=u.copy(),s.ticks=s.ticks-t,r.push(s));return e.addEvents(r),e},y.prototype.setSolo=function(e){e===undefined&&(e=!this.solo),this.mute=!1,this.solo=e,this.allNotesOff(),this.track&&this.track.setPartSolo(this,e)},y.prototype.allNotesOff=function(){if(this.track===undefined)return;this.track.instrument.allNotesOffPart(this.id)},y.prototype.reset=function(e,t){var n=this.eventsById,r,i;t&&(this.song=undefined),e&&(this.track=undefined),this.trackId=undefined,this.start.millis=undefined,this.end.millis=undefined;for(r in n)n.hasOwnProperty(r)&&(i=n[r],i.ticks-=this.ticks,i.reset(!1,e,t));this.ticks=0,this.needsUpdate=!0},y.prototype.update=function(){var t,r,i,s,o,u,a,f,l,c,h,p,d,v=[],m=[],g=0,y=this,b=this.id,w=this.track,E=this.track?this.track.id:undefined;this.events=[];for(o in this.eventsById)this.eventsById.hasOwnProperty(o)&&(u=this.eventsById[o],u.state!=="clean"&&(this.dirtyEvents[u.id]=u),u.state!=="removed"&&this.events.push(u));this.events.sort(function(e,t){return e.sortIndex-t.sortIndex});for(t=0,r=this.notes.length;t<r;t++){f=this.notes[t];if(f.noteOn.state==="removed"||f.noteOff!==undefined&&f.noteOff.state==="removed")f.state="removed",this.dirtyNotes[f.id]=f,delete this.notesById[f.id];else if(f.noteOn.state==="changed"||f.noteOff!==undefined&&f.noteOff.state==="changed")f.state="changed",this.dirtyNotes[f.id]=f}for(t=0,r=this.events.length;t<r;t++){u=this.events[t],a=u.noteNumber;if(u.type===e.NOTE_ON)u.midiNote===undefined&&(f=n(u),f.part=y,f.partId=b,f.track=w,f.trackId=E,f.state="new",this.notesById[f.id]=f,this.dirtyNotes[f.id]=f,m[a]===undefined&&(m[a]=[]),m[a].push(f));else if(u.type===e.NOTE_OFF)if(u.midiNote===undefined){if(m[a]===undefined)continue;var S=m[a].length-1;f=m[a][S];if(f.noteOff!==undefined&&f.durationTicks>0)continue;if(f===null)continue;if(f.noteOn===undefined)continue;f.state!=="new"&&(f.state="changed"),this.dirtyNotes[f.id]=f,f.addNoteOff(u)}else this.notesById[u.midiNote.id]===undefined&&(f=u.midiNote,f.part=y,f.partId=b,f.track=w,f.trackId=E,this.notesById[f.id]=f)}this.notes=[],m=null;for(o in this.notesById)this.notesById.hasOwnProperty(o)&&(f=this.notesById[o],this.notes.push(f));this.notes.sort(function(e,t){return e.ticks-t.ticks}),this.numEvents=this.events.length,this.numNotes=this.notes.length,h=this.events[0],p=this.events[this.numEvents-1];if(h){h.ticks<this.ticks&&(this.autoSize="both");switch(this.autoSize){case"right":this.start.ticks=this.ticks,this.end.ticks=p.ticks,this.duration.ticks=p.ticks-this.start.ticks;break;case"both":this.start.ticks=h.ticks,this.end.ticks=p.ticks,this.duration.ticks=p.ticks-h.ticks}}else this.start.ticks=this.ticks,this.end.ticks=this.ticks+100,this.duration.ticks=100;d=this.getStats("noteNumber all"),this.lowestNote=d.min,this.highestNote=d.max,this.ticks=this.start.ticks,this.state==="clean"&&(this.state="changed"),this.needsUpdate=!1},e.createPart=function(){return new y},e.protectedScope.addInitMethod(function(){n=e.createMidiNote,r=e.createMidiEvent,i=e.protectedScope.copyName,s=e.protectedScope.typeString,o=e.findEvent,u=e.findNote,a=e.getStats})}(),function(){"use strict";var e=window.sequencer,t=window.console,n=0,r=10,i,s,o,u;s=function(e,t,r,i){this.id="POS"+n++ +""+(new Date).getTime(),this.song=e,this.type=t||"",this.name=r||this.id,this.data=i||{},this.lastEvent=undefined,this.activeParts=[],this.activeNotes=[],this.activeEvents=[]},s.prototype.set=function(e,t){return this.unit=e,this.currentValue=t,this.eventIndex=0,this.noteIndex=0,this.partIndex=0,this.calculate(),this.data},s.prototype.get=function(){return this.data},s.prototype.update=function(e,t){return t===0?this.data:(this.unit=e,this.currentValue+=t,this.calculate(),this.data)},s.prototype.updateSong=function(){this.events=this.song.eventsMidiTime,this.numEvents=this.events.length,this.notes=this.song.notes,this.numNotes=this.song.numNotes,this.parts=this.song.parts,this.numParts=this.song.numParts,this.set("millis",this.song.millis||0)},s.prototype.setType=function(e){this.type=e,this.set(this.unit,this.currentValue)},s.prototype.addType=function(e){this.type+=" "+e,this.set(this.unit,this.currentValue)},s.prototype.removeType=function(e){var t=this.type.split(" ");this.type="",t.forEach(function(t){t!==e&&(this.type+=e+" ")}),this.type.trim(),this.set(this.currentValue)},s.prototype.calculate=function(){var n,i,s,a,f,l=[],c=[],h=[],p=[],d=[],v=[];for(n=this.eventIndex;n<this.numEvents;n++){i=this.events[n];if(!(i[this.unit]<=this.currentValue))break;i.type!==e.MIDI_NOTE&&i.type!==e.DUMMY_EVENT&&v.push(i),this.lastEvent=i,this.eventIndex++}this.lastEvent===undefined&&(this.lastEvent=this.song.timeEvents[0]),f=o(this.song,this.unit,this.currentValue,"all",this.lastEvent),this.data.eventIndex=this.eventIndex,this.data.millis=f.millis,this.data.ticks=f.ticks;if(this.type.indexOf("all")!==-1){var m=this.data;u(f,function(e,t){m[t]=e})}else this.type.indexOf("barsbeats")!==-1?(this.data.bar=f.bar,this.data.beat=f.beat,this.data.sixteenth=f.sixteenth,this.data.tick=f.tick,this.data.barsAsString=f.barsAsString,this.data.ticksPerBar=f.ticksPerBar,this.data.ticksPerBeat=f.ticksPerBeat,this.data.ticksPerSixteenth=f.ticksPerSixteenth,this.data.numSixteenth=f.numSixteenth):this.type.indexOf("time")!==-1?(this.data.hour=f.hour,this.data.minute=f.minute,this.data.second=f.second,this.data.millisecond=f.millisecond,this.data.timeAsString=f.timeAsString):this.type.indexOf("percentage")!==-1&&(this.data.percentage=f.percentage);if(this.type.indexOf("events")!==-1||this.type.indexOf("all")!==-1){this.collectedEvents=v;for(n=this.activeEvents.length-1;n>=0;n--){i=this.activeEvents[n];if(i.type===81||i.type===88)continue;if(i.state.indexOf("removed")===0||this.song.eventsById[i.id]===undefined)continue;i[this.unit]<=this.currentValue&&i[this.unit]>this.currentValue-r&&h.push(i)}this.activeEvents=[].concat(h);for(n=v.length-1;n>=0;n--)i=v[n],i[this.unit]>this.currentValue-r&&this.activeEvents.push(i);this.song.activeEvents={};for(n=this.activeEvents.length-1;n>=0;n--)i=this.activeEvents[n],this.song.activeEvents[i.id]=i}if(this.type.indexOf("notes")!==-1||this.type.indexOf("all")!==-1){for(n=this.noteIndex;n<this.numNotes;n++){s=this.notes[n];if(!(s.noteOn[this.unit]<=this.currentValue))break;d.push(s),this.noteIndex++}for(n=this.activeNotes.length-1;n>=0;n--){s=this.activeNotes[n];if(s.noteOn.state.indexOf("removed")===0||this.song.notesById[s.id]===undefined)continue;if(s.noteOff===undefined){e.debug&&t.warn("note with id",s.id,"has no noteOff event",s.noteOn.track.name);continue}s.noteOn[this.unit]<=this.currentValue&&s.noteOff[this.unit]>this.currentValue&&c.push(s)}this.activeNotes=[].concat(c);for(n=d.length-1;n>=0;n--){s=d[n];if(s.noteOff===undefined){e.debug&&t.warn("note with id",s.id,"has no noteOff event",s.noteOn.track.name);continue}s.noteOff[this.unit]>this.currentValue&&this.activeNotes.push(s)}this.song.activeNotes={};for(n=this.activeNotes.length-1;n>=0;n--)s=this.activeNotes[n],this.song.activeNotes[s.id]=s}if(this.type.indexOf("parts")!==-1||this.type.indexOf("all")!==-1){for(n=this.partIndex;n<this.numParts;n++){a=this.parts[n];if(!(a.start[this.unit]<=this.currentValue))break;p.push(a),this.partIndex++}for(n=this.activeParts.length-1;n>=0;n--)a=this.activeParts[n],a.start[this.unit]<=this.currentValue&&a.end[this.unit]>this.currentValue&&l.push(a);this.activeParts=[].concat(l);for(n=p.length-1;n>=0;n--)a=p[n],a.end[this.unit]>this.currentValue&&this.activeParts.push(a);this.song.activeParts={};for(n=this.activeParts.length-1;n>=0;n--)a=this.activeParts[n],this.song.activeParts[a.id]=a}this.busy===!0&&(this.busy=!1)},e.protectedScope.createPlayhead=function(e,t,n,r){return new s(e,t,n,r)},e.protectedScope.addInitMethod(function(){o=e.protectedScope.getPosition2,u=e.protectedScope.objectForEach,i=e.debug})}(),function(){"use strict";function z(e,t,n){var r=e.timeEvents,i,s;for(i=r.length-1;i>=0;i--){s=r[i];if(s[t]<=n)return N=i,s}}function W(e,t,n,r,i){return t==="millis"?q(e,n,i):t==="ticks"&&R(e,n,i),r==="all"&&j(),B(e)}var e=window.sequencer,t=window.console,n,r,i,s="barsandbeats barsbeats time millis ticks perc percentage",o="barsandbeats barsbeats time millis ticks all",u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C="all",k=!0,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U;L=function(e,t,n){return k=n===undefined?!0:!1,q(e,t),m},A=function(e,t,n){return k=n===undefined?!0:!1,R(e,t),g},O=function(e,t,n){return t=["barsbeats"].concat(t),F(e,t,"millis",n),g},M=function(e,t,n){return t=["barsbeats"].concat(t),F(e,t,"ticks",n),m},_=function(e,t,n){return k=n===undefined?!0:!1,R(e,t),j(),C="barsandbeats",B()},D=function(e,t,n){return k=n===undefined?!0:!1,q(e,t),j(),C="barsandbeats",B()},q=function(e,t,n){var r=e.lastEvent;return k===!1&&t>r.millis&&(t=r.millis),n===undefined&&(n=z(e,"millis",t)),H(n),n.millis===t?(b=0,y=0):(b=t-n.millis,y=b/p),g+=b,m+=y,m},R=function(e,t,n){var r=e.lastEvent;return k===!1&&t>r.ticks&&(t=r.ticks),n===undefined&&(n=z(e,"ticks",t)),H(n),n.ticks===t?(y=0,b=0):(y=t-m,b=y*p),m+=y,g+=b,g},U=function(e,t,n,r,i,s){var o=0,u,f,d,T,C=e.lastEvent;k===!1&&t>C.bar&&(t=C.bar),t=P(t),n=P(n),r=P(r),i=P(i,!0),s===undefined&&(s=z(e,"bar",t)),H(s);while(i>=h)r++,i-=h;while(r>v)n++,r-=v;while(n>a)t++,n-=a;s=z(e,"bar",t,N);for(o=N;o>=0;o--){s=e.timeEvents[o];if(s.bar<=t){H(s);break}}T=i-x,d=r-S,f=n-E,u=t-w,b=u*c*p,b+=f*l*p,b+=d*h*p,b+=T*p,y=b/p,w=t,E=n,S=r,x=i,g+=b,m+=y},j=function(){var e=n(y);while(e>=h){S++,e-=h;while(S>v){S-=v,E++;while(E>a)E-=a,w++}}x=n(e)},H=function(e){u=e.bpm,a=e.nominator,f=e.denominator,c=e.ticksPerBar,l=e.ticksPerBeat,h=e.ticksPerSixteenth,v=e.numSixteenth,p=e.millisPerTick,d=e.secondsPerTick,w=e.bar,E=e.beat,S=e.sixteenth,x=e.tick,m=e.ticks,g=e.millis},B=function(t){var r,i,s={};switch(C){case"millis":s.millis=n(g*1e3)/1e3,s.millisRounded=n(g);break;case"ticks":s.ticks=n(m);break;case"barsbeats":case"barsandbeats":s.bar=w,s.beat=E,s.sixteenth=S,s.tick=x,i=x===0?"000":x<10?"00"+x:x<100?"0"+x:x,s.barsAsString=w+":"+E+":"+S+":"+i;break;case"time":r=e.getNiceTime(g),s.hour=r.hour,s.minute=r.minute,s.second=r.second,s.millisecond=r.millisecond,s.timeAsString=r.timeAsString;break;case"all":s.millis=n(g*1e3)/1e3,s.millisRounded=n(g),s.ticks=n(m),s.bar=w,s.beat=E,s.sixteenth=S,s.tick=x,i=x===0?"000":x<10?"00"+x:x<100?"0"+x:x,s.barsAsString=w+":"+E+":"+S+":"+i,r=e.getNiceTime(g),s.hour=r.hour,s.minute=r.minute,s.second=r.second,s.millisecond=r.millisecond,s.timeAsString=r.timeAsString,s.bpm=n(u*t.playbackSpeed,3),s.nominator=a,s.denominator=f,s.ticksPerBar=c,s.ticksPerBeat=l,s.ticksPerSixteenth=h,s.numSixteenth=v,s.millisPerTick=p,s.secondsPerTick=d,s.percentage=m/t.durationTicks}return s},P=function(e,t){return e=isNaN(e)?t?0:1:e,e=n(e),t?e=e<0?0:e:e=e<1?1:e,e},I=function(e){C="all",k=!0;if(i(e)==="array"){var t=e.length,n,r,u,a;T=e[0],i(e[0])==="array"&&(e=e[0],T=e[0],t=e.length),n=[T];if(s.indexOf(T)!==-1){for(r=1;r<t;r++){u=e[r];if(u===!0||u===!1)k=u;else if(isNaN(u)){if(o.indexOf(u)===-1)return!1;C=u}else n.push(u)}return a=n.length,a!==2&&a!==3&&a!==5?!1:n}}return!1},F=function(e,n){var i=I(n),s,o,u;if(i===!1)return t.error("wrong position data"),!1;switch(T){case"barsbeats":case"barsandbeats":return U(e,i[1],i[2],i[3],i[4]),B(e);case"time":return s=0,o=i[1]||0,s+=o*60*60*1e3,o=i[2]||0,s+=o*60*1e3,o=i[3]||0,s+=o*1e3,o=i[4]||0,s+=o,q(e,s),j(),B(e);case"millis":return q(e,i[1]),j(),B(e);case"ticks":return R(e,i[1]),j(),B(e);case"perc":case"percentage":return u=i[2],m=i[1]*e.durationTicks,u!==undefined&&(m=r(m/u)*u),R(e,m),j(),o=B(e),o}return!1},e.protectedScope.getPosition=F,e.protectedScope.getPosition2=W,e.protectedScope.checkPosition=I,e.protectedScope.millisToTicks=L,e.protectedScope.ticksToMillis=A,e.protectedScope.ticksToBars=_,e.protectedScope.millisToBars=D,e.protectedScope.barsToTicks=M,e.protectedScope.barsToMillis=O,e.protectedScope.addInitMethod(function(){n=e.protectedScope.round,r=e.protectedScope.floor,i=e.protectedScope.typeString})}(),function(){"use strict";function o(n,r,o,u){var a;r=""+r,r=r.toUpperCase(),o=o||e.defaultPPQ;if(r===0)return{};var f,l,c,h,p,d,v=u||{};v.events===undefined&&(v.events={}),v.tracks===undefined&&(v.tracks={}),r.indexOf("TICKS")!==-1?d=parseInt(r.replace(/TICKS/,""),10):d=s[r]*o;if(d===undefined){e.debug&&t.warn("invalid quantize value");return}for(f=n.length-1;f>=0;f--)l=n[f],v.events[l.id]={event:l,ticks:l.ticks},l.type!==128&&(c=l.ticks,h=i(c/d)*d,p=h-c,l.ticks=h,l.state="changed",l.part.needsUpdate=!0,l.track.needsUpdate=!0,a=l.track,v.tracks[a.id]===undefined&&(v.tracks[a.id]={track:a,quantizedEvents:[]}),v.tracks[a.id].quantizedEvents.push(l),l.midiNote!==undefined&&(l.midiNote.noteOff.ticks+=p,l.midiNote.noteOff.state="changed",l.midiNote.state="changed",v.tracks[a.id].quantizedEvents.push(l.midiNote.noteOff)));return v}function u(e,t,n,r){var i=r||{}}var e=window.sequencer,t=window.console,n,r=Math.floor,i=Math.round,s={1:4,"1.":6,"1..":7,"1...":7.5,"1T":2/3*4,2:2,"2.":3,"2..":3.5,"2...":3.75,"2T":2/3*2,4:1,"4.":1.5,"4..":1.75,"4...":1.875,"4T":2/3*1,8:.5,"8.":.75,"8..":.875,"8...":.9375,"8T":2/3*1/2,16:.25,"16.":.375,"16..":.4375,"16...":.46875,"16T":2/3*1/4,32:1/8,"32.":.1875,"32..":.21875,"32...":.234375,"32T":2/3*1/8,64:1/16,"64.":.09375,"64..":.109375,"64...":.1171875,"64T":2/3*1/16,128:1/32,"128.":1.5/32,"128..":1.75/32,"128...":1.875/32,"128T":2/3*1/32};e.protectedScope.addInitMethod(function(){n=e.protectedScope.copyObject}),e.quantize=o,e.fixedLength=u}(),function(){"use strict";var e=window.sequencer,t=window.console,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m=function(e){this.id=o(),this.output=n.createGainNode(),this.output.connect(e.track.input),this.buffer=e.buffer,this.buffer&&(this.duration=this.buffer.duration),this.noteNumber=e.noteNumber,this.stopCallback=function(){},this.track=e.track};f=function(e,n){e.source.onended=function(){e.stopCallback(e)},n=n||0;try{e.source.stop(n)}catch(r){t.log(r)}},l=function(e){var r=n.currentTime,i,s,o;if(e.release_duration>0)try{switch(e.releaseEnvelope){case"linear":e.output.gain.linearRampToValueAtTime(e.volume,r),e.output.gain.linearRampToValueAtTime(0,r+e.releaseDuration);break;case"equal power":i=a(100,"fadeOut",e.volume),e.output.gain.setValueCurveAtTime(i,r,e.releaseDuration);break;case"array":o=e.releaseEnvelopeArray.length,i=new Float32Array(o);for(s=0;s<o;s++)i[s]=e.releaseEnvelopeArray[s]*e.volume;e.output.gain.setValueCurveAtTime(i,r,e.releaseDuration)}}catch(u){t.error(e.id,u)}},m.prototype.addData=function(e){this.sourceId=e.sourceId,this.noteName=e.noteName,this.midiNote=e.midiNote},m.prototype.createSource=function(){this.source=n.createBufferSource(),this.source.buffer=this.buffer},m.prototype.route=function(){this.source.connect(this.output)},m.prototype.start=function(e){if(this.source!==undefined){t.error("this should never happen");return}this.volume=e.velocity/127,this.output.gain.value=this.volume,this.createSource(),this.phase="decay",this.route(),i===!0&&(this.source.start=this.source.noteOn,this.source.stop=this.source.noteOff);try{this.source.start(e.time,e.offset||0,e.duration||this.duration)}catch(n){t.warn(n)}},m.prototype.stop=function(n,r){if(this.source===undefined){e.debug&&t.log("Sample.stop() source is undefined");return}if(n===0||n===undefined)n=e.getTime();this.stopCallback=r||function(){},this.release?(this.source.loop=!1,this.startReleasePhase=n,this.stopTime=n+this.releaseDuration):f(this,n)},m.prototype.unschedule=function(e,i){var s=n.currentTime,o=this,u=e===null?100:e;this.source.onended=undefined;try{this.output.gain.cancelScheduledValues(0),this.output.gain.linearRampToValueAtTime(0,s+u/1e3),r["unschedule_"+this.id]={time:s+u/1e3,execute:function(){if(!o){t.log("sample is gone");return}o.panner&&o.panner.node.disconnect(0),o.source!==undefined&&(o.source.disconnect(0),o.source=undefined),i&&i(o)}}}catch(a){t.log(a)}},m.prototype.update=function(e){var r=this.track.name==="Sonata # 3"&&this.track.song.bar>=6&&this.track.song.bar<=10;this.autopan&&this.panner.setPosition(e),this.startReleasePhase!==undefined&&n.currentTime>=this.startReleasePhase&&this.phase==="decay"?(r===!0&&t.log(this.phase,"-> release",this.releaseDuration),this.phase="release",l(this)):this.stopTime!==undefined&&n.currentTime>=this.stopTime&&this.phase==="release"&&(r===!0&&t.log(this.phase,"-> stopped",this.stopTime,n.currentTime),this.phase="stopped",f(this))},e.createSample=function(e){var n=!1;return n&&t.log(e),e.oscillator?(n&&t.log("synth"),new c(e)):e.sustain&&e.release&&e.panning?(n&&t.log("sustain, release, panning"),new v(e)):e.release&&e.panning?(n&&t.log("release, panning"),new d(e)):e.release&&e.sustain?(n&&t.log("release, sustain"),new p(e)):e.release?(n&&t.log("release"),new h(e)):(n&&t.log("simple"),new m(e))},e.protectedScope.addInitMethod(function(){var t=e.protectedScope.createClass;n=e.protectedScope.context,r=e.protectedScope.timedTasks,a=e.util.getEqualPowerCurve,i=e.legacy,o=e.protectedScope.getSampleId,s=e.protectedScope.typeString,u=e.createPanner,h=t(m,function(e){this.release=!0,this.releaseDuration=e.release_duration/1e3,this.releaseEnvelope=e.release_envelope}),p=t(m,function(e){this.release=!0,this.sustainStart=e.sustain_start/1e3,this.sustainEnd=e.sustain_end/1e3,this.releaseDuration=e.release_duration/1e3,this.releaseEnvelope=e.release_envelope,this.releaseEnvelope===undefined?this.releaseEnvelope="equal power":s(this.releaseEnvelope)==="array"&&(this.releaseEnvelopeArray=e.release_envelope_array,this.releaseEnvelope="array")}),p.prototype.route=function(){this.source.loop=!0,this.source.loopStart=this.sustainStart,this.source.loopEnd=this.sustainEnd,this.source.connect(this.output)},d=t(m,function(e){this.release=!0,this.releaseDuration=e.release_duration/1e3,this.releaseEnvelope=e.release_envelope,this.releaseEnvelope===undefined?this.releaseEnvelope="equal power":s(this.releaseEnvelope)==="array"&&(this.releaseEnvelopeArray=e.release_envelope_array,this.releaseEnvelope="array"),this.panPosition=e.panPosition}),d.prototype.route=function(
){this.panner=u(),this.panner.setPosition(this.panPosition||0),this.source.connect(this.panner.node),this.panner.node.connect(this.output)},v=t(m,function(e){this.release=!0,this.sustainStart=e.sustain_start/1e3,this.sustainEnd=e.sustain_end/1e3,this.releaseDuration=e.release_duration/1e3,this.releaseEnvelope=e.release_envelope,this.releaseEnvelope===undefined?this.releaseEnvelope="equal power":s(this.releaseEnvelope)==="array"&&(this.releaseEnvelopeArray=e.release_envelope_array,this.releaseEnvelope="array"),this.panPosition=e.panPosition}),v.prototype.route=function(){this.source.loop=!0,this.source.loopStart=this.sustainStart,this.source.loopEnd=this.sustainEnd,this.panner=u(),this.panner.setPosition(this.panPosition||0),this.source.connect(this.panner.node),this.panner.node.connect(this.output)},c=t(m,function(e){this.release=!0,this.panPosition=0,this.autopan=e.autopan||!1,this.frequency=e.event.frequency,this.waveForm=e.wave_form||0,this.releaseDuration=e.release_duration/1e3||1.5,this.releaseEnvelope=e.release_envelope||"equal power"}),c.prototype.createSource=function(){this.source=n.createOscillator(),this.source.type=this.waveForm,this.source.frequency.value=this.frequency},c.prototype.route=function(){this.volume*=.3,this.output.gain.value=this.volume,this.autopan?(this.panner=u(),this.panner.setPosition(0),this.source.connect(this.panner.node),this.panner.node.connect(this.output)):this.source.connect(this.output)}})}(),function(){"use strict";function m(e,t){var n,r=t.mapping,i,s,o,u,a,f,l,c,h,p;e.samples=[],e.samplesById={},c=t.remote_path,c=c===undefined?!1:c;for(n in r)r.hasOwnProperty(n)&&(h={id:n,folder:e.folder+"/"+e.name},c!==!1?(i=r[n],i.indexOf("http://")===0||i.indexOf("https://")===0?h.url=i:(o=i,a=i.lastIndexOf("/"),a!==-1&&(o=i.substring(a+1)),s=i.substring(0,a),f=i.lastIndexOf("."),p=t.extension,f!==-1&&(u=i.substring(f+1),u.length>=3&&u.length<=4&&(p=u,o=i.substring(a,f))),i=c+"/"+s+"/"+o+"."+p,i=i.replace(/\/{2,}/g,"/"),i=i.replace(/^\//,""),i=i.replace(/$\//,""),h.url=i)):(l=r[n],l.d!==undefined?(h.base64=r[n].d,l.s!==undefined&&(h.sustain=l.s),l.r!==undefined&&(h.release=l.r)):h.base64=r[n],e.samplesById[n]=h),e.samples.push(h))}function g(n,r){E(n.samples,function(e){},function(){n.loaded=!0,n.parseTime=c,e.debug>=2&&t.info("parsing",n.name,"took",c*1e3,"ms"),r&&r(!0)})}function y(e,t){e.reset(),e=undefined,t(!1)}function b(n){var o=r(n.localPath,e.storage.samplepacks,!0),u=n.action,a,f,l;if(o&&o.className==="SamplePack")if(u==="overwrite"){f=o.samples;for(a=f.length-1;a>=0;a--)l=f[a],s(l.name+"/"+l.folder,e.storage.audio)}else{if(u!=="append")return e.debug>=2&&t.warn("there is already a samplepack at",n.localPath),!1;f=o.samples;for(a=f.length-1;a>=0;a--)n.samples.push(f[a])}return i(n,n.localPath,e.storage.samplepacks),!0}function w(r,i){r.hasMapping!==!0?n({url:r.url,responseType:"json",onError:function(){y(r,i)},onSuccess:function(n){if(n===null){i(!1);return}if(n.mapping===undefined){e.debug>=2&&t.warn("can't create a SamplePack with this data",n),y(r,i);return}n.name!==undefined&&r.name===undefined&&(r.name=n.name),n.folder!==undefined&&r.folder===undefined&&(r.folder=n.folder),r.name===undefined&&(r.name=u(r.url).name),r.action=n.action,r.localPath=r.folder!==undefined?r.folder+"/"+r.name:r.name,b(r)===!0?(m(r,n),g(r,i)):i(!1)}}):b(r)===!0?g(r,i):i(!1)}function E(e,t,n){function u(a){i(a,h+"/"+p,l.audio),t&&t(a),r++,r<s?(o=e[r],S(o,u)):n()}var r=0,s=e.length,o=e[r];S(o,u)}function S(e,i){var s,o=e.url,u=e.base64;p=e.id,h=e.folder,s=r(h+"/"+p,l.audio,!0),s!==!1?i(s):u?(u!=="TWAAAP"?(s=a(u),x(s,i)):i(s),e.base64=""):o?n({url:o,responseType:"arraybuffer",onError:function(){i()},onSuccess:function(e){x(e,i)}}):t.error("could not load sample",h+"/"+p)}function x(n,r){var i=e.getTime();if(n!==null)try{f.decodeAudioData(n,function(t){c+=e.getTime()-i,r(t)},function(e){t.log("error decoding audiodata",p,e),r()})}catch(s){t.log(p,s),r()}}var e=window.sequencer,t=window.console,n,r,i,s,o,u,a,f,l,c,h,p,d=0,v;v=function(e){this.id="SP"+d++ +(new Date).getTime(),this.className="SamplePack",this.loaded=!1,this.loadTime=0,this.parseTime=c=0,this.url=e.url,this.name=e.name,this.folder=e.folder,this.info=e.info||e.samplepack_info,this.author=e.author||e.samplepack_author,this.license=e.license||e.samplepack_license,this.compression=e.compression||e.samplepack_compression,this.compression===undefined&&e.compression_type!==undefined&&(this.compression=e.compression_type+" "+e.compression_level),this.pack=e.pack,this.filesize=e.filesize,this.filesize===undefined&&this.pack!==undefined&&(this.filesize=this.pack.filesize),e.mapping?(this.name===undefined&&this.folder===undefined?(this.name=this.id,this.localPath=this.id):this.localPath=this.folder!==undefined?this.folder+"/"+this.name:this.name,this.hasMapping=!0,this.action=e.action,m(this,e)):e.url&&(this.url=e.url)},v.prototype.reset=function(){this.samples=[]},e.addSamplePack=function(n,r,i){var s=o(n),u,a,f,l;i=i===undefined?!1:i;if(s!=="object")return e.debug>=2&&t.warn("can't create a SamplePack with this data",n),!1;if(n.json){a=n.json,f=n.name,l=n.folder;if(o(a)==="string")try{a=JSON.parse(a)}catch(c){return e.debug>=2&&t.warn("can't create a SamplePack with this data",n),!1}if(a.mapping===undefined)return e.debug>=2&&t.warn("can't create a SamplePack with this data",n),!1;n={mapping:a.mapping,name:f===undefined?a.name:f,folder:l===undefined?a.folder:l}}u=new v(n),e.addTask({type:"load sample pack",method:w,params:u},function(e){r&&(e===!1?(u=null,r(null)):r(u))},i),e.startTaskQueue()},e.protectedScope.addInitMethod(function(){l=e.storage,n=e.protectedScope.ajax,f=e.protectedScope.context,r=e.protectedScope.findItem,u=e.protectedScope.parseUrl,i=e.protectedScope.storeItem,s=e.protectedScope.deleteItem,o=e.protectedScope.typeString,a=e.protectedScope.base64ToBinary})}(),function(){"use strict";function s(e,t,r,i){var o;for(t=0;t<r;t++){o=e[t];if(o===undefined)continue;o.className==="MidiEvent"?i.push(o):o.className==="MidiNote"?i.push(o.noteOn):n(o)==="array"&&s(o,0,o.length)}}var e=window.sequencer,t=window.console,n,r,i;i=function(e){this.song=e,this.looped=!1,this.notes={},this.audioEvents={}},i.prototype.updateSong=function(){this.events=this.song.eventsMidiAudioMetronome,this.numEvents=this.events.length,this.index=0,this.maxtime=0,this.notes={},this.audioEvents=this.song.audioEvents,this.numAudioEvents=this.audioEvents.length,this.scheduledAudioEvents={},this.looped=!1,this.setIndex(this.song.millis)},i.prototype.setIndex=function(e){var t;for(t=0;t<this.numEvents;t++)if(this.events[t].millis>=e){this.index=t;break}this.beyondLoop=!1,e>this.song.loopEnd&&(this.beyondLoop=!0),this.scheduledAudioEvents={}},i.prototype.getDanglingAudioEvents=function(e,t){var n,r,i=0;for(n=0;n<this.numAudioEvents;n++)r=this.audioEvents[n],r.millis<e&&r.endMillis>e?(r.playheadOffset=e-r.millis,r.time=this.startTime+r.millis-this.songStartMillis+r.playheadOffset,r.playheadOffset/=1e3,this.scheduledAudioEvents[r.id]=r,t.push(r),i++):r.playheadOffset=0;return t},i.prototype.getEvents=function(){var t,n,r=[],i,s,o,u,a,f,l,c;l=e.bufferTime*1e3,this.song.doLoop===!0&&this.song.loopDuration<l&&(this.maxtime=this.songMillis+this.song.loopDuration-1);if(this.song.doLoop===!0)if(this.maxtime>=this.song.loopEnd&&this.beyondLoop===!1){f=this.maxtime-this.song.loopEnd,this.maxtime=this.song.loopStart+f;if(this.looped===!1){this.looped=!0;for(t=this.index;t<this.numEvents;t++){n=this.events[t];if(!(n.millis<this.song.loopEnd))break;n.time=this.startTime+n.millis-this.songStartMillis,r.push(n),this.index++}a=this.song.loopEndTicks-1,u=this.song.getPosition("ticks",a).millis;for(t in this.notes)if(this.notes.hasOwnProperty(t)){i=this.notes[t],s=i.noteOn,o=i.noteOff;if(o.millis<=this.song.loopEnd)continue;n=e.createMidiEvent(a,128,s.data1,0),n.millis=u,n.part=s.part,n.track=s.track,n.midiNote=s.midiNote,n.time=this.startTime+n.millis-this.songStartMillis,r.push(n)}for(t in this.scheduledAudioEvents)this.scheduledAudioEvents.hasOwnProperty(t)&&(c=this.scheduledAudioEvents[t],c.endMillis>this.song.loopEnd&&(c.stopSample(this.song.loopEnd/1e3),delete this.scheduledAudioEvents[t]));this.notes={},this.setIndex(this.song.loopStart),this.song.startTime+=this.song.loopDuration,this.startTime=this.song.startTime,this.getDanglingAudioEvents(this.song.loopStart,r)}}else this.looped=!1;this.firstRun===!0&&(this.getDanglingAudioEvents(this.song.millis,r),this.firstRun=!1);for(t=this.index;t<this.numEvents;t++){n=this.events[t];if(!(n.millis<this.maxtime))break;n.time=this.startTime+n.millis-this.songStartMillis,n.type===144||n.type===128?n.midiNote!==undefined&&n.midiNote.noteOff!==undefined&&(n.type===144?this.notes[n.midiNote.id]=n.midiNote:n.type===128&&delete this.notes[n.midiNote.id],r.push(n)):n.type==="audio"?(this.scheduledAudioEvents[n.id]!==undefined&&(c=this.scheduledAudioEvents[n.id],c.sample!==undefined&&c.sample.source!==undefined&&c.stopSample(0)),this.scheduledAudioEvents[n.id]=n,n.time=n.time+n.playheadOffset*1e3,r.push(n)):r.push(n),this.index++}return r},i.prototype.update=function(){var t,n,i,s,o,u;this.prevMaxtime=this.maxtime,this.song.precounting===!0?(this.songMillis=this.song.metronome.millis,this.maxtime=this.songMillis+e.bufferTime*1e3,s=[].concat(this.song.metronome.getPrecountEvents(this.maxtime)),this.maxtime>this.song.metronome.endMillis&&(this.songMillis=0,this.maxtime=this.song.millis+e.bufferTime*1e3,this.startTime=this.song.startTime,this.startTime2=this.song.startTime2,this.songStartMillis=this.song.startMillis,s=this.getEvents())):(this.songMillis=this.song.millis,this.maxtime=this.songMillis+e.bufferTime*1e3,this.startTime=this.song.startTime,this.startTime2=this.song.startTime2,this.songStartMillis=this.song.startMillis,s=this.getEvents()),i=s.length;for(t=0;t<i;t++){n=s[t],o=n.track;if(o===undefined||n.mute===!0||n.part.mute===!0||n.track.mute===!0||n.track.type==="metronome"&&this.song.useMetronome===!1)continue;n.time+=o.audioLatency;if(n.type==="audio")n.time/=1e3,o.audio.processEvent(n);else if(o.routeToMidiOut===!1)n.time/=1e3,o.instrument.processEvent(n);else{u=o.channel;if(u==="any"||u===undefined||isNaN(u)===!0)u=0;r(o.midiOutputs,function(e){n.type===128||n.type===144||n.type===176?e.send([n.type+u,n.data1,n.data2],n.time):(n.type===192||n.type===224)&&e.send([n.type+u,n.data1],n.time)}),this.lastEventTime=n.time}}},i.prototype.unschedule=function(){var e=Array.prototype.slice.call(arguments),t=[],n,r,i,o;s(e,0,e.length,t);for(n=t.length-1;n>=0;n--)r=t[n],i=r.track,o=i.instrument,o&&o.unscheduleEvent(r)},i.prototype.reschedule=function(){var e,t,n=this.song.numTracks,r=this.song.tracks;for(e=0;e<n;e++)t=r[e],t.instrument.reschedule(this.song)},e.protectedScope.addInitMethod(function(){n=e.protectedScope.typeString,r=e.protectedScope.objectForEach}),e.protectedScope.createScheduler=function(e){return new i(e)}}(),function(){"use strict";function S(e){w[e.id]=e}function x(e){var t;for(t in e)e.hasOwnProperty(t)&&(e[t]=null)}var e=window.sequencer,t=window.console,n=Array.prototype.slice,r,i,s,o,u,a,f,l,c,h,p,d=0,v,m,g={},y,b=[],w={},E={};e.getSongs=function(){return w},e.deleteSong=function(e){if(e===undefined||e===null||e.className!=="Song")return;e.stop(),e.disconnect(h),delete w[e.id];var t,n,r,i,s,o,u;for(t=e.eventsMidiAudioMetronome.length-1;t>=0;t--)u=e.eventsMidiAudioMetronome[t],x(u);for(t=e.timeEvents.length-1;t>=0;t--)u=e.timeEvents[t];for(t=e.numTracks-1;t>=0;t--){n=e.tracks[t],n.audio!==undefined&&n.audio.recorder.cleanup();for(r=n.numParts-1;r>=0;r--){i=n.parts[r];for(s=i.numNotes-1;s>=0;s--)o=i.notes[s],x(o);x(i),i=null}x(n),n=null}return x(e),e=null,null},e.getSnapshot=function(e,n){if(e===undefined){t.error("song is undefined");return}n=n||e.id;var r=E[n],i=e.activeEvents,o=e.activeNotes,u=e.activeParts,a=[],f=[],l=[],c,h,p,d,v,m,g;if(r!==undefined){c=r.activeEvents,h=r.activeNotes,p=r.activeParts;for(g=c.length-1;g>=0;g--)d=c[g],i[d.id]===undefined&&e.eventsLib[d.id]!==undefined&&a.push(d);for(g=h.length-1;g>=0;g--)v=h[g],o[v.id]===undefined&&e.notesLib[v.id]!==undefined&&f.push(v);for(g=p.length-1;g>=0;g--)m=p[g],u[m.id]===undefined&&l.push(m)}return r={activeEvents:s(i),activeNotes:s(o),activeParts:s(u),nonActiveEvents:a,nonActiveNotes:f,nonActiveParts:l},E[n]=r,r},v=function(n){var r,i,s,o=e.getTime();for(r in f)f.hasOwnProperty(r)&&(s=f[r],s.time>=o&&(s.execute(),s=null,delete f[r]));for(r in l)l.hasOwnProperty(r)&&l[r]();for(r in c)c.hasOwnProperty(r)&&c[r]();d>=10?(i=(n-m)/1e3,e.diff=i,i>e.bufferTime&&e.autoAdjustBufferTime===!0&&(e.debug&&t.log("adjusted buffertime:"+e.bufferTime+" -> "+i),e.bufferTime=i)):d++,m=n,l={},window.requestAnimationFrame(v)},e.processEvent=e.processEvents=function(){var t=n.call(arguments),i,s,o,f,l,c,h,p=60,d,v,m,b,w,E;y=[],i=function(e,t,n){for(t=0;t<n;t++){s=e[t],v=r(s);if(s===undefined)continue;v==="midimessageevent"?(e=s.data,d=u(0,e[0],e[1],e[2]),y.push(d)):s.className==="MidiEvent"?y.push(s):v==="array"?i(s,0,s.length):v==="string"?m=s:isNaN(s)===!1&&(p=s)}},i(t,0,t.length),b=e.createPart(),w=e.createTrack(),w.setInstrument(m),g[w.instrumentId]===undefined?(g[w.instrumentId]=w,w.addPart(b),w.connect(a.destination)):(w=g[w.instrumentId],b=w.parts[0]),b.addEvents(y),w.update(),f=y.length,c=e.getTime(),E=60/p/e.defaultPPQ;for(o=0;o<f;o++)h=y[o],h.time=c+h.ticks*E+.002,w.instrument.processEvent(h)},e.stopProcessEvent=e.stopProcessEvents=function(){o(g,function(e){e.instrument.allNotesOff(),e=undefined}),g={}},e.play=function(){var t=n.call(arguments),i=[],s=[],o=[],u=[],a=[],f,l,c,h=!1,p,d,v,m,g,y,b;c=function(e,t,n,f){for(t=0;t<n;t++){l=e[t];if(l===undefined)continue;r(l)==="string"?b=l:l.className==="Song"?(m===undefined&&(m=l.bpm,g=l.nominator,y=l.denominator),u.push(l)):l.className==="Track"?(m===undefined&&(p=l.song,p!==undefined&&(m=p.bpm,g=p.nominator,y=p.denominator)),o.push(l)):l.className==="Part"?(m===undefined&&(p=l.song,p!==undefined&&(m=p.bpm,g=p.nominator,y=p.denominator)),s.push(l)):l.className==="MidiEvent"||l.className==="AudioEvent"?(m===undefined&&(v=l.part,v!==undefined&&(p=v.song,p!==undefined&&(m=p.bpm,g=p.nominator,y=p.denominator))),l.type===81||l.type===88?a.push(l):i.push(l)):r(l)==="array"?c(l,0,l.length,"    "):l===!0||l===!1?h=l:l.indexOf("S")===0&&(p=w[l],p&&p.play())}},c(t,0,t.length,"  ");for(f=u.length-1;f>=0;f--)p=u[f],o=o.concat(p.tracks),a=a.concat(p.timeEvents);return s.length>0&&(d=e.createTrack(),d.instrument=b,d.addParts(s),o.push(d)),i.length>0&&(d=e.createTrack(),d.instrument=b,v=e.createPart(),v.addEvents(i),d.addPart(v),o.push(d)),p=e.createSong({bpm:m||120,nominator:g||4,denominator:y||4,timeEvents:a,tracks:o}),S(p),p.play(),p},e.setAnimationFrameType=function(e,t){e=e||"default",e=e.toLowerCase(),t=t||15;switch(e){case"settimeout":window.requestAnimationFrame=function(e){setTimeout(e,t)};break;default:window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.requestAnimationFrame}},e.protectedScope.updateInstruments=function(){var e,t,n,r,i;for(e in w)if(w.hasOwnProperty(e)){i=w[e],n=i.tracks;for(t=n.length-1;t>=0;t--)r=n[t],r.instrument.reset()}},e.allNotesOff=function(){o(w,function(e){e.allNotesOff()})},window.onblur=function(){if(e.pauseOnBlur===!1)return;e.allNotesOff(),b=[],o(w,function(n){n.playing===!0&&(e.debug&&t.log("pause song",n.id),b.push(n),n.pause())})},window.onfocus=function(){if(e.pauseOnBlur===!1)return;var t,n,r,i=b.length;for(r=0;r<i;r++)t=b[r],n=t.millis,t.stop(),t.setPlayhead("millis",n),e.restartOnFocus&&t.play();b=[]},e.protectedScope.addSong=S,e.protectedScope.addInitMethod(function(){s=e.protectedScope.objectToArray,i=e.protectedScope.isEmptyObject,i=e.protectedScope.isEmptyObject,o=e.protectedScope.objectForEach,f=e.protectedScope.timedTasks,l=e.protectedScope.scheduledTasks,c=e.protectedScope.repetitiveTasks,r=e.protectedScope.typeString,a=e.protectedScope.context,u=e.createMidiEvent,h=e.protectedScope.masterGainNode,p=e.protectedScope.parseTimeEvents,v()})}(),function(){"use strict";function ot(e,t){function i(e,n,s){var o,u,a;for(n=0;n<s;n++)o=e[n],u=F(o),u==="array"?i(o,0,o.length):u==="string"?(a=t.eventsById[o],a!==undefined&&r.push(o)):o.className==="MidiEvent"&&r.push(o)}var r=[];return e=n.call(e),i(e,0,e.length),r}var e=window.sequencer,t=window.console,n=Array.prototype.slice,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,V,$,J,K,Q,G,Y,Z,et,tt,nt,rt=0,it,st;st=function(n){n=n||{},this.id="S"+rt++ +""+(new Date).getTime(),this.name=n.name||this.id,this.className="Song",V(this),this.midiInputs={},this.midiOutputs={},p(this),this.bpm=n.bpm||120,this.ppq=n.ppq||e.defaultPPQ,this.bars=n.bars||30,this.lastBar=this.bars,this.lowestNote=n.lowestNote||0,this.highestNote=n.highestNote||127,this.pitchRange=this.highestNote-this.lowestNote+1,this.nominator=n.nominator||4,this.denominator=n.denominator||4,this.factor=4/this.denominator,this.ticksPerBeat=this.ppq*this.factor,this.ticksPerBar=this.ticksPerBeat*this.nominator,this.millisPerTick=6e4/this.bpm/this.ppq,this.quantizeValue=n.quantizeValue||"8",this.fixedLengthValue=n.fixedLengthValue||!1,this.positionType=n.positionType||"all",this.useMetronome=n.useMetronome,this.autoSize=n.autoSize===undefined?!0:n.autoSize===!0,this.playbackSpeed=1,this.defaultInstrument=n.defaultInstrument||e.defaultInstrument,this.recordId=-1,this.autoQuantize=!1,this.loop=n.loop||!1,this.doLoop=!1,this.illegalLoop=!0,this.loopStart=0,this.loopEnd=0,this.loopDuration=0,this.audioRecordingLatency=0,this.useMetronome!==!0&&this.useMetronome!==!1&&(this.useMetronome=!1),this.grid=undefined,n.timeEvents&&n.timeEvents.length>0?(this.timeEvents=[].concat(n.timeEvents),this.tempoEvent=et(e.TEMPO,this)[0],this.timeSignatureEvent=et(e.TIME_SIGNATURE,this)[0],this.tempoEvent===undefined?(this.tempoEvent=r(0,e.TEMPO,this.bpm),this.timeEvents.unshift(this.tempoEvent)):this.bpm=this.tempoEvent.bpm,this.timeSignatureEvent===undefined?(this.timeSignatureEvent=r(0,e.TIME_SIGNATURE,this.nominator,this.denominator),this.timeEvents.unshift(this.timeSignatureEvent)):(this.nominator=this.timeSignatureEvent.nominator,this.denominator=this.timeSignatureEvent.denominator)):(this.tempoEvent=r(0,e.TEMPO,this.bpm),this.timeSignatureEvent=r(0,e.TIME_SIGNATURE,this.nominator,this.denominator),this.timeEvents=[this.tempoEvent,this.timeSignatureEvent]),n.timeEvents!==undefined&&n.bpm!==undefined&&this.bpm!==n.bpm&&this.setTempo(n.bpm,!1),n.timeEvents!==undefined&&(n.nominator!==undefined||n.denominator!==undefined)&&(this.nominator!==n.nominator||this.denominator!==n.denominator)&&this.setTimeSignature(n.nominator||this.nominator,n.denominator||this.denominator,!1),this.tracks=[],this.parts=[],this.notes=[],this.events=[],this.allEvents=[],this.tracksById={},this.tracksByName={},this.partsById={},this.notesById={},this.eventsById={},this.activeEvents=null,this.activeNotes=null,this.activeParts=null,this.recordedNotes=[],this.recordedEvents=[],this.recordingNotes={},this.numTracks=0,this.numParts=0,this.numNotes=0,this.numEvents=0,this.instruments=[],this.playing=!1,this.paused=!1,this.stopped=!0,this.recording=!1,this.prerolling=!1,this.precounting=!1,this.preroll=!0,this.precount=0,this.listeners={},this.playhead=i(this,this.positionType,this.id,this),this.playheadRecording=i(this,"all",this.id+"_recording"),this.scheduler=o(this),this.followEvent=s(this),this.volume=1,this.gainNode=l.createGainNode(),this.gainNode.gain.value=this.volume,this.metronome=u(this,O),this.connect(),n.className==="MidiFile"&&n.loaded===!1&&e.debug&&t.warn("midifile",n.name,"has not yet been loaded!"),n.tracks&&this.addTracks(n.tracks),n.parts&&this.addParts(n.parts),n.events&&this.addEvents(n.events),n.events||n.parts||n.tracks?(n.bars===undefined&&(this.lastBar=0),this.lastEvent=r([this.lastBar,e.END_OF_TRACK])):this.lastEvent=r([this.bars*this.ticksPerBar,e.END_OF_TRACK]),this.update(!0),this.numTimeEvents=this.timeEvents.length,this.playhead.set("ticks",0),this.midiEventListeners={}},Y=function(e,t){var n=!1;return e===undefined?n=!1:n.className==="Part"?n=e:F(e)==="string"?n=t.partsById[e]:isNaN(e)===!1&&(n=t.parts[e]),n},Q=function(e,t){var n=!1;return e===undefined?n=!1:e.className==="Track"?n=e:F(e)==="string"?(n=t.tracksById[e],n===undefined&&(n=t.tracksByName[e])):isNaN(e)===!1&&(n=t.tracks[e]),n===undefined&&(n=!1),n},G=function(e,t){var n=t.tracksById,r=t.tracksByName,i=[],s,o,u;for(s=e.length-1;s>=0;s--){u=Q(e[s]);if(u===!1)continue;u.song!==undefined&&u.song!==null&&(u=u.copy()),u.song=t,u.instrument.song=t,u.quantizeValue=t.quantizeValue,u.connect(t.gainNode),u.state="new",u.needsUpdate=!0,n[u.id]=u,r[u.name]=u,i.push(u.id),X(u.partsById,function(e){e.state="new"})}return i},$=function(e){var n,r,i=[];for(n=e.length-1;n>=0;n--){r=Q(e[n]);if(r===!1)continue;if(r.song!==undefined&&r.song!==this){t.warn("can't remove: this track belongs to song",r.song.id);continue}r.state="removed",r.disconnect(this.gainNode),r.reset(),delete this.tracksById[r.id],delete this.tracksByName[r.name],i.push(r)}return i},Z=function(e){var t,n,r=[];for(n=e.length-1;n>=0;n--)t=Y(e[n],this),t&&r.push(t);return r},et=function(e,t){var n=[];return t.timeEvents.forEach(function(t){t.type===e&&n.push(t)}),n},J=function(t){var n=e.getTime()*1e3,r=n-t.timeStamp,i=t.millis+r;t.diff=r,t.timeStamp=n;if(t.precounting===!0){t.metronome.millis+=r,t.scheduler.update(r);return}t.prevMillis=t.millis,t.doLoop&&t.scheduler.looped&&i>=t.loopEnd?(t.followEvent.resetAllListeners(),t.playhead.set("millis",t.loopStart+(i-t.loopEnd)),t.followEvent.update(),t.scheduler.update(),O(t,"loop")):i>=t.durationMillis?(t.playhead.update("millis",t.durationMillis-t.millis),t.followEvent.update(),t.pause(),t.endOfSong=!0,O(t,"end")):(t.playhead.update("millis",r),t.followEvent.update(),t.scheduler.update()),t.jump=!1},st.prototype.remove=function(){t.warn("Song.remove() is deprecated, please use sequencer.deleteSong()"),e.deleteSong(this)},st.prototype.play=function(){e.unlockWebAudio();var n,r;if(this.playing){this.pause();return}this.scheduler.firstRun=!0,this.doLoop=this.illegalLoop===!1&&this.loop===!0,this.endOfSong&&(this.followEvent.resetAllListeners(),this.playhead.set("millis",0),this.scheduler.setIndex(0)),this.timeStamp=e.getTime()*1e3,this.startTime=this.timeStamp;try{this.startTime2=window.performance.now()}catch(i){e.debug&&t.log("window.performance.now() not supported")}this.precounting&&(this.metronome.startTime=this.startTime,this.metronome.startTime2=this.startTime2,this.startTime+=this.metronome.precountDurationInMillis,this.startTime2+=this.metronome.precountDurationInMillis,n=this,r=this.startTime/1e3,h.playAfterPrecount=function(){e.getTime()>=r&&(n.precounting=!1,n.prerolling=!1,n.recording=!0,n.playing=!0,O(n,"record_start"),O(n,"play"),h.playAfterPrecount=undefined,delete h.playAfterPrecount)}),this.startMillis=this.millis,n=this,n.playhead.update("millis",0),n.followEvent.update(),h[this.id]=function(){J(n)},this.paused=!1,this.stopped=!1,this.endOfSong=!1,this.precounting!==!0&&(this.playing=!0,O(this,"play"))},st.prototype.pause=function(){if(this.recording===!0||this.precounting===!0){this.stop();return}if(this.stopped||this.paused){this.play();return}delete h[this.id],this.allNotesOff(),this.playing=!1,this.paused=!0,O(this,"pause")},st.prototype.stop=function(){if(this.stopped){this.followEvent.resetAllListeners(),this.playhead.set("millis",0),this.scheduler.setIndex(0);return}(this.recording===!0||this.precounting===!0)&&this.stopRecording(),delete h[this.id],X(c,function(e,t){if(t.indexOf("unschedule_")===0||t.indexOf("event_")===0)e=null,delete c[t]}),this.allNotesOff(),this.playing=!1,this.paused=!1,this.stopped=!0,this.endOfSong=!1,this.followEvent.resetAllListeners(),this.playhead.set("millis",0),this.scheduler.setIndex(0),O(this,"stop")},st.prototype.adjustLatencyForAllRecordings=function(e){this.audioRecordingLatency=e,this.tracks.forEach(function(t){t.setAudioRecordingLatency(e)})},st.prototype.setAudioRecordingLatency=function(e,t,n){var r,i,s;for(r=this.audioEvents.length-1;r>=0;r--){i=this.audioEvents[r],s=i.sampleId;if(s===undefined)continue;if(e===s)break}i.track.setAudioRecordingLatency(e,t,n)},st.prototype.startRecording=st.prototype.record=function(e){if(this.recording===!0||this.precounting===!0){this.stop();return}var t=!1,n=!1,r,i,s=this;this.metronome.precountDurationInMillis=0,this.playing?(this.precount=0,this.recordStartMillis=this.millis):e===undefined?(this.precount=0,this.recordStartMillis=this.millis):(this.setPlayhead("barsbeats",this.bar),this.metronome.createPrecountEvents(e),this.precount=e,this.recordStartMillis=this.millis-this.metronome.precountDurationInMillis),this.recordTimestampTicks=this.ticks,this.recordId="REC"+(new Date).getTime(),this.recordedNotes=[],this.recordedEvents=[],this.recordingNotes={},this.recordingAudio=!1,this.keyEditor!==undefined&&this.keyEditor.prepareForRecording(this.recordId);for(r=this.numTracks-1;r>=0;r--)i=this.tracks[r],i.recordEnabled==="audio"&&(this.recordingAudio=!0),i.recordEnabled==="audio"?(n=!0,i.prepareForRecording(this.recordId,function(){t===!1&&(t=!0,tt.call(s))})):i.prepareForRecording(this.recordId);return n===!1&&tt.call(this),this.recordId},tt=function(){this.recordTimestamp=l.currentTime*1e3,this.playing===!1?(this.precount>0?(this.precounting=!0,this.prerolling=this.preroll,this.prerolling?O(this,"record_preroll"):O(this,"record_precount")):(this.recording=!0,O(this,"record_start")),this.play()):(this.recording=!0,this.precounting=!1,O(this,"record_start"))},nt=function(e,t,n){var r,i=this;e<this.numTracks?(r=this.tracks[e],r.stopRecording(this.recordId,function(s){s!==undefined&&(t[r.name]=s),e++,nt.call(i,e,t,n)})):n(t)},st.prototype.stopRecording=function(){if(this.recording===!1)return;this.recording=!1,this.prerolling=!1,this.precounting=!1,delete h.playAfterPrecount;var e=this;return nt.call(this,0,{},function(t){e.update(),O(e,"recorded_events",t)}),this.update(),O(this,"record_stop"),this.recordId},st.prototype.undoRecording=function(e){var t,n;if(e===undefined)for(t=this.numTracks-1;t>=0;t--)this.tracks[t].undoRecording(this.recordId);else n=this.tracksByName,X(e,function(e,t){var r=n[t];r.undoRecording(e)})},st.prototype.getAudioRecordingData=function(e){var t,n,r;for(t=this.audioEvents.length-1;t>=0;t--){n=this.audioEvents[t],r=n.sampleId;if(r===undefined)continue;if(e===r)break}return n===undefined?!1:n.track.getAudioRecordingData(e)},st.prototype.quantize=function(){var t,r,i,s,o=n.call(arguments),u=o.length,a,f={};for(t=0;t<u;t++)i=o[t],s=F(i),s==="string"||s==="number"?a=i:s==="object"&&(f=i);for(t=this.numTracks-1;t>=0;t--)r=this.tracks[t],a===undefined&&(a=r.quantizeValue),e.quantize(r.events,a,this.ppq,f);return f},st.prototype.undoQuantize=function(n){if(n===undefined){e.debug>=2&&t.warn("please pass a quantize history object");return}var r,i;for(r=this.numTracks-1;r>=0;r--)i=this.tracks[r],i.undoQuantize(n)},st.prototype.quantizeRecording=function(e){var t,n;for(t=this.numTracks-1;t>=0;t--)n=this.tracks[t],n.recordId===this.recordId&&n.quantizeRecording(e)},st.prototype.setLeftLocator=function(){var e=E(this,n.call(arguments));e!==undefined&&(this.loopStartPosition=e,this.loopStart=e.millis,this.loopStartTicks=e.ticks),this.illegalLoop=this.loopStart>=this.loopEnd,this.doLoop=this.illegalLoop===!1&&this.loop===!0,this.loopDuration=this.illegalLoop===!0?0:this.loopEnd-this.loopStart},st.prototype.setRightLocator=function(){var e=E(this,n.call(arguments)),t=this.illegalLoop;e!==undefined&&(this.loopEndPosition=e,this.loopEnd=e.millis,this.loopEndTicks=e.ticks),this.illegalLoop=this.loopEnd<=this.loopStart,this.doLoop=this.illegalLoop===!1&&this.loop===!0,this.loopDuration=this.illegalLoop===!0?0:this.loopEnd-this.loopStart},st.prototype.setLoop=function(n){if(n===undefined)this.loop=!this.loop;else{if(n!==!0&&n!==!1){e.debug>=1&&t.error('pass "true", "false" or no value');return}this.loop=n}this.doLoop=this.illegalLoop===!1&&this.loop===!0},st.prototype.setPlayhead=function(){this.jump=!0,this.scheduler.looped=!1,this.scheduler.firstRun=!0,this.timeStamp=e.getTime()*1e3,this.startTime=this.timeStamp;try{this.startTime2=window.performance.now()}catch(r){e.debug&&t.log("window.performance.now() not supported")}this.playing&&this.allNotesOff();var i=E(this,n.call(arguments)),s=i.millis;this.startMillis=s,this.playhead.set("millis",s),this.scheduler.setIndex(s)},st.prototype.addEventListener=function(){return L.apply(this,arguments)},st.prototype.removeEventListener=function(){A.apply(this,arguments)},st.prototype.addEvent=st.prototype.addEvents=function(){var t,n;return t=this.tracks[0],t===undefined&&(t=e.createTrack(),this.addTrack(t)),t.needsUpdate&&t.update(),n=t.parts[0],n===undefined&&(n=e.createPart(),t.addPart(n)),n.addEvents.apply(n,arguments),this},st.prototype.addPart=st.prototype.addParts=function(){var t=this.tracks[0];return t===undefined&&(t=e.createTrack(),this.addTrack(t)),t.addParts.apply(t,arguments),this},st.prototype.addTrack=function(){var e=K(arguments),n=e[0],r=e.length;if(F(n)==="array"||r>1)t.warn("please use addTracks() if you want to get more that one tracks"),e=[n];return G(e,this)[0]},st.prototype.addTracks=function(){return G(K(arguments),this)},st.prototype.getTrack=function(e){return Q(e,this)},st.prototype.getTracks=function(){var e=K(arguments),t,n,r=[];for(n=e.length-1;n>=0;n--)t=Q(e[n],this),t&&r.push(t);return r},st.prototype.getPart=function(){var e=K(arguments);return e.length>1&&t.warn("please use getParts() if you want to get more that one part"),Z.call(this,e)[0]},st.prototype.getParts=function(){var e=K(arguments);return Z.call(this,e)},st.prototype.removeTrack=function(){var e=K(arguments);return e.length>1&&t.warn("please use removeTracks() if you want to remove more that one tracks"),$.call(this,e)[0]},st.prototype.removeTracks=function(){return $.call(this,K(arguments))},st.prototype.setPlaybackSpeed=function(e){if(e<.01||e>100){t.error("playback speed has to be > 0.01 and < 100");return}var n=this.ticks,r,i,s;this.playbackSpeed=e,this.update(!0),this.loopStartTicks!==undefined&&(r=this.getPosition("ticks",this.loopStartTicks),this.loopStart=r.millis,this.loopStartTicks=r.ticks),this.loopEndTicks!==undefined&&(i=this.getPosition("ticks",this.loopEndTicks),this.loopEnd=i.millis,this.loopEndTicks=i.ticks),s=this.getPosition("ticks",n),this.setPlayhead("ticks",s.ticks)},st.prototype.gridToSong=function(e,t,n,r){return P(this,e,t,n,r)},st.prototype.noteToGrid=function(e,t){return H(e,t,this)},st.prototype.eventToGrid=function(e,t,n){return B(e,t,n,this)},st.prototype.positionToGrid=function(e,t){return j(e,t,this)},st.prototype.getPosition=function(){return E(this,n.call(arguments))},st.prototype.ticksToMillis=function(e,t){return x(this,e,t)},st.prototype.millisToTicks=function(e,t){return S(this,e,t)},st.prototype.ticksToBars=function(e,t){return T(this,e,t)},st.prototype.millisToBars=function(e,t){return N(this,e,t)},st.prototype.barsToTicks=function(){return C(this,n.call(arguments))},st.prototype.barsToMillis=function(){return k(this,n.call(arguments))},st.prototype.findEvent=st.prototype.findEvents=function(e){return z(this,e)},st.prototype.findNote=st.prototype.findNotes=function(e){return W(this,e)},st.prototype.getStats=function(e){return U(this,e)},st.prototype.createGrid=function(e){return this.grid===undefined?this.grid=it(this,e):this.grid.update(e),this.grid},st.prototype.update=function(e){M(this,e)},st.prototype.updateGrid=function(e){return this.grid.update(e),this.grid},st.prototype.updateTempoEvent=function(n,r){if(n.type!==e.TEMPO){e.debug>=4&&t.error("this is not a tempo event");return}if(n.song!==this){e.debug>=4&&t.error("this event has not been added to this song yet");return}var i=this.ticks,s=this.percentage;n.bpm=r,this.update(!0),this.updatePlayheadAndLocators(i)},st.prototype.updateTimeSignatureEvent=function(n,r,i){if(n.type!==e.TIME_SIGNATURE){e.debug>=4&&t.error("this is not a time signature event");return}if(n.song!==this){e.debug>=4&&t.error("this event has not been added to this song yet");return}var s=this.ticks,o=this.percentage;n.nominator=r||n.nominator,n.denominator=i||n.denominator,this.update(!0),this.updatePlayheadAndLocators(s)},st.prototype.getTempoEvents=function(){return et(e.TEMPO,this)},st.prototype.getTimeSignatureEvents=function(){return et(e.TIME_SIGNATURE,this)},st.prototype.updatePlayheadAndLocators=function(e){var t,n,r=this.loopStartPosition,i=this.loopEndPosition,s;r!==undefined&&(t=this.getPosition("ticks",r.ticks),this.loopStart=t.millis,this.loopStartTicks=t.ticks,this.loopStartPosition=t),i!==undefined&&(n=this.getPosition("ticks",i.ticks),n.ticks>this.durationTicks&&(n=this.getPosition("ticks",this.bars)),this.
loopEnd=n.millis,this.loopEndTicks=n.ticks,this.loopEndPosition=n),s=this.getPosition("ticks",e),this.doLoop&&s.ticks>this.durationTicks?this.setPlayhead("ticks",0):this.setPlayhead("ticks",s.ticks),this.loopDuration=this.illegalLoop===!0?0:this.loopEnd-this.loopStart},st.prototype.setTempo=function(t,n){var r=et(e.TEMPO,this),i,s,o=this.ticks,u=this.percentage,a=t/r[0].bpm;for(i=r.length-1;i>=0;i--)s=r[i],s.bpm=a*s.bpm;this.bpm=t;if(n===!1)return;this.update(!0),this.updatePlayheadAndLocators(o)},st.prototype.setTimeSignature=function(t,n,r){var i=et(e.TIME_SIGNATURE,this),s,o,u=this.percentage,a=this.ticks;for(s=i.length-1;s>=0;s--)o=i[s],o.nominator=t,o.denominator=n;this.nominator=t,this.denominator=n;if(r===!1)return;this.update(!0),this.updatePlayheadAndLocators(a)},st.prototype.resetTempo=function(t){var n=et(e.TEMPO,this)[0],r=this.timeEvents;n.bpm=t,r=q(r,function(e){return e.type===81?!0:!1}),this.numTimeEvents=r.length,this.update(!0)},st.prototype.resetTimeSignature=function(t,n){var r=et(e.TIME_SIGNATURE,this)[0],i=this.timeEvents,s=this.ticks;r.nominator=t,r.denominator=n,i=q(i,function(e){return e.type===88?!0:!1}),this.numTimeEvents=i.length,this.update(!0),this.updatePlayheadAndLocators(s)},st.prototype.addTimeEvent=st.prototype.addTimeEvents=function(){var t=K(arguments),n=this.ticks,r,i,s;for(r=t.length-1;r>=0;r--)i=t[r],i.className==="MidiEvent"&&(i.type===e.TEMPO?this.timeEvents.push(i):i.type===e.TIME_SIGNATURE&&(s=this.getPosition("ticks",i.ticks),s.beat>s.nominator/2?s=this.getPosition("barsbeats",s.bar+1):s=this.getPosition("barsbeats",s.bar),i.ticks=s.ticks,this.timeEvents.push(i)));this.numTimeEvents=this.timeEvents.length,this.update(!0),this.updatePlayheadAndLocators(n)},st.prototype.removeTimeEvent=st.prototype.removeTimeEvents=function(){var e=K(arguments),t,n=e.length,r,i=this.ticks,s=[];for(t=0;t<n;t++)r=e[t],r!==this.tempoEvent&&r!==this.timeSignatureEvent&&s.push(r);this.timeEvents=I(s,this.timeEvents),this.numTimeEvents=this.timeEvents.length,this.update(!0),this.updatePlayheadAndLocators(i)},st.prototype.removeDoubleTimeEvents=function(){var e=[],t,n,r,i,s={81:{},88:{}};for(t=this.timeEvents.length-1;t>=0;t--){n=this.timeEvents[t];if(s[n.type][n.ticks]!==undefined)continue;i=n.type,r=n.ticks,s[i][r]=n,r===0&&(i===81?this.tempoEvent=n:i===88&&(this.timeSignatureEvent=n))}X(s[81],function(t){e.push(t)}),X(s[88],function(t){e.push(t)}),this.timeEvents=e,this.update(!0)},st.prototype.setPitchRange=function(e,t){var n=this;n.lowestNote=e,n.highestNote=t,n.numNotes=n.pitchRange=n.highestNote-n.lowestNote+1},st.prototype.trim=function(){_(this,!0)},st.prototype.setDurationInBars=function(e){var t=this,n=t.findEvent("bar > "+e),r=[],i=[],s=[],o={},u={};return n.forEach(function(e){var t=e.trackId,n=e.partId;o[t]===undefined&&(o[t]=[]),o[t].push(e),u[n]===undefined&&(u[n]=e.part)}),X(o,function(e,n){var r=t.getTrack(n);r.removeEvents(e),i.push(r)}),X(u,function(e,t){e.events.length===0?(e.track.removePart(e),r.push(e)):s.push(e)}),t.bars=e,t.lastBar=e,{removedEvents:n,removedParts:r,changedTracks:i,changedParts:s}},st.prototype.addEffect=function(){},st.prototype.removeEffect=function(){},st.prototype.setVolume=function(){function u(e,t,n){for(t=0;t<n;t++){var r=e[t],o=F(r);o==="array"?u(r,0,r.length):o==="number"?s=r:r.className==="Track"&&i.push(r)}}var e=n.call(arguments),r=e.length,i=[],s,o;if(r===1){s=e[0];if(isNaN(s)){t.warn("please pass a number");return}this.volume=s<0?0:s>1?1:s,this.gainNode.gain.value=this.volume}else{u(e,0,r);for(o=i.length-1;o>=0;o--)i[o].setVolume(s)}},st.prototype.getVolume=function(){return this.gainNode.gain.value},st.prototype.connect=function(){this.gainNode.connect(f)},st.prototype.disconnect=function(){this.gainNode.disconnect(f)},st.prototype.getMidiInputs=function(e){y(e,this)},st.prototype.getMidiOutputs=function(e){b(e,this)},st.prototype.setTrackSolo=function(e,t){var n,r;for(n=this.numTracks-1;n>=0;n--)r=this.tracks[n],t===!0?r.mute=r===e?!t:t:t===!1&&(r.mute=!1),r.solo=r===e?t:!1},st.prototype.muteAllTracks=function(e){var t,n;for(t=this.numTracks-1;t>=0;t--)n=this.tracks[t],n.mute=e},st.prototype.setMetronomeVolume=function(e){this.metronome.setVolume(e)},st.prototype.configureMetronome=function(e){this.metronome.configure(e)},st.prototype.resetMetronome=function(){this.metronome.reset()},st.prototype.setPrecount=function(e){this.precount=e},st.prototype.allNotesOff=function(){X(this.tracks,function(e){e.allNotesOff()}),this.metronome.allNotesOff(),this.resetExternalMidiDevices()},st.prototype.resetExternalMidiDevices=function(){var e=this.scheduler.lastEventTime+100;isNaN(e)&&(e=100),X(this.midiOutputs,function(t){t.send([176,123,0],e),t.send([176,121,0],e)})},st.prototype.addMidiEventListener=function(){return d(arguments,this)},st.prototype.removeMidiEventListener=function(e){v(e,this)},st.prototype.removeMidiEventListeners=function(){v(arguments,this)},st.prototype.getMidiInputsAsDropdown=function(e){return e=e||{type:"input"},w(e,this)},st.prototype.getMidiOutputsAsDropdown=function(e){return e=e||{type:"output"},w(e,this)},st.prototype.setMidiInput=function(e,t){m(e,t,this)},st.prototype.setMidiOutput=function(e,t){g(e,t,this)},st.prototype.getNoteLengthName=function(e){return R(this,e)},e.createSong=function(e){return new st(e)},e.protectedScope.addInitMethod(function(){l=e.protectedScope.context,c=e.protectedScope.timedTasks,h=e.protectedScope.repetitiveTasks,f=e.protectedScope.masterGainNode,r=e.createMidiEvent,it=e.protectedScope.createGrid,p=e.protectedScope.initMidiSong,m=e.protectedScope.setMidiInputSong,g=e.protectedScope.setMidiOutputSong,y=e.protectedScope.getMidiInputs,b=e.protectedScope.getMidiOutputs,d=e.protectedScope.addMidiEventListener,w=e.protectedScope.getMidiPortsAsDropdown,v=e.protectedScope.removeMidiEventListener,E=e.protectedScope.getPosition,S=e.protectedScope.millisToTicks,x=e.protectedScope.ticksToMillis,T=e.protectedScope.ticksToBars,N=e.protectedScope.millisToBars,C=e.protectedScope.barsToTicks,k=e.protectedScope.barsToMillis,F=e.protectedScope.typeString,I=e.protectedScope.removeFromArray,q=e.protectedScope.removeFromArray2,z=e.findEvent,W=e.findNote,U=e.getStats,P=e.gridToSong,H=e.noteToGrid,B=e.eventToGrid,j=e.positionToGrid,K=e.protectedScope.getArguments,X=e.protectedScope.objectForEach,R=e.protectedScope.getNoteLengthName,M=e.protectedScope.update,_=e.protectedScope.checkDuration,D=e.protectedScope.addMetronomeEvents,a=e.protectedScope.followEvent,i=e.protectedScope.createPlayhead,o=e.protectedScope.createScheduler,s=e.protectedScope.createFollowEvent,u=e.protectedScope.createMetronome,L=e.protectedScope.songAddEventListener,A=e.protectedScope.songRemoveEventListener,O=e.protectedScope.songDispatchEvent,V=e.protectedScope.addSong})}(),function(){"use strict";var e=window.sequencer,t=window.console,n=Array.prototype.slice,r,i=0,s,o,u;u=function(){var e,t,r,i=n.call(arguments),s=i.length,o=i[0],u=i[1],a=[];if(s>2){e=2;while(e<s)a.push(i[e]),e++}a.push(o),t=o.listeners[u];if(t===undefined||t.length===undefined)return;for(e=t.length-1;e>=0;e--)r=t[e],r.callback.apply(null,a)},s=function(){var e=n.call(arguments),r,s=e[0];switch(s){case"play":case"stop":case"pause":case"end":case"record_start":case"record_stop":case"record_precount":case"record_preroll":case"recorded_events":case"latency_adjusted":case"loop_off":case"loop_on":case"loop":case"sustain_pedal":return this.listeners[s]===undefined&&(this.listeners[s]=[]),r=s+"_"+i++,this.listeners[s].push({id:r,callback:e[1]}),r;case"note":case"event":case"position":return this.followEvent.addEventListener(s,e[1],e[2]);default:t.log(s,"is not a supported event")}},o=function(){var e=n.call(arguments),i,s=e[0],o=e[1],u,a,f=[],l,c;s.indexOf("_")!==-1?(i=s.split("_"),u=i[0],a=s):u=s;if(r(u)==="array")return this.followEvent.removeEventListener(e);switch(u){case"play":case"stop":case"pause":case"end":case"record_start":case"record_stop":case"record_precount":case"record_preroll":case"recorded_events":case"latency_adjusted":case"loop_off":case"loop_on":case"loop":case"sustain_pedal":i=this.listeners[u];if(i&&i.length>0){for(l=i.length-1;l>=0;l--)c=i[l],a!==undefined?c.id!==a&&f.push(c):o!==undefined&&c.callback!==o&&f.push(c);this.listeners[u]=[].concat(f)}break;case"note":case"event":case"position":return this.followEvent.removeEventListener(e);default:t.error("unsupported event")}},e.protectedScope.songAddEventListener=s,e.protectedScope.songRemoveEventListener=o,e.protectedScope.songDispatchEvent=u,e.protectedScope.addInitMethod(function(){r=e.protectedScope.typeString})}(),function(){"use strict";var e=window.sequencer,t=window.console,n,r,i,s,o,u=0,a={bar:1,beat:1,sixteenth:1,tick:0,ticks:1,barsbeats:1,barsandbeats:1,hour:1,minute:1,second:1,millisecond:0,millis:1,time:1},f="= == === > >= < <= != !== %=",l=new RegExp(" "+f.replace(/\s+/g," | ")+" "),c,h,p;p=function(e){this.song=e,this.allListenersById={},this.allListenersByType={},this.searchPatterns=[],this.eventListenersBySearchstring={},this.positionListenersBySearchstring={},this.allListenersByType={event:{instance:{},searchstring:{}},position:{ticks:[],repetitive:{},conditional_simple:{},conditional_complex:{}}}},p.prototype.updateSong=function(){var e,t,r,i,s,o,a,f=[],l,c,h;l=this.allListenersByType.event.instance;for(i in l)if(l.hasOwnProperty(i)&&this.song.eventsById[i]===undefined){f=l[i];for(e=f.length-1;e>=0;e--)h=f[e],delete this.allListenersById[h];delete this.allListenersByType.event.instance[i]}l=this.allListenersByType.event.searchstring,f=[];for(i in l)l.hasOwnProperty(i)&&(f=f.concat(l[i]));for(e=f.length-1;e>=0;e--)delete this.allListenersById[f[e]];this.allListenersByType.event.searchstring={},o=this.allListenersByType.event.searchstring;for(e=this.searchPatterns.length-1;e>=0;e--){a=this.searchPatterns[e],s=n(this.song,a.searchstring),o.type==="note"&&(s=n(s,"type = NOTE_ON OR type = NOTE_OFF"));for(t=s.length-1;t>=0;t--)r=s[t],h="event_"+u++,c={id:h,event:r,type:a.type,subtype:a.subtype,callback:a.callback},this.allListenersById[h]=c,o[r.id]===undefined&&(o[r.id]=[]),o[r.id].push(h)}},p.prototype.update=function(){var e,t=this.song,n=t.ticks,r=[],i,s;r=this.song.playhead.collectedEvents,i=r.length;for(e=0;e<i;e++)s=r[e],this.callEventListeners(s.id,s);this.callListenersPositionTicks(n),t.bar!==this.bar&&(this.bar=t.bar,this.callListenersPositionRepetitive("bar"),this.callListenersPositionConditionalSimple("bar",this.bar),this.callListenersPositionConditionalComplex("bar",this.bar)),t.beat!==this.beat&&(this.beat=t.beat,this.callListenersPositionRepetitive("beat"),this.callListenersPositionConditionalSimple("beat",this.beat),this.callListenersPositionConditionalComplex("beat",this.beat)),t.sixteenth!==this.sixteenth&&(this.sixteenth=t.sixteenth,this.callListenersPositionRepetitive("sixteenth"),this.callListenersPositionConditionalSimple("sixteenth",this.sixteenth),this.callListenersPositionConditionalComplex("sixteenth",this.sixteenth)),t.hour!==this.hour&&(this.hour=t.hour,this.callListenersPositionRepetitive("hour"),this.callListenersPositionConditionalSimple("hour",this.hour),this.callListenersPositionConditionalComplex("hour",this.hour)),t.minute!==this.minute&&(this.minute=t.minute,this.callListenersPositionRepetitive("minute"),this.callListenersPositionConditionalSimple("minute",this.minute),this.callListenersPositionConditionalComplex("minute",this.minute)),t.second!==this.second&&(this.second=t.second,this.callListenersPositionRepetitive("second"),this.callListenersPositionConditionalSimple("second",this.second),this.callListenersPositionConditionalComplex("second",this.second))},p.prototype.callEventListeners=function(e,t){var n,r,i,s,o=[];i=this.allListenersByType.event.instance,i[e]&&(o=o.concat(i[e])),i=this.allListenersByType.event.searchstring,i[e]&&(o=o.concat(i[e])),o.length>0;for(n=o.length-1;n>=0;n--)r=o[n],s=this.allListenersById[r],s.called!==!0&&(s.called=!0,s.callback(t))},p.prototype.callListenersPositionRepetitive=function(e){var t,n=this.allListenersByType.position.repetitive[e],r=this;n&&n.forEach(function(e){t=r.allListenersById[e],t.callback(t.searchstring)})},p.prototype.callListenersPositionConditionalSimple=function(e,t){var n,r,i,s=!1,o=this.allListenersByType.position.conditional_simple[e],u=this;o&&o.forEach(function(e){n=u.allListenersById[e],r=n.data,i=n.operator;switch(i){case">":s=t>r;break;case"<":s=t<r;break;case"%=":s=t%r===0;break;case"!=":case"!==":s=t!==r;break;case"===":s=t===r}s===!0&&n.callback(n.searchstring)})},p.prototype.callListenersPositionConditionalComplex=function(e,t){var n,r,i,s,o,u=this.allListenersByType.position.conditional_complex[e],a=this;u&&u.forEach(function(e){n=a.allListenersById[e],r=n.value1,i=n.value2,s=n.operator1,o=n.operator2,s==="<"?(t<r||t>i)&&n.callback(n.searchstring):s===">"&&t>r&&t<i&&n.callback(n.searchstring)})},p.prototype.callListenersPositionTicks=function(e){var t=this.allListenersByType.position.ticks,n,r=t.length,i;for(n=0;n<r;n++)i=this.allListenersById[t[n]],e>=i.ticks&&!i.called&&(i.callback(i.searchstring),i.called=!0)},p.prototype.addEventListener=function(e,i,s){var o,a,f,l,h,p,d,v,m=[],g=r(i);if(r(s)!=="function")return t.error(s,"is not a function; please provide a function for callback"),-1;if(e==="position")return v=this.addPositionEventListener(i,s),v;if(g==="string"){a=n(this.song,i),this.searchPatterns.push({searchstring:i,callback:s,type:"event",subtype:"searchstring"});if(a.length===0)return-1;p="searchstring",l=this.allListenersByType.event.searchstring,this.eventListenersBySearchstring[i]=h=[]}else{a=c(e,i);if(a===-1)return-1;p="instance",l=this.allListenersByType.event.instance}e==="note"&&(a=n(a,"type = NOTE_ON OR type = NOTE_OFF"));for(o=a.length-1;o>=0;o--)f=a[o],v="event_"+u++,d={id:v,event:f,type:e,subtype:p,callback:s},this.allListenersById[v]=d,l[f.id]===undefined&&(l[f.id]=[]),l[f.id].push(v),m.push(v),p==="searchstring"&&h.push(v);return p==="searchstring"||g==="array"||e==="note"?m:m[0]},p.prototype.addPositionEventListener=function(e,n){var s,o,l,c,p=e.split(/[\s+]/g),d=p.length,v=p[0],m=p[1],g=p[2],y=p[3],b=p[4],w=r(g);if(d!==1&&d!==3&&d!==5)return t.error("invalid search string, please consult documentation"),!1;if(a[v]!==1)return t.error(v,"is not a supported event id, please consult documentation"),-1;if(m==="="||m==="==")m="===";switch(v){case"barsbeats":case"barsandbeats":case"time":case"ticks":case"millis":if(m===undefined||m!=="===")return t.error(v,"can only be used conditionally with the operators '===', '==' or '='"),-1;y&&t.warn("this position event type can only be used with a single condition, ignoring second condition");break;case"bar":case"beat":case"sixteenth":case"hour":case"minute":case"second":if(g&&isNaN(g))return t.error("please provide a number"),-1;if(b&&isNaN(b))return t.error("please provide a number"),-1}if(m&&f.indexOf(m)===-1)return t.error(m,"is not a supported operator, please use any of",f),-1;if(m&&g===undefined){t.error("operator without value");return}if(y&&f.indexOf(m)===-1)return t.error(y,"is not a supported operator, please use any of",f),-1;if(y&&b===undefined){t.error("operator without value");return}if(m&&y&&h(m,y)===!1)return t.error("you can't use "+m+" together with "+y),-1;if(r(n)!=="function")return t.error(n,"is not a function; please provide a function for callback"),-1;switch(v){case"bar":case"beat":case"sixteenth":g-=0,b-=0;case"hour":case"minute":case"second":g-=0,b-=0,m&&(m==="<="?(g++,m="<"):m===">="&&(g--,m=">")),y&&(y==="<="?(b++,y="<"):y===">="&&(b--,y=">"));break;case"ticks":g-=0;break;case"barsbeats":case"barsandbeats":isNaN(g)?w==="string"?(g=g.replace(/[\[\]\s]/g,""),g=g.split(","),g=i(this.song,["barsbeats",g[0],g[1]||1,g[2]||1,g[3]||0]).ticks):t.error("please provide a number or an array of numbers"):g=i(this.song,["barsbeats",g,1,1,0]).ticks,v="ticks";break;case"millis":g=i(this.song,["millis",g]).ticks,v="ticks";break;case"time":isNaN(g)?w==="string"?(g=g.replace(/[\[\]\s]/g,""),t.log(g),g=g.split(","),g.length===1?(c=g[0]*60*1e3,g=i(this.song,["millis",c]).ticks):g=i(this.song,["time",g[0],g[1],g[2],g[3]]).ticks):t.error("please provide a number or an array of numbers"):(c=g*60*1e3,g=i(this.song,["millis",c]).ticks),t.log(g),v="ticks"}return o="position_"+u++,v==="ticks"?(l={id:o,callback:n,type:"position",subtype:"ticks",ticks:g,searchstring:e},this.allListenersByType.position.ticks.push(o)):!m&&!y?(l={id:o,callback:n,type:"position",subtype:"repetitive",position_type:v,searchstring:e},s=this.allListenersByType.position.repetitive,s[v]===undefined&&(s[v]=[]),s[v].push(o)):m&&!y?(l={id:o,callback:n,type:"position",subtype:"conditional_simple",position_type:v,data:g,operator:m,searchstring:e},s=this.allListenersByType.position.conditional_simple,s[v]===undefined&&(s[v]=[]),s[v].push(o)):m&&y&&(l={id:o,callback:n,type:"position",subtype:"conditional_complex",position_type:v,value1:g,value2:b,operator1:m,operator2:y,searchstring:e},s=this.allListenersByType.position.conditional_complex,s[v]===undefined&&(s[v]=[]),s[v].push(o)),this.allListenersById[o]=l,this.positionListenersBySearchstring[e]=o,o},p.prototype.removeEventListener=function(e){var n,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S=[],x=[],T;n=e[0],i=e.length;if(i===1){r(n)==="array"?l=n:l=[n];for(g=l.length-1;g>=0;g--){f=l[g];if(this.allListenersById[f]!==undefined){h=this.allListenersById[f],s=h.type,o=h.subtype;if(s==="position"){E=this.allListenersByType[s][o][h.position_type];for(y=E.length-1;y>=0;y--)p=E[y],p!==f&&S.push(p);this.allListenersByType[h.type][h.subtype][h.position_type]=[].concat(S),delete this.allListenersById[f]}else if(s==="event"||s==="note"){d=h.event,v=d.id,E=this.allListenersByType.event[o][v];for(y=E.length-1;y>=0;y--){p=E[y],h=this.allListenersById[p];if(p!==f){S.push(p);break}}this.allListenersByType.event[o][v]=[].concat(S),delete this.allListenersById[f]}}else t.warn("no event listener found with id",f)}}else if(i===2||i===3){s=e[0],u=e[1],a=e[2],T=r(u);switch(s){case"position":if(T==="string"){f=this.positionListenersBySearchstring[u],h=this.allListenersById[f],E=this.allListenersByType[h.type][h.subtype][h.position_type];for(g=E.length-1;g>=0;g--)p=E[g],p!==f&&S.push(p);this.allListenersByType[h.type][h.subtype][h.position_type]=[].concat(S),delete this.allListenersById[f],delete this.positionListenersBySearchstring[u]}break;case"event":case"note":if(T==="string"){E=this.eventListenersBySearchstring[u];for(g=E.length-1;g>=0;g--)x.push(E[g]);m=this.allListenersByType.event.searchstring;for(v in m)if(m.hasOwnProperty(v)){E=m[v],S=[];for(g=E.length-1;g>=0;g--){p=E[g],w=!1;for(y=x.length-1;y>=0;y--)if(p===x[y]){w=!0;break}w===!1?S.push(p):delete this.allListenersById[E[g]]}this.allListenersByType.event.searchstring[v]=[].concat(S)}delete this.eventListenersBySearchstring[u]}else if(T==="object"){if(u.className!=="MidiEvent"&&u.className!=="MidiNote"){t.error("please provide a midi event or a midi note");return}u.className==="MidiNote"?f=u.noteOn.id:u.className==="MidiEvent"&&(f=u.id),this.allListenersByType.event.instance[f]!==undefined?(s="instance",E=this.allListenersByType.event.instance[f]):this.allListenersByType.event.searchstring[f]!==undefined&&(s="searchstring",E=this.allListenersByType.event.searchstring[f]);if(E===undefined){t.warn("no event listener bound to event with id",f);return}u.className==="MidiNote"&&(l=this.allListenersByType.event[s][u.noteOff.id],E=E.concat(l));for(g=E.length-1;g>=0;g--)p=E[g],h=this.allListenersById[p],a&&h.callback!==a?S.push(h.id):delete this.allListenersById[h.id],this.allListenersByType.event[s][h.event.id]=[].concat(S)}}}},p.prototype.resetAllListeners=function(){var e=this.allListenersById,t,n;for(t in e)e.hasOwnProperty(t)&&(n=e[t],n.called=!1)},c=function(e,n){var i=r(n),s=[],o,u;if(i!=="array"&&n!==undefined&&n.className!=="MidiEvent"&&n.className!=="MidiNote")return t.error(n," is not valid data for event type 'event', please consult documentation"),-1;if(i==="array")for(o=n.length-1;o>=0;o--){u=n[o];if(e==="event"&&u.className!=="MidiEvent"&&u.className!=="AudioEvent"){t.warn("skipping",u,"because it is not a MidiEvent nor an AudioEvent");continue}if(e==="note"&&u.className!=="MidiNote"){t.warn("skipping",u,"because it is not a MidiNote");continue}s.push(u)}else if(e==="event"){if(n.className!=="MidiEvent"&&n.className!=="AudioEvent")return t.error(n," is not a MidiEvent nor an AudioEvent"),-1;s=[n]}else if(e==="note"){if(n.className!=="MidiNote")return t.error(n," is not a MidiNote"),-1;s=[n.noteOn,n.noteOff]}return s},h=function(e,t){switch(e){case"=":case"==":case"===":return!1}switch(t){case"=":case"==":case"===":return!1}return!0},e.protectedScope.createFollowEvent=function(e){return new p(e)},e.protectedScope.addInitMethod(function(){r=e.protectedScope.typeString,i=e.protectedScope.getPosition,o=e.midiEventNumberByName,s=e.midiEventNameByNumber,n=e.findEvent})}(),function(){"use strict";var e,t,n,r,i,s,o,u,a,f;f=function(n,r,i,s,o){var u,a,f,l;if(n===undefined){console.error("please provide a song");return}if(r===undefined||i===undefined){console.error("please provide a coordinate");return}if(s===undefined||o===undefined){console.error("please provide width and height");return}return u=t(r/s*n.ticks),a=n.highestNote-t(i/o*n.pitchRange),f=e(n,["ticks",u]),a=sequencer.createNote(a),{position:f,note:a}},sequencer.positionToSong=sequencer.coordinatesToPosition=sequencer.gridToSong=function(){var e=Array.prototype.slice.call(arguments),t=e.length,n=e[0];return t===4&&n.className!=="Song"?f(sequencer.getSong(),n,e[1],e[2],e[3]):f(n,e[1],e[2],e[3],e[4])},sequencer.songToGrid=function(){var e=Array.prototype.slice.call(arguments),t=e.length,n=e[0],r=e[1];switch(t){case 3:o(n,r,e[2]);break;case 4:n==="x"?s(r,e[2],e[3]):n==="y"&&u(r,e[2],e[3]);break;case 6:break;default:console.error("wrong number of arguments")}},o=function(e,t,n,r){r===undefined&&(r=sequencer.getSong());if(e.type!==sequencer.NOTE_ON&&e.type!==sequencer.NOTE_OFF)return console.error("please provide a NOTE_ON or a NOTE_OFF event"),null;var i=e.millis/r.durationMillis*t,o,a=sequencer.createNote(e.noteNumber);return{x:s(["ticks",e.ticks],t,r),y:u(a,n,r)}},s=function(n,i,s){s===undefined&&(s=sequencer.getSong());if(r(n)==="array"||n.type!=="ticks")n=e(s,n);var o=t(n.ticks/s.quantizeTicks)*s.quantizeTicks;return o/=s.ticks,o*=i,o},u=function(e,t,n){n===undefined&&(n=sequencer.getSong());var r=e.number,i;return r<n.lowestNote||r>n.highestNote?(console.error("note is out of range of the pitch range of this song"),null):(i=(r-n.highestNote)/n.pitchRange,i=i<0?-i:i,i*=t,i)},sequencer.protectedScope.addInitMethod(function(){e=sequencer.protectedScope.getPosition,t=sequencer.protectedScope.floor,n=sequencer.protectedScope.round,r=sequencer.protectedScope.typeString})}(),function(){"use strict";function f(e,t){var r=e.lastEventTmp,i,s;e.autoSize===!1?e.lastBar=e.bars:t?e.lastBar=r.bar:e.lastBar=Math.max(e.lastBar,r.bar),e.bars=parseInt(e.lastBar),i=n(e,["barsandbeats",e.bars,r.nominator,r.numSixteenth,r.ticksPerSixteenth,!0]),e.durationTicks=i.ticks,e.durationMillis=i.millis;for(s in i)i.hasOwnProperty(s)&&(e.lastEvent[s]=i[s])}function l(e,t){var n=t.concat(e.timeEvents);i(e,n),t=t.concat(e.events),t.sort(function(e,t){return e.sortIndex-t.sortIndex}),e.eventsMidiAudioMetronome=[].concat(t)}function c(e,t){var n,r;for(n=t.length-1;n>=0;n--)r=t[n],r.startPosition=e.getPosition("ticks",r.start.ticks),r.endPosition=e.getPosition("ticks",r.end.ticks),r.start.millis=r.startPosition.millis,r.end.millis=r.endPosition.millis,r.duration.millis=r.end.millis-r.start.millis,r.state="clean"}function h(t,n){var r,i;for(r=n.length-1;r>=0;r--)i=n[r],i.endless===!0?(i.durationTicks=e.ticks-i.noteOn.ticks,i.durationMillis=e.millis-i.noteOn.millis):(i.durationTicks=i.noteOff.ticks-i.noteOn.ticks,i.durationMillis=i.noteOff.millis-i.noteOn.millis),i.ticks=i.noteOn.ticks,i.millis=i.noteOn.millis,i.number=i.noteOn.noteNumber,i.state="clean"}function p(t,n){var r,i,s,o,u,a=t.recordTimestamp,f=t.recordStartMillis,l=f,c=n.length,h=t.playheadRecording;h.set("millis",f);for(r=0;r<c;r++)o=n[r],u=o.recordMillis-a+f,s=h.update("millis",u-l),l=u,i=e.getNiceTime(s.millis),o.ticks=s.ticks,o.bpm=s.bpm,o.factor=s.factor,o.nominator=s.nominator,o.denominator=s.denominator,o.ticksPerBar=s.ticksPerBar,o.ticksPerBeat=s.ticksPerBeat,o.ticksPerSixteenth=s.ticksPerSixteenth,o.numSixteenth=s.numSixteenth,o.millisPerTick=s.millisPerTick,o.secondsPerTick=s.secondsPerTick,o.millis=s.millis,o.seconds=s.millis/1e3,o.hour=i.hour,o.minute=i.minute,o.second=i.second,o.millisecond=i.millisecond,o.timeAsString=i.timeAsString,o.timeAsArray=i.timeAsArray,o.bar=s.bar,o.beat=s.beat,o.sixteenth=s.sixteenth,o.tick=s.tick,o.barsAsString=s.bar+":"+s.beat+":"+s.sixteenth+":"+s.tick,o.barsAsArray=[s.bar,s.beat,s.sixteenth,s.tick],o.state="clean";t.recordStartMillis=undefined,t.recordTimestamp=undefined}function d(e){var t=e.length,n,r,i=-1e5,s,o=[];for(n=0;n<t;n++)r=e[n],s===undefined&&(s=[]),s.push(r),r.ticks!==i&&(s.length>1?(s.sort(function(e,t){return t.type===144&&e.type===128?!1:t.type===144&&e.type===176&&e.data1===64&&e.data2===127?!1:t.type===176&&t.data1===64&&t.data2===127&&e.type===128?!1:t.type===128&&e.type===176&&e.data1===64&&e.data2===0?!1:t.type===144&&e.type===176&&e.data1===64&&e.data2===0?!1:e.type===176&&e.data1===64&&e.data2===0&&t.type===176&&t.data1===64&&t.data2===127?!1:!0}),o=o.concat(s),s=undefined):o.push(s[0])),i=r.ticks}var e=window.sequencer,t=window.console,n,r,i,s,o,u,a;u=function(t,n){if(e.playing===!0){o.updateSong=function(){a(t,n)};return}a(t,n)},a=function(e,t){var n,s,o,u,a,l,d,v,m,g,y,b=[],w=[],E=[],S=[],x=[],T=[],N=[],C=[],k=[],L=[],A=[],O=[],M=[],_=[],D=[],P=[],H=[],B=[],j=[],F=[],I=[],q={},R={},U={};t===!0&&r(e);for(s in e.tracksById)if(e.tracksById.hasOwnProperty(s)){l=e.tracksById[s],l.needsUpdate===!0&&l.update();for(o in l.partsById)if(l.partsById.hasOwnProperty(o)){d=l.partsById[o],d.needsUpdate===!0&&d.update(),g=d.dirtyEvents;for(u in g)if(g.hasOwnProperty(u)){v=g[u];switch(v.state){case"new":b.push(v);break;case"recorded":S.push(v);break;case"changed":w.push(v);break;case"removed":E.push(v),delete d.eventsById[u]}}y=d.dirtyNotes;for(u in y)if(y.hasOwnProperty(u)){m=y[u];switch(m.state){case"new":x.push(m);break;case"changed":T.push(m);break;case"removed":N.push(m),delete d.notesById[u]}}d.dirtyEvents={},d.dirtyNotes={},d.state!=="removed"?(j=j.concat(d.notes),P=P.concat(d.events)):(N=N.concat(d.notes),E=E.concat(d.events));switch(d.state){case"new":C.push(d),U[d.id]=d;break;case"changed":k.push(d),U[d.id]=d;break;case"removed":L.push(d),delete l.partsById[d.id]}}F=F.concat(l.parts);switch(l.state){case"clean":l.index=I.length,I.push(l);break;case"new":A.push(l),l.state="clean",l.index=I.length,I.push(l);break;case"changed":O.push(l),l.state="clean",l.index=I.length,I.push(l);break;case"removed":M.push(l),delete e.tracksById[l.id]}}for(n=E.length-1;n>=0;n--)v=E[n],v.state="clean";for(n=N.length-1;n>=0;n--)m=N[n],m.state="clean";for(n=L.length-1;n>=0;n--)d=L[n],d.state="clean";S.length>0&&p(e,S),P.sort(function(e,t){return e.sortIndex-t.sortIndex}),j.sort(function(e,t){return e.ticks-t.ticks}),F.sort(function(e,t){return e.ticks-t.ticks});for(n=P.length-1;n>=0;n--)v=P[n],q[v.id]=v,v.type==="audio"?B.push(v):H.push(v);for(n=j.length-1;n>=0;n--)m=j[n],R[m.id]=m;t===!1?(a=e.timeEvents.concat(b,w),i(e,a),a=[].concat(x,T),h(e,a),a=[].concat(C,k),c(e,a)):(a=e.timeEvents.concat(P),i(e,a),h(e,j),c(e,F)),f(e),e.metronome.bars!==e.bars?e.metronome.update():t===!0&&e.metronome.update(),_=[].concat(H,B,e.metronome.events),_.sort(function(e,t){return e.ticks-t.ticks}),D=[].concat(P,e.timeEvents),D.sort(function(e,t){return e.ticks-t.ticks}),e.eventsMidiAudioMetronome=_,e.eventsMidiTime=D,e.events=P,e.midiEvents=H,e.audioEvents=B,e.notes=j,e.parts=F,e.tracks=I,e.numEvents=P.length,e.numNotes=j.length,e.numParts=F.length,e.numTracks=I.length,e.eventsById=q,e.notesById=R,e.partsById=U,e.newEvents=b,e.changedEvents=w,e.removedEvents=E,e.newNotes=x,e.changedNotes=T,e.removedNotes=N,e.newParts=C,e.changedParts=k,e.removedParts=L,e.playhead.updateSong(),e.playheadRecording.updateSong(),e.scheduler.updateSong(),e.scheduler.reschedule(),e.followEvent.updateSong(),e.grid!==undefined&&e.grid.update(),e.keyEditor!==undefined&&e.keyEditor.updateSong({numBars:e.bars,newEvents:b,changedEvents:w,removedEvents:E,newNotes:x,changedNotes:T,removedNotes:N,newParts:C,changedParts:k,removedParts:L})},e.protectedScope.update=u,e.protectedScope.checkDuration=f,e.protectedScope.parseMetronomeEvents=l,e.protectedScope.addInitMethod(function(){n=e.protectedScope.getPosition,i=e.protectedScope.parseEvents,r=e.protectedScope.parseTimeEvents,s=e.protectedScope.getInstrument,o=e.protectedScope.scheduledTasks})}(),function(){"use strict";function N(e,t){var n=!1;return e?e.className==="Part"?n=e:s(e)==="string"?n=t.partsById[e]:isNaN(e)===!1&&(n=t.parts[e]):n=!1,n}function C(e,t){var n=!1;return e?e.className==="MidiEvent"||e.className==="AudioEvent"?n=e:s(e)==="array"&&e.length===4?n=l(e):s(e)==="string"?n=t.eventsById[e]:isNaN(e)===!1&&(n=t.events[e]):n=!1,n}function k(e,n){e=Array.prototype.slice.call(e);var r=0,i=0,o,u,a,f=e[0],l=[],c=[];if(s(f)==="array"){for(i=f.length-1;i>=0;i--)a=f[i],u=N(a,n),u&&l.push(u);r=l.length===0?0:1}o=e.length;for(i=r;i<o;i++)a=e[i],u=N(a,n),u?l.push(u):c.push(a);return l.length===0?(t.warn("no parts added"),!1):{parts:l,config:c}}function L(e,r){e=Array.prototype.slice.call(e);var i=0,o=0,u,a,f,l=e[0],c=[],h=[];if(s(l)==="array"){for(o=l.length-1;o>=0;o--)f=l[o],a=C(f,r),a&&c.push(a);i=1}u=e.length;for(o=i;o<u;o++)f=e[o],a=C(f,r),a?c.push(a):h.push(f);return c.length===0&&n>=2&&t.info("Please provide one or more events, or an array of events"),h.length===1&&s(h[0])==="array"&&(h=h[0]),{events:c,config:h}}function A(e,n){var r,i;e=f(e);if(e===!1)return!1;r=e[0];if(n===undefined&&r!=="ticks")return t.error("Track has not been added to a song yet, you can only use tick values"),!1;switch(r){case"ticks":i=e[1];break;case"millis":i=n.millisToTicks(e[1]);break;case"barsbeats":case"barsandbeats":case"time":e=n.getPosition(e,"ticks"),i=e.ticks}return i}function O(e,n){if(e===!1)return;var r,i,s,o,u,a,f,l=n.song,c=e.parts,h=c.length,p=n.partsById;for(r=0;r<h;r++){o=N(c[r]);if(o===!1){t.error(o,"is not a part");continue}o.track!==undefined&&(o=o.copy()),o.hasAudioEvents&&n.audio===undefined&&(n.audio=d(n)),o.song=l,o.track=n,o.trackId=n.id,u=o.eventsById,a=o.ticks,f=a!==0;for(i in u)u.hasOwnProperty(i)&&(s=u[i],s.track=n,s.channel=n.channel,s.trackId=n.id,f&&(s.ticks+=a),s.state="new");o.state="new",o.needsUpdate=!0,p[o.id]=o}n.needsUpdate=!0}function M(e,t){if(e===!1)return;var n,r,i=e.parts,s=e.config[0],o=s,u;for(u=i.length-1;u>=0;u--)r=i[u],n=r.ticks+s,n<0&&(n=0,o=-r.ticks),r.ticks=n,r.moveEvents(r.events,o),r.state!=="new"&&(r.state="changed");t.needsUpdate=!0}function _(e,n){if(e===!1)return;var r,i,s,o,u=n.song,a=e.parts,f=e.config;for(r=a.length-1;r>=0;r--){i=a[r],s=A(f[r],u);if(s===!1){t.warn("wrong position data, skipping part",i.id);continue}o=s-i.ticks,i.ticks=s,i.moveAllEvents(o),i.state!=="new"&&(i.state="changed")}n.needsUpdate=!0}function D(e,n){if(e===!1)return[];var r,i,s=[],o=e.parts;if(o===undefined)return t.log("weird situation, check this when it happens"),[];for(r=o.length-1;r>=0;r--){i=o[r];if(i.track!==undefined&&i.track!==n){t.warn("can't remove: this part belongs to track",i.track.id);continue}s.push(i),i.state="removed",i.reset(!0,!0)}return n.needsUpdate=!0,s}function P(e,n){if(e===!1)return;var r,i,s,o,u={},a=[],f=e;for(r=f.length-1;r>=0;r--){o=f[r];if(o.track!==undefined&&o.track!==n){t.warn("can't remove: this event belongs to track",o.track.id);continue}s=o.partId,u[s]===undefined&&(u[s]=[]),u[s].push(o),a.push(o)}for(s in u)u.hasOwnProperty(s)&&(i=n.partsById[s],i.removeEvents(u[s]));return n.needsUpdate=!0,a}function H(t){var n;t.song!==undefined&&t.song.defaultInstrument!==undefined&&(n=u(t.song.defaultInstrument,e.storage.instruments));if(n===!1||n===undefined)n=u(e.defaultInstrument,e.storage.instruments);return n}var e=window.sequencer,t=window.console,n=e.debug,r=Array.prototype.slice,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x=0,T;T=function(e,t,n){this.className="Track",this.id="T"+x++ +""+(new Date).getTime(),this.type=t||"instrument",this.name=e||this.id,this.song=n,this.instrumentName="",this.events=[],this.eventsById={},this.notes=[],this.notesById={},this.parts=[],this.partsById={},this.numParts=0,this.numEvents=0,this.needsUpdate=!1,this.audioLatency=0,this.effects={},this.numEffects=0,this.volume=1,this.input=h.createGainNode(),this.input.gain.value=1,this.output=h.createGainNode(),this.output.gain.value=this.volume,this.panner=v(),this
.input.connect(this.panner.node),this.panner.node.connect(this.output),this.lastEffect=this.input,this.midiInputs={},this.midiOutputs={},this.routeToMidiOut=!1,this.midiEventListeners={},this.monitor=!1,this.recordEnabled=!1,this.mute=!1,this.solo=!1,this.channel="any",this.quantizeValue=0,this.fixedLengthValue=0,this.autoQuantize=!1,this.retrospectiveRecording=[],this.recordingNotes={},this.enableRetrospectiveRecording=!1,t!=="metronome"&&this.setInstrument(this.instrumentName)},T.prototype.addPart=T.prototype.addParts=function(){var e=k(arguments,this);O(e,this)},T.prototype.addPartAt=T.prototype.addPartsAt=function(){var e=k(arguments,this),n,r,i,s,o;if(e===!1)return;r=e.parts,n=e.config;if(n===undefined)return t.error("please provide position data"),!1;for(i=r.length-1;i>=0;i--){s=r[i],n[0]==="ticks"?o=n[1]:o=A(n[i],this.song);if(o===!1)continue;s.ticks+=o}O(e,this)},T.prototype.movePart=T.prototype.moveParts=function(){var e=k(arguments,this);M(e,this)},T.prototype.movePartTo=T.prototype.movePartsTo=function(){var e=k(arguments,this);_(e,this)},T.prototype.moveAllParts=function(e){this.moveParts({parts:this.parts,config:[e]})},T.prototype.copyPart=T.prototype.copyParts=function(){var e=k(arguments,this),n,r=[];if(e===!1)return;if(n.length===0){t.error("no parts");return}return n=e.parts,n.forEach(function(e){r.push(e.copy())}),r.length===1?r[0]:r},T.prototype.removePart=function(){var e=k(arguments,this),t=D(e,this);return t.length===1?t[0]:t},T.prototype.removeParts=function(){var e=k(arguments,this);return D(e,this)},T.prototype.getPart=function(e){return N(e)},T.prototype.getParts=function(){var e=Array.prototype.slice.call(arguments),t,n=[],r;return r=function(e,i){t=e[i],s(t)==="array"?r(t,0):n.push(N(t))},r(e,0),n},T.prototype.getPartAt=T.prototype.getPartsAt=function(e){var n=A(e,this.song),r=this.parts,i=[];if(n===!1){t.error("please provide position as array, for instance: ['barsandbeats',5,1,2,0]");return}return r.forEach(function(e){e.ticks===n&&i.push(e)}),i},T.prototype.getPartFromTo=T.prototype.getPartsFromTo=function(e,n){var r=this.parts,i=[],s=A(e,this.song),o=A(n,this.song);if(s===!1){t.error("invalid position data for from position");return}if(o===!1){t.error("invalid position data for from position");return}return r.forEach(function(e){(s>=e.start.ticks&&s<=e.end.ticks||o>=e.start.ticks&&o<=e.end.ticks)&&i.push(e)}),i},T.prototype.getPartBetween=T.prototype.getPartBetween=function(e,n){var r=this.parts,i=[],s=A(e,this.song),o=A(o,this.song);if(s===!1||o===!1){t.error("please provide position as array, for instance: ['barsandbeats',5,1,2,0]");return}return r.forEach(function(e){e.start.ticks>=s&&e.end.ticks<=o&&i.push(e)}),i},T.prototype.copy=function(){var e=new T(o(this.name)),t,n,r,i=this.parts,s=[];e.song=null,e.instrumentId=this.instrumentId,e.numEffects=this.numEffects;if(this.numEffects>0){e.effects={};for(n in this.effects)this.effects.hasOwnProperty(n)&&(r=this.effects[n],e.effects[r.id]=r.copy())}for(n=i.length-1;n>=0;n--)t=i[n],s.push(t.copy());return e.addParts(s),e},T.prototype.removeEvent=T.prototype.removeEvents=function(){var e=L(arguments,this);P(e.events,this)},T.prototype.removeEventsFromTo=function(e,n){t.warn("removeEventsFromTo() is temporarily disabled")},T.prototype.removeEventAt=T.prototype.removeEventsAt=function(e){t.warn("removeEventAt() is temporarily disabled")},T.prototype.removeAllEvents=function(){P(this.events,this)},T.prototype.transposePart=function(e,t){var n=e.getStats("noteNumber all"),r=0,i=127,s;this.song&&(r=this.song.lowestNote,i=this.song.highestNote);if(n.min+t<r){s=r-n.min;return}if(n.max+t>i){s=i=n.max;return}e.transposeAllEvents(t)},T.prototype.reset=function(){var e,t;this.song=null,this.audio&&this.audio.setSong(null);for(e in this.partsById)this.partsById.hasOwnProperty(e)&&(t=this.partsById[e],t.reset(!1,!0));this.needsUpdate=!0},T.prototype.findEvent=function(e){return w(this,e)},T.prototype.findNote=function(e){return E(this,e)},T.prototype.getStats=function(e){return S(this,e)},T.prototype.update=function(){this.parts=[],this.notes=[],this.events=[];var e,t,n,r,i,s;for(t in this.partsById)if(this.partsById.hasOwnProperty(t)){n=this.partsById[t],n.needsUpdate===!0&&n.update(),n.events.length===0&&n.keepWhenEmpty===!1&&this.removePart(n);if(n.state==="new"&&this.song!==undefined){i=n.events;for(e=i.length-1;e>=0;e--)r=i[e],r.song=this.song}n.state!=="removed"&&(this.parts.push(n),this.notes=this.notes.concat(n.notes),this.events=this.events.concat(n.events))}this.parts.sort(function(e,t){return e.ticks-t.ticks}),this.notes.sort(function(e,t){return e.ticks-t.ticks}),this.events.sort(function(e,t){return e.sortIndex-t.sortIndex}),this.numEvents=this.events.length,this.numNotes=this.notes.length,this.numParts=this.parts.length;for(e=this.numEvents-1;e>=0;e--)r=this.events[e],this.eventsById[r.id]=r;for(e=this.numNotes-1;e>=0;e--)s=this.notes[e],this.notesById[s.id]=s;this.needsUpdate=!1},T.prototype.getIndex=function(){var e=-1,t=this.song.tracks,n=t.length,r,i;if(n>0)for(i=0;i<n;i++){r=t[i];if(r.id===this.id){e=i;break}}return e},T.prototype.addEffect=function(e,t){if(!e)return;this.effects[e.id]=e,this.numEffects++,this.lastEffect!==undefined&&(this.lastEffect.disconnect(0),e.setInput(this.lastEffect)),e.output.connect(this.panner.node),this.lastEffect=e.output},T.prototype.removeEffect=function(e){if(e===!1)return;delete this.effects[e.id],this.numEffects--},T.prototype.setEffectPosition=function(e,t){var n,r,i=this.numEffects-1;if(t<0||t>i)return;e.position=t;for(n=0;n<i-1;n++)r=this.effects[n],r.position>=t&&r!==e&&(r.position+=1)},T.prototype.setSolo=function(e){e===undefined&&(e=!this.solo),this.mute=!1,this.solo=e,this.song&&this.song.setTrackSolo(this,e)},T.prototype.setPartSolo=function(e,t){var n,r;for(n=this.numParts-1;n>=0;n--)r=this.parts[n],t===!0?r.mute=r===e?!t:t:t===!1&&(r.mute=!1),r.solo=r===e?t:!1},T.prototype.setVolume=function(n){isNaN(n)?e.debug>=1&&t.error("please pass a number"):n<0||n>1?e.debug>=1&&t.error("please pass a float between 0 and 1"):(this.volume=n,this.input.gain.value=this.volume)},T.prototype.getVolume=function(){return this.volume},T.prototype.setPanning=function(e){this.panner.setPosition(e)},T.prototype.connect=function(e){this.output.connect(e)},T.prototype.disconnect=function(e){this.output.disconnect(0)},T.prototype.setInstrument=function(e){if(e===""||e===undefined||e===!1)e=H(this);var t=p(e);t===!1&&(t=p(H(this))),t.track=this,this.instrument&&this.instrument.allNotesOff(),this.instrument=t,this.instrumentId=t.name,this.song&&(this.instrument.song=this.song)},T.prototype.setMidiInput=function(t,n){var r,i,s=this.midiInputs,o;n=n===undefined?!0:n;if(t==="all"){o=this.song!==undefined?this.song.midiInputs:e.midiInputs,a(o,function(e,t){n===!0?s[t]=e:delete s[t]});return}r=this.song.midiInputs[t];if(r===undefined)return;n?this.midiInputs[t]=r:delete this.midiInputs[t]},T.prototype.setMidiOutput=function(e,t){t=t===undefined?!0:t;var n=this.song.midiOutputs[e],r=this;if(n===undefined)return;t===!0&&this.instrument.allNotesOff(),t?this.midiOutputs[e]=n:delete this.midiOutputs[e],this.routeToMidiOut=!1,a(this.midiOutputs,function(e,t){e!==!1&&(r.routeToMidiOut=!0)})},T.prototype.prepareForRecording=function(t,n){if(this.recordEnabled!=="midi"&&this.recordEnabled!=="audio")return;this.recordPart=e.createPart(),this.addPart(this.recordPart),this.recordingNotes={},this.recordId=t,this.recordEnabled==="audio"&&(this.audio===undefined&&(this.audio=d(this)),this.audio.prepareForRecording(t,n))},T.prototype.stopRecording=function(r,i){if(this.recordId!==r)return;this.recordingNotes={};if(this.autoQuantize||this.song.autoQuantize)n>=1&&t.log("performing auto quantize"),this.quantizeRecording();if(this.recordEnabled==="midi")this.recordPart.update(),i(this.recordPart.events);else if(this.recordEnabled==="audio"){var s=this;this.audio.stopRecording(function(t){var n=e.createAudioEvent({ticks:s.song.recordTimestampTicks,buffer:t.audioBuffer,sampleId:t.id});s.recordPart.addEvent(n),s.recordPart.update(),i([n])})}},T.prototype.undoRecording=function(e){var t=s(e);t==="string"?this.recordId===e&&this.removePart(this.recordPart):t==="array"&&this.removeEvents(e)},T.prototype.setWaveformConfig=function(e){this.waveformConfig=e,this.audio!==undefined&&(this.audio.recorder.waveformConfig=e)},T.prototype.getAudioRecordingData=function(n){if(this.audio===undefined)return;return n===undefined?(e.debug>=e.WARN&&t.warn("please provide a recording id"),!1):e.storage.audio.recordings[n]},T.prototype.encodeAudioRecording=function(n,r,i,s){if(this.audio===undefined)return;if(n===undefined){e.debug>=e.WARN&&t.warn("please provide a recording id"),s&&s(!1);return}var o=e.storage.audio.recordings[n];y(o.audioBuffer,r,i,function(e){o.mp3=e,s(o)})},T.prototype.setAudioRecordingLatency=function(e,t,n){this.audio!==undefined&&this.audio.setAudioRecordingLatency(e,t,function(t){var r,i,s,o=this.song.audioEvents;for(r=o.length-1;r>=0;r--){i=o[r],s=i.sampleId;if(s===undefined)continue;e===s&&(i.buffer=t.audioBuffer)}n!==undefined&&n()})},T.prototype.quantizeRecording=function(t){return t=t||this.quantizeValue,e.quantize(this.recordPart.events,t,this.song.ppq)},T.prototype.quantize=function(){var t,n,i,o=r.call(arguments),u=o.length,a,f={};for(t=0;t<u;t++)n=o[t],i=s(n),i==="string"||i==="number"?a=n:i==="object"&&(f=n);return a===undefined&&(a=this.quantizeValue),e.quantize(this.events,a,this.song.ppq,history)},T.prototype.undoQuantize=function(n){if(n===undefined){e.debug>=2&&t.warn("please pass a quantize history object");return}var r=n.tracks[this.id].quantizedEvents,i=r.length,s,o;for(s=0;s<i;s++)o=r[s],o.ticks=n.events[o.id].ticks},T.prototype.addMidiEventListener=function(){return m(arguments,this)},T.prototype.removeMidiEventListener=function(e){g(e,this)},T.prototype.allNotesOff=function(e){this.audio&&this.audio.allNotesOff(),this.instrument&&this.instrument.allNotesOff()},T.prototype.processMidiEvent=function(e){b(e,this)},e.protectedScope.Track=T,e.createTrack=function(e,t,n){return new T(e,t,n)},e.protectedScope.addInitMethod(function(){var t=e.protectedScope;S=e.getStats,w=e.findEvent,E=e.findNote,i=e.createPart,l=e.createMidiEvent,c=e.createMidiNote,p=e.createInstrument,v=e.createPanner,y=e.encodeAudio,h=t.context,u=t.findItem,m=t.addMidiEventListener,g=t.removeMidiEventListener,d=e.protectedScope.createAudioTrack,f=t.checkPosition,a=t.objectForEach,s=t.typeString,o=t.copyName,b=t.handleMidiMessageTrack})}(),function(){"use strict";function o(){window.Pitchshift&&(s=new t(i,r.sampleRate,"FFT"))}function u(e,t,i){if(s===undefined){n.log("include Kiev II");return}if(t===0&&i){i(e);return}var o=e.numberOfChannels,u,a,f,l,c=[],h,p,d;for(u=0;u<o;u++){a=e.getChannelData(u),f=a.length,l=new Float32Array(f),h=Math.pow(1.0595,t),s.process(h,a.length,4,a);for(p=0;p<f;p++)l[p]=s.outdata[p];c[u]=l}d=r.createBuffer(o,f,e.sampleRate);for(u=0;u<o;u++)d.getChannelData(u).set(c[u]);i(d)}var e=window.sequencer,t=window.Pitchshift,n=window.console,r,i=2048,s;e.protectedScope.transpose=u,e.protectedScope.addInitMethod(function(){r=e.protectedScope.context,o()})}(),function(){"use strict";function c(e){if(typeof e!="object")return typeof e;if(e===null)return"null";var t=Object.prototype.toString.call(e).match(/\[object\s(\w+)\]/)[1];return t.toLowerCase()}function h(e){var t,n,r,i,s,o="";return s=e/1e3,t=b(s/3600),n=b(s%3600/60),r=b(s%60),i=y((s-t*3600-n*60-r)*1e3),o+=t+":",o+=n<10?"0"+n:n,o+=":",o+=r<10?"0"+r:r,o+=":",o+=i===0?"000":i<10?"00"+i:i<100?"0"+i:i,{hour:t,minute:n,second:r,millisecond:i,timeAsString:o,timeAsArray:[t,n,r,i]}}function p(e){var t,n;if(e===null||typeof e!="object")return e;n=e.constructor();for(t in e)e.hasOwnProperty(t)&&(n[t]=p(e[t]));return n}function d(e){var t,n={};if(c(e)!=="object")return{};for(t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n}function v(e){var t=e.indexOf("_copy"),n,r;return t===-1?n=e+"_copy":(r=e.substring(t+5),r===""?n=e+"2":n=e.slice(0,-1)+(parseInt(r,10)+1)),n}function m(e,t){var n,r,i,s,o=[],u,a,f;c(e)!=="array"&&(e=[e]),i=t.length,s=e.length;for(n=0;n<i;n++){a=t[n],u=!1;for(r=0;r<s;r++){f=e[r];if(a===f){u=!0;break}}u===!1&&o.push(a)}return o}function g(e,t){var n,r=e.length,i,s=[];for(n=0;n<r;n++)i=e[n],t(i)===!1&&s.push(i);return s}function y(e,t){if(t===undefined||t<=0)return s(e);var n=i(10,t);return s(e*n)/n}function b(e,t){if(t===undefined||t<=0)return o(e);var n=i(10,t);return o(e*n)/n}function w(e,t){if(e===undefined)return!1;var n,r=!0;t=t||"";for(n in e)if(e.hasOwnProperty(n)&&t.indexOf(n)===-1){r=!1;break}return r}function E(e,t){var n,r=e;for(n in r)r.hasOwnProperty(n)&&t(r[n],n)}function S(e){var t,n=[];for(t in e)e.hasOwnProperty(t)&&n.push(e[t]);return n}function x(e,t){var n,r={};for(n=e.length-1;n>=0;n--)r[e[n][t]]=e[n];return r}function T(e,t){var n;return n=function(){this.parent=e,arguments.length>0&&(e.apply(this,arguments),t!==undefined&&t.apply(this,arguments))},n.prototype=Object.create(e.prototype),n}function N(e){function s(i,s){s=s||function(){},i=i||function(){},t.onload=function(){if(t.status!==200){s(t.status);return}e.responseType==="json"?(r=t.response.length,i(JSON.parse(t.response),r)):i(t.response)},t.onerror=function(t){e.onError(t)},t.open(n,e.url,!0),e.overrideMimeType&&t.overrideMimeType(e.overrideMimeType),e.responseType&&(e.responseType==="json"?t.responseType="text":t.responseType=e.responseType),n==="POST"&&t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.data?t.send(e.data):t.send()}var t=new XMLHttpRequest,n=e.method===undefined?"GET":e.method,r,i;i=new Promise(s);if(e.onSuccess===undefined)return i;i.then(e.onSuccess,e.onError)}function C(e){var t=new XMLHttpRequest,n=e.method===undefined?"GET":e.method,r;t.onreadystatechange=function(){t.request===404&&e.onError(404)},t.onload=function(){if(t.status!==200){e.onError(t.status);return}e.responseType==="json"?(r=t.response.length,e.onSuccess(JSON.parse(t.response),r)):e.onSuccess(t.response)},t.onerror=function(t){e.onError(t)},t.open(n,e.url,!0),e.overrideMimeType&&t.overrideMimeType(e.overrideMimeType),e.responseType&&(e.responseType==="json"?t.responseType="text":t.responseType=e.responseType),n==="POST"&&t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.data?t.send(e.data):t.send()}function k(e,t,n){var r,i;for(r in e){if(l!==!1)return;if(e.hasOwnProperty(r)){i=e[r];if(i!==undefined&&i.className==="Folder"){if(r===t){l=i;return}k(i,t,n+".")}}}}function L(e,t,n,r){var i,s;for(i in e)if(e.hasOwnProperty(i)){if(i==="id"||i==="path"||i==="className")continue;s=e[i];if(s===undefined)continue;s.className==="Folder"?n===!0&&L(s,t,n,r+"."):s.name===undefined?t.push({name:i,data:s}):t.push(s)}}function A(e,t,n){n=n===undefined?!0:n;var r=q(e),i=r.length,s,o,u,a=r[i-1],f=[];if(i===0)L(t,f,n,".");else{s=t;for(o=0;o<i;o++){u=r[o],s=s[u];if(s===undefined)break}s?L(s,f,n,"."):(l=!1,k(t,a,"."),L(l,f,n,"."))}return f.sort(function(e,t){var n=e.name.toLowerCase(),r=t.name.toLowerCase();return n<r?-1:n>r?1:0}),f}function O(e,t,n){var r,i,s;for(r in e){if(f!==!1)return;if(e.hasOwnProperty(r)){i=e[r],s=c(i);if(r===t){f=i;break}i!==undefined&&i.className==="Folder"&&(n+=".",O(i,t,n))}}}function M(e,t,n){n=n===undefined?!1:n;if(e===undefined||e==="")return t;var r,i,s,o,u,a,l;s=q(e),l=s.pop(),o=s.length;if(l==="")return t;f=!1;if(s.length>0){u=t;for(r=0;r<o;r++){i=s[r],u=u[i];if(u===undefined)break}u&&(a=u[l])}return a===undefined&&(n===!0?a=t[l]:(O(t,l,"."),a=f)),a===undefined&&(a=!1),a}function _(e,t,n){var r,i,s,o,u,a="";i=q(t),s=i.length,o=n;for(u=0;u<s;u++){r=i[u],a+="/"+r,o[r]===undefined&&(o[r]={path:a,className:"Folder"});if(u===s-1){o[r]=e;break}o=o[r]}}function D(e,t){var n,r,i,s=t;n=M(e,t,!0);if(!n)return!1;if(n.className==="Folder")for(i in n)n.hasOwnProperty(i)&&i!=="className"&&delete n[i];e=q(e);while(e.length>1){i=0,s=t;while(i<e.length-1)s=s[e[i++]];r=e[i],n=s[r],n.className==="Folder"?w(n,"path className")&&delete s[r]:delete s[r],e.pop()}return e.length===1&&e[0]!==""&&(r=e[0],n=t[r],n.className==="Folder"?w(t[r],"path className")&&delete t[r]:delete t[r]),!0}function P(e,r){return new Promise(function(i,s){try{n.decodeAudioData(r,function(n){i({id:e,buffer:n})},function(r){t.log("error decoding audiodata",e,r),i({id:e,buffer:undefined})})}catch(o){t.log("error decoding audiodata",e,o),i({id:e,buffer:undefined})}})}function H(e,t){return new Promise(function(n,r){N({url:t,responseType:"arraybuffer"}).then(function(i){P(e,i).then(n,r)},function(){n({id:e,buffer:undefined})})})}function B(e){var t,n,r=[];for(t in e)e.hasOwnProperty(t)&&(n=e[t],n.indexOf("http://")===-1?r.push(P(t,I(n))):r.push(H(t,n)));return new Promise(function(e,t){Promise.all(r).then(function(n){var r={};n.forEach(function(e){r[e.id]=e.buffer}),e(r)},function(n){t(n)})})}function j(e){var t,n,r,i,s;t=e||"",n=[],r=t.length,i=String.fromCharCode;for(s=0;s<r;s++)n[s]=i(t.charCodeAt(s)&255);return n.join("")}function F(e){var t,n,r,i,s;t=e||"",r=t.length,n=new Uint8Array(r),i=String.fromCharCode;for(s=0;s<r;s++)n[s]=i(t.charCodeAt(s)&255);return n}function I(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",n,r,i,s,o,u,a,f,l,c,h,p,d,v=0;n=Math.ceil(3*e.length/4),i=new ArrayBuffer(n),r=new Uint8Array(i),s=t.indexOf(e.charAt(e.length-1)),o=t.indexOf(e.charAt(e.length-1)),s==64&&n--,o==64&&n--,e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");for(d=0;d<n;d+=3)l=t.indexOf(e.charAt(v++)),c=t.indexOf(e.charAt(v++)),h=t.indexOf(e.charAt(v++)),p=t.indexOf(e.charAt(v++)),u=l<<2|c>>4,a=(c&15)<<4|h>>2,f=(h&3)<<6|p,r[d]=u,h!=64&&(r[d+1]=a),p!=64&&(r[d+2]=f);return i}function q(e){return e===undefined?[]:(e=e.replace(/undefined/g,""),e=e.replace(/\/{2,}/g,"/"),e=e.replace(/^\//,""),e=e.replace(/\/$/,""),e=e.split("/"),e)}function R(e){var t="",n=e,r="",i,s,o;return e=e.replace(/\/{2,}/g,"/"),e=e.replace(/^\//,""),e=e.replace(/\/$/,""),i=e.lastIndexOf("/"),i!==-1&&(n=e.substring(i+1),t=e.substring(0,i)),s=e.lastIndexOf("."),s!==-1&&(o=e.substring(s+1),o.length>=3&&o.length<=4&&(r=o,n=e.substring(i+1,s))),{path:t,name:n,ext:r}}function U(e,t,n,r,i){if(t===0){r&&r();return}var s=n[e];s.load(function(){i&&i(arguments),e++,e<t?U(e,t,n,r,i):r&&r()})}function z(e){var t=[],n,i;return e=r.call(e),n=function(e,r,s){for(r=0;r<s;r++)i=e[r],c(i)==="array"?n(i,0,i.length):t.push(i)},n(e,0,e.length),t}function W(e,t,n){var r,i,s,o=new Float32Array(e);for(r=0;r<e;r++)s=r/e,t==="fadeIn"?i=Math.cos((1-s)*.5*Math.PI)*n:t==="fadeOut"&&(i=Math.cos(s*.5*Math.PI)*n),o[r]=i,r===e-1&&(o[r]=t==="fadeIn"?1:0);return o}function X(e,t,n,r,i){var s=n-t,o=i-r,u;return u=(e-t)*o/s+r,u}function V(e,t,n){var r,i,s;for(r in e)e.hasOwnProperty(r)&&(i=e[r],i.className===t?n.push(i):(s=c(i),s==="object"&&O(i,t,n)))}function $(e){function s(n){var r=t.valueAsNumber;e.onMouseDown&&e.onMouseDown(r,n),i.onMouseDown&&i.onMouseDown(r,n)}function o(n){var r=t.valueAsNumber;e.onMouseUp&&e.onMouseUp(r,n),i.onMouseUp&&i.onMouseUp(r,n)}function u(n){var r=t.valueAsNumber;e.onMouseMove&&e.onMouseMove(r,n),i.onMouseMove&&i.onMouseMove(r,n)}function a(n){var r=t.valueAsNumber;e.onChange&&e.onChange(r,n),i.onChange&&i.onChange(r,n)}var t=e.slider,n=e.message,r=e.label,i;return e.label===undefined&&(r=t.parentNode.firstChild),e.initialSliderValue!==undefined&&(t.value=e.initialSliderValue),e.initialLabelValue!==undefined&&(r.innerHTML=n.replace("{value}",e.initialLabelValue)),e.min!==undefined&&(t.min=e.min),e.max!==undefined&&(t.max=e.max),e.step!==undefined&&(t.step=e.step),t.addEventListener("mousedown",function(e){setTimeout(s,0,e),t.addEventListener("mousemove",u,!1)},!1),t.addEventListener("mouseup",function(e){setTimeout(o,0,e),t.removeEventListener("mousemove",u,!1)},!1),t.addEventListener("change",function(e){a(e)},!1),i={getValue:function(){return e.getValue?e.getValue(t.valueAsNumber):t.valueAsNumber},setValue:function(n){e.setValue?t.value=e.setValue(n):t.value=n},setLabel:function(e){r.innerHTML=n.replace("{value}",e)},elem:t,element:t},i.set=function(e){setLabel(e),setValue(e)},i}function J(e){function i(){var i=u();e.onMouseMove!==undefined&&e.onMouseMove(t.valueAsNumber,i),r.innerHTML=n.replace("{value}",i)}function s(){var i=u();e.onMouseUp!==undefined&&e.onMouseUp(t.valueAsNumber,i),r.innerHTML=n.replace("{value}",i)}function o(){var i=u();e.onMouseDown!==undefined&&e.onMouseDown(t.valueAsNumber,i),r.innerHTML=n.replace("{value}",i)}function u(){var n=t.valueAsNumber;return e.calculate!==undefined&&(n=e.calculate(n)),n}function a(t){return e.calculateFromLabel!==undefined&&(t=e.calculateFromLabel(t)),t}var t=e.slider,n=e.message,r=t.parentNode.firstChild;return e.initialValueSlider&&(t.value=e.initialValueSlider,r.innerHTML=n.replace("{value}",u())),e.initialValueLabel&&(r.innerHTML=n.replace("{value}",e.initialValueLabel),t.value=a(e.initialValueLabel)),t.addEventListener("mousedown",function(){setTimeout(o,0),t.addEventListener("mousemove",i,!1)},!1),t.addEventListener("mouseup",function(){setTimeout(s,0),t.removeEventListener("mousemove",i,!1)},!1),{updateSlider:function(e){t.value=e,r.innerHTML=n.replace("{value}",u(e))},updateLabel:function(e){r.innerHTML=n.replace("{value}",e),t.value=a(e)},getValue1:function(){return t.valueAsNumber},getValue2:function(){return u(t.valueAsNumber)}}}function K(e,t,n){var r=u()*(t-e)+e;return n===!0?s(r):r}function Q(t){var n,r=0,i=[],s,o,u,a,f,l,c,h,p,d;t=t||{},d=t.ppq||e.defaultPPQ,u=t.numNotes||20,f=t.noteLength||d/2,l=t.minVelocity||30,c=t.maxVelocity||127,h=t.minNoteNumber||60,p=t.maxNoteNumber||127,f>d&&(f=d);for(n=0;n<u;n++)a=K(h,p,!0),o=K(l,c,!0),s=e.createMidiEvent(r,e.NOTE_ON,a,o),i.push(s),r+=f,s=e.createMidiEvent(r,e.NOTE_OFF,a,0),i.push(s),r+=d-f;return i}function G(){function f(e,t,n){var r,i,s,o,u;for(o=t;o<n;o++){r=e[o],i=c(r);if(i==="array")l(r);else if(i==="object")if(r.className==="Part"||r.className==="Track"||r.className==="Song")l(r.events);else if(r.className==="MidiFile")for(u=r.numTracks-1;u>=0;u--)s=r.tracks[u],s.needsUpdate===!0&&(s.update(),s.events&&l(s.events))}}function l(e){for(u=e.length-1;u>=0;u--)a=e[u],a.ticks=o*a.ticks,a.state!=="new"&&(a.state="changed")}var n=r.call(arguments),i=n[0],s=n[1],o=s/i,u,a;if(isNaN(i)||isNaN(s)){e.debug===4&&t.error("PPQ values must be numbers");return}f(n,2,n.length)}function Y(e,t){for(var n in a)if(a.hasOwnProperty(n)&&t===e.ppq/n)return a[n];return!1}function Z(e){return y(6e7/e)}function et(e){var t,n=e.indexOf("http://");return n!==-1&&(t=e.substring(n),n=t.indexOf(" "),n!==-1&&(t=t.substring(0,n))),'<a href="'+t+'"></a>'}function tt(e,t,n){var r,i,s=document.createElement("canvas"),o=s.getContext("2d"),u=e.getChannelData(0),a=e.getChannelData(0),f=u.length,l,c=t.height||100,h=t.color||"#71DE71",p=t.bgcolor||"#000",d,v=c/2,m=t.sampleStep||50,c,g,y,b,w=0,E=0,S=[],x,T=[];t.width!==undefined?(l=t.width,d=l/f):(d=t.density||1,l=1e3,g=f*t.density%l,y=Math.ceil(f*t.density/l),b=0),s.width=l,s.height=c,o.fillStyle=p,o.fillRect(0,0,l,c),o.beginPath(),o.strokeStyle=h,o.lineWidth=1,o.moveTo(0,v);for(r=0;r<f;r+=m)w=(r-E)*d,w>=l?(o.stroke(),S.push(s.toDataURL("image/png")),b++,b===y-1?s.width=g:s.width=l,o.beginPath(),o.strokeStyle=h,E=r,w=0,o.moveTo(w,v-u[r]*v)):o.lineTo(w,v-u[r]*v);w<l&&(o.stroke(),S.push(s.toDataURL("image/png"))),n(S)}function nt(e){var t="",n=new Uint8Array(e),r=n.byteLength;for(var i=0;i<r;i++)t+=String.fromCharCode(n[i]);return window.btoa(t)}function rt(e){return e>64&&e<91?e-65:e>96&&e<123?e-71:e>47&&e<58?e+4:e===43?62:e===47?63:0}function it(e,t){var n=e.replace(/[^A-Za-z0-9\+\/]/g,""),r=n.length,i=t?Math.ceil((r*3+1>>2)/t)*t:r*3+1>>2,s=new Uint8Array(i);for(var o,u,a=0,f=0,l=0;l<r;l++){u=l&3,a|=rt(n.charCodeAt(l))<<18-6*u;if(u===3||r-l===1){for(o=0;o<3&&f<i;o++,f++)s[f]=a>>>(16>>>o&24)&255;a=0}}return s}function st(e){return e<26?e+65:e<52?e+71:e<62?e-4:e===62?43:e===63?47:65}function ot(e){var t=2,n="";for(var r=e.length,i=0,s=0;s<r;s++){t=s%3,s>0&&s*4/3%76===0&&(n+="\r\n"),i|=e[s]<<(16>>>t&24);if(t===2||e.length-s===1)n+=String.fromCharCode(st(i>>>18&63),st(i>>>12&63),st(i>>>6&63),st(i&63)),i=0}return n.substr(0,n.length-2+t)+(t===2?"":t===1?"=":"==")}function ut(e){var t="";for(var n,r=e.length,i=0;i<r;i++)n=e[i],t+=String.fromCharCode(n>251&&n<254&&i+5<r?(n-252)*1073741824+(e[++i]-128<<24)+(e[++i]-128<<18)+(e[++i]-128<<12)+(e[++i]-128<<6)+e[++i]-128:n>247&&n<252&&i+4<r?(n-248<<24)+(e[++i]-128<<18)+(e[++i]-128<<12)+(e[++i]-128<<6)+e[++i]-128:n>239&&n<248&&i+3<r?(n-240<<18)+(e[++i]-128<<12)+(e[++i]-128<<6)+e[++i]-128:n>223&&n<240&&i+2<r?(n-224<<12)+(e[++i]-128<<6)+e[++i]-128:n>191&&n<224&&i+1<r?(n-192<<6)+e[++i]-128:n);return t}function at(e){var t,n,r=e.length,i=0;for(var s=0;s<r;s++)n=e.charCodeAt(s),i+=n<128?1:n<2048?2:n<65536?3:n<2097152?4:n<67108864?5:6;t=new Uint8Array(i);for(var o=0,u=0;o<i;u++)n=e.charCodeAt(u),n<128?t[o++]=n:n<2048?(t[o++]=192+(n>>>6),t[o++]=128+(n&63)):n<65536?(t[o++]=224+(n>>>12),t[o++]=128+(n>>>6&63),t[o++]=128+(n&63)):n<2097152?(t[o++]=240+(n>>>18),t[o++]=128+(n>>>12&63),t[o++]=128+(n>>>6&63),t[o++]=128+(n&63)):n<67108864?(t[o++]=248+(n>>>24),t[o++]=128+(n>>>18&63),t[o++]=128+(n>>>12&63),t[o++]=128+(n>>>6&63),t[o++]=128+(n&63)):(t[o++]=252+(n>>>30),t[o++]=128+(n>>>24&63),t[o++]=128+(n>>>18&63),t[o++]=128+(n>>>12&63),t[o++]=128+(n>>>6&63),t[o++]=128+(n&63));return t}var e=window.sequencer,t=window.console,n,r=Array.prototype.slice,i=Math.pow,s=Math.round,o=Math.floor,u=Math.random,a={1:"quarter",2:"eighth",4:"sixteenth",8:"32th",16:"64th"},f,l;e.protectedScope.addInitMethod(function(){n=e.protectedScope.context}),e.util.b64ToUint6=rt,e.util.base64DecToArr=it,e.util.uint6ToB64=st,e.util.base64EncArr=ot,e.util.UTF8ArrToStr=ut,e.util.strToUTF8Arr=at,e.util.ajax=N,e.util.ajax2=C,e.util.parseSamples=B,e.util.round=y,e.util.floor=b,e.util.remap=X,e.util.getRandom=K,e.util.createSlider=$,e.util.createSlider2=J,e.util.getRandomNotes=Q,e.util.getEqualPowerCurve=W,e.util.objectForEach=E,e.util.insertLink=et,e.util.encode64=nt,e.protectedScope.getNoteLengthName=Y,e.protectedScope.toBinaryString=j,e.protectedScope.base64ToBinary=I,e.protectedScope.toUint8Array=F,e.protectedScope.getArguments=z,e.protectedScope.pathToArray=q,e.protectedScope.parseUrl=R,e.protectedScope.loadLoop=U,e.protectedScope.findItem=M,e.protectedScope.storeItem=_,e.protectedScope.deleteItem=D,e.protectedScope.toBinaryString=j,e.protectedScope.ajax=N,e.protectedScope.copyObject=d,e.protectedScope.findItemsInFolder=A,e.convertPPQ=G,e.getNiceTime=h,e.protectedScope.isEmptyObject=w,e.protectedScope.objectForEach=E,e.protectedScope.objectToArray=S,e.protectedScope.arrayToObject=x,e.protectedScope.createClass=T,e.protectedScope.clone=p,e.protectedScope.round=y,e.protectedScope.floor=b,e.protectedScope.typeString=c,e.protectedScope.copyName=v,e.protectedScope.removeFromArray=m,e.protectedScope.removeFromArray2=g,e.protectedScope.filterItemsByClassName=V,e.getMicrosecondsFromBPM=Z,e.getWaveformData=tt}(),function(){"use strict";function a(e,n,i){try{t.decodeAudioData(r(e),function(){window.sequencer[n]=!0,i()},function(){i()})}catch(s){i()}}var e=window.sequencer,t,n,r,i=!1,s=[],o="T2dnUwACAAAAAAAAAABdxd4XAAAAADaS0jQBHgF2b3JiaXMAAAAAAUSsAAAAAAAAgLsAAAAAAAC4AU9nZ1MAAAAAAAAAAAAAXcXeFwEAAAAaXK+QDz3/////////////////MgN2b3JiaXMtAAAAWGlwaC5PcmcgbGliVm9yYmlzIEkgMjAxMDExMDEgKFNjaGF1ZmVudWdnZXQpAAAAAAEFdm9yYmlzH0JDVgEAAAEAGGNUKUaZUtJKiRlzlDFGmWKSSomlhBZCSJ1zFFOpOdeca6y5tSCEEBpTUCkFmVKOUmkZY5ApBZlSEEtJJXQSOiedYxBbScHWmGuLQbYchA2aUkwpxJRSikIIGVOMKcWUUkpCByV0DjrmHFOOSihBuJxzq7WWlmOLqXSSSuckZExCSCmFkkoHpVNOQkg1ltZSKR1zUlJqQegghBBCtiCEDYLQkFUAAAEAwEAQGrIKAFAAABCKoRiKAoSGrAIAMgAABKAojuIojiM5kmNJFhAasgoAAAIAEAAAwHAUSZEUybEkS9IsS9NEUVV91TZVVfZ1Xdd1Xdd1IDRkFQAAAQBASKeZpRogwgxkGAgNWQUAIAAAAEYowhADQkNWAQAAAQAAYig5iCa05nxzjoNmOWgqxeZ0cCLV5kluKubmnHPOOSebc8Y455xzinJmMWgmtOaccxKDZiloJrTmnHOexOZBa6q05pxzxjmng3FGGOecc5q05kFqNtbmnHMWtKY5ai7F5pxzIuXmSW0u1eacc84555xzzjnnnHOqF6dzcE4455xzovbmWm5CF+eccz4Zp3tzQjjnnHPOOeecc84555xzgtCQVQAAEAAAQRg2hnGnIEifo4EYRYhpyKQH3aPDJGgMcgqpR6OjkVLqIJRUxkkpnSA0ZBUAAAgAACGEFFJIIYUUUkghhRRSiCGGGGLIKaecggoqqaSiijLKLLPMMssss8wy67CzzjrsMMQQQwyttBJLTbXVWGOtueecaw7SWmmttdZKKaWUUkopCA1ZBQCAAAAQCBlkkEFGIYUUUoghppxyyimooAJCQ1YBAIAAAAIAAAA8yXNER3RER3RER3RER3REx3M8R5RESZRESbRMy9RMTxVV1ZVdW9Zl3fZtYRd23fd13/d149eFYVmWZVmWZVmWZVmWZVmWZVmC0JBVAAAIAACAEEIIIYUUUkghpRhjzDHnoJNQQiA0ZBUAAAgAIAAAAMBRHMVxJEdyJMmSLEmTNEuzPM3TPE30RFEUTdNURVd0Rd20RdmUTdd0Tdl0VVm1XVm2bdnWbV+Wbd/3fd/3fd/3fd/3fd/3dR0IDVkFAEgAAOhIjqRIiqRIjuM4kiQBoSGrAAAZAAABACiKoziO40iSJEmWpEme5VmiZmqmZ3qqqAKhIasAAEAAAAEAAAAAACia4imm4imi4jmiI0qiZVqipmquKJuy67qu67qu67qu67qu67qu67qu67qu67qu67qu67qu67qu67ouEBqyCgCQAADQkRzJkRxJkRRJkRzJAUJDVgEAMgAAAgBwDMeQFMmxLEvTPM3TPE30RE/0TE8VXdEFQkNWAQCAAAACAAAAAAAwJMNSLEdzNEmUVEu1VE21VEsVVU9VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVU1TdM0TSA0ZCUAAAQAwGKNweUgISUl5d4QwhCTnjEmIbVeIQSRkt4xBhWDnjKiDHLeQuMQgx4IDVkRAEQBAADGIMcQc8g5R6mTEjnnqHSUGuccpY5SZynFmGLNKJXYUqyNc45SR62jlGIsLXaUUo2pxgIAAAIcAAACLIRCQ1YEAFEAAIQxSCmkFGKMOaecQ4wp55hzhjHmHHOOOeegdFIq55x0TkrEGHOOOaecc1I6J5VzTkonoQAAgAAHAIAAC6HQkBUBQJwAgEGSPE/yNFGUNE8URVN0XVE0XdfyPNX0TFNVPdFUVVNVbdlUVVmWPM80PdNUVc80VdVUVVk2VVWWRVXVbdN1ddt0Vd2Wbdv3XVsWdlFVbd1UXds3Vdf2Xdn2fVnWdWPyPFX1TNN1PdN0ZdV1bVt1XV33TFOWTdeVZdN1bduVZV13Zdn3NdN0XdNVZdl0Xdl2ZVe3XVn2fdN1hd+VZV9XZVkYdl33hVvXleV0Xd1XZVc3Vln2fVvXheHWdWGZPE9VPdN0Xc80XVd1XV9XXdfWNdOUZdN1bdlUXVl2Zdn3XVfWdc80Zdl0Xds2XVeWXVn2fVeWdd10XV9XZVn4VVf2dVnXleHWbeE3Xdf3VVn2hVeWdeHWdWG5dV0YPlX1fVN2heF0Zd/Xhd9Zbl04ltF1fWGVbeFYZVk5fuFYlt33lWV0XV9YbdkYVlkWhl/4neX2feN4dV0Zbt3nzLrvDMfvpPvK09VtY5l93VlmX3eO4Rg6v/Djqaqvm64rDKcsC7/t68az+76yjK7r+6osC78q28Kx677z/L6wLKPs+sJqy8Kw2rYx3L5uLL9wHMtr68ox675RtnV8X3gKw/N0dV15Zl3H9nV040c4fsoAAIABBwCAABPKQKEhKwKAOAEAjySJomRZoihZliiKpui6omi6rqRppqlpnmlammeapmmqsimarixpmmlanmaamqeZpmiarmuapqyKpinLpmrKsmmasuy6sm27rmzbomnKsmmasmyapiy7sqvbruzquqRZpql5nmlqnmeapmrKsmmarqt5nmp6nmiqniiqqmqqqq2qqixbnmeamuippieKqmqqpq2aqirLpqrasmmqtmyqqm27quz6sm3rummqsm2qpi2bqmrbruzqsizbui9pmmlqnmeamueZpmmasmyaqitbnqeaniiqquaJpmqqqiybpqrKlueZqieKquqJnmuaqirLpmraqmmatmyqqi2bpirLrm37vuvKsm6qqmybqmrrpmrKsmzLvu/Kqu6KpinLpqrasmmqsi3bsu/Lsqz7omnKsmmqsm2qqi7Lsm0bs2z7umiasm2qpi2bqirbsi37uizbuu/Krm+rqqzrsi37uu76rnDrujC8smz7qqz6uivbum/rMtv2fUTTlGVTNW3bVFVZdmXZ9mXb9n3RNG1bVVVbNk3VtmVZ9n1Ztm1hNE3ZNlVV1k3VtG1Zlm1htmXhdmXZt2Vb9nXXlXVf133j12Xd5rqy7cuyrfuqq/q27vvCcOuu8AoAABhwAAAIMKEMFBqyEgCIAgAAjGGMMQiNUs45B6FRyjnnIGTOQQghlcw5CCGUkjkHoZSUMucglJJSCKGUlFoLIZSUUmsFAAAUOAAABNigKbE4QKEhKwGAVAAAg+NYlueZomrasmNJnieKqqmqtu1IlueJommqqm1bnieKpqmqruvrmueJommqquvqumiapqmqruu6ui6aoqmqquu6sq6bpqqqriu7suzrpqqqquvKriz7wqq6rivLsm3rwrCqruvKsmzbtm/cuq7rvu/7wpGt67ou/MIxDEcBAOAJDgBABTasjnBSNBZYaMhKACADAIAwBiGDEEIGIYSQUkohpZQSAAAw4AAAEGBCGSg0ZEUAECcAABhDKaSUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJIKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKqaSUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKZVSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUgoAkIpwAJB6MKEMFBqyEgBIBQAAjFFKKcacgxAx5hhj0EkoKWLMOcYclJJS5RyEEFJpLbfKOQghpNRSbZlzUlqLMeYYM+ekpBRbzTmHUlKLseaaa+6ktFZrrjXnWlqrNdecc825tBZrrjnXnHPLMdecc8455xhzzjnnnHPOBQDgNDgAgB7YsDrCSdFYYKEhKwGAVAAAAhmlGHPOOegQUow55xyEECKFGHPOOQghVIw55xx0EEKoGHPMOQghhJA55xyEEEIIIXMOOugghBBCBx2EEEIIoZTOQQghhBBKKCGEEEIIIYQQOgghhBBCCCGEEEIIIYRSSgghhBBCCaGUUAAAYIEDAECADasjnBSNBRYashIAAAIAgByWoFLOhEGOQY8NQcpRMw1CTDnRmWJOajMVU5A5EJ10EhlqQdleMgsAAIAgACDABBAYICj4QgiIMQAAQYjMEAmFVbDAoAwaHOYBwANEhEQAkJigSLu4gC4DXNDFXQdCCEIQglgcQAEJODjhhife8IQbnKBTVOogAAAAAAAMAOABAOCgACIimquwuMDI0Njg6PAIAAAAAAAWAPgAADg+gIiI5iosLjAyNDY4OjwCAAAAAAAAAACAgIAAAAAAAEAAAACAgE9nZ1MABAEAAAAAAAAAXcXeFwIAAABq2npxAgEBAAo=",u="//sQxAADwAABpAAAACAAADSAAAAETEFNRTMuOTkuNVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVU=";e.protectedScope.callInitMethods(),t=e.protectedScope.context,n=e.protectedScope.initMidi,r=e.protectedScope.base64ToBinary,delete e.protectedScope,e.ready=function(e){i===!0?e():s.push(e)},e.addInstrument({name:"sinewave",folder:"heartbeat",autopan:!1,attack:200,keyrange:[21,108],release_duration:50}),e.addInstrument({name:"metronome",folder:"heartbeat",sample_path:"heartbeat/metronome",keyrange:[60,61],mapping:{60:{n:"lowtick"},61:{n:"hightick"}}}),e.addSamplePack({name:"metronome",folder:"heartbeat",mapping:{hightick:"UklGRkQFAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YSAFAACx/xf/dADOACwBsP3p+6H+zAGoBOkCCwBX/EH5OvxlA4kJ2wcSArT9E/ut+HT2evUx98n6OAF5CCUMwQvfCOsJxAx0DSIMEAq9BiAB3vhz7mLkT9sR133YxN2s5QLv0vrUBnwRnxuQJeEsSDCiMd8yFS8aKFIhohUsCKj64u625OraA9HuyPnElcP+wxvJWtW25637VQ0jHPgnBTDDM1o0CzKLK+8hzhgFDOz8Se4J47DYVtG0z5fQq9LB12rfA+j99roHAhelIyMwIjdTOuU8mjwIOGoxhCb5E53/j+3k3/fTY8pTw4y/Tr+ew8DMvdsk8RcHRRkSKO4yGTkHPkU/rzzyNcgsrR94Dp/5r+Zs17zOncoDxhfE38WLyn/TeOMi9r0IRxlRKIQzyTlOPKo9yjmWMcokDRLc/Y7rudtdzu/D2L1Iu+27JcG3yYrVLujl+3UOZx1UK5Q0qzmNPDk8ZjeeMPojzhH+/jLtPd5m0hHLHsYIw5TEMMnA0jvj8fSOBiwXASZgMzM8dUBGQbI+rzjpKkIZygZT9QflcdaRyqXCz7+VwUPH784r3K7s+v0KDu8bvyeLMb43NjrhOIo0dSvQHi0PnP6i7ovg3NTxy4/Gf8X8yH/QBtvX55P2Ygb0FcUjsy4LNmI5ejiXM38r7iC8FJwHPvok7dDgQdaJzlTKIsoFzsrVkuA87d/6qAi7FQ0h9ClKMLEz3TOrMBcqYSD8E9AFd/dS6kTf6dbU0XnQv9IH2MXfZ+ln9DEAFwwdFy8giib6KawqeChgI/UbHBOTCZj/vvXe7InlFuDN3P3b0d1F4gzpifG2+u4D7Qw1FfwbnCD+IlgjWyHLHPMVog2mBL37qvP+7NvnYuTv4rvjfubN6k3wpPZ0/WkEOwtiEUsWcxm+Gl4aOhhiFDAPIwmbAtn7TPVy77zqcefr5YHmHull7enyfPmcAHgHew1REr8Vhhd/F+AV1RJ0DikJWQNc/ZP3efKd7hvs2ur46rHs5u8e9N/48/0hA/8HFgwuD04RSBIREqsQOg7mCssGMAJW/Xn4G/TK8Lbuzu0I7qTvnPJy9sX6bP84BLYIbAwdD84QYxG7EOcODAxwCFMEAQC9+7P3SvTX8XHw+u9R8KTxIvSo9+X7VQCUBJ0IMwziDj4QLhAGD9UMrgnTBZcBRv1v+Xv2UfS+8tfx+vES87z0+vb3+Zf9ZgEQBSEIUArWC8kM2QyzC5EJEAdvBHgBXP5n++r4Avd89Wj07fMw9D31Jvfp+Uj9xQD9A8QG5QhXClELrAsvC9wJ7gd6BWIC3v6O+7T4PPZN9EHzWvNf9Pz1Fvit+qL9rQCHAwEG/weCCZUKFwvDCnIJcAcQBWcCaf8Z/CD55vaB9dD0wPSP9UL3m/k7/Mz+JwEyAw8FzAY7CBsJaQk5CWkI2gatBCICYf+j/Fr6vfiV9872sfZP91z4p/lR+3H9zf89AroEFAfjCP0Jcwo8CjAJdQdgBSEDkgDQ/Vj7ZfnR95T28fUd9v32Vvg2+nb8+/6xAWoE4AbDCP4JpAqbCqQJ0weEBfgCTACT/R37M/m+9672IPY69gb3afhW+tT8qf+MAj0FggcuCScKXAriCcMIEAfyBJYCFwCP/Rz7A/l793z2F/Zn9mH37fjd+i39yf9pAt0EFAfRCNkJGAqrCZYIvgZPBJ8B6P4//M350vdz9q/1lfUq9mz3RPmi+3H+bgFVBOQG3wgHCkwK0Am7CCAHCgWmAjAA"
,lowtick:"UklGRlQFAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YTAFAAB0/5v+U/4T/3gA0wFTAuUB+f8d/nT90f1q/ub+tf46/mb/8wFQA9gC7wCd/mr+FAGRA3cE6wJf/h36evmv+8v/NwRHBZUC2/60+//5EvuZ/aX/bgFOAp8Azvzh9wfzLPF68zT4y/2BAygIfQwaEjYY0x31Irwl8SOWHVESOgPh9NfpReFt22nYHddD2BXcZeDa5InqgPDx9nP+6gS4CBYLnw0zES0WXxv4HkcgLh/1G+EX1RNpD4wKigXH/6r5/fNu7lTpj+Zu5hHoXOtL71byr/Qp91L64v6OBO4JoQ5zEskU+hU1FiQVeRP7EWgP4Qr0BIT+tPid9C3y1vCh8FDxJvK28vvyy/LA8pLzU/XP95v6xvw4/uD/RAK2BSkKcg6BEScTZBMeEqkPTQxjCKEEVwFi/nv7h/hp9aDyAvHP8MfxLvM+9PX0uPW19g/4Lfr7/C4AKgNaBXQGywb0BhIHWQfWB1oIzAjtCF8IHwdtBakDVwKLAeYA8v9w/kj81/nQ94v29/XX9bz1bPUY9Uz1Z/aH+Hr7yP4MAi4F+wcfCnYLNgyfDPsMSw0sDUAMfgrcB5IEMwFb/iX8T/pT+O/1X/Mf8cbvrO+18MLyvfVP+Rf9wgAoBCEHpwnIC5EN4Q5AD3wO1Ay0CpsIvwbvBNcCbQAr/nX8Ofsf+vb4mvda9rj1z/WX9pL3a/hH+ZX6R/wn/vP/eQESA/AE+wYDCcwKFAyPDCkMFQuSCe4HVQbSBHQDCwI8ANL9JPuY+HX28vTq82PzdPMV9Az1MfZ49zD5gftx/sQBBQXLB8cJ/gqpCw8MigwWDXENXQ2rDDUL7QgDBswCdv8S/K74WPVk8hXwou4P7mvu1+9T8pz1Uvli/ZoBwgWRCcsMPg/CEEQR4RDADwoO9wusCVMH4ARSApn/ufzd+Wj3bvX78xzzx/L68qzz1vSD9qX4Gfvd/c0AhwO/BWwHmghvCQEKVQonClsJCwiIBh0F0gOgAm0BOwAx/03+XP0g/Lb6cPmX+F/4vfh++TH6s/os+7/7cvwL/Zz9XP5O/3IA3AF9AzsF9gaUCAAKHgueCzcL9wntB3sF4wIzAI396fp1+Gv2IvWn9N30p/Xi9m74G/ru+9P9k/8aAYEC1AMTBSIG0wYuB1gHkgcACGEISAhTBzEFWAKt/5L92fuU+vX50fmf+SP5i/gb+Bf4mviv+Sr7kvyb/Uj+r/4X/8r/+gCiAo0EUAaRBzwISwjqB3IHGQfCBv8FpgTMApQAKf67+5n5/vfn9jz2yPVn9SL1RPXq9SP3Dvmr+6f+sQGKBAcH+whOCh0Laws3C28KLAmDB5AFfQNoAVP/Zv3e+7P6sfnL+Cv4vPeM95b37feV+Jn51Poq/LL9mv+YAVYD3gQuBmcHSAikCIEI7Af+BuEFngQXA1sBv/9v/pf9MP3W/Fj8q/sR+6H6U/o3+mP6y/pN+/f7xvye/WH+Jf9mAD4CQAQJBisHtgf6Bw0I8QdsB1sGywT4AggBCP/o/KX6mPg19572jfaz9uf2S/cM+E35E/tW/af/5wH1A8AFKgfkB/AHgwfxBlAGgQVIBMMCJwGs/43+vP0i/Zr8Lfzl+9H76fvi+9f75fsf/In8BP10/ej9cf4O/7f/dAAcAaUBEgKMAhgDpAMEBCEEDwTfA3IDxQL8ASoBUwCG/87+J/6h/Rr9pPxk/Gb8oPwJ/XH9w/39/UD+qP41/9D/WwDeAGsBAgKdAhEDQQNAA0sDbwOVA5YDVwPOAhgCVAGRAA=="}}),e.addTask({type:"test mp3",method:function(e){a(u,"mp3",e)},params:[]}),e.addTask({type:"test ogg",method:function(e){a(o,"ogg",e)},params:[]}),e.addTask({type:"init midi",method:n,params:[]},function(){s.forEach(function(e){e()});if(e.debug>=4){var t="sequencer ready, support for:";e.ogg===!0&&(t+=" ogg"),e.mp3===!0&&(t+=" mp3"),console.log(t)}i=!0},!1)}();